diff -urN -x lib a2billing_v1.9.4/admin/Public/call-count-reporting-history.php a2billing/admin/Public/call-count-reporting-history.php
--- a2billing_v1.9.4/admin/Public/call-count-reporting-history.php	1969-12-31 21:00:00.000000000 -0300
+++ a2billing/admin/Public/call-count-reporting-history.php	2012-09-10 18:35:26.000000000 -0300
@@ -0,0 +1,434 @@
+<?php
+
+/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
+
+/**
+ * This file is part of A2Billing (http://www.a2billing.net/)
+ *
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
+ * powered by Star2billing S.L. <http://www.star2billing.com/>
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
+ * @author      Belaid Arezqui <areski@gmail.com>
+ * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
+ * @package     A2Billing
+ *
+ * Software License Agreement (GNU Affero General Public License)
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Affero General Public License as
+ * published by the Free Software Foundation, either version 3 of the
+ * License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Affero General Public License for more details.
+ *
+ * You should have received a copy of the GNU Affero General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ * 
+ * 
+**/
+
+
+include ("../lib/admin.defines.php");
+include ("../lib/admin.module.access.php");
+include ("../lib/admin.smarty.php");
+
+if (! has_rights (ACX_CALL_REPORT)) {
+	Header ("HTTP/1.0 401 Unauthorized");
+	Header ("Location: PP_error.php?c=accessdenied");	   
+	die();
+}
+
+getpost_ifset(array('inputtopvar','topsearch', 'posted', 'Period', 'frommonth', 'fromstatsmonth', 'tomonth', 'tostatsmonth', 'fromday', 'fromstatsday_sday', 'fromstatsmonth_sday', 'today', 'tostatsday_sday', 'tostatsmonth_sday', 'resulttype', 'stitle', 'atmenu', 'order', 'sens', 'choose_currency', 'terminatecauseid', 'nodisplay','grouped'));
+
+
+
+if (!isset ($FG_TABLE_CLAUSE) || strlen($FG_TABLE_CLAUSE)==0) {
+	$cc_yearmonth = sprintf("%04d-%02d-%02d",date("Y"),date("n"),date("d")); 	
+	$FG_TABLE_CLAUSE=" UNIX_TIMESTAMP(starttime) <= UNIX_TIMESTAMP('$cc_yearmonth')";
+}
+
+$FG_DEBUG = 0;
+
+
+// THIS VARIABLE DEFINE THE COLOR OF THE HEAD TABLE
+$FG_TABLE_ALTERNATE_ROW_COLOR[] = "#FFFFFF";
+$FG_TABLE_ALTERNATE_ROW_COLOR[] = "#F2F8FF";
+
+
+$DBHandle = DbConnect();
+
+if($order=="day" && $grouped==0) {
+    $order="";
+}
+
+$FG_TABLE_COL = array();
+switch ($topsearch) {	
+	case "topdestination":
+		$FG_TABLE_COL[]=array (gettext("Destination"), "destination", "25%", "center", "SORT", "15", "lie", "cc_prefix", "destination", "id='%id'", "%1");
+		$on_field1 = "cc_prefix.destination";
+		$on_field2 = "destination";
+		$FG_TABLE_DEFAULT_ORDER = "cc_prefix.destination";
+		$FG_TABLE_NAME="cc_call_archive LEFT JOIN cc_prefix ON cc_call_archive.destination = cc_prefix.prefix";
+		if($order=="card_id" || empty ($order))$order="destination";
+		break;
+	case "topuser":
+	default:
+		$FG_TABLE_COL[]=array (gettext("Account Used"), 'card_id', "25%", "center","SORT", "", "30", "", "", "", "", "linktocustomer_id");
+		$on_field1 = $on_field2 = "card_id";
+		$FG_TABLE_DEFAULT_ORDER = "card_id";
+		$FG_TABLE_NAME="cc_call_archive";
+		if($order=="destination" || empty ($order))$order="card_id";
+		break;
+}
+
+$FG_TABLE_COL[]=array (gettext("Duration"), "calltime", "15%", "center", "SORT", "30", "", "", "", "", "", "display_minute");
+$FG_TABLE_COL[]=array (gettext("Sell"), "cost", "15%", "center","sort","","","","","","","display_2bill");
+$FG_TABLE_COL[]=array (gettext("Buy"), "buy", "15%", "center","sort","","","","","","","display_2bill");
+if ($grouped) $FG_TABLE_COL[]=array (gettext("Calldate"), "day", "10%", "center", "SORT", "19", "", "", "", "", "", "display_dateformat");
+if ((isset($inputtopvar)) && ($inputtopvar!="") && (isset($topsearch)) && ($topsearch!="")){
+	$FG_TABLE_COL[]=array (gettext("NbrCall"), 'nbcall', "10%", "center", "SORT");
+}
+
+
+if ($grouped) {
+	$FG_COL_QUERY=$on_field1.', sum(sessiontime) AS calltime, sum(sessionbill) as cost, sum(buycost) as buy,DATE(starttime) AS day, count(*) as nbcall';
+	$SQL_GROUP=" GROUP BY ".$on_field2.",DATE(starttime) ";
+} else {
+	$FG_COL_QUERY=$on_field1.', sum(sessiontime) AS calltime, sum(sessionbill) as cost, sum(buycost) as buy, count(*) as nbcall';
+	$SQL_GROUP=" GROUP BY ".$on_field2." ";
+}
+
+$FG_TABLE_DEFAULT_SENS = "DESC";
+
+
+$FG_NB_TABLE_COL=count($FG_TABLE_COL);
+$FG_TOTAL_TABLE_COL = $FG_NB_TABLE_COL;
+$FG_HTML_TABLE_TITLE = gettext(" - Call Report - ");
+$FG_HTML_TABLE_WIDTH="96%";
+
+if ( empty ($order) || empty($sens) || ( $order == 'card_id' && $topsearch == 'topdestination') || ( $order == 'destination' && $topsearch == 'topuser')) {
+	$order = $FG_TABLE_DEFAULT_ORDER;
+	$sens  = $FG_TABLE_DEFAULT_SENS;
+}
+
+$date_clause='';
+normalize_day_of_month($fromstatsday_sday, $fromstatsmonth_sday, 1); 
+normalize_day_of_month($tostatsday_sday, $tostatsmonth_sday, 1);
+ 	
+if ($fromday && isset($fromstatsday_sday) && isset($fromstatsmonth_sday)) $date_clause.=" AND UNIX_TIMESTAMP(starttime) >= UNIX_TIMESTAMP('$fromstatsmonth_sday-$fromstatsday_sday') ";
+if ($today && isset($tostatsday_sday) && isset($tostatsmonth_sday)) $date_clause.=" AND UNIX_TIMESTAMP(starttime) <= UNIX_TIMESTAMP('$tostatsmonth_sday-".sprintf("%02d",intval($tostatsday_sday)/*+1*/)." 23:59:59') ";
+
+
+if (strpos($date_clause, 'AND') > 0) {
+	$FG_TABLE_CLAUSE = substr($date_clause,5); 
+}
+
+// To select just terminatecauseid=ANSWER
+if (!isset($terminatecauseid)) {
+	$terminatecauseid="ANSWER";
+}
+if ($terminatecauseid=="ANSWER") {
+	if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE.=" AND ";
+	$FG_TABLE_CLAUSE .=" (terminatecauseid=1) ";
+}
+
+
+$instance_table = new Table($FG_TABLE_NAME, $FG_COL_QUERY);
+
+if (!$nodisplay) {
+	$list = $instance_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE, $order, $sens, null, null,$inputtopvar , 0,$SQL_GROUP);	
+}
+
+
+$smarty->display('main.tpl');
+
+?>
+
+<!-- ** ** ** ** ** Part for the research ** ** ** ** ** -->
+	<center>
+	<FORM METHOD=POST name="myForm" ACTION="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php echo $current_page?>">
+	<INPUT TYPE="hidden" NAME="posted" value=1>
+	<INPUT TYPE="hidden" NAME="current_page" value=0>	
+		<table class="bar-status" width="85%" border="0" cellspacing="1" cellpadding="2" align="center">
+			
+			<tr>
+        		<td align="left" class="bgcolor_002">
+					<font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("DATE");?></font>
+			</td>
+      			<td align="left" class="bgcolor_003" width="650">
+					<table width="100%" border="0" cellspacing="0" cellpadding="0" >
+					<tr><td class="fontstyle_searchoptions">
+	  				<input type="checkbox" name="fromday" value="true" <?php  if ($fromday){ ?>checked<?php }?>> <?php echo gettext("From");?> :
+					<select name="fromstatsday_sday" class="form_input_select">
+						<?php  
+						for ($i=1;$i<=31;$i++) {
+							if ($fromstatsday_sday==sprintf("%02d",$i)) $selected="selected";
+							else	$selected="";
+							echo '<option value="'.sprintf("%02d",$i)."\"$selected>".sprintf("%02d",$i).'</option>';
+						}
+						?>	
+					</select>
+				 	<select name="fromstatsmonth_sday" class="form_input_select">
+					<?php 	
+						$monthname = array( gettext("January"), gettext("February"),gettext("March"), gettext("April"), gettext("May"), gettext("June"), gettext("July"), gettext("August"), gettext("September"), gettext("October"), gettext("November"), gettext("December"));
+						$year_actual = date("Y");  	
+						for ($i=$year_actual;$i >= $year_actual-1;$i--) {		   
+							if ($year_actual==$i) {
+								$monthnumber = date("n")-1; // Month number without lead 0.
+							} else {
+								$monthnumber=11;
+							}		   
+							for ($j=$monthnumber;$j>=0;$j--) {	
+								$month_formated = sprintf("%02d",$j+1);
+								if ($fromstatsmonth_sday=="$i-$month_formated") $selected="selected";
+								else $selected="";
+								echo "<OPTION value=\"$i-$month_formated\" $selected> $monthname[$j]-$i </option>";				
+							}
+						}
+					?>
+					</select>
+					</td><td class="fontstyle_searchoptions">&nbsp;&nbsp;
+					<input type="checkbox" name="today" value="true" <?php  if ($today){ ?>checked<?php }?>> <?php echo gettext("To");?>  :
+					<select name="tostatsday_sday" class="form_input_select">
+					<?php  
+						for ($i=1;$i<=31;$i++) {
+							if ($tostatsday_sday==sprintf("%02d",$i)){$selected="selected";}else{$selected="";}
+							echo '<option value="'.sprintf("%02d",$i)."\"$selected>".sprintf("%02d",$i).'</option>';
+						}
+					?>						
+					</select>
+				 	<select name="tostatsmonth_sday" class="form_input_select">
+					<?php 	$year_actual = date("Y");  	
+						for ($i=$year_actual;$i >= $year_actual-1;$i--) {		   
+							if ($year_actual==$i) {
+								$monthnumber = date("n")-1; // Month number without lead 0.
+							} else {
+								$monthnumber=11;
+							}		   
+							for ($j=$monthnumber;$j>=0;$j--) {	
+								$month_formated = sprintf("%02d",$j+1);
+							   	if ($tostatsmonth_sday=="$i-$month_formated") $selected="selected";
+								else	$selected="";
+								echo "<OPTION value=\"$i-$month_formated\" $selected> $monthname[$j]-$i </option>";				
+							}
+						}
+					?>
+					</select>
+					</td></tr></table>
+	  			</td>
+    		</tr>
+		<tr>
+			<TD class="bgcolor_004" align="left">
+				<font class="fontstyle_003">&nbsp;&nbsp;<?php echo strtoupper(gettext("Number in Result"));?></font>
+			</TD>
+			<td class="bgcolor_005" align="left" >
+				<table width="100%" border="0" cellspacing="0" cellpadding="0">
+				<tr>	
+					<td  align="left" class="fontstyle_searchoptions" >
+					    <select name="inputtopvar" class="form_input_select">
+						<option value="10" <?php if($inputtopvar==10) echo "selected"?>> 10&nbsp;<?php echo gettext('RESULTS');?>  </option>
+						<option value="20" <?php if($inputtopvar==20) echo "selected"?>> 20&nbsp;<?php echo gettext('RESULTS');?>   </option>
+						<option value="30" <?php if($inputtopvar==30) echo "selected"?>> 30&nbsp;<?php echo gettext('RESULTS');?>   </option>
+						<option value="40" <?php if($inputtopvar==40) echo "selected"?>> 40&nbsp;<?php echo gettext('RESULTS');?>   </option>
+						<option value="50" <?php if($inputtopvar==50) echo "selected"?>> 50&nbsp;<?php echo gettext('RESULTS');?>   </option>
+					    </select>
+					</td>
+					<td  align="center" class="fontstyle_searchoptions">
+						
+					</td>
+					<td  align="center" class="fontstyle_searchoptions">
+						
+					</td>
+				</tr></table>
+			</TD>
+		 </tr>
+			<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
+			<tr>
+			  <td class="bgcolor_002" align="left" ><font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("OPTIONS");?></font></td>
+			  <td class="bgcolor_003" align="center" >
+			  <table width="100%" border="0" cellspacing="0" cellpadding="0">
+			  <tr>
+			  	<td width="35%" class="fontstyle_searchoptions" >
+				<table width="100%" border="0" cellspacing="0" cellpadding="0">
+				<tr class="bgcolor_005">
+					<td  class="fontstyle_searchoptions">
+						<?php echo gettext("GROUP BY");?> : 
+				   </td>
+				   <td  class="fontstyle_searchoptions">
+				   		<?php echo gettext("Calls by user");?>
+				   		<input type="radio" name="topsearch" value="topuser" <?php if ($topsearch=="topuser" || empty($topsearch)){ ?> checked="checked" <?php  } ?>>
+				   		<?php echo gettext("Calls by destination");?>
+				   		<input type="radio" name="topsearch" value="topdestination" <?php if ($topsearch=="topdestination"){ ?> checked="checked" <?php  } ?>>
+				   </td>
+				</tr>
+				<tr>
+					<td width="20%"  class="fontstyle_searchoptions">
+						<?php echo gettext("SHOW");?> :  						
+				   </td>
+				   <td width="80%"  class="fontstyle_searchoptions">				   		
+				  <?php echo gettext("Answered Calls")?>
+				  <input name="terminatecauseid" type="radio" value="ANSWER" <?php if((!isset($terminatecauseid))||($terminatecauseid=="ANSWER")){?>checked<?php }?> /> 
+				  <?php echo gettext("All Calls")?>	
+				   <input name="terminatecauseid" type="radio" value="ALL" <?php if($terminatecauseid=="ALL"){?>checked<?php }?>/>
+					</td>
+				</tr>
+				<tr class="bgcolor_005">
+					<td  class="fontstyle_searchoptions">
+						<?php echo gettext("GROUP BY DAY");?> : 
+				   </td>
+				   <td  class="fontstyle_searchoptions">
+				   <?php echo gettext("Yes")?>
+				  <input name="grouped" type="radio" value="1" <?php if($grouped){?>checked<?php }?> /> 
+				  <?php echo gettext("NO")?>
+				  <input name="grouped" type="radio" value="0" <?php if((!isset($grouped))||(!$grouped)){?>checked<?php }?>/>
+					</td>
+				</tr>
+				<tr>
+					<td  class="fontstyle_searchoptions">
+						<?php echo gettext("RESULT");?> :
+					</td>
+					<td  class="fontstyle_searchoptions">
+						
+	
+					<?php echo gettext("Mins");?> <input type="radio" NAME="resulttype" value="min" <?php if((!isset($resulttype))||($resulttype=="min")){?>checked<?php }?>> - <?php echo gettext("Secs")?> <input type="radio" NAME="resulttype" value="sec" <?php if($resulttype=="sec"){?>checked<?php }?>>
+
+					</td>
+				</tr>
+				<tr class="bgcolor_005">
+					<td  class="fontstyle_searchoptions">
+						<?php echo gettext("CURRENCY");?> : 
+				   </td>
+				   <td  class="fontstyle_searchoptions">
+				<select NAME="choose_currency" size="1" class="form_input_select">
+							<?php
+								$currencies_list = get_currencies();
+								foreach($currencies_list as $key => $cur_value) {
+							?>
+								<option value='<?php echo $key ?>' <?php if (($choose_currency==$key) || (!isset($choose_currency) && $key==strtoupper(BASE_CURRENCY))){?>selected<?php } ?>><?php echo $cur_value[1].' ('.$cur_value[2].')' ?>
+								</option>
+							<?php 	} ?>
+						</select>   
+					</td>
+				</tr>
+				</table>
+			   </td>
+				</tr>
+				</table>
+			  </td>
+			  </tr>
+			<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
+			<tr>
+        		<td class="bgcolor_004" align="left" > </td>
+				<td class="bgcolor_005" align="center" >
+					<input type="image"  name="image16" align="top" border="0" src="<?php echo Images_Path;?>/button-search.gif" />
+	  			</td>
+    		</tr>
+		</tbody></table>
+	</FORM>
+</center>
+<br><br>
+
+<!-- ** ** ** ** ** Part to display the CDR ** ** ** ** ** -->
+<?php if (!$nodisplay) { ?>
+<table width="<?php echo $FG_HTML_TABLE_WIDTH?>" border="0" align="center" cellpadding="0" cellspacing="0">
+	<TR bgcolor="#ffffff">
+		<TD class="bgcolor_021" height=16 style="PADDING-LEFT: 5px; PADDING-RIGHT: 3px">
+		<TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+			<TR>
+				<TD><SPAN class="fontstyle_003"><?php echo $FG_HTML_TABLE_TITLE?></SPAN></TD>
+			</TR>
+		</TABLE>
+		</TD>
+	</TR>
+        <TR> 
+          <TD> <TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+                <TR class="bgcolor_008"> 
+				  
+                  <?php 
+				  	if (is_array($list) && count($list)>0){
+					
+				  	for($i=0;$i<$FG_NB_TABLE_COL;$i++){ 
+					?>				
+				  
+					
+                  <TD width="<?php echo $FG_TABLE_COL[$i][2]?>" align=middle class="tableBody" style="PADDING-BOTTOM: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; PADDING-TOP: 2px"> 
+                    <center><strong> 
+                    <?php  if (strtoupper($FG_TABLE_COL[$i][4])=="SORT"){?>
+                    <a href="<?php  echo $PHP_SELF."?s=1&t=0&stitle=$stitle&atmenu=$atmenu&current_page=$current_page&order=".$FG_TABLE_COL[$i][1]."&sens="; if ($sens=="ASC"){echo"DESC";}else{echo"ASC";} 
+					echo "&topsearch=$topsearch&inputtopvar=$inputtopvar&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&resulttype=$resulttype&terminatecauseid=$terminatecauseid&grouped=$grouped";?>"> 
+                    <span class="liens"><?php  } ?>
+                    <?php echo $FG_TABLE_COL[$i][0]?> 
+                    <?php if ($order==$FG_TABLE_COL[$i][1] && $sens=="ASC"){?>
+                    &nbsp;<img src="<?php echo Images_Path;?>/icon_up_12x12.GIF" width="12" height="12" border="0"> 
+                    <?php }elseif ($order==$FG_TABLE_COL[$i][1] && $sens=="DESC"){?>
+                    &nbsp;<img src="<?php echo Images_Path;?>/icon_down_12x12.GIF" width="12" height="12" border="0"> 
+                    <?php }?>
+                    <?php  if (strtoupper($FG_TABLE_COL[$i][4])=="SORT"){?>
+                    </span></a> 
+                    <?php }?>
+                    </strong></center></TD>
+				   <?php } ?>
+                </TR>
+                
+				<?php
+				  	 $ligne_number=0;
+				  	 foreach ($list as $recordset) {
+						 $ligne_number++;
+				?>
+               		 <TR bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>"  onMouseOver="bgColor='#C4FFD7'" onMouseOut="bgColor='<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>'"> 
+							 
+					<?php 
+						for($i=0;$i<$FG_NB_TABLE_COL;$i++) {
+							
+							$record_display = $recordset[$i];
+							if ( is_numeric($FG_TABLE_COL[$i][5]) && (strlen($record_display) > $FG_TABLE_COL[$i][5])  ){
+								$record_display = substr($record_display, 0, $FG_TABLE_COL[$i][5]-3)."";  
+							} ?>
+	                 		 <TD vAlign=top align="<?php echo $FG_TABLE_COL[$i][3]?>" class=tableBody><?php 
+							 if (isset ($FG_TABLE_COL[$i][11]) && strlen($FG_TABLE_COL[$i][11])>1) {
+							 		call_user_func($FG_TABLE_COL[$i][11], $record_display);
+							 } else {
+							 		echo stripslashes($record_display);
+							 }				 
+						 ?></TD>
+				 	<?php  
+				 		} ?>
+					</TR>
+				<?php
+					 }//foreach ($list as $recordset)
+					 if ($ligne_number < $FG_LIMITE_DISPLAY)
+					 	$ligne_number_end=$ligne_number +2;
+					 
+					 while ($ligne_number < $ligne_number_end) {
+					 	$ligne_number++;
+				?>
+					<TR bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>"> 
+				  		<?php 
+				  			for($i=0;$i<$FG_NB_TABLE_COL;$i++) { 
+				 		 ?>
+                 		 <TD vAlign=top class=tableBody>&nbsp;</TD>
+				 		 <?php  } ?>
+                 		 <TD align="center" vAlign=top class=tableBodyRight>&nbsp;</TD>				
+					</TR>
+									
+				<?php					 
+					 } //END_WHILE
+					 
+				  }else{
+				  		echo gettext("No data found !!!");
+				  }//end_if
+				 ?>
+                
+            </TABLE></td>
+        </tr>
+      
+      </table>
+<br>
+<?php
+}
+$smarty->display('footer.tpl');
+
diff -urN -x lib a2billing_v1.9.4/admin/Public/call-log-customers-history.php a2billing/admin/Public/call-log-customers-history.php
--- a2billing_v1.9.4/admin/Public/call-log-customers-history.php	1969-12-31 21:00:00.000000000 -0300
+++ a2billing/admin/Public/call-log-customers-history.php	2012-09-11 19:46:26.000000000 -0300
@@ -0,0 +1,1386 @@
+<?php
+
+/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
+
+/**
+ * This file is part of A2Billing (http://www.a2billing.net/)
+ *
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
+ * powered by Star2billing S.L. <http://www.star2billing.com/>
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
+ * @author      Belaid Arezqui <areski@gmail.com>
+ * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
+ * @package     A2Billing
+ *
+ * Software License Agreement (GNU Affero General Public License)
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Affero General Public License as
+ * published by the Free Software Foundation, either version 3 of the
+ * License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Affero General Public License for more details.
+ *
+ * You should have received a copy of the GNU Affero General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ * 
+ * 
+**/
+
+
+include ("../lib/admin.defines.php");
+include ("../lib/admin.module.access.php");
+include ("../lib/admin.smarty.php");
+
+if (! has_rights ( ACX_CALL_REPORT )) {
+	Header ( "HTTP/1.0 401 Unauthorized" );
+	Header ( "Location: PP_error.php?c=accessdenied" );
+	die ();
+}
+
+getpost_ifset ( array ('customer', 'sellrate', 'buyrate', 'entercustomer','entercustomer_num', 'enterprovider', 'entertariffgroup', 'entertrunk', 'enterratecard', 'posted', 'Period', 'frommonth', 'fromstatsmonth', 'tomonth', 'tostatsmonth', 'fromday', 'fromstatsday_sday', 'fromstatsmonth_sday', 'today', 'tostatsday_sday', 'tostatsmonth_sday', 'fromtime', 'totime', 'fromstatsday_hour', 'tostatsday_hour', 'fromstatsday_min', 'tostatsday_min', 'dsttype', 'srctype', 'dnidtype', 'clidtype', 'channel', 'resulttype', 'stitle', 'atmenu', 'current_page', 'order', 'sens', 'dst', 'src', 'dnid', 'clid', 'choose_currency', 'terminatecauseid', 'choose_calltype', 'download', 'file') );
+
+if (($download == "file") && $file) {
+	
+	if (strpos($file, '/') !== false) exit;
+	
+	$value_de = base64_decode ( $file );
+	$dl_full = MONITOR_PATH . "/" . $value_de;
+	$dl_name = $value_de;
+	
+	if (! file_exists ( $dl_full )) {
+		echo gettext ( "ERROR: Cannot download file " . $dl_full . ", it does not exist.<br>" );
+		exit ();
+	}
+	
+	header ( "Content-Type: application/octet-stream" );
+	header ( "Content-Disposition: attachment; filename=$dl_name" );
+	header ( "Content-Length: " . filesize ( $dl_full ) );
+	header ( "Accept-Ranges: bytes" );
+	header ( "Pragma: no-cache" );
+	header ( "Expires: 0" );
+	header ( "Cache-Control: must-revalidate, post-check=0, pre-check=0" );
+	header ( "Content-transfer-encoding: binary" );
+	
+	@readfile ( $dl_full );
+	exit ();
+}
+
+$dialstatus_list = Constants::getDialStatusList ();
+
+if (! isset ( $current_page ) || ($current_page == "")) {
+	$current_page = 0;
+}
+
+// this variable specifie the debug type (0 => nothing, 1 => sql result, 2 => boucle checking, 3 other value checking)
+$FG_DEBUG = 0;
+
+// The variable FG_TABLE_NAME define the table name to use
+$FG_TABLE_NAME = "cc_call_archive t1 LEFT OUTER JOIN cc_trunk t3 ON t1.id_trunk = t3.id_trunk LEFT OUTER JOIN cc_ratecard t4 ON t1.id_ratecard = t4.id";
+
+
+
+// THIS VARIABLE DEFINE THE COLOR OF THE HEAD TABLE
+$FG_TABLE_ALTERNATE_ROW_COLOR [] = "#FFFFFF";
+$FG_TABLE_ALTERNATE_ROW_COLOR [] = "#F2F8FF";
+
+$yesno = array ();
+$yesno ["1"] = array ("Yes", "1" );
+$yesno ["0"] = array ("No", "0" );
+
+// 0 = NORMAL CALL ; 1 = VOIP CALL (SIP/IAX) ; 2= DIDCALL + TRUNK ; 3 = VOIP CALL DID ; 4 = CALLBACK call
+$list_calltype = array ();
+$list_calltype ["0"] = array (gettext("STANDARD"), "0" );
+$list_calltype ["1"] = array (gettext("SIP/IAX"), "1" );
+$list_calltype ["2"] = array (gettext("DIDCALL"), "2" );
+$list_calltype ["3"] = array (gettext("DID_VOIP"), "3" );
+$list_calltype ["4"] = array (gettext("CALLBACK"), "4" );
+$list_calltype ["5"] = array (gettext("PREDICT"), "5" );
+$list_calltype ["6"] = array (gettext("AUTO DIALER"), "6" );
+$list_calltype ["7"] = array (gettext("DID-ALEG"), "7" );
+
+$FG_TABLE_DEFAULT_ORDER = "t1.starttime";
+$FG_TABLE_DEFAULT_SENS = "DESC";
+
+
+$DBHandle = DbConnect ();
+
+$FG_TABLE_COL = array ();
+$FG_TABLE_COL [] = array (gettext ( "Date" ), "starttime", "10%", "center", "SORT", "19", "", "", "", "", "", "display_dateformat" );
+$FG_TABLE_COL [] = array (gettext ( "CallerID" ), "src", "7%", "center", "SORT", "30" );
+$FG_TABLE_COL [] = array (gettext ( "DNID" ), "dnid", "7%", "center", "SORT", "30" );
+$FG_TABLE_COL [] = array (gettext ( "Phone Number" ), "calledstation", "10%", "center", "SORT", "30", "", "", "", "", "", "" );
+$FG_TABLE_COL [] = array (gettext ( "Destination" ), "dest","10%", "center", "SORT", "15", "lie", "cc_prefix", "destination,prefix", "prefix='%id'", "%1" );
+$FG_TABLE_COL [] = array (gettext ( "Buy Rate" ), "buyrate", "6%", "center", "SORT", "30", "", "", "", "", "", "display_2bill" );
+$FG_TABLE_COL [] = array (gettext ( "Sell Rate" ), "rateinitial", "6%", "center", "SORT", "30", "", "", "", "", "", "display_2bill" );
+$FG_TABLE_COL [] = array (gettext ( "Duration" ), "sessiontime", "5%", "center", "SORT", "30", "", "", "", "", "", "display_minute" );
+$FG_TABLE_COL [] = array (gettext ( "Account" ), "card_id", "6%", "center", "sort", "", "lie_link", "cc_card", "username,id", "id='%id'", "%1", "", "A2B_entity_card.php" );
+$FG_TABLE_COL [] = array (gettext ( "Trunk" ), "trunkcode", "6%", "center", "SORT", "30" );
+$FG_TABLE_COL [] = array ('<acronym title="' . gettext ( "Terminate Cause" ) . '">' . gettext ( "TC" ) . '</acronym>', "terminatecauseid", "7%", "center", "SORT", "", "list", $dialstatus_list );
+$FG_TABLE_COL [] = array (gettext ( "CallType" ), "sipiax", "6%", "center", "SORT", "", "list", $list_calltype );
+$FG_TABLE_COL [] = array (gettext ( "Buy" ), "buycost", "7%", "center", "SORT", "30", "", "", "", "", "", "display_2bill" );
+$FG_TABLE_COL [] = array (gettext ( "Sell" ), "sessionbill", "7%", "center", "SORT", "30", "", "", "", "", "", "display_2bill" );
+$FG_TABLE_COL [] = array (gettext ( "Margin" ), "margin", "7%", "center", "SORT", "30", "", "", "", "", "", "display_2dec_percentage" );
+$FG_TABLE_COL [] = array (gettext ( "Markup" ), "markup", "7%", "center", "SORT", "30", "", "", "", "", "", "display_2dec_percentage" );
+
+if (LINK_AUDIO_FILE) {
+	$FG_TABLE_COL [] = array ("", "uniqueid", "1%", "center", "", "30", "", "", "", "", "", "linkonmonitorfile" );
+}
+
+if (has_rights (ACX_DELETE_CDR)) {
+	$FG_TABLE_COL [] = array ("", "id", "1%", "center", "", "30", "", "", "", "", "", "linkdelete_cdr" );
+}
+
+// This Variable store the argument for the SQL query
+$FG_COL_QUERY = 't1.starttime, t1.src, t1.dnid, t1.calledstation, t1.destination AS dest, t4.buyrate, t4.rateinitial, t1.sessiontime, t1.card_id, t3.trunkcode, t1.terminatecauseid, t1.sipiax, t1.buycost, t1.sessionbill, case when t1.sessionbill!=0 then ((t1.sessionbill-t1.buycost)/t1.sessionbill)*100 else NULL end as margin,case when t1.buycost!=0 then ((t1.sessionbill-t1.buycost)/t1.buycost)*100 else NULL end as markup';
+
+if (LINK_AUDIO_FILE) {
+	$FG_COL_QUERY .= ', t1.uniqueid';
+}
+if (has_rights (ACX_DELETE_CDR)) {
+	$FG_COL_QUERY .= ', t1.id';
+}
+$FG_COL_QUERY_GRAPH = 't1.callstart, t1.duration';
+
+$FG_LIMITE_DISPLAY = 25;
+$FG_NB_TABLE_COL = count ( $FG_TABLE_COL );
+$FG_EDITION = true;
+$FG_TOTAL_TABLE_COL = $FG_NB_TABLE_COL;
+if ($FG_DELETION || $FG_EDITION)
+	$FG_TOTAL_TABLE_COL ++;
+
+$FG_HTML_TABLE_TITLE = gettext ( " - Call Logs - " );
+$FG_HTML_TABLE_WIDTH = '98%';
+
+
+$instance_table = new Table ( $FG_TABLE_NAME, $FG_COL_QUERY );
+
+if (is_null ( $order ) || is_null ( $sens )) {
+	$order = $FG_TABLE_DEFAULT_ORDER;
+	$sens = $FG_TABLE_DEFAULT_SENS;
+}
+
+if ($posted == 1) {
+	$SQLcmd = '';
+	$SQLcmd = do_field ( $SQLcmd, 'src', 'src' );
+	$SQLcmd = do_field ( $SQLcmd, 'dst', 'calledstation' );
+	$SQLcmd = do_field ( $SQLcmd, 'dnid', 'dnid' );
+}
+
+$date_clause = '';
+
+normalize_day_of_month($fromstatsday_sday, $fromstatsmonth_sday, 1);
+normalize_day_of_month($tostatsday_sday, $tostatsmonth_sday, 1);
+// Date Clause
+if ($fromday && isset ( $fromstatsday_sday ) && isset ( $fromstatsmonth_sday )) {
+	if ($fromtime) {
+		$date_clause .= " AND t1.starttime >= ('$fromstatsmonth_sday-$fromstatsday_sday $fromstatsday_hour:$fromstatsday_min')";
+	} else {
+		$date_clause .= " AND t1.starttime >= ('$fromstatsmonth_sday-$fromstatsday_sday')";
+	}
+}
+if ($today && isset ( $tostatsday_sday ) && isset ( $tostatsmonth_sday )) {
+	if ($totime) {
+		$date_clause .= " AND t1.starttime <= ('$tostatsmonth_sday-" . sprintf ( "%02d", intval ( $tostatsday_sday )/*+1*/) . " $tostatsday_hour:$tostatsday_min:59')";
+	} else {
+		$date_clause .= " AND t1.starttime <= ('$tostatsmonth_sday-" . sprintf ( "%02d", intval ( $tostatsday_sday )/*+1*/) . " 23:59:59')";
+	}
+}
+
+
+if (strpos ( $SQLcmd, 'WHERE' ) > 0) {
+	$FG_TABLE_CLAUSE = substr ( $SQLcmd, 6 ) . $date_clause;
+} elseif (strpos ( $date_clause, 'AND' ) > 0) {
+	$FG_TABLE_CLAUSE = substr ( $date_clause, 5 );
+}
+
+if (! isset ( $FG_TABLE_CLAUSE ) || strlen ( $FG_TABLE_CLAUSE ) == 0) {
+	$cc_yearmonth = sprintf ( "%04d-%02d-%02d", date ( "Y" ), date ( "n" ), date ( "d" ) );
+	$FG_TABLE_CLAUSE = " t1.starttime >= ('$cc_yearmonth')";
+}
+
+if (isset ( $customer ) && ($customer > 0)) {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= "t1.card_id='$customer'";
+} else {
+	if (isset ( $entercustomer ) && ($entercustomer > 0)) {
+		if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+			$FG_TABLE_CLAUSE .= " AND ";
+		$FG_TABLE_CLAUSE .= "t1.card_id='$entercustomer'";
+	}elseif(isset ( $entercustomer_num ) && ($entercustomer_num > 0)) {
+		$res = $DBHandle -> Execute ("select id from cc_card where username=".$entercustomer_num);
+		if ($res){
+			if($res->RecordCount ()){
+				$row =$res -> fetchRow();
+				if (strlen ( $FG_TABLE_CLAUSE ) > 0)	$FG_TABLE_CLAUSE .= " AND ";
+				$FG_TABLE_CLAUSE .= "t1.card_id='$row[0]'";
+			}
+		}
+	}
+}
+
+if (isset ( $enterprovider ) && $enterprovider > 0) {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= "t3.id_provider = '$enterprovider'";
+}
+if (isset ( $entertrunk ) && $entertrunk > 0) {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= "t3.id_trunk = '$entertrunk'";
+}
+if (isset ( $entertariffgroup ) && $entertariffgroup > 0) {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= "t1.id_tariffgroup = '$entertariffgroup'";
+}
+if (isset ( $enterratecard ) && $enterratecard > 0) {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= "t1.id_ratecard = '$enterratecard'";
+}
+
+
+
+
+if (isset ( $choose_calltype ) && ($choose_calltype != - 1)) {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " t1.sipiax='$choose_calltype' ";
+}
+
+$FG_ASR_CIC_CLAUSE = $FG_TABLE_CLAUSE;
+
+//To select just terminatecauseid=ANSWER
+if (! isset ( $terminatecauseid )) {
+	$terminatecauseid = "ANSWER";
+}
+if ($terminatecauseid == "ANSWER") {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=1) ";
+}
+if ($terminatecauseid == "INCOMPLET") {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid !=1) ";
+}
+if ($terminatecauseid == "CONGESTION") {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=5) ";
+}
+if ($terminatecauseid == "NOANSWER") {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=3) ";
+}
+if ($terminatecauseid == "BUSY") {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=2) ";
+}
+if ($terminatecauseid == "CHANUNAVAIL") {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=6) ";
+}
+if ($terminatecauseid == "CANCEL") {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=4) ";
+}
+
+if (! $nodisplay) {
+	$list = $instance_table->Get_list ( $DBHandle, $FG_TABLE_CLAUSE, $order, $sens, null, null, $FG_LIMITE_DISPLAY, $current_page * $FG_LIMITE_DISPLAY );
+}
+
+// EXPORT
+$FG_EXPORT_SESSION_VAR = "pr_export_entity_call";
+
+// Query Preparation for the Export Functionality
+$_SESSION [$FG_EXPORT_SESSION_VAR] = "SELECT $FG_COL_QUERY FROM $FG_TABLE_NAME WHERE $FG_TABLE_CLAUSE";
+
+if (! is_null ( $order ) && ($order != '') && ! is_null ( $sens ) && ($sens != '')) {
+	$_SESSION [$FG_EXPORT_SESSION_VAR] .= " ORDER BY $order $sense";
+}
+
+/************************/
+$QUERY = "SELECT DATE(t1.starttime) AS day, sum(t1.sessiontime) AS calltime, sum(t1.sessionbill) AS cost, count(*) as nbcall,
+           sum(t1.buycost) AS buy, sum(case when t1.sessiontime>0 then 1 else 0 end) as success_calls
+        	FROM $FG_TABLE_NAME WHERE $FG_TABLE_CLAUSE GROUP BY day ORDER BY day"; //extract(DAY from calldate)
+
+if (! $nodisplay) {
+	$res = $DBHandle->Execute ( $QUERY );
+	if ($res) {
+		$num = $res->RecordCount ();
+		for($i = 0; $i < $num; $i ++) {
+			$list_total_day [] = $res->fetchRow ();
+		}
+	}
+	
+	if ($FG_DEBUG == 3)
+		echo "<br>Clause : $FG_TABLE_CLAUSE";
+	
+	$nb_record = $instance_table->Table_count ( $DBHandle, $FG_TABLE_CLAUSE );
+	if ($FG_DEBUG >= 1)
+		var_dump ( $list );
+
+}
+
+
+if ($nb_record <= $FG_LIMITE_DISPLAY) {
+	$nb_record_max = 1;
+} else {
+	if ($nb_record % $FG_LIMITE_DISPLAY == 0) {
+		$nb_record_max = (intval ( $nb_record / $FG_LIMITE_DISPLAY ));
+	} else {
+		$nb_record_max = (intval ( $nb_record / $FG_LIMITE_DISPLAY ) + 1);
+	}
+}
+
+if ($FG_DEBUG == 3)
+	echo "<br>Nb_record : $nb_record";
+if ($FG_DEBUG == 3)
+	echo "<br>Nb_record_max : $nb_record_max";
+
+$smarty->display ( 'main.tpl' );
+
+?>
+
+
+<!-- ** ** ** ** ** Part for the research ** ** ** ** ** -->
+<center>
+<FORM METHOD=POST name="myForm"
+	ACTION="<?php
+	echo $PHP_SELF?>?s=1&t=0&order=<?php
+	echo $order?>&sens=<?php
+	echo $sens?>&current_page=<?php
+	echo $current_page?>">
+<INPUT TYPE="hidden" NAME="posted" value=1> <INPUT TYPE="hidden"
+	NAME="current_page" value=0>
+<TABLE class="bar-status" width="85%" border="0" cellspacing="1"
+	cellpadding="2" align="center">
+		<?php
+		if ($_SESSION ["pr_groupID"] == 2 && is_numeric ( $_SESSION ["pr_IDCust"] )) {
+			?>
+		<?php
+		} else {
+			?>
+		<tr>
+		<td align="left" valign="top" class="bgcolor_004"><font
+			class="fontstyle_003">&nbsp;&nbsp;<?php
+			echo gettext ( "CUSTOMERS" );
+			?></font>
+		</td>
+		<td class="bgcolor_005" align="left">
+		<table width="100%" border="0" cellspacing="0" cellpadding="0">
+			<tr>
+				<td class="fontstyle_searchoptions" width="700" valign="top">
+					<?php
+			echo gettext ( "Enter the customer ID" );
+			?>: <INPUT TYPE="text"
+					NAME="entercustomer" value="<?php echo $entercustomer?>"
+					class="form_input_text"> <a href="#"
+					onclick="window.open('A2B_entity_card.php?popup_select=1&popup_formname=myForm&popup_fieldname=entercustomer' , 'CardNumberSelection','scrollbars=1,width=550,height=330,top=20,left=100,scrollbars=1');"><img
+					src="<?php echo Images_Path; ?>/icon_arrow_orange.gif"></a>
+				 <BR> OR <br>
+				<?php echo gettext ( "Enter the customer number" );?>: <INPUT TYPE="text" NAME="entercustomer_num" 
+					value="<?php echo $entercustomer_num?>" class="form_input_text"> <a href="#"
+                                        onclick="window.open('A2B_entity_card.php?popup_select=2&popup_formname=myForm&popup_fieldname=entercustomer_num' , 'CardNumberSelection','scrollbars=1,width=550,height=330,top=20,left=100,scrollbars=1');"><img
+                                        src="<?php echo Images_Path; ?>/icon_arrow_orange.gif"></a>
+				</td>
+				<td width="50%">
+				<table width="100%" border="0" cellspacing="0" cellpadding="0">
+					<tr>
+						<td align="left" class="fontstyle_searchoptions"><?php echo gettext ( "CallPlan" ); ?> :</td>
+						<td align="left" class="fontstyle_searchoptions"><INPUT TYPE="text" NAME="entertariffgroup" value="<?php echo $entertariffgroup?>" size="4" class="form_input_text">&nbsp;<a href="#" onclick="window.open('A2B_entity_tariffgroup.php?popup_select=2&popup_formname=myForm&popup_fieldname=entertariffgroup' , 'CallPlanSelection','scrollbars=1,width=550,height=330,top=20,left=100');"><img
+							src="<?php echo Images_Path; ?>/icon_arrow_orange.gif"></a></td>
+						<td align="left" class="fontstyle_searchoptions"><?php echo gettext ( "Provider" ); ?> :
+			
+			<td align="left" class="fontstyle_searchoptions"><INPUT
+							TYPE="text" NAME="enterprovider"
+							value="<?php echo $enterprovider?>" size="4" class="form_input_text">&nbsp;<a href="#"
+							onclick="window.open('A2B_entity_provider.php?popup_select=2&popup_formname=myForm&popup_fieldname=enterprovider' , 'ProviderSelection','scrollbars=1,width=550,height=330,top=20,left=100');"><img
+							src="<?php echo Images_Path; ?>/icon_arrow_orange.gif"></a></td>
+					</tr>
+					<tr>
+						<td align="left" class="fontstyle_searchoptions"><?php echo gettext ( "Trunk" ); ?> :</td>
+						<td align="left" class="fontstyle_searchoptions"><INPUT
+							TYPE="text" NAME="entertrunk" value="<?php
+			echo $entertrunk?>"
+							size="4" class="form_input_text">&nbsp;<a href="#"
+							onclick="window.open('A2B_entity_trunk.php?popup_select=2&popup_formname=myForm&popup_fieldname=entertrunk' , 'TrunkSelection','scrollbars=1,width=550,height=330,top=20,left=100');"><img
+							src="<?php
+			echo Images_Path;
+			?>/icon_arrow_orange.gif"></a></td>
+						<td align="left" class="fontstyle_searchoptions"><?php
+			echo gettext ( "Rate" );
+			?> :</td>
+						<td align="left" class="fontstyle_searchoptions"><INPUT
+							TYPE="text" NAME="enterratecard"
+							value="<?php
+			echo $enterratecard?>" size="4"
+							class="form_input_text">&nbsp;<a href="#"
+							onclick="window.open('A2B_entity_def_ratecard.php?popup_select=2&popup_formname=myForm&popup_fieldname=enterratecard' , 'RatecardSelection','scrollbars=1,width=550,height=330,top=20,left=100');"><img
+							src="<?php
+			echo Images_Path;
+			?>/icon_arrow_orange.gif"></a></td>
+					</tr>
+				</table>
+				</td>
+			</tr>
+
+		</table>
+		</td>
+	</tr>			
+		<?php
+		}
+		?>
+	<tr>
+		<td align="left" class="bgcolor_004"><font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext ( "DATE" ); ?></font>
+		</td>
+		<td align="left" class="bgcolor_005">
+		<table width="100%" border="0" cellspacing="0" cellpadding="0">
+			<tr>
+				<td class="fontstyle_searchoptions"><input type="checkbox"
+					name="fromday" value="true" <?php
+					if ($fromday) {
+						?> checked
+					<?php
+					}
+					?>> <?php
+					echo gettext ( "From" );
+					?> :
+				<select name="fromstatsday_sday" class="form_input_select">
+					<?php
+					for($i = 1; $i <= 31; $i ++) {
+						if ($fromstatsday_sday == sprintf ( "%02d", $i ))
+							$selected = "selected";
+						else
+							$selected = "";
+						echo '<option value="' . sprintf ( "%02d", $i ) . "\"$selected>" . sprintf ( "%02d", $i ) . '</option>';
+					}
+					?>	
+				</select> <select name="fromstatsmonth_sday"
+					class="form_input_select">
+				<?php
+				$year_actual = date ( "Y" );
+				$monthname = array (gettext ( "January" ), gettext ( "February" ), gettext ( "March" ), gettext ( "April" ), gettext ( "May" ), gettext ( "June" ), gettext ( "July" ), gettext ( "August" ), gettext ( "September" ), gettext ( "October" ), gettext ( "November" ), gettext ( "December" ) );
+				
+				for($i = $year_actual; $i >= $year_actual - 1; $i --) {
+					if ($year_actual == $i) {
+						$monthnumber = date ( "n" ) - 1; // Month number without lead 0.
+					} else {
+						$monthnumber = 11;
+					}
+					for($j = $monthnumber; $j >= 0; $j --) {
+						$month_formated = sprintf ( "%02d", $j + 1 );
+						if ($fromstatsmonth_sday == "$i-$month_formated")
+							$selected = "selected";
+						else
+							$selected = "";
+						echo "<OPTION value=\"$i-$month_formated\" $selected> $monthname[$j]-$i </option>";
+					}
+				}
+				?>
+				</select> <br />
+				<input type="checkbox" name="fromtime" value="true"
+					<?php
+					if ($fromtime) {
+						?> checked <?php
+					}
+					?>> 
+				<?php
+				echo gettext ( "Time :" )?>
+				<select name="fromstatsday_hour" class="form_input_select">
+				<?php
+				for($i = 0; $i <= 23; $i ++) {
+					if ($fromstatsday_hour == sprintf ( "%02d", $i )) {
+						$selected = "selected";
+					} else {
+						$selected = "";
+					}
+					echo '<option value="' . sprintf ( "%02d", $i ) . "\"$selected>" . sprintf ( "%02d", $i ) . '</option>';
+				}
+				?>						
+				</select> : <select name="fromstatsday_min"
+					class="form_input_select">
+				<?php
+				for($i = 0; $i < 60; $i = $i + 5) {
+					if ($fromstatsday_min == sprintf ( "%02d", $i )) {
+						$selected = "selected";
+					} else {
+						$selected = "";
+					}
+					echo '<option value="' . sprintf ( "%02d", $i ) . "\"$selected>" . sprintf ( "%02d", $i ) . '</option>';
+				}
+				?>						
+				</select></td>
+				<td class="fontstyle_searchoptions"><input type="checkbox"
+					name="today" value="true" <?php
+					if ($today) {
+						?> checked <?php
+					}
+					?>> 
+				<?php
+				echo gettext ( "To" );
+				?>  :
+				<select name="tostatsday_sday" class="form_input_select">
+				<?php
+				for($i = 1; $i <= 31; $i ++) {
+					if ($tostatsday_sday == sprintf ( "%02d", $i )) {
+						$selected = "selected";
+					} else {
+						$selected = "";
+					}
+					echo '<option value="' . sprintf ( "%02d", $i ) . "\"$selected>" . sprintf ( "%02d", $i ) . '</option>';
+				}
+				?>						
+				</select> <select name="tostatsmonth_sday" class="form_input_select">
+				<?php
+				$year_actual = date ( "Y" );
+				for($i = $year_actual; $i >= $year_actual - 1; $i --) {
+					if ($year_actual == $i) {
+						$monthnumber = date ( "n" ) - 1; // Month number without lead 0.
+					} else {
+						$monthnumber = 11;
+					}
+					for($j = $monthnumber; $j >= 0; $j --) {
+						$month_formated = sprintf ( "%02d", $j + 1 );
+						if ($tostatsmonth_sday == "$i-$month_formated")
+							$selected = "selected";
+						else
+							$selected = "";
+						echo "<OPTION value=\"$i-$month_formated\" $selected> $monthname[$j]-$i </option>";
+					}
+				}
+				?>
+				</select> <br />
+				<input type="checkbox" name="totime" value="true"
+					<?php
+					if ($totime) {
+						?> checked <?php
+					}
+					?>> 
+				<?php
+				echo gettext ( "Time :" )?>
+				<select name="tostatsday_hour" class="form_input_select">
+				<?php
+				for($i = 0; $i <= 23; $i ++) {
+					if ($tostatsday_hour == sprintf ( "%02d", $i )) {
+						$selected = "selected";
+					} else {
+						$selected = "";
+					}
+					echo '<option value="' . sprintf ( "%02d", $i ) . "\"$selected>" . sprintf ( "%02d", $i ) . '</option>';
+				}
+				?>						
+				</select> : <select name="tostatsday_min" class="form_input_select">
+				<?php
+				for($i = 0; $i < 60; $i = $i + 5) {
+					if ($tostatsday_min == sprintf ( "%02d", $i )) {
+						$selected = "selected";
+					} else {
+						$selected = "";
+					}
+					echo '<option value="' . sprintf ( "%02d", $i ) . "\"$selected>" . sprintf ( "%02d", $i ) . '</option>';
+				}
+				?>						
+				</select></td>
+			</tr>
+		</table>
+		</td>
+	</tr>
+	<tr>
+		<td class="bgcolor_002" align="left"><font class="fontstyle_003">&nbsp;&nbsp;<?php
+		echo gettext ( "PHONENUMBER" );
+		?></font>
+		</td>
+		<td class="bgcolor_003" align="left">
+		<table width="100%" border="0" cellspacing="0" cellpadding="0">
+			<tr>
+				<td>&nbsp;&nbsp;<INPUT TYPE="text" NAME="dst"
+					value="<?php
+					echo $dst?>" class="form_input_text"></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dsttype" value="1"
+					<?php
+					if ((! isset ( $dsttype )) || ($dsttype == 1)) {
+						?> checked <?php
+					}
+					?>><?php
+					echo gettext ( "Exact" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dsttype" value="2" <?php
+					if ($dsttype == 2) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Begins with" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dsttype" value="3" <?php
+					if ($dsttype == 3) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Contains" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dsttype" value="4" <?php
+					if ($dsttype == 4) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Ends with" );
+					?></td>
+			</tr>
+		</table>
+		</td>
+	</tr>
+	<tr>
+		<td align="left" class="bgcolor_004"><font class="fontstyle_003">&nbsp;&nbsp;<?php
+		echo gettext ( "CALLERID" );
+		?></font>
+		</td>
+		<td class="bgcolor_005" align="left">
+		<table width="100%" border="0" cellspacing="0" cellpadding="0">
+			<tr>
+				<td>&nbsp;&nbsp;<INPUT TYPE="text" NAME="src"
+					value="<?php
+					echo "$src";
+					?>" class="form_input_text"></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="srctype" value="1"
+					<?php
+					if ((! isset ( $srctype )) || ($srctype == 1)) {
+						?> checked <?php
+					}
+					?>><?php
+					echo gettext ( "Exact" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="srctype" value="2" <?php
+					if ($srctype == 2) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Begins with" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="srctype" value="3" <?php
+					if ($srctype == 3) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Contains" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="srctype" value="4" <?php
+					if ($srctype == 4) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Ends with" );
+					?></td>
+			</tr>
+		</table>
+		</td>
+	</tr>
+
+	<tr>
+		<td align="left" class="bgcolor_004"><font class="fontstyle_003">&nbsp;&nbsp;<?php
+		echo gettext ( "DNID" );
+		?></font>
+		</td>
+		<td class="bgcolor_005" align="left">
+		<table width="100%" border="0" cellspacing="0" cellpadding="0">
+			<tr>
+				<td>&nbsp;&nbsp;<INPUT TYPE="text" NAME="dnid"
+					value="<?php
+					echo "$dnid";
+					?>" class="form_input_text"></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dnidtype" value="1"
+					<?php
+					if ((! isset ( $dnidtype )) || ($dnidtype == 1)) {
+						?> checked <?php
+					}
+					?>><?php
+					echo gettext ( "Exact" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dnidtype" value="2" <?php
+					if ($dnidtype == 2) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Begins with" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dnidtype" value="3" <?php
+					if ($dnidtype == 3) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Contains" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dnidtype" value="4" <?php
+					if ($dnidtype == 4) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Ends with" );
+					?></td>
+			</tr>
+		</table>
+		</td>
+	</tr>
+
+	<!-- Select Calltype: -->
+	<tr>
+		<td class="bgcolor_002" align="left"><font class="fontstyle_003">&nbsp;&nbsp;<?php
+		echo gettext ( "CALL TYPE" );
+		?></font></td>
+		<td class="bgcolor_003" align="center">
+		<table width="100%" border="0" cellspacing="0" cellpadding="0">
+			<tr>
+				<td class="fontstyle_searchoptions"><select NAME="choose_calltype"
+					size="1" class="form_input_select">
+					<option value='-1'
+						<?php
+						if (($choose_calltype == - 1) || (! isset ( $choose_calltype ))) {
+							?>
+						selected <?php
+						}
+						?>><?php
+						echo gettext ( 'ALL CALLS' )?>
+								</option>
+							<?php
+							foreach ( $list_calltype as $key => $cur_value ) {
+								?>
+								<option value='<?php
+								echo $cur_value [1]?>'
+						<?php
+								if ($choose_calltype == $cur_value [1]) {
+									?> selected <?php
+								}
+								?>><?php
+								echo gettext ( $cur_value [0] )?>
+								</option>
+							<?php
+							}
+							?>
+						</select></td>
+			</tr>
+		</table>
+		</td>
+	</tr>
+
+	<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
+	<tr>
+		<td class="bgcolor_002" align="left"><font class="fontstyle_003">&nbsp;&nbsp;<?php
+		echo gettext ( "OPTIONS" );
+		?></font></td>
+		<td class="bgcolor_003" align="center">
+		<div align="left">
+
+		<table width="100%" border="0" cellspacing="0" cellpadding="0">
+			<tr>
+				<td width="20%" class="fontstyle_searchoptions">
+					<?php
+					echo gettext ( "SHOW CALLS" );
+					?> :  						
+			   </td>
+				<td width="80%" class="fontstyle_searchoptions"><select
+					NAME="terminatecauseid" size="1" class="form_input_select">
+					<option value='ANSWER'
+						<?php
+						if ((! isset ( $terminatecauseid )) || ($terminatecauseid == "ANSWER")) {
+							?>
+						selected <?php
+						}
+						?>><?php
+						echo gettext ( 'ANSWERED' )?>
+							</option>
+
+					<option value='ALL' <?php
+					if ($terminatecauseid == "ALL") {
+						?> selected
+						<?php
+					}
+					?>><?php
+						echo gettext ( 'ALL' )?>
+							</option>
+
+					<option value='INCOMPLET'
+						<?php
+						if ($terminatecauseid == "INCOMPLET") {
+							?> selected <?php
+						}
+						?>><?php
+						echo gettext ( 'NOT COMPLETED' )?>
+							</option>
+
+					<option value='CONGESTION'
+						<?php
+						if ($terminatecauseid == "CONGESTION") {
+							?> selected <?php
+						}
+						?>><?php
+						echo gettext ( 'CONGESTIONED' )?>
+							</option>
+
+					<option value='BUSY' <?php
+					if ($terminatecauseid == "BUSY") {
+						?>
+						selected <?php
+					}
+					?>><?php
+						echo gettext ( 'BUSIED' )?>
+							</option>
+
+					<option value='NOANSWER'
+						<?php
+						if ($terminatecauseid == "NOANSWER") {
+							?> selected <?php
+						}
+						?>><?php
+						echo gettext ( 'NOT ANSWERED' )?>
+							</option>
+
+					<option value='CHANUNAVAIL'
+						<?php
+						if ($terminatecauseid == "CHANUNAVAIL") {
+							?> selected <?php
+						}
+						?>><?php
+						echo gettext ( 'CHANNEL UNAVAILABLE' )?>
+							</option>
+
+					<option value='CANCEL' <?php
+					if ($terminatecauseid == "CANCEL") {
+						?>
+						selected <?php
+					}
+					?>><?php
+						echo gettext ( 'CANCELED' )?>
+							</option>
+
+				</select></td>
+			</tr>
+			<tr class="bgcolor_005">
+				<td class="fontstyle_searchoptions">
+					<?php
+					echo gettext ( "RESULT" );
+					?> : 
+			   </td>
+				<td class="fontstyle_searchoptions">
+					<?php
+					echo gettext ( "mins" );
+					?><input type="radio" NAME="resulttype"
+					value="min"
+					<?php
+					if ((! isset ( $resulttype )) || ($resulttype == "min")) {
+						?> checked
+					<?php
+					}
+					?>> - <?php
+					echo gettext ( "secs" )?> <input type="radio"
+					NAME="resulttype" value="sec" <?php
+					if ($resulttype == "sec") {
+						?>
+					checked <?php
+					}
+					?>></td>
+			</tr>
+			<tr>
+				<td class="fontstyle_searchoptions">
+					<?php
+					echo gettext ( "CURRENCY" );
+					?> :
+				</td>
+				<td class="fontstyle_searchoptions"><select NAME="choose_currency"
+					size="1" class="form_input_select">
+						<?php
+						$currencies_list = get_currencies ();
+						foreach ( $currencies_list as $key => $cur_value ) {
+							?>
+							<option value='<?php
+							echo $key?>'
+						<?php
+							if (($choose_currency == $key) || (! isset ( $choose_currency ) && $key == strtoupper ( BASE_CURRENCY ))) {
+								?>
+						selected <?php
+							}
+							?>><?php
+							echo $cur_value [1] . ' (' . $cur_value [2] . ')'?>
+							</option>
+						<?php
+						}
+						?>
+					</select></td>
+			</tr>
+		</table>
+		
+		</td>
+	</tr>
+	<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
+
+	<tr>
+		<td class="bgcolor_004" align="left"></td>
+		<td class="bgcolor_005" align="center"><input type="image"
+			name="image16" align="top" border="0"
+			src="<?php
+			echo Images_Path;
+			?>/button-search.gif" /></td>
+	</tr>
+</table>
+</FORM>
+</center>
+
+
+<!-- ** ** ** ** ** Part to display the CDR ** ** ** ** ** -->
+
+<center><?php
+echo gettext ( "Number of call" );
+?> : <?php
+if (is_array ( $list ) && count ( $list ) > 0) {
+	echo $nb_record;
+} else {
+	echo "0";
+}
+?></center>
+
+<table width="<?php echo $FG_HTML_TABLE_WIDTH?>" border="0" align="center" cellpadding="0" cellspacing="0">
+	<TR bgcolor="#ffffff">
+		<TD class="bgcolor_021" height=16 style="PADDING-LEFT: 5px; PADDING-RIGHT: 3px">
+		<TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+			<TR>
+				<TD><SPAN class="fontstyle_003"><?php echo $FG_HTML_TABLE_TITLE?></SPAN></TD>
+			</TR>
+		</TABLE>
+		</TD>
+	</TR>
+	<TR>
+		<TD>
+		<TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+			<TR class="bgcolor_008">
+				<TD width="<?php echo $FG_ACTION_SIZE_COLUMN?>" align=center class="tableBodyRight" style="PADDING-BOTTOM: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; PADDING-TOP: 2px"></TD>					
+				  
+                  <?php
+						if (is_array ( $list ) && count ( $list ) > 0) {
+							
+							for($i = 0; $i < $FG_NB_TABLE_COL; $i ++) {
+								?>
+					<TD width="<?php echo $FG_TABLE_COL [$i] [2]?>" align=middle class="tableBody" style="PADDING-BOTTOM: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; PADDING-TOP: 2px">
+						<center><strong> 
+						<?php if (strtoupper ( $FG_TABLE_COL [$i] [4] ) == "SORT") { ?>
+						<a href="<?php
+								echo $PHP_SELF . "?entercustomer_num=$entercustomer_num&s=1&t=0&stitle=$stitle&atmenu=$atmenu&current_page=$current_page&order=" . $FG_TABLE_COL [$i] [1] . "&sens=";
+								if ($sens == "ASC") {
+									echo "DESC";
+								} else {
+									echo "ASC";
+								}
+								echo "&entercustomer=$entercustomer&enterprovider=$enterprovider&entertrunk=$entertrunk&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&dsttype=$dsttype&srctype=$srctype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&dst=$dst&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype";
+									?>">
+<span class="liens"><?php
+								}
+								?>
+<?php echo $FG_TABLE_COL [$i] [0]?> 
+<?php if ($order == $FG_TABLE_COL [$i] [1] && $sens == "ASC") { ?>
+&nbsp;<img src="<?php echo Images_Path; ?>/icon_up_12x12.GIF" width="12"
+height="12" border="0"> 
+<?php
+ } elseif ($order == $FG_TABLE_COL [$i] [1] && $sens == "DESC") {
+?>
+&nbsp;<img src="<?php echo Images_Path; ?>/icon_down_12x12.GIF" width="12" height="12" border="0"> 
+<?php } ?>
+<?php if (strtoupper ( $FG_TABLE_COL [$i] [4] ) == "SORT") { ?>
+</span></a> 
+<?php } ?>
+</strong></center>
+</TD>
+   <?php } ?>		
+   <?php if ($FG_DELETION || $FG_EDITION) { ?>
+   <?php } ?>		
+</TR>
+<?php
+															
+$ligne_number = 0;
+//print_r($list);
+foreach ( $list as $recordset ) {
+	$ligne_number ++;
+	?>
+
+<TR bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$ligne_number % 2]?>" onMouseOver="bgColor='#C4FFD7'" onMouseOut="bgColor='<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$ligne_number % 2]?>'">
+<TD vAlign=top align="<?php echo $FG_TABLE_COL [$i] [3]?>" class=tableBody><?php echo $ligne_number + $current_page * $FG_LIMITE_DISPLAY . ".&nbsp;"; ?></TD>
+ 
+<?php for($i = 0; $i < $FG_NB_TABLE_COL; $i ++) { ?>
+
+	<?php if ($FG_TABLE_COL [$i] [6] == "lie") {
+										
+					$instance_sub_table = new Table ( $FG_TABLE_COL [$i] [7], $FG_TABLE_COL [$i] [8] );
+					$sub_clause = str_replace ( "%id", $recordset [$i], $FG_TABLE_COL [$i] [9] );
+					$select_list = $instance_sub_table->Get_list ( $DBHandle, $sub_clause, null, null, null, null, null, null, null, 10);
+					
+					$field_list_sun = preg_split('/,/', $FG_TABLE_COL [$i] [8] );
+					$record_display = $FG_TABLE_COL [$i] [10];
+					
+					if (is_array($select_list)) {
+						for($l = 1; $l <= count ( $field_list_sun ); $l ++) {
+							$record_display = str_replace ( "%$l", $select_list [0] [$l - 1], $record_display );
+						}
+					} else {
+						$record_display = $recordset [$i];
+					}
+				} elseif($FG_TABLE_COL[$i][6]=="lie_link") {
+					$instance_sub_table = new Table($FG_TABLE_COL[$i][7], $FG_TABLE_COL[$i][8]);
+					$sub_clause = str_replace ( "%id", $recordset [$i], $FG_TABLE_COL [$i] [9] );
+					$select_list = $instance_sub_table -> Get_list ($DBHandle, $sub_clause, null, null, null, null, null, null, null, 10);
+					if(is_array($select_list)){
+						$field_list_sun = preg_split('/,/',$FG_TABLE_COL[$i][8]);
+						$record_display = $FG_TABLE_COL[$i][10];
+						$link = $FG_TABLE_COL[$i][12]."?form_action=ask-edit&id=".$select_list[0][1];
+						for ($l=1;$l<=count($field_list_sun);$l++){
+							$val = str_replace("%$l", $select_list[0][$l-1], $record_display);
+							$record_display = "<a href='$link'>$val</a>";
+						}
+					}else{
+						$record_display="";
+					}
+				} elseif ($FG_TABLE_COL [$i] [6] == "list") {
+					$select_list = $FG_TABLE_COL [$i] [7];
+					$record_display = $select_list [$recordset [$i]] [0];
+				
+				} else {
+					$record_display = $recordset [$i];
+				}
+				
+				if (is_numeric ( $FG_TABLE_COL [$i] [5] ) && (strlen ( $record_display ) > $FG_TABLE_COL [$i] [5])) {
+					$record_display = substr ( $record_display, 0, $FG_TABLE_COL [$i] [5] - 3 ) . "";
+				
+				}
+				
+				?>
+		<TD vAlign=top align="<?php echo $FG_TABLE_COL [$i] [3]?>" class=tableBody><?php
+			if (isset ( $FG_TABLE_COL [$i] [11] ) && strlen ( $FG_TABLE_COL [$i] [11] ) > 1) {
+				call_user_func ( $FG_TABLE_COL [$i] [11], $record_display );
+			} elseif (strlen($record_display)>0) {
+				echo stripslashes ( $record_display );
+			} else {
+				echo '&nbsp;';
+			}
+		?></TD>
+	 <?php } ?>
+  
+	</TR>
+	<?php } //foreach ($list as $recordset)
+		if ($ligne_number < $FG_LIMITE_DISPLAY)
+			$ligne_number_end = $ligne_number + 2;
+		while ( $ligne_number < $ligne_number_end ) {
+			$ligne_number ++;
+			?>
+		<TR
+		bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$ligne_number % 2]?>"> 
+		<?php for($i = 0; $i < $FG_NB_TABLE_COL; $i ++) { ?>
+		 <TD vAlign=top class=tableBody>&nbsp;</TD>
+		 <?php } ?>
+		 <TD align="center" vAlign=top class=tableBodyRight>&nbsp;</TD>
+		</TR>
+		
+		<?php } //END_WHILE
+				
+				} else {
+					echo gettext ( "No data found !!!" );
+				} //end_if 
+		?>
+		</TABLE>
+		</td>
+	</tr>
+	<TR bgcolor="#ffffff">
+		<TD class="bgcolor_005" height="16" style="PADDING-LEFT: 5px; PADDING-RIGHT: 3px">
+			<TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+				<TR>
+					<TD align="right"><SPAN class="fontstyle_003">
+                    <?php if ($current_page > 0) { ?>
+					<img src="<?php echo Images_Path; ?>/fleche-g.gif"
+					width="5" height="10"> <a href="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php echo ($current_page - 1)?><?php
+									if (! is_null ( $letter ) && ($letter != "")) {
+										echo "&letter=$letter";
+									}
+									echo "&entercustomer_num=$entercustomer_num&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&dsttype=$dsttype&srctype=$srctype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&dst=$dst&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype&entercustomer=$entercustomer&enterprovider=$enterprovider&entertrunk=$entertrunk";
+									?>">
+					<?php echo gettext ( "Previous" ); ?> </a> - <?php } ?><?php echo ($current_page + 1); ?> / <?php echo $nb_record_max; ?>
+					<?php if ($current_page < $nb_record_max - 1) { ?>
+					- <a href="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php echo ($current_page + 1)?><?php
+									if (! is_null ( $letter ) && ($letter != "")) {
+										echo "&letter=$letter";
+									}
+									echo "&entercustomer_num=$entercustomer_num&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&dsttype=$dsttype&srctype=$srctype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&dst=$dst&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype&entercustomer=$entercustomer&enterprovider=$enterprovider&entertrunk=$entertrunk";
+									?>">
+					<?php echo gettext ( "Next" ); ?></a> <img src="<?php echo Images_Path; ?>/fleche-d.gif" width="5" height="10"> </SPAN> 
+					<?php } ?>
+                  </TD>
+		</TABLE>
+		</TD>
+	</TR>
+</table>
+
+
+<!-- ** ** ** ** ** Part to display the GRAPHIC ** ** ** ** ** -->
+<br>
+
+<?php
+if (is_array ( $list_total_day ) && count ( $list_total_day ) > 0) {
+	
+	$mmax = 0;
+	$totalcall == 0;
+	$totalminutes = 0;
+	$totalsuccess = 0;
+	$totalfail = 0;
+	foreach ( $list_total_day as $data ) {
+		if ($mmax < $data [1])
+			$mmax = $data [1];
+		$totalcall += $data [3];
+		$totalminutes += $data [1];
+		$totalcost += $data [2];
+		$totalbuycost += $data [4];
+		$totalsuccess += $data [5];
+	}
+	$max_fail = 0;	
+?>
+
+<?php 
+$profit = $totalcost - $totalbuycost;
+$rand_num = rand(1,4);
+
+// Show the donate button only 25% of the page display
+if ($profit > 500 && $rand_num==4 && SHOW_DONATION) {
+?>
+<center>
+<table align="center" width="50%" bgcolor="white" cellpadding="5" cellspacing="5" style="border: solid 1px">
+	<tr>
+		<td align="center"> 
+		
+			<center>
+				<b><font color="#A00000"><?php echo gettext("Thanks to A2Billing, you have made a profit of over 500 euro !");?></font></b><BR>
+					<?php echo gettext("Support A2Billing by clicking on the Donate button bellow :");?>  
+				
+				<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
+					<input type="hidden" name="cmd" value="_s-xclick">
+					<input type="hidden" name="lc" value="US">
+					<input type="hidden" name="country" value="USA">
+					<input type="hidden" name="hosted_button_id" value="3769548">
+					<input type="image" src="https://www.paypal.com/en_US/ES/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="Make Donation with PayPal">
+					<img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1">
+				</form>		
+			</center>		
+		</td>
+	</tr>
+</table>
+</center>
+<br>
+<?php } ?>
+
+<!-- END TITLE GLOBAL MINUTES //-->
+
+<table border="0" cellspacing="0" cellpadding="0" width="95%">
+	<tbody>
+		<tr>
+			<td bgcolor="#000000">
+			<table border="0" cellspacing="1" cellpadding="2" width="100%">
+				<tbody>
+					<tr>
+						<td align="center" class="bgcolor_019"></td>
+						<td class="bgcolor_020" align="center" colspan="10"><font
+							class="fontstyle_003"><?php echo gettext ( "TRAFFIC SUMMARY" ); ?></font></td>
+					</tr>
+					<tr class="bgcolor_019">
+						<td align="center" class="bgcolor_020"><font class="fontstyle_003"><?php echo gettext ( "DATE" ); ?></font></td>
+						<td align="center"><font class="fontstyle_003"><acronym
+							title="<?php echo gettext ( "DURATION" ); ?>"><?php	echo gettext ( "DUR" );	?></acronym></font></td>
+						<td align="center"><font class="fontstyle_003"><?php echo gettext ( "GRAPHIC" ); ?></font></td>
+						<td align="center"><font class="fontstyle_003"><?php echo gettext ( "CALLS" ); ?></font></td>
+						<td align="center"><font class="fontstyle_003"><acronym
+							title="<?php echo gettext ( "AVERAGE LENGTH OF CALL" );	?>"><?php echo gettext ( "ALOC" );	?></acronym></font></td>
+						<td align="center"><font class="fontstyle_003"><acronym
+							title="<?php echo gettext ( "ANSWER SEIZE RATIO" );	?>"><?php echo gettext ( "ASR" ); ?></acronym></font></td>
+						<td align="center"><font class="fontstyle_003"><?php echo gettext ( "SELL" );	?></font></td>
+						<td align="center"><font class="fontstyle_003"><?php echo gettext ( "BUY" );	?></font></td>
+						<td align="center"><font class="fontstyle_003"><?php echo gettext ( "PROFIT" );	?></font></td>
+						<td align="center"><font class="fontstyle_003"><?php echo gettext ( "MARGIN" );	?></font></td>
+						<td align="center"><font class="fontstyle_003"><?php echo gettext ( "MARKUP" );	?></font></td>
+
+						<!-- LOOP -->
+	<?php
+	$i = 0;
+	$j = 0;
+	foreach ( $list_total_day as $data ) {
+		$i = ($i + 1) % 2;
+		$tmc = $data [1] / $data [3];
+		
+		if ((! isset ( $resulttype )) || ($resulttype == "min")) {
+			$tmc = sprintf ( "%02d", intval ( $tmc / 60 ) ) . ":" . sprintf ( "%02d", intval ( $tmc % 60 ) );
+		} else {
+			
+			$tmc = intval ( $tmc );
+		}
+		
+		if ((! isset ( $resulttype )) || ($resulttype == "min")) {
+			$minutes = sprintf ( "%02d", intval ( $data [1] / 60 ) ) . ":" . sprintf ( "%02d", intval ( $data [1] % 60 ) );
+		} else {
+			$minutes = $data [1];
+		}
+		if ($mmax > 0)
+			$widthbar = intval ( ($data [1] / $mmax) * 150 );
+		?>
+		</tr>
+					<tr>
+						<td align="right" class="sidenav" nowrap="nowrap"><font
+							class="fontstyle_003"><?php
+		echo $data [0]?></font></td>
+						<td bgcolor="<?php
+		echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php
+		echo $minutes?> </font></td>
+						<td bgcolor="<?php
+		echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="left" nowrap="nowrap" width="<?php
+		echo $widthbar + 40?>">
+						<table cellspacing="0" cellpadding="0">
+							<tbody>
+								<tr>
+									<td bgcolor="#e22424"><img
+										src="<?php
+		echo Images_Path;
+		?>/spacer.gif"
+										width="<?php echo $widthbar?>" height="6"></td>
+								</tr>
+							</tbody>
+						</table>
+						</td>
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php echo $data [3]?></font></td>
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php echo $tmc?> </font></td>
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php display_2dec_percentage ( $data [5] * 100/ ($data [3]) )?> </font></td>
+						<!-- SELL -->
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php display_2bill ( $data [2] )?>
+						</font></td>
+						<!-- BUY -->
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php display_2bill ( $data [4] )?>
+						</font></td>
+						<!-- PROFIT -->
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php display_2bill ( $data [2] - $data [4] )?>
+						</font></td>
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php
+							if ($data [2] != 0) {
+								display_2dec_percentage ( (($data [2] - $data [4]) / $data [2]) * 100 );
+							} else {
+								echo "NULL";
+							}
+							?>
+						</font></td>
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php
+							if ($data [4] != 0) {
+								display_2dec_percentage ( (($data [2] - $data [4]) / $data [4]) * 100 );
+							} else {
+								echo "NULL";
+							}
+							?>
+						</font></td>
+			     <?php
+					$j ++;
+				}
+				
+				if ((! isset ( $resulttype )) || ($resulttype == "min")) {
+					$total_tmc = sprintf ( "%02d", intval ( ($totalminutes / $totalcall) / 60 ) ) . ":" . sprintf ( "%02d", intval ( ($totalminutes / $totalcall) % 60 ) );
+					$totalminutes = sprintf ( "%02d", intval ( $totalminutes / 60 ) ) . ":" . sprintf ( "%02d", intval ( $totalminutes % 60 ) );
+				} else {
+					$total_tmc = intval ( $totalminutes / $totalcall );
+				}
+				
+				?>                   	
+				</tr>
+					<!-- END DETAIL -->
+
+					<!-- END LOOP -->
+
+					<!-- TOTAL -->
+					<tr bgcolor="bgcolor_019">
+						<td align="right" nowrap="nowrap"><font class="fontstyle_003"><?php
+						echo gettext ( "TOTAL" );
+						?></font></td>
+						<td align="center" nowrap="nowrap" colspan="2"><font
+							class="fontstyle_003"><?php echo $totalminutes?> </font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php echo $totalcall?></font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php echo $total_tmc?></font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php display_2dec_percentage ( $totalsuccess*100 / $totalcall )?> </font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php display_2bill ( $totalcost )?></font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php display_2bill ( $totalbuycost )?></font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php display_2bill ( $totalcost - $totalbuycost )?></font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php
+							if ($totalcost != 0) {
+								display_2dec_percentage ( (($totalcost - $totalbuycost) / $totalcost) * 100 );
+							} else {
+								echo "NULL";
+							}
+							?></font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php
+							if ($totalbuycost != 0) {
+								display_2dec_percentage ( (($totalcost - $totalbuycost) / $totalbuycost) * 100 );
+							} else {
+								echo "NULL";
+							}
+							?></font></td>
+					</tr>
+					<!-- END TOTAL -->
+
+				</tbody>
+			</table>
+			<!-- END ARRAY GLOBAL //--></td>
+		</tr>
+	</tbody>
+</table>
+
+<br>
+<!-- SECTION EXPORT //--> &nbsp; &nbsp; 
+<a href="export_csv.php?var_export=<?php echo $FG_EXPORT_SESSION_VAR?>&var_export_type=type_csv" target="_blank"><img src="<?php echo Images_Path; ?>/excel.gif" border="0" height="30" /><?php echo gettext ( "Export CSV" ); ?></a> 
+- &nbsp; &nbsp;
+<a href="export_csv.php?var_export=<?php echo $FG_EXPORT_SESSION_VAR?>&var_export_type=type_xml" target="_blank"><img src="<?php echo Images_Path; ?>/icons_xml.gif" border="0" height="32" /><?php echo gettext ( "Export XML" ); ?></a>
+
+<?php } else { ?>
+<center>
+<h3><?php echo gettext ( "No calls in your selection");?>.</h3>
+<?php  } ?>
+</center>
+
+<?php
+
+$smarty->display('footer.tpl');
+
diff -urN -x lib a2billing_v1.9.4/admin/Public/templates/default/main.tpl a2billing/admin/Public/templates/default/main.tpl
--- a2billing_v1.9.4/admin/Public/templates/default/main.tpl	2011-05-31 16:39:39.000000000 -0300
+++ a2billing/admin/Public/templates/default/main.tpl	2012-09-11 20:21:20.000000000 -0300
@@ -1,605 +1,607 @@
-{include file="header.tpl"}
-
-
-{if ($popupwindow == 0)}
-	<div id="top_menu">
-		<ul id="menu_horizontal">
-			<li class="topmenu-left-button" style="border:none;">
-				<div style="width:100%;height:100%;text-align:center;" >
-					<a href="PP_intro.php"> 
-							<strong> {php} echo gettext("HOME");{/php}</strong>&nbsp;
-						<img style="vertical-align:bottom;" src="templates/{$SKIN_NAME}/images/house.png"> 
-					</a>
-				</div>
-			</li>
-			{if ($ACXDASHBOARD > 0) }
-			<li class="topmenu-left-button" >
-				<div style="width:100%;height:100%;text-align:center;" >
-					<a href="dashboard.php" > 
-						<strong> {php} echo gettext("DASHBOARD");{/php}</strong>&nbsp;
-						<img style="vertical-align:bottom;" src="templates/{$SKIN_NAME}/images/chart_bar.png"> 
-					</a>
-				</div>
-			</li>
-			{/if}
-			<li class="topmenu-left-button">
-				<div style="width:100%;height:100%;text-align:center;" >
-					 <a href="A2B_notification.php" > 
-						<strong > {php} echo gettext("NOTIFICATION");{/php}</strong>&nbsp;
-					<img style="vertical-align:bottom;" src="templates/{$SKIN_NAME}/images/email.png"> 
-					{if ($NEW_NOTIFICATION > 0) }
-						<strong style="font-size:8px; color:red;"> NEW</strong>
-					{else}
-						<strong style="font-size:8px;">&nbsp;</strong>
-					{/if}
-					  </a>
-				</div>
-			</li>
-			<li class="topmenu-right-button" style="border-right:none;">
-				<div style="width:90%;height:100%;text-align:center;" >
-					<a href="logout.php?logout=true" target="_top"><font color="#EC3F41"><b>&nbsp;&nbsp;{php} echo gettext("LOGOUT");{/php}</b></font>
-					<img style="vertical-align:bottom;" src="templates/{$SKIN_NAME}/images/logout.png"> </a>
-				</div>
-			</li>
-		</ul>
-
-	</div>
-	
-{/if}
-
-{if ($popupwindow == 0)}
-<div id="left-sidebar">
-<div id="leftmenu-top">
-<div id="leftmenu-down">
-<div id="leftmenu-middle">
-
-<ul id="nav">
-  
-  	{if ($ACXCUSTOMER > 0) }
-  	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img1"
-	{if ($section == "1")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("CUSTOMERS");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="1")}
-		style="">
-	{else}
-	style="display:none;">
-	{/if}
-	<ul>
-		<li><ul>
-				<li><a href="A2B_entity_card.php?section=1">{php} echo gettext("Add :: Search");{/php}</a></li>
-                <li><a href="CC_card_import.php?section=1">{php} echo gettext("Import");{/php}</a></li>
-				<li><a href="A2B_entity_friend.php?atmenu=sip&section=1">{php} echo gettext("VoIP Settings");{/php}</a></li>
-				<li><a href="A2B_entity_callerid.php?atmenu=callerid&section=1">{php} echo gettext("Caller-ID");{/php}</a></li>
-				<li><a href="A2B_notifications.php?section=1">{php} echo gettext("Credit Notification");{/php}</a></li>
-				<li><a href="A2B_entity_card_group.php?section=1">{php} echo gettext("Groups");{/php}</a></li>
-				<li><a href="A2B_entity_card_seria.php?section=1">{php} echo gettext("Card series");{/php}</a></li>
-				<li><a href="A2B_entity_speeddial.php?atmenu=speeddial&section=1">{php} echo gettext("Speed Dial");{/php}</a></li>
-				<li><a href="card-history.php?atmenu=cardhistory&section=1">{php} echo gettext("History");{/php}</a></li>
-				<li><a href="A2B_entity_statuslog.php?atmenu=statuslog&section=1">{php} echo gettext("Status");{/php}</a></li>
-		</ul></li>
-	</ul>
-	</div>
-	{/if}
-
-	{if ($ACXADMINISTRATOR  > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img2"
-	{if ($section == "2")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("AGENTS");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="2")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_agent.php?atmenu=user&section=2">{php} echo gettext("Add :: Search");{/php}</a></li>
-				<li><a href="A2B_entity_signup_agent.php?atmenu=user&section=2">{php} echo gettext("Signup URLs");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-
-
-	{if ($ACXADMINISTRATOR  > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img3"
-	{if ($section == "3")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("ADMINS");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="3")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_user.php?atmenu=user&groupID=0&section=3">{php} echo gettext("Add :: Search");{/php}</a></li>
-				<li><a href="A2B_entity_user.php?atmenu=user&groupID=1&section=3">{php} echo gettext("Access Control");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-
-	{if ($ACXSUPPORT > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img4"
-	{if ($section == "4")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("SUPPORT");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="4")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="CC_ticket.php?section=4">{php} echo gettext("Customer Tickets");{/php}</a></li>
-				<li><a href="A2B_ticket_agent.php?section=4">{php} echo gettext("Agent Tickets");{/php}</a></li>
-				<li><a href="CC_support_component.php?section=4">{php} echo gettext("Ticket Components");{/php}</a></li>
-				<li><a href="CC_support.php?section=4">{php} echo gettext("Support Boxes");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-
-	{if ($ACXCALLREPORT > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img5"
-	{if ($section == "5")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("CALL REPORTS");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="5")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-					<li><a href="call-log-customers.php?nodisplay=1&posted=1&section=5">{php} echo gettext("CDRs");{/php}</a></li>
-					<li><a href="call-count-reporting.php?nodisplay=1&posted=1&section=5">{php} echo gettext("Call Count");{/php}</a></li>
-					<li><a href="A2B_trunk_report.php?section=5">{php} echo gettext("Trunk");{/php}</a></li>
-					<li><a href="call-dnid.php?nodisplay=1&posted=1&section=5">{php} echo gettext("DNID");{/php}</a></li>
-					<li><a href="call-pnl-report.php?section=5">{php} echo gettext("PNL");{/php}</a></li>
-					<li><a href="call-comp.php?section=5">{php} echo gettext("Compare Calls");{/php}</a></li>
-					<li><a href="call-daily-load.php?section=5">{php} echo gettext("Daily Traffic");{/php}</a></li>
-					<li><a href="call-last-month.php?section=5">{php} echo gettext("Monthly Traffic");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-
-	{if ($ACXRATECARD > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img6"
-	{if ($section == "6")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("RATES");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="6")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_tariffgroup.php?atmenu=tariffgroup&section=6">{php} echo gettext("Call Plan");{/php}</a></li>
-				<li><a href="A2B_entity_tariffplan.php?atmenu=tariffplan&section=6">{php} echo gettext("RateCards");{/php}</a></li>
-				<li><a href="CC_ratecard_import.php?atmenu=ratecard&section=6"> {php} echo gettext("Import");{/php}</a></li>
-				<li><a href="CC_ratecard_merging.php?atmenu=ratecard&section=6"> {php} echo gettext("Merge");{/php}</a></li>
-				<li><a href="CC_entity_sim_ratecard.php?atmenu=ratecard&section=6"> {php} echo gettext("Simulator");{/php}</a></li>
-				<li><a href="A2B_entity_def_ratecard.php?atmenu=ratecard&section=6">{php} echo gettext("Rates");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-
-	{if ($ACXTRUNK > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img7"
-	{if ($section == "7")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("PROVIDERS");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="7")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_provider.php?section=7">{php} echo gettext("Providers");{/php}</a></li>
-				<li><a href="A2B_entity_trunk.php?section=7">{php} echo gettext("Trunks");{/php}</a></li>
-				<li><a href="A2B_entity_prefix.php?section=7">{php} echo gettext("Prefixes");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-
-	{if ($ACXDID > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img8"
-	{if ($section == "8")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("INBOUND DID");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="8")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_did.php?section=8">{php} echo gettext("Add :: Search");{/php}</a></li>
-				<li><a href="A2B_entity_didgroup.php?section=8">{php} echo gettext("Groups");{/php}</a>
-				<li><a href="A2B_entity_did_destination.php?section=8">{php} echo gettext("Destination");{/php}</a></li>
-				<li><a href="A2B_entity_did_import.php?section=8">{php} echo gettext("Import [CSV]");{/php}</a></li>
-				<li><a href="A2B_entity_didx.php?section=8">{php} echo gettext("Import [DIDX]");{/php}</a></li>
-				<li><a href="A2B_entity_did_use.php?atmenu=did_use&section=8">{php} echo gettext("Usage");{/php}</a></li>
-				<li><a href="A2B_entity_did_billing.php?atmenu=did_billing&section=8">{php} echo gettext("Billing");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-	
-
-	{if ($ACXOUTBOUNDCID > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img9"
-	{if ($section == "9")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("OUTBOUND CID");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="9")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_outbound_cid.php?atmenu=cid&section=9">{php} echo gettext("Add");{/php}</a></li>
-				<li><a href="A2B_entity_outbound_cidgroup.php?atmenu=cidgroup&section=9">{php} echo gettext("Groups");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-
-
-	
-	{if ($ACXBILLING > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img10"
-	{if ($section == "10")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("BILLING");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="10")}
-		style="">
-	{else}
-	style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_voucher.php?section=10">{php} echo gettext("Vouchers");{/php}</a></li>
-				<li><a href="A2B_entity_moneysituation.php?atmenu=moneysituation&section=10">{php} echo gettext("Customers Balance");{/php}</a></li>
-                <li><a href="A2B_entity_transactions.php?atmenu=payment&section=10"> {php} echo gettext("Transactions");{/php}</a></li>
-				<li><a href="A2B_entity_billing_customer.php?atmenu=payment&section=10"> {php} echo gettext("Billings");{/php}</a></li>
-				<li><a href="A2B_entity_logrefill.php?atmenu=payment&section=10"> {php} echo gettext("Refills");{/php}</a></li>
-				<li><a href="A2B_entity_payment.php?atmenu=payment&section=10"> {php} echo gettext("Payments");{/php}</a></li>
-				<li><a href="A2B_entity_paymentlog.php?section=10"> {php} echo gettext("E-Payment Log");{/php}</a></li>
-				<li><a href="A2B_entity_charge.php?section=10"> {php} echo gettext("Charges");{/php}</a></li>
-				<li><a href="A2B_entity_agentsituation.php?atmenu=agentsituation&section=10">{php} echo gettext("Agents Balance");{/php}</a></li>
-				<li><a href="A2B_entity_commission_agent.php?atmenu=payment&section=10"> {php} echo gettext("Commissions");{/php}</a></li>
-				<li><a href="A2B_entity_remittance_request.php?atmenu=payment&section=10"> {php} echo gettext("Remittance Request");{/php}</a></li>
-				<li><a href="A2B_entity_transactions_agent.php?atmenu=payment&section=10"> {php} echo gettext("Transactions");{/php}</a></li>
-				<li><a href="A2B_entity_logrefill_agent.php?atmenu=payment&section=10"> {php} echo gettext("Refills");{/php}</a></li>
-				<li><a href="A2B_entity_payment_agent.php?atmenu=payment&section=10"> {php} echo gettext("Payments");{/php}</a></li>
-				<li><a href="A2B_entity_paymentlog_agent.php?section=10"> {php} echo gettext("E-Payment Log");{/php}</a></li>
-				<li><a href="A2B_entity_payment_configuration.php?atmenu=payment&section=10">{php} echo gettext("Payment Methods");{/php}</a></li>
-				<li><a href="A2B_currencies.php?section=10">{php} echo gettext("Currency List");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-
-
-	{if ($ACXINVOICING > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img11"
-	{if ($section == "11")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("INVOICES");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="11")}
-		style="">
-	{else}
-	style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_receipt.php?atmenu=payment&section=11">{php} echo gettext("Receipts");{/php}</a></li>
-				<li><a href="A2B_entity_invoice.php?atmenu=payment&section=11">{php} echo gettext("Invoices");{/php}</a></li>
-				<li><a href="A2B_entity_invoice_conf.php?atmenu=payment&section=11"> {php} echo gettext("Configuration");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-
-	
-	{if ($ACXPACKAGEOFFER > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img12"
-	{if ($section == "12")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("PACKAGE OFFER");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="12")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_package.php?atmenu=package&section=12">{php} echo gettext("Add");{/php}</a></li>
-				<li><a href="A2B_detail_package.php?section=12">{php} echo gettext("Details");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-	
-
-	{if ($ACXCRONTSERVICE  > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img13"
-	{if ($section == "13")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("RECUR SERVICE");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="13")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_service.php?section=13">{php} echo gettext("Account Service");{/php}</a></li>
-				<li><a href="A2B_entity_subscription.php?section=13">{php} echo gettext("Subscriptions Service");{/php}</a></li>
-				<li><a href="A2B_entity_subscriber_signup.php?section=13">{php} echo gettext("Subscriptions SIGNUP");{/php}</a></li>
-				<li><a href="A2B_entity_subscriber.php?section=13">{php} echo gettext("Subscribers");{/php}</a></li>
-				<li><a href="A2B_entity_autorefill.php?section=13">{php} echo gettext("AutoRefill Report");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-	
-
-	{if ($ACXCALLBACK  > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img14"
-	{if ($section == "14")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("CALLBACK");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="14")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_callback.php?section=14">{php} echo gettext("Add");{/php}</a></li>
-				<li><a href="A2B_entity_server_group.php?section=14">{php} echo gettext("Server Group");{/php}</a></li>
-				<li><a href="A2B_entity_server.php?section=14">{php} echo gettext("Server");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-
-	{if ($ACXPREDICTIVEDIALER  > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img15"
-	{if ($section == "15")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("CAMPAIGNS");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="15")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_campaign.php?section=15">{php} echo gettext("Add");{/php}</a></li>
-				<li><a href="A2B_entity_campaign_config.php?section=15">{php} echo gettext("Config");{/php}</a></li>
-				<li><a href="A2B_entity_phonebook.php?section=15">{php} echo gettext("Phone Book");{/php}</a></li>
-				<li><a href="A2B_entity_phonenumber.php?section=15"> {php} echo gettext("Add Number");{/php}</a></li>
-				<li><a href="A2B_phonelist_import.php?section=15"> {php} echo gettext("Import");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-
-	
-	{if ($ACXMAINTENANCE  > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img16"
-	{if ($section == "16")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("MAINTENANCE");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="16")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_alarm.php?section=16"> {php} echo gettext("Alarms");{/php}</a></li>
-				<li><a href="A2B_entity_log_viewer.php?section=16">{php} echo gettext("Users Activity");{/php}</a></li>
-				<li><a href="A2B_entity_backup.php?form_action=ask-add&section=16">{php} echo gettext("Database Backup");{/php}</a></li>
-				<li><a href="A2B_entity_restore.php?section=16">{php} echo gettext("Database Restore");{/php}</a></li>
-				<li><a href="CC_musiconhold.php?section=16">{php} echo gettext("MusicOnHold");{/php}</a></li>
-				<li><a href="CC_upload.php?section=16">{php} echo gettext("Upload File");{/php}</a></li>
-				<li><a href="A2B_logfile.php?section=16">{php} echo gettext("Watch Log files");{/php}</a></li>
-				<li><a href="A2B_data_archiving.php?section=16">{php} echo gettext("Archiving");{/php}</a></li>
-				<li><a href="A2B_asteriskinfo.php?section=16">{php} echo "Asterisk Info";{/php}</a></li>
-				<li><a href="A2B_phpsysinfo.php?section=16">{php} echo "phpSysInfo";{/php}</a></li>
-				<li><a href="A2B_phpinfo.php?section=16">{php} echo "phpInfo";{/php}</a></li>
-				<li><a href="A2B_entity_monitor.php?section=16"> {php} echo gettext("Monitoring");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	
-	{/if}
-	
-	{if ($ACXMAIL  > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img17"
-	{if ($section == "17")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("MAIL");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="17")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_mailtemplate.php?atmenu=mailtemplate&section=17&languages=en">{php} echo gettext("Mail templates");{/php}</a></li>
-				<li><a href="A2B_mass_mail.php?section=17">{php} echo gettext("Mass Mail");{/php}</a></li>
-			</ul></li>
-		</ul>
-	</div>
-	{/if}
-
-	
-	{if ($ACXSETTING  > 0)}
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img18"
-	{if ($section == "18")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("SYSTEM SETTINGS");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="18")}
-		style="">
-	{else}
-		style="display:none;">
-	{/if}
-		<ul>
-			<li><ul>
-				<li><a href="A2B_entity_config.php?form_action=list&atmenu=config&section=18">{php} echo gettext("Global List");{/php}</a></li>
-				<li><a href="A2B_entity_config_group.php?form_action=list&atmenu=configgroup&section=18">{php} echo gettext("Group List");{/php}</a></li>
-				<li><a href="A2B_entity_config_generate_confirm.php?section=18">{php} echo gettext("Add agi-conf");{/php}</a></li>
-				<li><a href="phpconfig.php?dir=/etc/asterisk&section=18">{php} echo gettext("* Config Editor");{/php}</a></li>
-				{if ($ASTERISK_GUI_LINK)}
-					<li><a href="http://{$HTTP_HOST}:8088/asterisk/static/config/index.html" target="_blank">{php} echo gettext("Asterisk GUI");{/php}</a></li>
-				{/if}
-			</ul></li>
-		</ul>
-	</div>
-	
-	{/if}
-	
-</ul>
-	
-<br/>
-<ul id="nav"><li>
-	<ul><li><a href="A2B_entity_password.php?atmenu=password&form_action=ask-edit"><strong>{php} echo gettext("Change Password");{/php}</strong> <img style="vertical-align:bottom;" src="templates/{$SKIN_NAME}/images/key.png"> </a></li></ul>
-</li></ul>
-
-</div>
-</div>
-</div>
-
-
-
-<table width="100%" cellspacing="15">
-<tr>
-	<td>
-		<a href="PP_intro.php?ui_language=english" target="_parent"><img src="templates/{$SKIN_NAME}/images/flags/gb.gif" border="0" title="English" alt="English"></a>
-		<a href="PP_intro.php?ui_language=brazilian" target="_parent"><img src="templates/{$SKIN_NAME}/images/flags/br.gif" border="0" title="Brazilian" alt="Brazilian"></a>
-		<a href="PP_intro.php?ui_language=romanian" target="_parent"><img src="templates/{$SKIN_NAME}/images/flags/ro.gif" border="0" title="Romanian"alt="Romanian"></a>
-		<a href="PP_intro.php?ui_language=french" target="_parent"><img src="templates/{$SKIN_NAME}/images/flags/fr.gif" border="0" title="French" alt="French"></a>
-		<a href="PP_intro.php?ui_language=spanish" target="_parent"><img src="templates/{$SKIN_NAME}/images/flags/es.gif" border="0" title="Spanish" alt="Spanish"></a>
-		<a href="PP_intro.php?ui_language=greek" target="_parent"><img src="templates/{$SKIN_NAME}/images/flags/gr.gif" border="0" title="Greek" alt="Greek"></a>
-	</td>
-</tr>
-</table>
-
-<div id="osx-modal-content">
-	<div id="osx-modal-title">Dear A2Billing Administrator</div>
-	<div id="osx-modal-data">
-		<h2>Licence Violation!</h2>
-		<p>Thank you for using A2Billing. However, we have detected that you have edited the Authors names, Copyright or licensing information in the A2Billing Management Interface.</p>
-		<p>The <a href="http://www.fsf.org/licensing/licenses/agpl-3.0.html" target="_blank">AGPL 3</a> license under which you are allowed to use A2Billing requires that the original copyright and license must be displayed and kept intact. Without this information being displayed, you do not have a right to use the software.</p>
-		<p>However, if it is important to you that the Authors names, Copyright and License information is not displayed, possibly for publicity purposes; then we can offer you additional permissions to use and convey A2Billing, with these items removed, for a fee that will be used to help sponsor the continued development of A2Billing.</p>
-		<p>For more information, please go to <a target="_blank" href="http://www.star2billing.com/licensing">http://www.star2billing.com/licensing</a>.</p>
-		<p>Yours,<br/>
-		The A2Billing Team<br/>
-		Star2Billing S.L</p>
-		<p><button class="simplemodal-close">Close</button></p>
-	</div>
-</div>
-
-
-</div>
-
-<div id="main-content">
-<br/>
-{else}
-<div>
-{/if}
-
-{if ($LCMODAL  > 0)}
-<script type="text/javascript">
-    loadLicenceModal();
-</script>
-{/if}
- 
-{$MAIN_MSG}
-
+{include file="header.tpl"}
+
+
+{if ($popupwindow == 0)}
+	<div id="top_menu">
+		<ul id="menu_horizontal">
+			<li class="topmenu-left-button" style="border:none;">
+				<div style="width:100%;height:100%;text-align:center;" >
+					<a href="PP_intro.php"> 
+							<strong> {php} echo gettext("HOME");{/php}</strong>&nbsp;
+						<img style="vertical-align:bottom;" src="templates/{$SKIN_NAME}/images/house.png"> 
+					</a>
+				</div>
+			</li>
+			{if ($ACXDASHBOARD > 0) }
+			<li class="topmenu-left-button" >
+				<div style="width:100%;height:100%;text-align:center;" >
+					<a href="dashboard.php" > 
+						<strong> {php} echo gettext("DASHBOARD");{/php}</strong>&nbsp;
+						<img style="vertical-align:bottom;" src="templates/{$SKIN_NAME}/images/chart_bar.png"> 
+					</a>
+				</div>
+			</li>
+			{/if}
+			<li class="topmenu-left-button">
+				<div style="width:100%;height:100%;text-align:center;" >
+					 <a href="A2B_notification.php" > 
+						<strong > {php} echo gettext("NOTIFICATION");{/php}</strong>&nbsp;
+					<img style="vertical-align:bottom;" src="templates/{$SKIN_NAME}/images/email.png"> 
+					{if ($NEW_NOTIFICATION > 0) }
+						<strong style="font-size:8px; color:red;"> NEW</strong>
+					{else}
+						<strong style="font-size:8px;">&nbsp;</strong>
+					{/if}
+					  </a>
+				</div>
+			</li>
+			<li class="topmenu-right-button" style="border-right:none;">
+				<div style="width:90%;height:100%;text-align:center;" >
+					<a href="logout.php?logout=true" target="_top"><font color="#EC3F41"><b>&nbsp;&nbsp;{php} echo gettext("LOGOUT");{/php}</b></font>
+					<img style="vertical-align:bottom;" src="templates/{$SKIN_NAME}/images/logout.png"> </a>
+				</div>
+			</li>
+		</ul>
+
+	</div>
+	
+{/if}
+
+{if ($popupwindow == 0)}
+<div id="left-sidebar">
+<div id="leftmenu-top">
+<div id="leftmenu-down">
+<div id="leftmenu-middle">
+
+<ul id="nav">
+  
+  	{if ($ACXCUSTOMER > 0) }
+  	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img1"
+	{if ($section == "1")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("CUSTOMERS");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="1")}
+		style="">
+	{else}
+	style="display:none;">
+	{/if}
+	<ul>
+		<li><ul>
+				<li><a href="A2B_entity_card.php?section=1">{php} echo gettext("Add :: Search");{/php}</a></li>
+                <li><a href="CC_card_import.php?section=1">{php} echo gettext("Import");{/php}</a></li>
+				<li><a href="A2B_entity_friend.php?atmenu=sip&section=1">{php} echo gettext("VoIP Settings");{/php}</a></li>
+				<li><a href="A2B_entity_callerid.php?atmenu=callerid&section=1">{php} echo gettext("Caller-ID");{/php}</a></li>
+				<li><a href="A2B_notifications.php?section=1">{php} echo gettext("Credit Notification");{/php}</a></li>
+				<li><a href="A2B_entity_card_group.php?section=1">{php} echo gettext("Groups");{/php}</a></li>
+				<li><a href="A2B_entity_card_seria.php?section=1">{php} echo gettext("Card series");{/php}</a></li>
+				<li><a href="A2B_entity_speeddial.php?atmenu=speeddial&section=1">{php} echo gettext("Speed Dial");{/php}</a></li>
+				<li><a href="card-history.php?atmenu=cardhistory&section=1">{php} echo gettext("History");{/php}</a></li>
+				<li><a href="A2B_entity_statuslog.php?atmenu=statuslog&section=1">{php} echo gettext("Status");{/php}</a></li>
+		</ul></li>
+	</ul>
+	</div>
+	{/if}
+
+	{if ($ACXADMINISTRATOR  > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img2"
+	{if ($section == "2")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("AGENTS");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="2")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_agent.php?atmenu=user&section=2">{php} echo gettext("Add :: Search");{/php}</a></li>
+				<li><a href="A2B_entity_signup_agent.php?atmenu=user&section=2">{php} echo gettext("Signup URLs");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+
+
+	{if ($ACXADMINISTRATOR  > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img3"
+	{if ($section == "3")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("ADMINS");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="3")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_user.php?atmenu=user&groupID=0&section=3">{php} echo gettext("Add :: Search");{/php}</a></li>
+				<li><a href="A2B_entity_user.php?atmenu=user&groupID=1&section=3">{php} echo gettext("Access Control");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+
+	{if ($ACXSUPPORT > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img4"
+	{if ($section == "4")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("SUPPORT");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="4")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="CC_ticket.php?section=4">{php} echo gettext("Customer Tickets");{/php}</a></li>
+				<li><a href="A2B_ticket_agent.php?section=4">{php} echo gettext("Agent Tickets");{/php}</a></li>
+				<li><a href="CC_support_component.php?section=4">{php} echo gettext("Ticket Components");{/php}</a></li>
+				<li><a href="CC_support.php?section=4">{php} echo gettext("Support Boxes");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+
+	{if ($ACXCALLREPORT > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img5"
+	{if ($section == "5")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("CALL REPORTS");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="5")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+					<li><a href="call-log-customers.php?nodisplay=1&posted=1&section=5">{php} echo gettext("CDRs");{/php}</a></li>
+                                        <li><a href="call-log-customers-history.php?nodisplay=1&posted=1&section=5">{php} echo "CDRs History";{/php}</a></li>
+					<li><a href="call-count-reporting.php?nodisplay=1&posted=1&section=5">{php} echo gettext("Call Count");{/php}</a></li>
+					<li><a href="call-count-reporting-history.php?nodisplay=1&posted=1&section=5">{php} echo gettext("Call Count History");{/php}</a></li>
+					<li><a href="A2B_trunk_report.php?section=5">{php} echo gettext("Trunk");{/php}</a></li>
+					<li><a href="call-dnid.php?nodisplay=1&posted=1&section=5">{php} echo gettext("DNID");{/php}</a></li>
+					<li><a href="call-pnl-report.php?section=5">{php} echo gettext("PNL");{/php}</a></li>
+					<li><a href="call-comp.php?section=5">{php} echo gettext("Compare Calls");{/php}</a></li>
+					<li><a href="call-daily-load.php?section=5">{php} echo gettext("Daily Traffic");{/php}</a></li>
+					<li><a href="call-last-month.php?section=5">{php} echo gettext("Monthly Traffic");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+
+	{if ($ACXRATECARD > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img6"
+	{if ($section == "6")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("RATES");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="6")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_tariffgroup.php?atmenu=tariffgroup&section=6">{php} echo gettext("Call Plan");{/php}</a></li>
+				<li><a href="A2B_entity_tariffplan.php?atmenu=tariffplan&section=6">{php} echo gettext("RateCards");{/php}</a></li>
+				<li><a href="CC_ratecard_import.php?atmenu=ratecard&section=6"> {php} echo gettext("Import");{/php}</a></li>
+				<li><a href="CC_ratecard_merging.php?atmenu=ratecard&section=6"> {php} echo gettext("Merge");{/php}</a></li>
+				<li><a href="CC_entity_sim_ratecard.php?atmenu=ratecard&section=6"> {php} echo gettext("Simulator");{/php}</a></li>
+				<li><a href="A2B_entity_def_ratecard.php?atmenu=ratecard&section=6">{php} echo gettext("Rates");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+
+	{if ($ACXTRUNK > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img7"
+	{if ($section == "7")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("PROVIDERS");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="7")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_provider.php?section=7">{php} echo gettext("Providers");{/php}</a></li>
+				<li><a href="A2B_entity_trunk.php?section=7">{php} echo gettext("Trunks");{/php}</a></li>
+				<li><a href="A2B_entity_prefix.php?section=7">{php} echo gettext("Prefixes");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+
+	{if ($ACXDID > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img8"
+	{if ($section == "8")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("INBOUND DID");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="8")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_did.php?section=8">{php} echo gettext("Add :: Search");{/php}</a></li>
+				<li><a href="A2B_entity_didgroup.php?section=8">{php} echo gettext("Groups");{/php}</a>
+				<li><a href="A2B_entity_did_destination.php?section=8">{php} echo gettext("Destination");{/php}</a></li>
+				<li><a href="A2B_entity_did_import.php?section=8">{php} echo gettext("Import [CSV]");{/php}</a></li>
+				<li><a href="A2B_entity_didx.php?section=8">{php} echo gettext("Import [DIDX]");{/php}</a></li>
+				<li><a href="A2B_entity_did_use.php?atmenu=did_use&section=8">{php} echo gettext("Usage");{/php}</a></li>
+				<li><a href="A2B_entity_did_billing.php?atmenu=did_billing&section=8">{php} echo gettext("Billing");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+	
+
+	{if ($ACXOUTBOUNDCID > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img9"
+	{if ($section == "9")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("OUTBOUND CID");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="9")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_outbound_cid.php?atmenu=cid&section=9">{php} echo gettext("Add");{/php}</a></li>
+				<li><a href="A2B_entity_outbound_cidgroup.php?atmenu=cidgroup&section=9">{php} echo gettext("Groups");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+
+
+	
+	{if ($ACXBILLING > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img10"
+	{if ($section == "10")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("BILLING");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="10")}
+		style="">
+	{else}
+	style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_voucher.php?section=10">{php} echo gettext("Vouchers");{/php}</a></li>
+				<li><a href="A2B_entity_moneysituation.php?atmenu=moneysituation&section=10">{php} echo gettext("Customers Balance");{/php}</a></li>
+                <li><a href="A2B_entity_transactions.php?atmenu=payment&section=10"> {php} echo gettext("Transactions");{/php}</a></li>
+				<li><a href="A2B_entity_billing_customer.php?atmenu=payment&section=10"> {php} echo gettext("Billings");{/php}</a></li>
+				<li><a href="A2B_entity_logrefill.php?atmenu=payment&section=10"> {php} echo gettext("Refills");{/php}</a></li>
+				<li><a href="A2B_entity_payment.php?atmenu=payment&section=10"> {php} echo gettext("Payments");{/php}</a></li>
+				<li><a href="A2B_entity_paymentlog.php?section=10"> {php} echo gettext("E-Payment Log");{/php}</a></li>
+				<li><a href="A2B_entity_charge.php?section=10"> {php} echo gettext("Charges");{/php}</a></li>
+				<li><a href="A2B_entity_agentsituation.php?atmenu=agentsituation&section=10">{php} echo gettext("Agents Balance");{/php}</a></li>
+				<li><a href="A2B_entity_commission_agent.php?atmenu=payment&section=10"> {php} echo gettext("Commissions");{/php}</a></li>
+				<li><a href="A2B_entity_remittance_request.php?atmenu=payment&section=10"> {php} echo gettext("Remittance Request");{/php}</a></li>
+				<li><a href="A2B_entity_transactions_agent.php?atmenu=payment&section=10"> {php} echo gettext("Transactions");{/php}</a></li>
+				<li><a href="A2B_entity_logrefill_agent.php?atmenu=payment&section=10"> {php} echo gettext("Refills");{/php}</a></li>
+				<li><a href="A2B_entity_payment_agent.php?atmenu=payment&section=10"> {php} echo gettext("Payments");{/php}</a></li>
+				<li><a href="A2B_entity_paymentlog_agent.php?section=10"> {php} echo gettext("E-Payment Log");{/php}</a></li>
+				<li><a href="A2B_entity_payment_configuration.php?atmenu=payment&section=10">{php} echo gettext("Payment Methods");{/php}</a></li>
+				<li><a href="A2B_currencies.php?section=10">{php} echo gettext("Currency List");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+
+
+	{if ($ACXINVOICING > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img11"
+	{if ($section == "11")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("INVOICES");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="11")}
+		style="">
+	{else}
+	style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_receipt.php?atmenu=payment&section=11">{php} echo gettext("Receipts");{/php}</a></li>
+				<li><a href="A2B_entity_invoice.php?atmenu=payment&section=11">{php} echo gettext("Invoices");{/php}</a></li>
+				<li><a href="A2B_entity_invoice_conf.php?atmenu=payment&section=11"> {php} echo gettext("Configuration");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+
+	
+	{if ($ACXPACKAGEOFFER > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img12"
+	{if ($section == "12")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("PACKAGE OFFER");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="12")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_package.php?atmenu=package&section=12">{php} echo gettext("Add");{/php}</a></li>
+				<li><a href="A2B_detail_package.php?section=12">{php} echo gettext("Details");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+	
+
+	{if ($ACXCRONTSERVICE  > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img13"
+	{if ($section == "13")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("RECUR SERVICE");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="13")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_service.php?section=13">{php} echo gettext("Account Service");{/php}</a></li>
+				<li><a href="A2B_entity_subscription.php?section=13">{php} echo gettext("Subscriptions Service");{/php}</a></li>
+				<li><a href="A2B_entity_subscriber_signup.php?section=13">{php} echo gettext("Subscriptions SIGNUP");{/php}</a></li>
+				<li><a href="A2B_entity_subscriber.php?section=13">{php} echo gettext("Subscribers");{/php}</a></li>
+				<li><a href="A2B_entity_autorefill.php?section=13">{php} echo gettext("AutoRefill Report");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+	
+
+	{if ($ACXCALLBACK  > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img14"
+	{if ($section == "14")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("CALLBACK");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="14")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_callback.php?section=14">{php} echo gettext("Add");{/php}</a></li>
+				<li><a href="A2B_entity_server_group.php?section=14">{php} echo gettext("Server Group");{/php}</a></li>
+				<li><a href="A2B_entity_server.php?section=14">{php} echo gettext("Server");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+
+	{if ($ACXPREDICTIVEDIALER  > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img15"
+	{if ($section == "15")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("CAMPAIGNS");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="15")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_campaign.php?section=15">{php} echo gettext("Add");{/php}</a></li>
+				<li><a href="A2B_entity_campaign_config.php?section=15">{php} echo gettext("Config");{/php}</a></li>
+				<li><a href="A2B_entity_phonebook.php?section=15">{php} echo gettext("Phone Book");{/php}</a></li>
+				<li><a href="A2B_entity_phonenumber.php?section=15"> {php} echo gettext("Add Number");{/php}</a></li>
+				<li><a href="A2B_phonelist_import.php?section=15"> {php} echo gettext("Import");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+
+	
+	{if ($ACXMAINTENANCE  > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img16"
+	{if ($section == "16")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("MAINTENANCE");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="16")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_alarm.php?section=16"> {php} echo gettext("Alarms");{/php}</a></li>
+				<li><a href="A2B_entity_log_viewer.php?section=16">{php} echo gettext("Users Activity");{/php}</a></li>
+				<li><a href="A2B_entity_backup.php?form_action=ask-add&section=16">{php} echo gettext("Database Backup");{/php}</a></li>
+				<li><a href="A2B_entity_restore.php?section=16">{php} echo gettext("Database Restore");{/php}</a></li>
+				<li><a href="CC_musiconhold.php?section=16">{php} echo gettext("MusicOnHold");{/php}</a></li>
+				<li><a href="CC_upload.php?section=16">{php} echo gettext("Upload File");{/php}</a></li>
+				<li><a href="A2B_logfile.php?section=16">{php} echo gettext("Watch Log files");{/php}</a></li>
+				<li><a href="A2B_data_archiving.php?section=16">{php} echo gettext("Archiving");{/php}</a></li>
+				<li><a href="A2B_asteriskinfo.php?section=16">{php} echo "Asterisk Info";{/php}</a></li>
+				<li><a href="A2B_phpsysinfo.php?section=16">{php} echo "phpSysInfo";{/php}</a></li>
+				<li><a href="A2B_phpinfo.php?section=16">{php} echo "phpInfo";{/php}</a></li>
+				<li><a href="A2B_entity_monitor.php?section=16"> {php} echo gettext("Monitoring");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	
+	{/if}
+	
+	{if ($ACXMAIL  > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img17"
+	{if ($section == "17")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("MAIL");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="17")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_mailtemplate.php?atmenu=mailtemplate&section=17&languages=en">{php} echo gettext("Mail templates");{/php}</a></li>
+				<li><a href="A2B_mass_mail.php?section=17">{php} echo gettext("Mass Mail");{/php}</a></li>
+			</ul></li>
+		</ul>
+	</div>
+	{/if}
+
+	
+	{if ($ACXSETTING  > 0)}
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img18"
+	{if ($section == "18")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("SYSTEM SETTINGS");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="18")}
+		style="">
+	{else}
+		style="display:none;">
+	{/if}
+		<ul>
+			<li><ul>
+				<li><a href="A2B_entity_config.php?form_action=list&atmenu=config&section=18">{php} echo gettext("Global List");{/php}</a></li>
+				<li><a href="A2B_entity_config_group.php?form_action=list&atmenu=configgroup&section=18">{php} echo gettext("Group List");{/php}</a></li>
+				<li><a href="A2B_entity_config_generate_confirm.php?section=18">{php} echo gettext("Add agi-conf");{/php}</a></li>
+				<li><a href="phpconfig.php?dir=/etc/asterisk&section=18">{php} echo gettext("* Config Editor");{/php}</a></li>
+				{if ($ASTERISK_GUI_LINK)}
+					<li><a href="http://{$HTTP_HOST}:8088/asterisk/static/config/index.html" target="_blank">{php} echo gettext("Asterisk GUI");{/php}</a></li>
+				{/if}
+			</ul></li>
+		</ul>
+	</div>
+	
+	{/if}
+	
+</ul>
+	
+<br/>
+<ul id="nav"><li>
+	<ul><li><a href="A2B_entity_password.php?atmenu=password&form_action=ask-edit"><strong>{php} echo gettext("Change Password");{/php}</strong> <img style="vertical-align:bottom;" src="templates/{$SKIN_NAME}/images/key.png"> </a></li></ul>
+</li></ul>
+
+</div>
+</div>
+</div>
+
+
+
+<table width="100%" cellspacing="15">
+<tr>
+	<td>
+		<a href="PP_intro.php?ui_language=english" target="_parent"><img src="templates/{$SKIN_NAME}/images/flags/gb.gif" border="0" title="English" alt="English"></a>
+		<a href="PP_intro.php?ui_language=brazilian" target="_parent"><img src="templates/{$SKIN_NAME}/images/flags/br.gif" border="0" title="Brazilian" alt="Brazilian"></a>
+		<a href="PP_intro.php?ui_language=romanian" target="_parent"><img src="templates/{$SKIN_NAME}/images/flags/ro.gif" border="0" title="Romanian"alt="Romanian"></a>
+		<a href="PP_intro.php?ui_language=french" target="_parent"><img src="templates/{$SKIN_NAME}/images/flags/fr.gif" border="0" title="French" alt="French"></a>
+		<a href="PP_intro.php?ui_language=spanish" target="_parent"><img src="templates/{$SKIN_NAME}/images/flags/es.gif" border="0" title="Spanish" alt="Spanish"></a>
+		<a href="PP_intro.php?ui_language=greek" target="_parent"><img src="templates/{$SKIN_NAME}/images/flags/gr.gif" border="0" title="Greek" alt="Greek"></a>
+	</td>
+</tr>
+</table>
+
+<div id="osx-modal-content">
+	<div id="osx-modal-title">Dear A2Billing Administrator</div>
+	<div id="osx-modal-data">
+		<h2>Licence Violation!</h2>
+		<p>Thank you for using A2Billing. However, we have detected that you have edited the Authors names, Copyright or licensing information in the A2Billing Management Interface.</p>
+		<p>The <a href="http://www.fsf.org/licensing/licenses/agpl-3.0.html" target="_blank">AGPL 3</a> license under which you are allowed to use A2Billing requires that the original copyright and license must be displayed and kept intact. Without this information being displayed, you do not have a right to use the software.</p>
+		<p>However, if it is important to you that the Authors names, Copyright and License information is not displayed, possibly for publicity purposes; then we can offer you additional permissions to use and convey A2Billing, with these items removed, for a fee that will be used to help sponsor the continued development of A2Billing.</p>
+		<p>For more information, please go to <a target="_blank" href="http://www.star2billing.com/licensing">http://www.star2billing.com/licensing</a>.</p>
+		<p>Yours,<br/>
+		The A2Billing Team<br/>
+		Star2Billing S.L</p>
+		<p><button class="simplemodal-close">Close</button></p>
+	</div>
+</div>
+
+
+</div>
+
+<div id="main-content">
+<br/>
+{else}
+<div>
+{/if}
+
+{if ($LCMODAL  > 0)}
+<script type="text/javascript">
+    loadLicenceModal();
+</script>
+{/if}
+ 
+{$MAIN_MSG}
+
Binary files a2billing_v1.9.4/common/cust_ui_locale/es_ES/LC_MESSAGES/messages.mo and a2billing/common/cust_ui_locale/es_ES/LC_MESSAGES/messages.mo differ
diff -urN -x lib a2billing_v1.9.4/common/cust_ui_locale/es_ES/LC_MESSAGES/messages.po a2billing/common/cust_ui_locale/es_ES/LC_MESSAGES/messages.po
--- a2billing_v1.9.4/common/cust_ui_locale/es_ES/LC_MESSAGES/messages.po	2011-05-31 16:39:39.000000000 -0300
+++ a2billing/common/cust_ui_locale/es_ES/LC_MESSAGES/messages.po	2012-09-19 09:54:27.000000000 -0300
@@ -8,8 +8,8 @@
 "Project-Id-Version: \n"
 "Report-Msgid-Bugs-To: \n"
 "POT-Creation-Date: 2011-02-18 00:40+0100\n"
-"PO-Revision-Date: 2009-04-23 16:29-0400\n"
-"Last-Translator: Ivan ili Schmidt <ivan@zilic.net>\n"
+"PO-Revision-Date: 2012-09-19 09:54-0300\n"
+"Last-Translator: Sebastin Moreno <smoreno@inconcertcc.com>\n"
 "Language-Team: ARESKI <areski@gmail.com>\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=utf-8\n"
@@ -20,17 +20,21 @@
 msgid "Your notification settings has successfully been updated."
 msgstr "Su transaccin fue exitosa."
 
-#: A2B_recurring_payment.php:140 A2B_recurring_payment.php:146
+#: A2B_recurring_payment.php:140
+#: A2B_recurring_payment.php:146
 msgid "Reccurring payment : automated refill"
 msgstr ""
 
-#: A2B_recurring_payment.php:156 iridium_threed.php:315
+#: A2B_recurring_payment.php:156
+#: iridium_threed.php:315
 #: checkout_process.php:357
 msgid "CUSTOMER REFILL"
 msgstr "RELLENO DE CLIENTES"
 
-#: A2B_recurring_payment.php:157 iridium_threed.php:317
-#: lib/Form/Class.FormBO.php:840 lib/Form/Class.FormBO.php:949
+#: A2B_recurring_payment.php:157
+#: iridium_threed.php:317
+#: lib/Form/Class.FormBO.php:840
+#: lib/Form/Class.FormBO.php:949
 #: checkout_process.php:358
 msgid "Invoice for refill"
 msgstr "Factura por relleno"
@@ -39,8 +43,10 @@
 msgid "Automated Refill : recurring payment"
 msgstr ""
 
-#: A2B_recurring_payment.php:194 iridium_threed.php:387
-#: lib/Form/Class.FormBO.php:996 checkout_process.php:392
+#: A2B_recurring_payment.php:194
+#: iridium_threed.php:387
+#: lib/Form/Class.FormBO.php:996
+#: checkout_process.php:392
 msgid "AUTOMATICALY GENERATED COMMISSION!"
 msgstr "COMISIN GENERADA AUTOMTICAMENTE!"
 
@@ -48,22 +54,27 @@
 msgid "CAMPAIGN"
 msgstr "CAMPAA"
 
-#: A2B_entity_phonenumber.php:116 lib/interface/constants.php:15
+#: A2B_entity_phonenumber.php:116
+#: lib/interface/constants.php:15
 msgid "INFO"
 msgstr "INFORMACIN"
 
-#: A2B_entity_phonenumber.php:119 form_data/FG_var_invoice.inc:70
-#: form_data/FG_var_campaign.inc:72 form_data/FG_var_ticket.inc:60
+#: A2B_entity_phonenumber.php:119
+#: form_data/FG_var_invoice.inc:70
+#: form_data/FG_var_campaign.inc:72
+#: form_data/FG_var_ticket.inc:60
 #: form_data/FG_var_phonenumber.inc:65
 #, fuzzy
 msgid "STATUS"
 msgstr "ESTADO"
 
-#: A2B_entity_phonenumber.php:122 lib/Form/Class.ViewHandler.inc.php:196
+#: A2B_entity_phonenumber.php:122
+#: lib/Form/Class.ViewHandler.inc.php:196
 msgid "ACTION"
 msgstr "ACCIN"
 
-#: A2B_entity_phonenumber.php:137 lib/interface/constants.php:328
+#: A2B_entity_phonenumber.php:137
+#: lib/interface/constants.php:328
 #: lib/interface/constants.php:346
 msgid "EXPIRED"
 msgstr "EXPIRADO"
@@ -253,7 +264,9 @@
 msgid "We found several destinations:"
 msgstr "Hemos encontrado varios destinos:"
 
-#: simulator.php:209 form_data/FG_var_did.inc:67 form_data/FG_var_did.inc:122
+#: simulator.php:209
+#: form_data/FG_var_did.inc:67
+#: form_data/FG_var_did.inc:122
 #: form_data/FG_var_ratecard.inc:56
 msgid "DESTINATION"
 msgstr "DESTINO"
@@ -262,7 +275,8 @@
 msgid "CallTime available"
 msgstr "Tiempo de llamado  disponible"
 
-#: simulator.php:216 call-history.php:380
+#: simulator.php:216
+#: call-history.php:380
 msgid "Minutes"
 msgstr "Minutos"
 
@@ -294,22 +308,26 @@
 msgid "Priority"
 msgstr "Prioridad"
 
-#: A2B_support.php:150 lib/interface/constants.php:267
+#: A2B_support.php:150
+#: lib/interface/constants.php:267
 #: A2B_entity_ratecard.php:97
 msgid "NONE"
 msgstr "NINGUNO"
 
-#: A2B_support.php:151 lib/interface/constants.php:268
+#: A2B_support.php:151
+#: lib/interface/constants.php:268
 #: lib/Class.Notification.php:109
 msgid "LOW"
 msgstr "BAJO"
 
-#: A2B_support.php:152 lib/interface/constants.php:269
+#: A2B_support.php:152
+#: lib/interface/constants.php:269
 #: lib/Class.Notification.php:106
 msgid "MEDIUM"
 msgstr "MEDIO"
 
-#: A2B_support.php:153 lib/interface/constants.php:270
+#: A2B_support.php:153
+#: lib/interface/constants.php:270
 #: lib/Class.Notification.php:104
 msgid "HIGH"
 msgstr "ALTO"
@@ -318,9 +336,14 @@
 msgid "Component"
 msgstr "Componente"
 
-#: A2B_support.php:179 A2B_invoice_view.php:215 A2B_receipt_detail.php:138
-#: card-history.php:76 A2B_billing_preview.php:184 A2B_billing_preview.php:277
-#: A2B_receipt_preview_detail.php:216 A2B_receipt_view.php:201
+#: A2B_support.php:179
+#: A2B_invoice_view.php:215
+#: A2B_receipt_detail.php:138
+#: card-history.php:76
+#: A2B_billing_preview.php:184
+#: A2B_billing_preview.php:277
+#: A2B_receipt_preview_detail.php:216
+#: A2B_receipt_view.php:201
 msgid "Description"
 msgstr "Descripcion"
 
@@ -328,15 +351,18 @@
 msgid "CREATE"
 msgstr "CREAR"
 
-#: iridium_threed.php:331 checkout_process.php:365
+#: iridium_threed.php:331
+#: checkout_process.php:365
 msgid "Refill ONLINE"
 msgstr ""
 
-#: form_data/FG_var_did.inc:60 lib/interface/constants.php:89
+#: form_data/FG_var_did.inc:60
+#: lib/interface/constants.php:89
 msgid "Active"
 msgstr "Activo"
 
-#: form_data/FG_var_did.inc:61 lib/interface/constants.php:88
+#: form_data/FG_var_did.inc:61
+#: lib/interface/constants.php:88
 msgid "Inactive"
 msgstr "Inactivo"
 
@@ -349,17 +375,22 @@
 msgid "Validated"
 msgstr "Fecha de Llamada"
 
-#: form_data/FG_var_did.inc:68 templates/default/main.tpl:62
+#: form_data/FG_var_did.inc:68
+#: templates/default/main.tpl:62
 msgid "DID"
 msgstr "DID"
 
-#: form_data/FG_var_did.inc:69 form_data/FG_var_did.inc:132
-#: form_data/FG_var_callerid.inc:49 form_data/FG_var_callerid.inc:91
-#: lib/interface/constants.php:342 lib/interface/constants.php:367
+#: form_data/FG_var_did.inc:69
+#: form_data/FG_var_did.inc:132
+#: form_data/FG_var_callerid.inc:49
+#: form_data/FG_var_callerid.inc:91
+#: lib/interface/constants.php:342
+#: lib/interface/constants.php:367
 msgid "ACTIVATED"
 msgstr "ACTIVADO"
 
-#: form_data/FG_var_did.inc:70 form_data/FG_var_did.inc:141
+#: form_data/FG_var_did.inc:70
+#: form_data/FG_var_did.inc:141
 #: form_data/FG_var_ticket.inc:58
 msgid "PRIORITY"
 msgstr "PRIORIDAD"
@@ -368,8 +399,10 @@
 msgid "USED MINUTE"
 msgstr "MINUTOS USADOS"
 
-#: form_data/FG_var_did.inc:72 form_data/FG_var_signup.inc:229
-#: form_data/FG_var_card.inc:102 userinfo.php:116
+#: form_data/FG_var_did.inc:72
+#: form_data/FG_var_signup.inc:229
+#: form_data/FG_var_card.inc:102
+#: userinfo.php:116
 msgid "COUNTRY"
 msgstr "PAIS"
 
@@ -386,7 +419,8 @@
 msgid "Enter here the phonenumber you want to call or the SIP/IAX/H323 peer to reach (ie: 347894999 or SIP/jeremy@182.212.1.45). To call SIP/IAX/H323 peer, you need to enable the voip_call bellow (voip_call = Yes) "
 msgstr "Ingrese aqu el nmero telefnico al quie quiere llamar o el peer SIP/IAX/H323 (Ejemplo: 347894999 o SIP/jeremy@182.212.1.45). Para llamar a un peer SIP/IAX/H323, necesita habilitar la opcin voip_call debajo (voip_call = yes) "
 
-#: form_data/FG_var_did.inc:138 form_data/FG_var_callerid.inc:97
+#: form_data/FG_var_did.inc:138
+#: form_data/FG_var_callerid.inc:97
 msgid "Choose if you want to activate this card"
 msgstr "Elija si quiere actigar esta tarjeta"
 
@@ -398,45 +432,66 @@
 msgid "Choose if you want to not use the trunk and let the asterisk call directly the destination (ie, Destination : SIP/jeremy@182.212.1.45)"
 msgstr "Elija si quiere no usar el trunk y dejar a Asterisk llamar al destino directamente (Ejemplo:Destino : SIP/jeremy@182.212.1.45)"
 
-#: form_data/FG_var_did.inc:169 form_data/FG_var_campaign.inc:295
-#: form_data/FG_var_speeddial.inc:118 form_data/FG_var_phonebook.inc:109
-#: form_data/FG_var_ticket.inc:80 form_data/FG_var_phonenumber.inc:144
-#: form_data/FG_var_callerid.inc:116 lib/Form/Class.FormHandler.inc.php:554
+#: form_data/FG_var_did.inc:169
+#: form_data/FG_var_campaign.inc:295
+#: form_data/FG_var_speeddial.inc:118
+#: form_data/FG_var_phonebook.inc:109
+#: form_data/FG_var_ticket.inc:80
+#: form_data/FG_var_phonenumber.inc:144
+#: form_data/FG_var_callerid.inc:116
+#: lib/Form/Class.FormHandler.inc.php:554
 msgid "If you really want remove this"
 msgstr "Si usted realmente quiere elimiar esto"
 
-#: form_data/FG_var_did.inc:169 form_data/FG_var_campaign.inc:295
-#: form_data/FG_var_speeddial.inc:118 form_data/FG_var_phonebook.inc:109
-#: form_data/FG_var_ticket.inc:80 form_data/FG_var_phonenumber.inc:144
+#: form_data/FG_var_did.inc:169
+#: form_data/FG_var_campaign.inc:295
+#: form_data/FG_var_speeddial.inc:118
+#: form_data/FG_var_phonebook.inc:109
+#: form_data/FG_var_ticket.inc:80
+#: form_data/FG_var_phonenumber.inc:144
 #: form_data/FG_var_callerid.inc:116
 msgid "click on the delete button."
 msgstr "Haga click en el botn Eliminar"
 
-#: form_data/FG_var_did.inc:170 form_data/FG_var_campaign.inc:296
-#: form_data/FG_var_speeddial.inc:119 form_data/FG_var_phonebook.inc:110
-#: form_data/FG_var_ticket.inc:81 form_data/FG_var_phonenumber.inc:145
-#: form_data/FG_var_callerid.inc:117 lib/Form/Class.FormHandler.inc.php:557
+#: form_data/FG_var_did.inc:170
+#: form_data/FG_var_campaign.inc:296
+#: form_data/FG_var_speeddial.inc:119
+#: form_data/FG_var_phonebook.inc:110
+#: form_data/FG_var_ticket.inc:81
+#: form_data/FG_var_phonenumber.inc:145
+#: form_data/FG_var_callerid.inc:117
+#: lib/Form/Class.FormHandler.inc.php:557
 msgid "you can add easily a new"
 msgstr "Puede fcilmente agregar un nuevo"
 
-#: form_data/FG_var_did.inc:170 form_data/FG_var_campaign.inc:296
-#: form_data/FG_var_speeddial.inc:119 form_data/FG_var_phonebook.inc:110
-#: form_data/FG_var_ticket.inc:81 form_data/FG_var_phonenumber.inc:145
-#: form_data/FG_var_callerid.inc:117 lib/Form/Class.FormHandler.inc.php:557
+#: form_data/FG_var_did.inc:170
+#: form_data/FG_var_campaign.inc:296
+#: form_data/FG_var_speeddial.inc:119
+#: form_data/FG_var_phonebook.inc:110
+#: form_data/FG_var_ticket.inc:81
+#: form_data/FG_var_phonenumber.inc:145
+#: form_data/FG_var_callerid.inc:117
+#: lib/Form/Class.FormHandler.inc.php:557
 msgid "Fill the following fields and confirm by clicking on the button add."
 msgstr "Llene los siguientes campos y confirme haciendo click en el botn agregar"
 
-#: form_data/FG_var_did.inc:174 form_data/FG_var_campaign.inc:300
-#: form_data/FG_var_speeddial.inc:124 form_data/FG_var_phonebook.inc:114
-#: form_data/FG_var_ticket.inc:85 form_data/FG_var_callerid.inc:123
+#: form_data/FG_var_did.inc:174
+#: form_data/FG_var_campaign.inc:300
+#: form_data/FG_var_speeddial.inc:124
+#: form_data/FG_var_phonebook.inc:114
+#: form_data/FG_var_ticket.inc:85
+#: form_data/FG_var_callerid.inc:123
 #: lib/Form/Class.FormHandler.inc.php:559
 #: lib/Form/Class.FormHandler.inc.php:560
 msgid "Your new"
 msgstr "Su nuevo"
 
-#: form_data/FG_var_did.inc:174 form_data/FG_var_campaign.inc:300
-#: form_data/FG_var_speeddial.inc:124 form_data/FG_var_phonebook.inc:114
-#: form_data/FG_var_ticket.inc:85 form_data/FG_var_callerid.inc:123
+#: form_data/FG_var_did.inc:174
+#: form_data/FG_var_campaign.inc:300
+#: form_data/FG_var_speeddial.inc:124
+#: form_data/FG_var_phonebook.inc:114
+#: form_data/FG_var_ticket.inc:85
+#: form_data/FG_var_callerid.inc:123
 msgid "has been inserted."
 msgstr "Ha sido insertado. "
 
@@ -448,18 +503,22 @@
 msgid "REFERENCE"
 msgstr "REFERENCIA"
 
-#: form_data/FG_var_invoice.inc:68 form_data/FG_var_receipt.inc:67
-#: form_data/FG_var_phonenumber.inc:64 call-history.php:259
+#: form_data/FG_var_invoice.inc:68
+#: form_data/FG_var_receipt.inc:67
+#: form_data/FG_var_phonenumber.inc:64
+#: call-history.php:259
 #: call-history.php:592
 msgid "DATE"
 msgstr "FECHA"
 
-#: form_data/FG_var_invoice.inc:69 form_data/FG_var_receipt.inc:68
+#: form_data/FG_var_invoice.inc:69
+#: form_data/FG_var_receipt.inc:68
 #: form_data/FG_var_ticket.inc:55
 msgid "TITLE"
 msgstr "TTULO"
 
-#: form_data/FG_var_invoice.inc:71 form_data/FG_var_receipt.inc:69
+#: form_data/FG_var_invoice.inc:71
+#: form_data/FG_var_receipt.inc:69
 msgid "AMOUNT INCL VAT"
 msgstr "Monto c/IVA"
 
@@ -479,7 +538,8 @@
 msgid "CALL PLAN"
 msgstr "PLAN DE LLAMADOS"
 
-#: form_data/FG_var_signup.inc:175 form_data/FG_var_card.inc:53
+#: form_data/FG_var_signup.inc:175
+#: form_data/FG_var_card.inc:53
 msgid "LASTNAME"
 msgstr "APELLIDOS"
 
@@ -487,7 +547,8 @@
 msgid "Insert your lastname"
 msgstr "Ingrese sus apellidos"
 
-#: form_data/FG_var_signup.inc:184 form_data/FG_var_card.inc:62
+#: form_data/FG_var_signup.inc:184
+#: form_data/FG_var_card.inc:62
 msgid "FIRSTNAME"
 msgstr "NOMBRE"
 
@@ -495,7 +556,8 @@
 msgid "Insert your firstname"
 msgstr "Ingrese su nombre"
 
-#: form_data/FG_var_signup.inc:192 userinfo.php:107
+#: form_data/FG_var_signup.inc:192
+#: userinfo.php:107
 msgid "EMAIL"
 msgstr "EMAIL"
 
@@ -503,7 +565,8 @@
 msgid "Insert your email"
 msgstr "Ingrese e-mail"
 
-#: form_data/FG_var_signup.inc:199 form_data/FG_var_card.inc:72
+#: form_data/FG_var_signup.inc:199
+#: form_data/FG_var_card.inc:72
 #: userinfo.php:112
 msgid "ADDRESS"
 msgstr "DIRECCIN"
@@ -512,7 +575,8 @@
 msgid "Insert your address"
 msgstr "Ingrese su Direccin"
 
-#: form_data/FG_var_signup.inc:208 form_data/FG_var_card.inc:82
+#: form_data/FG_var_signup.inc:208
+#: form_data/FG_var_card.inc:82
 #: userinfo.php:114
 msgid "CITY"
 msgstr "CIUDAD"
@@ -522,7 +586,8 @@
 msgid "Insert your city"
 msgstr "Ingrese la Ciudad"
 
-#: form_data/FG_var_signup.inc:217 form_data/FG_var_card.inc:92
+#: form_data/FG_var_signup.inc:217
+#: form_data/FG_var_card.inc:92
 msgid "STATE/PROVINCE"
 msgstr "ESTADO/PROVINCIA"
 
@@ -531,7 +596,8 @@
 msgid "Insert your state"
 msgstr "Ingrese el Estado"
 
-#: form_data/FG_var_signup.inc:239 form_data/FG_var_card.inc:113
+#: form_data/FG_var_signup.inc:239
+#: form_data/FG_var_card.inc:113
 msgid "ZIP/POSTAL CODE"
 msgstr "CODIGO POSTAL"
 
@@ -539,11 +605,13 @@
 msgid "Insert your zipcode"
 msgstr "Ingrese el cdigo postal"
 
-#: form_data/FG_var_signup.inc:257 form_data/FG_var_card.inc:122
+#: form_data/FG_var_signup.inc:257
+#: form_data/FG_var_card.inc:122
 msgid "TIMEZONE"
 msgstr "ZONA HORARIA"
 
-#: form_data/FG_var_signup.inc:268 form_data/FG_var_phonenumber.inc:61
+#: form_data/FG_var_signup.inc:268
+#: form_data/FG_var_phonenumber.inc:61
 #: call-history.php:324
 msgid "PHONENUMBER"
 msgstr "NMERO TELEFNICO"
@@ -628,7 +696,8 @@
 msgid "Your card number is "
 msgstr "Su nmero de tarjeta es"
 
-#: form_data/FG_var_signup.inc:430 activate.php:111
+#: form_data/FG_var_signup.inc:430
+#: activate.php:111
 #: signup_confirmation.php:121
 msgid "Your password is "
 msgstr "Su password es"
@@ -691,15 +760,18 @@
 msgid "Customer can enable the voicemail for this card."
 msgstr "Elija si quiere activar la notificacin por e-mail para esta tarjeta"
 
-#: form_data/FG_var_card.inc:169 form_data/FG_var_notify.inc:114
+#: form_data/FG_var_card.inc:169
+#: form_data/FG_var_notify.inc:114
 msgid "you can add easily update your information clicking on the button."
 msgstr ""
 
-#: form_data/FG_var_card.inc:172 form_data/FG_var_notify.inc:117
+#: form_data/FG_var_card.inc:172
+#: form_data/FG_var_notify.inc:117
 msgid "Your record has been updated."
 msgstr "Su registro ha sido actualizado."
 
-#: form_data/FG_var_voucher.inc:45 A2B_entity_voucher.php:116
+#: form_data/FG_var_voucher.inc:45
+#: A2B_entity_voucher.php:116
 msgid "VOUCHER"
 msgstr "VOUCHER"
 
@@ -715,9 +787,12 @@
 msgid "Add CAMPAIGN"
 msgstr "Agregar CAMPAA"
 
-#: form_data/FG_var_campaign.inc:68 form_data/FG_var_speeddial.inc:53
-#: form_data/FG_var_speeddial.inc:90 form_data/FG_var_phonebook.inc:65
-#: form_data/FG_var_phonebook.inc:81 form_data/FG_var_phonenumber.inc:62
+#: form_data/FG_var_campaign.inc:68
+#: form_data/FG_var_speeddial.inc:53
+#: form_data/FG_var_speeddial.inc:90
+#: form_data/FG_var_phonebook.inc:65
+#: form_data/FG_var_phonebook.inc:81
+#: form_data/FG_var_phonenumber.inc:62
 #: form_data/FG_var_phonenumber.inc:101
 msgid "NAME"
 msgstr "NOMBRE"
@@ -730,7 +805,8 @@
 msgid "EXPIRATIONDATE"
 msgstr "FECHA DE EXPIRACIN"
 
-#: form_data/FG_var_campaign.inc:71 A2B_entity_sipiax_info.php:88
+#: form_data/FG_var_campaign.inc:71
+#: A2B_entity_sipiax_info.php:88
 msgid "CARD"
 msgstr "TARJETA"
 
@@ -771,7 +847,8 @@
 msgid "Insert the starting date"
 msgstr "Ingrese la fecha de inicio"
 
-#: form_data/FG_var_campaign.inc:148 form_data/FG_var_campaign.inc:157
+#: form_data/FG_var_campaign.inc:148
+#: form_data/FG_var_campaign.inc:157
 #, fuzzy
 msgid "Please respect the format YYYY-MM-DD HH:MM:SS. For instance, '2004-12-31 00:00:00'"
 msgstr "Por favor respete el formato YYYY-MM-DD HH:MM:SS. Por ejemplo,'2004-12-31 00:00:00'"
@@ -804,7 +881,8 @@
 msgid "Insert the daily starting time"
 msgstr "Ingrese el horario de inicio diario"
 
-#: form_data/FG_var_campaign.inc:175 form_data/FG_var_campaign.inc:184
+#: form_data/FG_var_campaign.inc:175
+#: form_data/FG_var_campaign.inc:184
 #, fuzzy
 msgid "Please respect the format HH:MM:SS. For instance, '00:00:00'"
 msgstr "Por favor respete el formato YYYY-MM-DD HH:MM:SS. Por ejemplo,'2004-12-31 00:00:00'"
@@ -821,7 +899,8 @@
 msgid "MONDAY"
 msgstr "LUNES"
 
-#: form_data/FG_var_campaign.inc:192 form_data/FG_var_campaign.inc:201
+#: form_data/FG_var_campaign.inc:192
+#: form_data/FG_var_campaign.inc:201
 #: form_data/FG_var_campaign.inc:210
 msgid "Choose if you want to enable the campaign callback for the monday"
 msgstr "Elija si quiere activar la campaa callback el lunes"
@@ -866,12 +945,15 @@
 msgid "Choose if you want to enable the campaign callback for the sunday"
 msgstr "Elija si quiere activar la campaa callback el domingo"
 
-#: form_data/FG_var_campaign.inc:249 form_data/FG_var_payment.inc:53
-#: form_data/FG_var_phonebook.inc:66 form_data/FG_var_phonebook.inc:90
+#: form_data/FG_var_campaign.inc:249
+#: form_data/FG_var_payment.inc:53
+#: form_data/FG_var_phonebook.inc:66
+#: form_data/FG_var_phonebook.inc:90
 msgid "DESCRIPTION"
 msgstr "DESCRIPCIN"
 
-#: form_data/FG_var_campaign.inc:255 form_data/FG_var_phonebook.inc:96
+#: form_data/FG_var_campaign.inc:255
+#: form_data/FG_var_phonebook.inc:96
 msgid "Insert the description"
 msgstr "Ingrese la descripcin"
 
@@ -879,9 +961,12 @@
 msgid "PHONE BOOK"
 msgstr "AGENDA"
 
-#: form_data/FG_var_campaign.inc:294 form_data/FG_var_speeddial.inc:117
-#: form_data/FG_var_phonebook.inc:108 form_data/FG_var_phonenumber.inc:143
-#: form_data/FG_var_callerid.inc:115 lib/Form/Class.FormHandler.inc.php:553
+#: form_data/FG_var_campaign.inc:294
+#: form_data/FG_var_speeddial.inc:117
+#: form_data/FG_var_phonebook.inc:108
+#: form_data/FG_var_phonenumber.inc:143
+#: form_data/FG_var_callerid.inc:115
+#: lib/Form/Class.FormHandler.inc.php:553
 msgid "You can modify, through the following form, the different properties of your"
 msgstr "Usted puede modificar a travs del siguiente formulario las diferentes propiedades de su"
 
@@ -893,11 +978,13 @@
 msgid "Setup those values to create the new"
 msgstr "Configure los valores para crear el nuevo"
 
-#: form_data/FG_var_speeddial.inc:51 form_data/FG_var_speeddial.inc:80
+#: form_data/FG_var_speeddial.inc:51
+#: form_data/FG_var_speeddial.inc:80
 msgid "SPEEDDIAL"
 msgstr "DISCADO RAPIDO"
 
-#: form_data/FG_var_speeddial.inc:52 form_data/FG_var_speeddial.inc:100
+#: form_data/FG_var_speeddial.inc:52
+#: form_data/FG_var_speeddial.inc:100
 #: userinfo.php:108
 msgid "PHONE"
 msgstr "TELFONO"
@@ -930,7 +1017,8 @@
 msgid "payment"
 msgstr "Pago"
 
-#: form_data/FG_var_payment.inc:50 form_data/FG_var_receipt.inc:65
+#: form_data/FG_var_payment.inc:50
+#: form_data/FG_var_receipt.inc:65
 #: form_data/FG_var_ticket.inc:54
 msgid "ID"
 msgstr "ID"
@@ -971,7 +1059,8 @@
 msgid "THERE IS NO RECEIPT CREATED!"
 msgstr "NO HAY RECIBO CREADO!"
 
-#: form_data/FG_var_phonebook.inc:38 form_data/FG_var_phonenumber.inc:91
+#: form_data/FG_var_phonebook.inc:38
+#: form_data/FG_var_phonenumber.inc:91
 #: templates/default/main.tpl:114
 msgid "Phone Book"
 msgstr "Agenda"
@@ -992,7 +1081,8 @@
 msgid "Insert the provider name"
 msgstr "Ingrese el nombre del proveedor"
 
-#: form_data/FG_var_phonebook.inc:113 lib/Form/Class.SearchHandler.inc.php:379
+#: form_data/FG_var_phonebook.inc:113
+#: lib/Form/Class.SearchHandler.inc.php:379
 #: lib/Form/Class.SearchHandler.inc.php:394
 #: lib/Form/Class.SearchHandler.inc.php:410
 #: lib/Form/Class.SearchHandler.inc.php:426
@@ -1004,7 +1094,8 @@
 msgid "Add"
 msgstr "Agregue un"
 
-#: form_data/FG_var_phonebook.inc:118 form_data/FG_var_ticket.inc:88
+#: form_data/FG_var_phonebook.inc:118
+#: form_data/FG_var_ticket.inc:88
 #: form_data/FG_var_phonenumber.inc:153
 msgid "Click 'Confirm Data' to continue"
 msgstr "Haga click en \"Confirmar Informacin\" para seguir"
@@ -1053,7 +1144,8 @@
 msgid "COMPONENT"
 msgstr "COMPONENTE"
 
-#: form_data/FG_var_ticket.inc:59 lib/interface/constants.php:276
+#: form_data/FG_var_ticket.inc:59
+#: lib/interface/constants.php:276
 msgid "VIEWED"
 msgstr "VISTO"
 
@@ -1069,7 +1161,8 @@
 msgid "PHONEBOOK"
 msgstr "AGENDA"
 
-#: form_data/FG_var_phonenumber.inc:63 form_data/FG_var_phonenumber.inc:110
+#: form_data/FG_var_phonenumber.inc:63
+#: form_data/FG_var_phonenumber.inc:110
 #: lib/interface/constants.php:410
 msgid "AMOUNT"
 msgstr "CANTIDAD"
@@ -1078,7 +1171,8 @@
 msgid "No phone numbers have been created"
 msgstr "Ningn nmero telefnico ha sido creado"
 
-#: form_data/FG_var_phonenumber.inc:82 templates/default/main.tpl:115
+#: form_data/FG_var_phonenumber.inc:82
+#: templates/default/main.tpl:115
 msgid "Phone Number"
 msgstr "Nmero Telefnico"
 
@@ -1118,11 +1212,13 @@
 msgid "Your new phone number has been inserted."
 msgstr "Su nuevo nmero telefnico fue insertado."
 
-#: form_data/FG_var_callerid.inc:39 call-history.php:131
+#: form_data/FG_var_callerid.inc:39
+#: call-history.php:131
 msgid "CallerID"
 msgstr "CallerID"
 
-#: form_data/FG_var_callerid.inc:48 form_data/FG_var_callerid.inc:81
+#: form_data/FG_var_callerid.inc:48
+#: form_data/FG_var_callerid.inc:81
 msgid "CALLERID"
 msgstr "IDENTIFICADOR DE LLAMADA"
 
@@ -1179,15 +1275,21 @@
 msgstr "Han ocurrido errores al procesar su formulario."
 
 #: lib/customer.defines.php:123
-msgid "Please make the following corrections:\\n\\n"
-msgstr "Por favor haga las siguientes correcciones:\\n\\n"
+msgid ""
+"Please make the following corrections:\\n"
+"\\n"
+msgstr ""
+"Por favor haga las siguientes correcciones:\\n"
+"\\n"
 
 #: lib/customer.defines.php:124
 msgid "* The 'Review Text' must have at least"
 msgstr "* El texto de su revisin debe tener al menos"
 
-#: lib/customer.defines.php:124 lib/customer.defines.php:136
-#: lib/customer.defines.php:137 lib/customer.defines.php:150
+#: lib/customer.defines.php:124
+#: lib/customer.defines.php:136
+#: lib/customer.defines.php:137
+#: lib/customer.defines.php:150
 msgid "characters"
 msgstr "caracteres"
 
@@ -1195,7 +1297,8 @@
 msgid "You must rate the product for your review."
 msgstr "Usted debe valorar el producto para su revisin."
 
-#: lib/customer.defines.php:126 lib/customer.defines.php:128
+#: lib/customer.defines.php:126
+#: lib/customer.defines.php:128
 msgid "Please select a payment method for your order."
 msgstr "Por favor seleccione una forma de pago para su orden."
 
@@ -1207,11 +1310,13 @@
 msgid "Credit Card"
 msgstr "Tarjeta de Crdito"
 
-#: lib/customer.defines.php:131 lib/customer.defines.php:141
+#: lib/customer.defines.php:131
+#: lib/customer.defines.php:141
 msgid "Credit Card Test Info"
 msgstr "Informacin de prueba de la Tarjeta de Crdito"
 
-#: lib/customer.defines.php:131 lib/customer.defines.php:141
+#: lib/customer.defines.php:131
+#: lib/customer.defines.php:141
 msgid "Expiry: Any"
 msgstr ""
 
@@ -1231,11 +1336,13 @@
 msgid "Credit Card Expiry Date"
 msgstr "Fecha de vencimiento de la Tarjeta de Crdito"
 
-#: lib/customer.defines.php:136 lib/customer.defines.php:149
+#: lib/customer.defines.php:136
+#: lib/customer.defines.php:149
 msgid "* The owner's name of the credit card must be at least"
 msgstr "*El nombre del propietario de la Tarjeta de Crdito debe ser por lo menos"
 
-#: lib/customer.defines.php:137 lib/customer.defines.php:150
+#: lib/customer.defines.php:137
+#: lib/customer.defines.php:150
 msgid "* The credit card number must be at least"
 msgstr "*EL nmero de la Tarjeta de Crdito debe ser por lo menos"
 
@@ -1283,27 +1390,34 @@
 msgid "Impossible to write to the file"
 msgstr "Imposible escribir en el archivo"
 
-#: lib/customer.smarty.php:103 lib/admin.smarty.php:68 lib/agent.smarty.php:69
+#: lib/customer.smarty.php:103
+#: lib/admin.smarty.php:68
+#: lib/agent.smarty.php:69
 msgid "This option is not available on the Demo!"
 msgstr "Est opcin no est disponible en Demo!"
 
-#: lib/epayment/methods/iridium.php:607 checkout_success.php:70
+#: lib/epayment/methods/iridium.php:607
+#: checkout_success.php:70
 msgid "We are sorry your transaction is failed. Please try later or check your provided information."
 msgstr "Lo sentimos, su transaccn fall. Por favor intente luego o revise la informacin proporcionada."
 
-#: lib/epayment/methods/iridium.php:611 checkout_success.php:74
+#: lib/epayment/methods/iridium.php:611
+#: checkout_success.php:74
 msgid "We are sorry your transaction is denied. Please try later or check your provided information."
 msgstr "Lo sentimos, su transaccn fue denegada. Por favor intente luego o revise la informacin proporcionada."
 
-#: lib/epayment/methods/iridium.php:620 checkout_success.php:82
+#: lib/epayment/methods/iridium.php:620
+#: checkout_success.php:82
 msgid "Your transaction is in progress."
 msgstr "Su transaccin est en proceso."
 
-#: lib/epayment/methods/iridium.php:624 checkout_success.php:86
+#: lib/epayment/methods/iridium.php:624
+#: checkout_success.php:86
 msgid "Your transaction was successful."
 msgstr "Su transaccin fue exitosa."
 
-#: lib/support/classes/ticket.php:79 lib/support/classes/ticket.php:233
+#: lib/support/classes/ticket.php:79
+#: lib/support/classes/ticket.php:233
 msgid "(AGENT)"
 msgstr "(AGENTE)"
 
@@ -1311,8 +1425,10 @@
 msgid "(ADMINISTRATOR) "
 msgstr "(ADMINISTRADOR)"
 
-#: lib/support/classes/ticket.php:370 lib/interface/constants.php:277
-#: lib/interface/constants.php:325 lib/interface/constants.php:343
+#: lib/support/classes/ticket.php:370
+#: lib/interface/constants.php:277
+#: lib/interface/constants.php:325
+#: lib/interface/constants.php:343
 msgid "NEW"
 msgstr "NUEVO"
 
@@ -1332,7 +1448,8 @@
 msgid "INVALID"
 msgstr "INVALIDO"
 
-#: lib/Class.SOAP-function.php:851 lib/Form/Class.FormBO.php:287
+#: lib/Class.SOAP-function.php:851
+#: lib/Form/Class.FormBO.php:287
 msgid "CREATION CARD REFILL"
 msgstr ""
 
@@ -1415,13 +1532,17 @@
 #: lib/Form/Class.FormHandler.EditForm.inc.php:780
 #: lib/Form/Class.FormHandler.DelForm.inc.php:161
 #: lib/Form/Class.FormHandler.AddForm.inc.php:158
-#: CC_entity_edit_speeddial.php:298 CC_entity_edit_speeddial.php:508
-#: CC_entity_edit_speeddial.php:800 CC_entity_edit_speeddial.php:1046
-#: card-history.php:418 CC_entity_edit_did_destination.php:407
+#: CC_entity_edit_speeddial.php:298
+#: CC_entity_edit_speeddial.php:508
+#: CC_entity_edit_speeddial.php:800
+#: CC_entity_edit_speeddial.php:1046
+#: card-history.php:418
+#: CC_entity_edit_did_destination.php:407
 #: CC_entity_edit_did_destination.php:626
 #: CC_entity_edit_did_destination.php:944
 #: CC_entity_edit_did_destination.php:1066
-#: CC_entity_edit_did_destination.php:1208 call-history.php:525
+#: CC_entity_edit_did_destination.php:1208
+#: call-history.php:525
 msgid "No data found !!!"
 msgstr "No se encontraron resultados !!!"
 
@@ -1430,21 +1551,24 @@
 msgstr "LISTA"
 
 #: lib/Form/Class.FormHandler.EditForm.inc.php:333
-#: lib/interface/constants.php:64 CC_entity_edit_did_destination.php:739
+#: lib/interface/constants.php:64
+#: CC_entity_edit_did_destination.php:739
 msgid "No"
 msgstr "No"
 
 #: lib/Form/Class.FormHandler.EditForm.inc.php:353
 #: lib/Form/Class.FormHandler.EditForm.inc.php:509
 #: lib/Form/Class.FormHandler.EditForm.inc.php:632
-#: CC_entity_edit_speeddial.php:452 CC_entity_edit_speeddial.php:642
+#: CC_entity_edit_speeddial.php:452
+#: CC_entity_edit_speeddial.php:642
 #: CC_entity_edit_did_destination.php:773
 msgid "Add a new"
 msgstr "Agregar un nuevo"
 
 #: lib/Form/Class.FormHandler.EditForm.inc.php:440
 #: lib/Form/Class.FormHandler.EditForm.inc.php:567
-#: CC_entity_edit_speeddial.php:564 CC_entity_edit_speeddial.php:733
+#: CC_entity_edit_speeddial.php:564
+#: CC_entity_edit_speeddial.php:733
 #: CC_entity_edit_did_destination.php:680
 #: CC_entity_edit_did_destination.php:875
 msgid "LIST"
@@ -1483,12 +1607,15 @@
 msgid "SUMMARY OF CHARGE"
 msgstr "RESUMEN DE CARGOS"
 
-#: lib/Form/Class.FormBO.php:715 A2B_billing_preview.php:230
+#: lib/Form/Class.FormBO.php:715
+#: A2B_billing_preview.php:230
 msgid "Summary of the charge charged since the last billing."
 msgstr ""
 
-#: lib/Form/Class.FormBO.php:721 lib/Form/Class.FormBO.php:751
-#: A2B_billing_preview.php:107 A2B_billing_preview.php:116
+#: lib/Form/Class.FormBO.php:721
+#: lib/Form/Class.FormBO.php:751
+#: A2B_billing_preview.php:107
+#: A2B_billing_preview.php:116
 #: A2B_receipt_preview_detail.php:77
 #, fuzzy
 msgid "CHARGE :"
@@ -1510,8 +1637,10 @@
 msgid "Invoice for POSTPAID"
 msgstr "Factura para POSTPAGO"
 
-#: lib/Form/Class.FormBO.php:836 lib/Form/Class.FormBO.php:838
-#: lib/Form/Class.FormBO.php:945 lib/Form/Class.FormBO.php:947
+#: lib/Form/Class.FormBO.php:836
+#: lib/Form/Class.FormBO.php:838
+#: lib/Form/Class.FormBO.php:945
+#: lib/Form/Class.FormBO.php:947
 msgid "REFILL"
 msgstr "RELLENO"
 
@@ -1520,51 +1649,63 @@
 msgid "From :"
 msgstr "Desde:"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:195
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:195
 msgid "January"
 msgstr "Enero"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:196
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:196
 msgid "February"
 msgstr "Febrero"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:197
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:197
 msgid "March"
 msgstr "Marzo"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:198
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:198
 msgid "April"
 msgstr "Abril"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:199
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:199
 msgid "May"
 msgstr "Mayo"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:200
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:200
 msgid "June"
 msgstr "Junio"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:201
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:201
 msgid "July"
 msgstr "Julio"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:202
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:202
 msgid "August"
 msgstr "Agosto"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:203
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:203
 msgid "September"
 msgstr "Septiembre"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:204
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:204
 msgid "October"
 msgstr "Octubre"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:205
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:205
 msgid "November"
 msgstr "Noviembre"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:206
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:206
 msgid "December"
 msgstr "Diciembre"
 
@@ -1573,19 +1714,23 @@
 msgid "To :"
 msgstr "Hasta:"
 
-#: lib/Form/Class.SearchHandler.inc.php:213 call-history.php:329
+#: lib/Form/Class.SearchHandler.inc.php:213
+#: call-history.php:329
 msgid "Exact"
 msgstr "Exacto"
 
-#: lib/Form/Class.SearchHandler.inc.php:214 call-history.php:330
+#: lib/Form/Class.SearchHandler.inc.php:214
+#: call-history.php:330
 msgid "Begins with"
 msgstr "Empieza con"
 
-#: lib/Form/Class.SearchHandler.inc.php:215 call-history.php:331
+#: lib/Form/Class.SearchHandler.inc.php:215
+#: call-history.php:331
 msgid "Contains"
 msgstr "Contiene"
 
-#: lib/Form/Class.SearchHandler.inc.php:216 call-history.php:332
+#: lib/Form/Class.SearchHandler.inc.php:216
+#: call-history.php:332
 msgid "Ends with"
 msgstr "Acaba con"
 
@@ -1597,7 +1742,8 @@
 msgid "selected, use the option below if you are willing to make a batch updated of the selected cards."
 msgstr "seleccionado, use el botn debajo si desea hacer un update de todas las tarjetas seleccionadas."
 
-#: lib/Form/Class.SearchHandler.inc.php:356 templates/default/main.tpl:70
+#: lib/Form/Class.SearchHandler.inc.php:356
+#: templates/default/main.tpl:70
 msgid "RATECARD"
 msgstr "RATECARD"
 
@@ -1665,7 +1811,8 @@
 msgid " BATCH UPDATE RATECARD "
 msgstr "ACTUALIZAR LOTE DE RATECARD"
 
-#: lib/Form/Class.FormHandler.DelForm.inc.php:46 checkout_success.php:55
+#: lib/Form/Class.FormHandler.DelForm.inc.php:46
+#: checkout_success.php:55
 msgid "Message"
 msgstr "Mensaje"
 
@@ -1853,13 +2000,13 @@
 msgid "(at least 6 Alphanumeric characters)"
 msgstr "(por lo menos 6 caracteres Alfanumricos)"
 
-#: lib/Form/Class.FormHandler.inc.php:1059
-#, php-format
-msgid "(PERCENT FORMAT WITH/WITHOUT DECIMAL, use '.' for decimal and don't use '%' character. e.g.: 12.4 )"
-msgstr "(FORMATO NUMRICO PORCENTUAL CON/SIN DECIMAL, use '.'para decimal y no use '%', por ejemplo: 12.4)"
+msgid "(PERCENT FORMAT WITH/WITHOUT DECIMAL, use . for decimal and don't use % character. e.g.: 12.4 )"
+msgstr "(FORMATO NUMRICO PORCENTUAL CON/SIN DECIMAL, use . para decimal y no use %, por ejemplo: 12.4)"
 
+#: lib/Form/Class.FormHandler.inc.php:1059
 #: lib/Form/Class.FormHandler.inc.php:1737
 #: CC_entity_edit_did_destination.php:233
+#, php-format
 msgid "error deletion"
 msgstr "Error en la eliminacin"
 
@@ -1895,7 +2042,8 @@
 msgid "Create a new "
 msgstr "Crear un nuevo"
 
-#: lib/Misc.php:523 lib/Class.Notification.php:140
+#: lib/Misc.php:523
+#: lib/Class.Notification.php:140
 msgid "UNKNOWN"
 msgstr "DESCONOCIDO"
 
@@ -1903,11 +2051,13 @@
 msgid "First"
 msgstr "Primero"
 
-#: lib/Misc.php:723 A2B_entity_did.php:459
+#: lib/Misc.php:723
+#: A2B_entity_did.php:459
 msgid "Prev"
 msgstr "Previo"
 
-#: lib/Misc.php:724 A2B_entity_did.php:429
+#: lib/Misc.php:724
+#: A2B_entity_did.php:429
 msgid "Next"
 msgstr "Siguiente"
 
@@ -1935,7 +2085,10 @@
 msgid "Can't find our base_currency in cc_currencies."
 msgstr "No se encuentra base_currency in cc_currencies."
 
-#: lib/Misc.php:1130 lib/Misc.php:1153 lib/Misc.php:1157 lib/Misc.php:1167
+#: lib/Misc.php:1130
+#: lib/Misc.php:1153
+#: lib/Misc.php:1157
+#: lib/Misc.php:1167
 msgid "Currency update ABORTED."
 msgstr "Actualizacin de monedas ABORTADA."
 
@@ -1969,28 +2122,34 @@
 msgid "WARNING"
 msgstr "ESPERANDO"
 
-#: lib/interface/constants.php:18 lib/interface/constants.php:72
+#: lib/interface/constants.php:18
+#: lib/interface/constants.php:72
 #, fuzzy
 msgid "ERROR"
 msgstr "PGINA de ERROR"
 
-#: lib/interface/constants.php:24 lib/interface/constants.php:38
+#: lib/interface/constants.php:24
+#: lib/interface/constants.php:38
 msgid "ENGLISH"
 msgstr "INGLS"
 
-#: lib/interface/constants.php:25 lib/interface/constants.php:39
+#: lib/interface/constants.php:25
+#: lib/interface/constants.php:39
 msgid "SPANISH"
 msgstr "ESPAOL"
 
-#: lib/interface/constants.php:26 lib/interface/constants.php:40
+#: lib/interface/constants.php:26
+#: lib/interface/constants.php:40
 msgid "FRENCH"
 msgstr "FRANCES"
 
-#: lib/interface/constants.php:27 lib/interface/constants.php:41
+#: lib/interface/constants.php:27
+#: lib/interface/constants.php:41
 msgid "RUSSIAN"
 msgstr "RUSO"
 
-#: lib/interface/constants.php:28 lib/interface/constants.php:42
+#: lib/interface/constants.php:28
+#: lib/interface/constants.php:42
 msgid "BRAZILIAN"
 msgstr ""
 
@@ -2020,7 +2179,8 @@
 msgid "CUSTOMERS AND AGENTS"
 msgstr ""
 
-#: lib/interface/constants.php:63 A2B_entity_did.php:413
+#: lib/interface/constants.php:63
+#: A2B_entity_did.php:413
 msgid "Yes"
 msgstr "Si"
 
@@ -2044,7 +2204,8 @@
 msgid "Only dialout rate"
 msgstr "Slo tarifa de discado "
 
-#: lib/interface/constants.php:113 lib/interface/constants.php:122
+#: lib/interface/constants.php:113
+#: lib/interface/constants.php:122
 msgid "Free"
 msgstr "Gratis"
 
@@ -2060,11 +2221,13 @@
 msgid "Dial"
 msgstr "Discar"
 
-#: lib/interface/constants.php:128 lib/interface/constants.php:375
+#: lib/interface/constants.php:128
+#: lib/interface/constants.php:375
 msgid "INDIVIDUAL ACCESS"
 msgstr "ACCESO INDIVIDUAL"
 
-#: lib/interface/constants.php:129 lib/interface/constants.php:374
+#: lib/interface/constants.php:129
+#: lib/interface/constants.php:374
 msgid "SIMULTANEOUS ACCESS"
 msgstr "ACCESO SIMULTNEO"
 
@@ -2080,32 +2243,39 @@
 msgid "NO EXPIRATION"
 msgstr "SIN EXPIRACIN"
 
-#: lib/interface/constants.php:147 lib/interface/constants.php:386
+#: lib/interface/constants.php:147
+#: lib/interface/constants.php:386
 msgid "EXPIRE DATE"
 msgstr "FECHA DE VENCIMIENTO"
 
-#: lib/interface/constants.php:148 lib/interface/constants.php:387
+#: lib/interface/constants.php:148
+#: lib/interface/constants.php:387
 msgid "EXPIRE DAYS SINCE FIRST USE"
 msgstr "EXPIRA x DAS DESPUS DEL PRIMER USO"
 
-#: lib/interface/constants.php:149 lib/interface/constants.php:388
+#: lib/interface/constants.php:149
+#: lib/interface/constants.php:388
 msgid "EXPIRE DAYS SINCE CREATION"
 msgstr "EXPIRA x DAS DESPUS DE SU CREACIN"
 
-#: lib/interface/constants.php:156 lib/interface/constants.php:167
+#: lib/interface/constants.php:156
+#: lib/interface/constants.php:167
 msgid "OPEN"
 msgstr "ABIERTO"
 
-#: lib/interface/constants.php:157 lib/interface/constants.php:168
+#: lib/interface/constants.php:157
+#: lib/interface/constants.php:168
 msgid "CLOSE"
 msgstr "CERRAR"
 
-#: lib/interface/constants.php:175 lib/interface/constants.php:189
+#: lib/interface/constants.php:175
+#: lib/interface/constants.php:189
 #: lib/interface/constants.php:212
 msgid "UNPAID"
 msgstr "Impago"
 
-#: lib/interface/constants.php:176 lib/interface/constants.php:188
+#: lib/interface/constants.php:176
+#: lib/interface/constants.php:188
 #: lib/interface/constants.php:215
 msgid "PAID"
 msgstr "PAGADO"
@@ -2127,7 +2297,8 @@
 msgid "SENT-PAID"
 msgstr ""
 
-#: lib/interface/constants.php:222 CC_entity_edit_speeddial.php:1080
+#: lib/interface/constants.php:222
+#: CC_entity_edit_speeddial.php:1080
 #: CC_entity_edit_did_destination.php:1240
 msgid "New"
 msgstr "Nuevo"
@@ -2210,7 +2381,8 @@
 msgid "NOANSWER"
 msgstr "SIN RESPUESTA"
 
-#: lib/interface/constants.php:298 lib/interface/constants.php:341
+#: lib/interface/constants.php:298
+#: lib/interface/constants.php:341
 #: lib/interface/constants.php:366
 msgid "CANCEL"
 msgstr "CANCELAR"
@@ -2235,30 +2407,37 @@
 msgid "INVALIDARGS"
 msgstr ""
 
-#: lib/interface/constants.php:323 lib/interface/constants.php:355
+#: lib/interface/constants.php:323
+#: lib/interface/constants.php:355
 #, fuzzy
 msgid "ACTIVE"
 msgstr "ACTIVADO"
 
-#: lib/interface/constants.php:324 lib/interface/constants.php:341
-#: lib/interface/constants.php:356 lib/interface/constants.php:366
+#: lib/interface/constants.php:324
+#: lib/interface/constants.php:341
+#: lib/interface/constants.php:356
+#: lib/interface/constants.php:366
 #: lib/interface/constants.php:433
 msgid "CANCELLED"
 msgstr "CANCELADO"
 
-#: lib/interface/constants.php:326 lib/interface/constants.php:344
+#: lib/interface/constants.php:326
+#: lib/interface/constants.php:344
 msgid "WAITING-MAILCONFIRMATION"
 msgstr "ESPERANDO CONFIRMACIN DE EMAIL"
 
-#: lib/interface/constants.php:327 lib/interface/constants.php:345
+#: lib/interface/constants.php:327
+#: lib/interface/constants.php:345
 msgid "RESERVED"
 msgstr "RESERADO"
 
-#: lib/interface/constants.php:329 lib/interface/constants.php:347
+#: lib/interface/constants.php:329
+#: lib/interface/constants.php:347
 msgid "SUSPENDED FOR UNDERPAYMENT"
 msgstr ""
 
-#: lib/interface/constants.php:330 lib/interface/constants.php:348
+#: lib/interface/constants.php:330
+#: lib/interface/constants.php:348
 msgid "SUSPENDED FOR LITIGATION"
 msgstr "SUSPENDIDO POR LITIGIO"
 
@@ -2267,7 +2446,8 @@
 msgid "WAITING SUBSCRIPTION PAYMENT"
 msgstr "DESCRIPCIN"
 
-#: lib/interface/constants.php:344 lib/interface/constants.php:430
+#: lib/interface/constants.php:344
+#: lib/interface/constants.php:430
 msgid "WAITING"
 msgstr "ESPERANDO"
 
@@ -2380,7 +2560,8 @@
 msgid "Error : Card is actually in use!!!"
 msgstr "Error: La tarjeta est actualmente en uso!!!"
 
-#: lib/Class.A2Billing.php:3337 lib/Class.A2Billing.php:3345
+#: lib/Class.A2Billing.php:3337
+#: lib/Class.A2Billing.php:3345
 #: lib/Class.A2Billing.php:3353
 msgid "Error : Card have expired!!!"
 msgstr "Error: La Tarjeta  ha Expirado"
@@ -2588,8 +2769,11 @@
 msgid "Amount"
 msgstr "Monto"
 
-#: checkout_confirmation.php:166 A2B_invoice_view.php:217
-#: A2B_invoice_view.php:274 A2B_billing_preview.php:279 userinfo.php:250
+#: checkout_confirmation.php:166
+#: A2B_invoice_view.php:217
+#: A2B_invoice_view.php:274
+#: A2B_billing_preview.php:279
+#: userinfo.php:250
 #: userinfo.php:276
 msgid "VAT"
 msgstr "IVA"
@@ -2647,7 +2831,8 @@
 msgid "Remove this Speed Dial"
 msgstr "Borrar este Marcador Rpido"
 
-#: CC_entity_edit_speeddial.php:1061 CC_entity_edit_did_destination.php:1223
+#: CC_entity_edit_speeddial.php:1061
+#: CC_entity_edit_did_destination.php:1223
 msgid "Delete"
 msgstr "Borrar"
 
@@ -2655,7 +2840,8 @@
 msgid "Deletetion"
 msgstr "Eliminacin"
 
-#: CC_entity_edit_speeddial.php:1080 CC_entity_edit_did_destination.php:1240
+#: CC_entity_edit_speeddial.php:1080
+#: CC_entity_edit_did_destination.php:1240
 msgid "Inserted"
 msgstr "Insertado"
 
@@ -2697,7 +2883,9 @@
 msgid "INVOICE"
 msgstr "FACTURA"
 
-#: A2B_invoice_view.php:163 A2B_invoice_view.php:180 A2B_receipt_view.php:155
+#: A2B_invoice_view.php:163
+#: A2B_invoice_view.php:180
+#: A2B_receipt_view.php:155
 msgid "VAT nr."
 msgstr "VAT nr."
 
@@ -2713,12 +2901,19 @@
 msgid "mail"
 msgstr "mail"
 
-#: A2B_invoice_view.php:190 A2B_invoice_view.php:214
-#: A2B_receipt_detail.php:118 A2B_receipt_detail.php:137 card-history.php:75
-#: A2B_billing_preview.php:162 A2B_billing_preview.php:183
-#: A2B_billing_preview.php:255 A2B_billing_preview.php:276
-#: A2B_receipt_preview_detail.php:215 call-history.php:130
-#: A2B_receipt_view.php:179 A2B_receipt_view.php:200
+#: A2B_invoice_view.php:190
+#: A2B_invoice_view.php:214
+#: A2B_receipt_detail.php:118
+#: A2B_receipt_detail.php:137
+#: card-history.php:75
+#: A2B_billing_preview.php:162
+#: A2B_billing_preview.php:183
+#: A2B_billing_preview.php:255
+#: A2B_billing_preview.php:276
+#: A2B_receipt_preview_detail.php:215
+#: call-history.php:130
+#: A2B_receipt_view.php:179
+#: A2B_receipt_view.php:200
 msgid "Date"
 msgstr "FECHA"
 
@@ -2726,28 +2921,35 @@
 msgid "Invoice number"
 msgstr "Nmero de factura"
 
-#: A2B_invoice_view.php:199 A2B_receipt_view.php:185
+#: A2B_invoice_view.php:199
+#: A2B_receipt_view.php:185
 msgid "Client Account Number"
 msgstr "Nmero de cuenta de cliente"
 
-#: A2B_invoice_view.php:216 A2B_billing_preview.php:278
+#: A2B_invoice_view.php:216
+#: A2B_billing_preview.php:278
 msgid "Cost excl. VAT"
 msgstr "Costo sin IVA"
 
-#: A2B_invoice_view.php:218 A2B_billing_preview.php:280
+#: A2B_invoice_view.php:218
+#: A2B_billing_preview.php:280
 msgid "Cost incl. VAT"
 msgstr "Costo con IVA"
 
-#: A2B_invoice_view.php:267 A2B_billing_preview.php:327
+#: A2B_invoice_view.php:267
+#: A2B_billing_preview.php:327
 msgid "Subtotal excl. VAT:"
 msgstr "Subtotal sin IVA:"
 
-#: A2B_invoice_view.php:280 A2B_billing_preview.php:340
+#: A2B_invoice_view.php:280
+#: A2B_billing_preview.php:340
 msgid "Total incl. VAT:"
 msgstr "Total con IVA:"
 
-#: A2B_receipt_detail.php:90 A2B_receipt_detail.php:97
-#: A2B_receipt_preview_detail.php:169 A2B_receipt_preview_detail.php:176
+#: A2B_receipt_detail.php:90
+#: A2B_receipt_detail.php:97
+#: A2B_receipt_preview_detail.php:169
+#: A2B_receipt_preview_detail.php:176
 msgid "Page"
 msgstr ""
 
@@ -2755,18 +2957,22 @@
 msgid "RECEIPT DETAIL"
 msgstr "DETALLE DE RECIBO"
 
-#: A2B_receipt_detail.php:139 A2B_billing_preview.php:185
-#: A2B_receipt_preview_detail.php:217 call-history.php:137
+#: A2B_receipt_detail.php:139
+#: A2B_billing_preview.php:185
+#: A2B_receipt_preview_detail.php:217
+#: call-history.php:137
 #: A2B_receipt_view.php:202
 msgid "Cost"
 msgstr "Costo"
 
-#: A2B_receipt_detail.php:175 A2B_receipt_preview_detail.php:254
+#: A2B_receipt_detail.php:175
+#: A2B_receipt_preview_detail.php:254
 #, fuzzy
 msgid "Total Page"
 msgstr "Total:"
 
-#: A2B_receipt_detail.php:182 A2B_receipt_preview_detail.php:260
+#: A2B_receipt_detail.php:182
+#: A2B_receipt_preview_detail.php:260
 #, fuzzy
 msgid "Total Receipt :"
 msgstr "Total:"
@@ -2779,71 +2985,123 @@
 msgid "SELECT BY MONTH"
 msgstr "SELECCIONAR POR MES"
 
-#: card-history.php:213 card-history.php:264 call-history.php:264
+#: card-history.php:213
+#: card-history.php:264
+#: call-history.php:264
 msgid "FROM"
 msgstr "DESDE"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "JANUARY"
 msgstr "ENERO"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "FEBRUARY"
 msgstr "FEBREO"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "MARCH"
 msgstr "MARZO"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "APRIL"
 msgstr "ABRIL"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "MAY"
 msgstr "MAYO"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "JUNE"
 msgstr "JUNIO"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "JULY"
 msgstr "JULIO"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "AUGUST"
 msgstr "AGOSTO"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "SEPTEMBER"
 msgstr "SEPTIEMBRE"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "OCTOBER"
 msgstr "OCTUBRE"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "NOVEMBER"
 msgstr "NOVIEMBRE"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "DECEMBER"
 msgstr "DICIEMBRE"
 
-#: card-history.php:233 card-history.php:292 call-history.php:292
+#: card-history.php:233
+#: card-history.php:292
+#: call-history.php:292
 msgid "TO"
 msgstr "Hasta"
 
@@ -2851,7 +3109,8 @@
 msgid "SELECT BY DAY"
 msgstr "SELECCIONAR POR DA"
 
-#: card-history.php:326 call-history.php:407
+#: card-history.php:326
+#: call-history.php:407
 msgid "Search"
 msgstr "Buscar"
 
@@ -2946,11 +3205,13 @@
 msgid "PREVIEW NEXT RECEIPT"
 msgstr "VISTA PREVIA DE FACTURA"
 
-#: A2B_billing_preview.php:169 A2B_billing_preview.php:262
+#: A2B_billing_preview.php:169
+#: A2B_billing_preview.php:262
 msgid "Client number"
 msgstr "Nmero de cliente"
 
-#: A2B_billing_preview.php:221 A2B_receipt_view.php:238
+#: A2B_billing_preview.php:221
+#: A2B_receipt_view.php:238
 msgid "Total:"
 msgstr "Total:"
 
@@ -3014,7 +3275,8 @@
 msgid "Username"
 msgstr "Nombre"
 
-#: A2B_entity_sipiax_info.php:118 templates/default/index.tpl:61
+#: A2B_entity_sipiax_info.php:118
+#: templates/default/index.tpl:61
 #, fuzzy
 msgid "Password"
 msgstr "Contrasea antigua"
@@ -3049,7 +3311,9 @@
 msgid "Speed Dial code"
 msgstr "Cdigo de Discado Rpido"
 
-#: A2B_entity_speeddial.php:109 call-history.php:133 A2B_entity_did.php:415
+#: A2B_entity_speeddial.php:109
+#: call-history.php:133
+#: A2B_entity_did.php:415
 msgid "Destination"
 msgstr "Destino"
 
@@ -3230,7 +3494,8 @@
 msgid "DID_VOIP"
 msgstr ""
 
-#: call-history.php:119 templates/default/main.tpl:78
+#: call-history.php:119
+#: templates/default/main.tpl:78
 msgid "CALLBACK"
 msgstr "CALLBACK"
 
@@ -3370,23 +3635,28 @@
 msgid "Welcome! Your account has been successfully activated. Thank you!"
 msgstr "Bienvenido! Su cuenta ha sido activada. Muchas gracias!"
 
-#: activate.php:105 signup_confirmation.php:115
+#: activate.php:105
+#: signup_confirmation.php:115
 msgid "Thank you for registering with us !"
 msgstr "Muchas gracias por registrarse con nosotros!"
 
-#: activate.php:106 signup_confirmation.php:116
+#: activate.php:106
+#: signup_confirmation.php:116
 msgid "An email confirming your information has been sent to"
 msgstr "Su informacin para login ha sido enviada por email a "
 
-#: activate.php:108 signup_confirmation.php:118
+#: activate.php:108
+#: signup_confirmation.php:118
 msgid "Your cardnumber is "
 msgstr "Su nmero de tarjeta es"
 
-#: activate.php:109 signup_confirmation.php:119
+#: activate.php:109
+#: signup_confirmation.php:119
 msgid "To login to your account :"
 msgstr "Para ingresar a su cuenta:"
 
-#: activate.php:110 signup_confirmation.php:120
+#: activate.php:110
+#: signup_confirmation.php:120
 msgid "Your card alias (login) is "
 msgstr "Su alias (login) es"
 
@@ -3499,7 +3769,8 @@
 msgid "Forgot your password ?"
 msgstr "Olvid la contrasea?"
 
-#: templates/default/index.tpl:95 templates/default/index.tpl:98
+#: templates/default/index.tpl:95
+#: templates/default/index.tpl:98
 msgid "Click here"
 msgstr ""
 
@@ -3634,7 +3905,9 @@
 msgid "Add phone number"
 msgstr "Agregar Nmero Telefnico"
 
-#: A2B_entity_did.php:433 A2B_entity_did.php:462 A2B_entity_did.php:485
+#: A2B_entity_did.php:433
+#: A2B_entity_did.php:462
+#: A2B_entity_did.php:485
 msgid "Ok"
 msgstr "Ok"
 
@@ -3706,6 +3979,30 @@
 msgid "USE VOUCHER"
 msgstr "USA VOUCHER"
 
+msgid "CALL - REAL TIME"
+msgstr "LLAMADAS - ACTUAL"
+
+msgid "CALL - HISTORY"
+msgstr "LLAMADAS - HISTRICO"
+
+msgid "This section presents historical information except the last two days."
+msgstr "Esta seccin presenta informacin histrica excepto los dos ltimos das."
+
+msgid "This sections presents information only the last two days."
+msgstr "Esta seccin presenta unicamente informacin de los dos ltimos das."
+
+msgid "CDR TO DOWNLOAD"
+msgstr "DESCARGA REGISTRO DE LLAMADAS"
+
+msgid "CDR Date"
+msgstr "Fecha - Registro de llamadas"
+
+msgid "File to Download"
+msgstr "Archivo para descarga"
+
+msgid "CDR File"
+msgstr "Archivo"
+
 #~ msgid "Source"
 #~ msgstr "Origen"
 
diff -urN -x lib a2billing_v1.9.4/Cronjobs/a2billing_archive_data_cront.php a2billing/Cronjobs/a2billing_archive_data_cront.php
--- a2billing_v1.9.4/Cronjobs/a2billing_archive_data_cront.php	2011-05-31 16:39:39.000000000 -0300
+++ a2billing/Cronjobs/a2billing_archive_data_cront.php	2012-09-20 12:37:06.000000000 -0300
@@ -1,108 +1,264 @@
-#!/usr/bin/php -q
-<?php
-
-/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
-
-/**
- * This file is part of A2Billing (http://www.a2billing.net/)
- *
- * A2Billing, Commercial Open Source Telecom Billing platform,   
- * powered by Star2billing S.L. <http://www.star2billing.com/>
- * 
- * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
- * @author      Belaid Arezqui <areski@gmail.com>
- * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
- * @package     A2Billing
- *
- * Software License Agreement (GNU Affero General Public License)
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU Affero General Public License as
- * published by the Free Software Foundation, either version 3 of the
- * License, or (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU Affero General Public License for more details.
- *
- * You should have received a copy of the GNU Affero General Public License
- * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- * 
- * 
-**/
-
-/***************************************************************************
- *            a2billing_archive_data_cront.php
- *
- *  Fri Oct 28 11:51:08 2005
- *  Copyright  2005  User
- *  ADD THIS SCRIPT IN A CRONTAB JOB
- *
-	crontab -e
-	0 12 * * * php /usr/local/a2billing/Cronjobs/a2billing_archive_data_cront.php
-	
-	field	 allowed values
-	-----	 --------------
-	minute	 		0-59
-	hour		 	0-23
-	day of month	1-31
-	month	 		1-12 (or names, see below)
-	day of week	 	0-7 (0 or 7 is Sun, or use names)
-
-	
-****************************************************************************/
-
-set_time_limit(0);
-error_reporting(E_ALL ^ (E_NOTICE | E_WARNING));
-
-include (dirname(__FILE__) . "/lib/admin.defines.php");
-include (dirname(__FILE__) . "/lib/ProcessHandler.php");
-
-if (!defined('PID')) {
-	define("PID", "/var/run/a2billing/a2billing_archive_data_cront_pid.php");
-}
-
-// CHECK IF THE CRONT PROCESS IS ALREADY RUNNING
-if (ProcessHandler :: isActive()) {
-	die(); // Already running!
-} else {
-	ProcessHandler :: activate();
-}
-
-$A2B = new A2Billing();
-$A2B->load_conf($agi, NULL, 0, $idconfig);
-
-write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . "[#### ARCHIVING DATA BEGIN ####]");
-
-if (!$A2B->DbConnect()) {
-	echo "[Cannot connect to the database]\n";
-	write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . "[Cannot connect to the database]");
-	exit;
-}
-
-$A2B = new A2Billing();
-$A2B->load_conf($agi, NULL, 0, $idconfig);
-
-$instance_table = new Table();
-
-$prior_x_month = $A2B->config["backup"]['archive_call_prior_x_month'];
-
-if ($A2B->config["database"]['dbtype'] == "postgres") {
-    $condition = "CURRENT_TIMESTAMP - interval '$prior_x_month months' > starttime";
-} else {
-    $condition = "DATE_SUB(NOW(),INTERVAL $prior_x_month MONTH) > starttime";
-}
-
-$value = "SELECT sessionid, uniqueid, card_id, nasipaddress, starttime, stoptime, sessiontime, calledstation, sessionbill, id_tariffgroup, id_tariffplan, id_ratecard, id_trunk, sipiax, src, id_did, buycost, id_card_package_offer, real_sessiontime, dnid, terminatecauseid, destination FROM cc_call WHERE $condition";
-$func_fields = "sessionid, uniqueid, card_id, nasipaddress, starttime, stoptime, sessiontime, calledstation, sessionbill, id_tariffgroup, id_tariffplan, id_ratecard, id_trunk, sipiax, src, id_did, buycost, id_card_package_offer, real_sessiontime, dnid, terminatecauseid, destination";
-$func_table = 'cc_call_archive';
-$id_name = "";
-$subquery = true;
-$result = $instance_table->Add_table($A2B->DBHandle, $value, $func_fields, $func_table, $id_name, $subquery);
-
-$fun_table = "cc_call";
-$result = $instance_table->Delete_table($A2B->DBHandle, $condition, $fun_table);
-write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . "[#### ARCHIVING DATA END ####]");
-
-
+#!/usr/bin/php -q
+<?php
+
+/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
+
+/**
+ * This file is part of A2Billing (http://www.a2billing.net/)
+ *
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
+ * powered by Star2billing S.L. <http://www.star2billing.com/>
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
+ * @author      Belaid Arezqui <areski@gmail.com>
+ * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
+ * @package     A2Billing
+ *
+ * Software License Agreement (GNU Affero General Public License)
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Affero General Public License as
+ * published by the Free Software Foundation, either version 3 of the
+ * License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Affero General Public License for more details.
+ *
+ * You should have received a copy of the GNU Affero General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ * 
+ * 
+**/
+
+/***************************************************************************
+ *            a2billing_archive_data_cront.php
+ *
+ *  Fri Oct 28 11:51:08 2005
+ *  Copyright  2005  User
+ *  ADD THIS SCRIPT IN A CRONTAB JOB
+ *
+	crontab -e
+	0 12 * * * php /usr/local/a2billing/Cronjobs/a2billing_archive_data_cront.php
+	
+	field	 allowed values
+	-----	 --------------
+	minute	 		0-59
+	hour		 	0-23
+	day of month	1-31
+	month	 		1-12 (or names, see below)
+	day of week	 	0-7 (0 or 7 is Sun, or use names)
+
+	
+****************************************************************************/
+
+set_time_limit(0);
+error_reporting(E_ALL ^ (E_NOTICE | E_WARNING));
+
+include (dirname(__FILE__) . "/lib/admin.defines.php");
+require_once ("lib/iam_csvdump.php");
+include (dirname(__FILE__) . "/lib/ProcessHandler.php");
+
+if (!defined('PID')) {
+	define("PID", "/var/www/html/billing/a2billing_archive_data_cront_pid.php");
+}
+
+// CHECK IF THE CRONT PROCESS IS ALREADY RUNNING
+if (ProcessHandler :: isActive()) {
+	die(); // Already running!
+} else {
+	ProcessHandler :: activate();
+}
+
+$A2B = new A2Billing();
+$A2B->load_conf($agi, NULL, 0, $idconfig);
+
+write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . "[#### ARCHIVING DATA BEGIN ####]");
+
+if (!$A2B->DbConnect()) {
+	echo "[Cannot connect to the database]\n";
+	write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . "[Cannot connect to the database]");
+	exit;
+}
+
+$A2B = new A2Billing();
+$A2B->load_conf($agi, NULL, 0, $idconfig);
+
+$DBHandle = DbConnect();
+
+// Verifico que exista la tabla cc_call_archive, si no existe la creo.
+$Query = "CREATE TABLE IF NOT EXISTS cc_call_archive (id bigint(20) NOT NULL auto_increment ,sessionid varchar(40) collate utf8_bin NOT NULL ,uniqueid varchar(30) collate utf8_bin NOT NULL, ";
+$Query .= "card_id bigint(20) NOT NULL , nasipaddress varchar(30) collate utf8_bin NOT NULL , starttime timestamp NOT NULL default CURRENT_TIMESTAMP , ";
+$Query .= "stoptime timestamp NOT NULL default '0000-00-00 00:00:00' , sessiontime int(11) default NULL, calledstation varchar(50) collate utf8_bin NOT NULL , ";
+$Query .= "sessionbill float default NULL , id_tariffgroup int(11) default NULL , id_tariffplan int(11) default NULL , id_ratecard int(11) default NULL , ";
+$Query .= "id_trunk int(11) default NULL , sipiax int(11) default '0' ,  src varchar(40) collate utf8_bin NOT NULL ,  id_did int(11) default NULL , ";
+$Query .= "buycost decimal(15,5) default '0.00000' ,  id_card_package_offer int(11) default '0' ,  real_sessiontime int(11) default NULL , ";
+$Query .= "dnid varchar(40) collate utf8_bin NOT NULL , terminatecauseid int(1) default '1' , destination int(11) default '0' ," ;
+$Query .= "PRIMARY KEY  (id),  KEY starttime (starttime),  KEY calledstation (calledstation),  KEY terminatecauseid ";
+$Query .= "(terminatecauseid)) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_bin";
+
+$res = $DBHandle -> Execute($Query);
+
+// PRIMERO REALIZO EL RENAME DE LA cc_call PARA PASAR TODO A UNA TABLA TEMPORAL 
+write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [Comienzo el switch (REANME) de la tabla de tiempo real]");
+$actual_date = date("YmdHis");
+$temp_table = "cc_call_tmp_".$actual_date;
+
+$Query = "DROP TABLE IF EXISTS cc_call_vacia";
+$res = $DBHandle -> Execute($Query);
+
+$Query = "CREATE TABLE cc_call_vacia (id bigint(20) NOT NULL auto_increment ,sessionid varchar(40) collate utf8_bin NOT NULL ,uniqueid varchar(30) collate utf8_bin NOT NULL, ";
+$Query .= "card_id bigint(20) NOT NULL , nasipaddress varchar(30) collate utf8_bin NOT NULL , starttime timestamp NOT NULL default CURRENT_TIMESTAMP , ";
+$Query .= "stoptime timestamp NOT NULL default '0000-00-00 00:00:00' , sessiontime int(11) default NULL, calledstation varchar(50) collate utf8_bin NOT NULL , ";
+$Query .= "sessionbill float default NULL , id_tariffgroup int(11) default NULL , id_tariffplan int(11) default NULL , id_ratecard int(11) default NULL , ";
+$Query .= "id_trunk int(11) default NULL , sipiax int(11) default '0' ,  src varchar(40) collate utf8_bin NOT NULL ,  id_did int(11) default NULL , ";
+$Query .= "buycost decimal(15,5) default '0.00000' ,  id_card_package_offer int(11) default '0' ,  real_sessiontime int(11) default NULL , ";
+$Query .= "dnid varchar(40) collate utf8_bin NOT NULL , terminatecauseid int(1) default '1' , destination int(11) default '0' ," ;
+$Query .= "PRIMARY KEY  (id),  KEY starttime (starttime),  KEY calledstation (calledstation),  KEY terminatecauseid ";
+$Query .= "(terminatecauseid)) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_bin";
+
+$res = $DBHandle -> Execute($Query);
+if  ($res) {
+	$Query = "RENAME TABLE cc_call TO $temp_table , cc_call_vacia TO cc_call;";
+	$res = $DBHandle -> Execute($Query);
+	if ($res) {
+		write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [Comienzo copia de datos desde Temporal a cc_call_archive.]");
+		//-------------------------COPIA DATOS A LA HISTORICA -------------------------------------------
+		$Query = "INSERT INTO cc_call_archive (sessionid, uniqueid, card_id, nasipaddress, starttime, stoptime, sessiontime, calledstation, sessionbill, ";
+		$Query .= "id_tariffgroup, id_tariffplan, id_ratecard, id_trunk, sipiax, src, id_did, buycost, id_card_package_offer, real_sessiontime, dnid, ";
+		$Query .= "terminatecauseid, destination) ";
+		$Query .= "(SELECT sessionid, uniqueid, card_id, nasipaddress, starttime, stoptime, sessiontime, calledstation, sessionbill, ";
+		$Query .= "id_tariffgroup, id_tariffplan, id_ratecard, id_trunk, sipiax, src, id_did, buycost, id_card_package_offer, real_sessiontime, dnid, ";
+		$Query .= "terminatecauseid, destination ";
+		$Query .= "FROM $temp_table)";
+		
+		$res = $DBHandle -> Execute($Query);
+		
+		if ($res) {
+			//-------------------------GENERO ARCHIVO CON INFO DEL DIA -------------------------------------------
+			$dumpfile = new iam_csvdump;
+			
+			//Obtengo offset del server respecto a UTC
+			$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
+			foreach ($timezone_list as $key => $timezone_list_val) {
+				$server_offset = $timezone_list_val[3];
+				break;
+			}
+			
+			//Verifico si existe la carpeta destino, sino la creo
+			$dirname = "/var/www/html/billing/customer_cdr/";
+			if (!file_exists($filename)) {
+				mkdir("$dirname");
+				chmod("$dirname", 0777);
+			}
+			
+			// Obtengo accounts
+			$Query = "SELECT cc.id,ct.gmtoffset, cc.currency FROM cc_card cc LEFT JOIN cc_timezone AS ct ON ct.id = cc.id_timezone";
+			$res = $DBHandle -> Execute($Query);
+			if ($res) {
+				$num = $res -> RecordCount();
+				for($i=0;$i<$num;$i++) {				
+					$cards [] =$res -> fetchRow();
+				}
+				foreach ($cards as $datarow){
+					
+					$card_id = $datarow ['0'];
+					$gmtoffset_card = $datarow ['1'];
+					$currency_card = $datarow ['2'];
+					write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [Comienzo generacion de archivo CDR para ACCOUNT: $card_id]");
+					
+					//Verifico si existe la carpeta destino para el customer, sino la creo
+					$dirname_customer = "$dirname".$card_id."/";
+					if (!file_exists($dirname_customer)) {
+						mkdir("$dirname_customer");
+						chmod("$dirname_customer", 0777);
+					}
+					$date_offset = (-($server_offset - $gmtoffset_card)) / 60 / 60 ;						
+					
+					//Dia actual 
+					$actual_day = date("Y-m-d");
+					
+					//Resto dos dias para obtener la fecha inicial a generar
+					$menos2day = - 48;
+					$timestamp =$dumpfile->date_add_hour ($actual_day,$menos2day);
+					$initial_day_tmp = date("Y-m-d", $timestamp);
+					
+					//Sumo el offset para obtener fecha y hora inicial.
+					$timestamp =$dumpfile->date_add_hour ($initial_day_tmp,-$date_offset);
+					$initial_day = date("Y-m-d H:i:s", $timestamp);
+
+					$initial_day_file = date("Ymd", $timestamp);
+					
+					$timestamp = $dumpfile->date_add_hour($initial_day, 24);
+					$end_day = date("Y-m-d H:i:s", $timestamp);
+					
+
+					$Query = "SELECT t1.starttime as DATE , t1.src as CALLERID , t1.calledstation as PHONENUMBER, t3.destination as Destination,  t4.buyrate, t4.rateinitial, ";
+					$Query .= "t1.sessiontime AS Duration, t2.trunkcode as trunkcode, ";
+					$Query .= "CASE t1.terminatecauseid WHEN 1 THEN 'ANSWER' WHEN 2 THEN 'BUSY' WHEN '3' THEN 'NOANSWER' WHEN 4 THEN 'CANCEL' WHEN 5 THEN 'CONGESTION'  ";
+					$Query .= "WHEN 6 THEN 'CHANUNAVAIL' WHEN 7 THEN 'DONTCALL' WHEN 8 THEN 'TORTURE' WHEN 9 THEN 'INVALIDARGS' END,  ";
+					$Query .= "t1.buycost, t1.sessionbill, case when t1.sessionbill!=0 then ((t1.sessionbill-t1.buycost)/t1.sessionbill)*100 else 0 end as margin, ";
+					$Query .= "case when t1.buycost!=0 then ((t1.sessionbill-t1.buycost)/t1.buycost)*100 else 0 end as markup ";
+					$Query .= "FROM cc_call_archive t1  ";
+					$Query .= "LEFT OUTER JOIN cc_trunk t2 ON t1.id_trunk = t2.id_trunk  ";
+					$Query .= "LEFT OUTER JOIN cc_ratecard t4 ON t1.id_ratecard = t4.id ";
+					$Query .= "LEFT OUTER JOIN cc_prefix t3 on t1.destination = t3.prefix ";
+					$Query .= "WHERE t1.starttime >= ('$initial_day') and t1.starttime <= ('$end_day') and t1.card_id='$card_id' ORDER BY t1.starttime ASC";		
+
+					$file_name =  $dirname_customer.$card_id."_".$initial_day_file;
+					write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [file_name -> $file_name]");
+					
+					write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [initial_day -> $initial_day]");
+					write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [end_day -> $end_day]");
+					
+					$header = '"Date","CallerID","PhoneNumber","Destination","BuyRate","RateInitial","Duration","TrunkCode","TerminateCause","BuyCost","SessionBill","Margin","Markup"';
+					$dumpfile->dump_job($Query, $file_name, "csv", DBNAME, USER, PASS, HOST, DB_TYPE, $header, $gmtoffset_card,$currency_card);
+					
+					//Dia actual 
+					$actual_day = date("Y-m-d");
+					
+					//------------------- BORRO ARCHIVO CDR DE 35 DIAS HACIA ATRAS --------------------------------------		
+					$menos36day = - 864; // 864 horas = 36 dias					
+					//Resto 36 dias para obtener el nombre del archivo a borrar
+					$timestamp =$dumpfile->date_add_hour ($actual_day,$menos36day);
+					$day_tmp = date("Ymd", $timestamp);
+					write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [Borro archivo CDR de mas de 35 dias para ACCOUNT: $card_id.]");
+					$nom_archive = 	$dirname_customer.$card_id."_".$day_tmp.".zip";
+					write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [nom_archive -> $nom_archive]");
+					unlink($nom_archive);
+				
+					//------------------- BORRO INFO DE 35 DIAS HACIA ATRAS DE LA TABLA HISTORICA ------------------------
+					$menos35day = - 840; // 840 horas = 35 dias
+					//Resto 35 dias para obtener fecha a partir de la cual debo borrar
+					$timestamp =$dumpfile->date_add_hour ($actual_day,$menos35day);
+					$day_tmp = date("Ymd", $timestamp);
+					//Sumo el offset para obtener fecha y hora inicial.
+					$timestamp =$dumpfile->date_add_hour ($day_tmp,-$date_offset);
+					$initial_day = date("Y-m-d H:i:s", $timestamp);
+										
+					write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [Borro informacion anterior a 35 dias para ACCOUNT: $card_id.]");
+					$Query = "DELETE FROM cc_call_archive where starttime < ('$initial_day') and card_id='$card_id'; " ;
+					$res = $DBHandle -> Execute($Query);
+				}
+			}
+			write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [Borro tabla temporal.]");
+			//-------------------------BORRO TEMPORAL ------------------------------------------------------------
+			$Query = "DROP TABLE IF EXISTS $temp_table";
+			$res = $DBHandle -> Execute($Query);
+			
+			
+			
+		} else {
+			write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [NO SE PUDO INSERTAR DATOS EN LA HISTORICA.]");
+		}
+	} else {
+		write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [NO SE PUDO HACER EL RENAME.]");
+	}
+} else {
+	write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [NO SE PUDO CREAR LA TEMPORAL.]");
+}
+
+write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . "[#### ARCHIVING DATA END ####]");
+
+
diff -urN -x lib a2billing_v1.9.4/customer/call-history.php a2billing/customer/call-history.php
--- a2billing_v1.9.4/customer/call-history.php	2011-05-31 16:39:39.000000000 -0300
+++ a2billing/customer/call-history.php	2012-09-20 13:07:30.000000000 -0300
@@ -1,666 +1,778 @@
-<?php
-
-/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
-
-/**
- * This file is part of A2Billing (http://www.a2billing.net/)
- *
- * A2Billing, Commercial Open Source Telecom Billing platform,   
- * powered by Star2billing S.L. <http://www.star2billing.com/>
- * 
- * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
- * @author      Belaid Arezqui <areski@gmail.com>
- * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
- * @package     A2Billing
- *
- * Software License Agreement (GNU Affero General Public License)
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU Affero General Public License as
- * published by the Free Software Foundation, either version 3 of the
- * License, or (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU Affero General Public License for more details.
- *
- * You should have received a copy of the GNU Affero General Public License
- * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- * 
- * 
-**/
-
-
-include ("lib/customer.defines.php");
-include ("lib/customer.module.access.php");
-include ("lib/customer.smarty.php");
-
-
-if (! has_rights (ACX_CALL_HISTORY)) { 
-	Header ("HTTP/1.0 401 Unauthorized");
-	Header ("Location: PP_error.php?c=accessdenied");	   
-	die();
-}
-
-getpost_ifset(array('posted', 'Period', 'frommonth', 'fromstatsmonth', 'tomonth', 'tostatsmonth', 'fromday', 'fromstatsday_sday', 'fromstatsmonth_sday', 'today', 'tostatsday_sday', 'tostatsmonth_sday', 'phonenumbertype', 'sourcetype', 'clidtype', 'channel', 'resulttype', 'stitle', 'atmenu', 'current_page', 'order', 'sens', 'phonenumber', 'src', 'clid', 'choose_currency', 'terminatecauseid', 'choose_calltype', 'download', 'file'));
-
-
-if (($download == "file") && $file && $ACXSEERECORDING) {
-	
-	if (strpos($file, '/') !== false) exit;
-	
-	$value_de = base64_decode ( $file );
-	$dl_full = MONITOR_PATH . "/" . $value_de;
-	$dl_name = $value_de;
-	
-	if (! file_exists ( $dl_full )) {
-		echo gettext ( "ERROR: Cannot download file " . $dl_full . ", it does not exist.<br>" );
-		exit ();
-	}
-	
-	header ( "Content-Type: application/octet-stream" );
-	header ( "Content-Disposition: attachment; filename=$dl_name" );
-	header ( "Content-Length: " . filesize ( $dl_full ) );
-	header ( "Accept-Ranges: bytes" );
-	header ( "Pragma: no-cache" );
-	header ( "Expires: 0" );
-	header ( "Cache-Control: must-revalidate, post-check=0, pre-check=0" );
-	header ( "Content-transfer-encoding: binary" );
-	
-	@readfile ( $dl_full );
-	exit ();
-}
-
-
-$QUERY = "SELECT username, credit, lastname, firstname, address, city, state, country, zipcode, phone, email, fax, lastuse, activated, status FROM cc_card WHERE username = '".$_SESSION["pr_login"]."' AND uipass = '".$_SESSION["pr_password"]."'";
-
-$DBHandle_max = DbConnect();
-$numrow = 0;
-$resmax = $DBHandle_max -> Execute($QUERY);
-if ($resmax)
-	$numrow = $resmax -> RecordCount();
-
-if ($numrow == 0) exit();
-$customer_info =$resmax -> fetchRow();
-
-if ($customer_info[14] != "1" && $customer_info[14] != "8") {
-	Header("HTTP/1.0 401 Unauthorized");
-	Header("Location: PP_error.php?c=accessdenied");
-	die();
-}
-
-$customer = $_SESSION["card_id"];
-
-
-$dialstatus_list = Constants::getDialStatusList();
-
-if (!isset ($current_page) || ($current_page == "")) {
-	$current_page=0;
-}
-
-$FG_DEBUG = 0;
-$FG_TABLE_NAME="cc_call t1";
-
-// THIS VARIABLE DEFINE THE COLOR OF THE HEAD TABLE
-$FG_TABLE_ALTERNATE_ROW_COLOR[] = "#FFFFFF";
-$FG_TABLE_ALTERNATE_ROW_COLOR[] = "#F2F8FF";
-
-$yesno = array();
-$yesno["1"] = array( "Yes", "1");
-$yesno["0"] = array( "No", "0");
-
-// 0 = NORMAL CALL ; 1 = VOIP CALL (SIP/IAX) ; 2= DIDCALL + TRUNK ; 3 = VOIP CALL DID ; 4 = CALLBACK call
-$list_calltype = array(); 
-$list_calltype["0"]  = array( gettext("STANDARD"), "0");
-$list_calltype["1"]  = array( gettext("SIP/IAX"), "1");
-$list_calltype["2"]  = array( gettext("DIDCALL"), "2");
-$list_calltype["3"]  = array( gettext("DID_VOIP"), "3");
-$list_calltype["4"]  = array( gettext("CALLBACK"), "4");
-$list_calltype["5"]  = array( gettext("PREDICT"), "5");
-$list_calltype ["6"] = array (gettext("AUTO DIALER"), "6" );
-$list_calltype ["7"] = array (gettext("DID-ALEG"), "7" );
-
-$DBHandle  = DbConnect();
-
-$FG_TABLE_DEFAULT_ORDER = "t1.starttime";
-$FG_TABLE_DEFAULT_SENS = "DESC";
-
-$FG_TABLE_COL = array();
-$FG_TABLE_COL[]=array (gettext("Date"), "starttime", "17%", "center", "SORT", "22", "", "", "", "", "", "");
-$FG_TABLE_COL[]=array (gettext("CallerID"), "source", "14%", "center", "SORT", "30");
-$FG_TABLE_COL[]=array (gettext("PhoneNumber"), "calledstation", "14%", "center", "SORT", "30", "", "", "", "", "", "");
-$FG_TABLE_COL[]=array (gettext("Destination"), "destination", "14%", "center", "SORT", "30", "lie", "cc_prefix", "destination", "prefix='%id'", "%1" );
-$FG_TABLE_COL[]=array (gettext("Duration"), "sessiontime", "10%", "center", "SORT", "30", "", "", "", "", "", "display_minute");
-$FG_TABLE_COL[]=array ('<acronym title="'.gettext("Terminate Cause").'">'.gettext("TC").'</acronym>', "terminatecauseid", "10%", "center", "SORT", "", "list", $dialstatus_list);
-$FG_TABLE_COL[]=array (gettext("CallType"), "sipiax", "12%", "center", "SORT",  "", "list", $list_calltype);
-$FG_TABLE_COL[]=array (gettext("Cost"), "sessionbill", "12%", "center", "SORT", "30", "", "", "", "", "", "display_2bill");
-
-if ($ACXSEERECORDING) {
-	$FG_TABLE_COL [] = array ("", "uniqueid", "1%", "center", "", "30", "", "", "", "", "", "linkonmonitorfile_customer" );
-}
-
-$FG_COL_QUERY = 't1.starttime, t1.src, t1.calledstation, t1.destination, t1.sessiontime, t1.terminatecauseid, t1.sipiax, t1.sessionbill';
-
-if ($ACXSEERECORDING) {
-	$FG_COL_QUERY .= ', t1.uniqueid';
-}
-
-$FG_LIMITE_DISPLAY = 25;
-$FG_NB_TABLE_COL = count($FG_TABLE_COL);
-$FG_EDITION = true;
-$FG_TOTAL_TABLE_COL = $FG_NB_TABLE_COL;
-if ($FG_DELETION || $FG_EDITION) $FG_TOTAL_TABLE_COL++;
-$FG_HTML_TABLE_TITLE = " - ".gettext("Call Logs")." - ";
-$FG_HTML_TABLE_WIDTH = "98%";
-
-
-$instance_table = new Table($FG_TABLE_NAME, $FG_COL_QUERY);
-
-
-if ( is_null ($order) || is_null($sens) ){
-	$order = $FG_TABLE_DEFAULT_ORDER;
-	$sens  = $FG_TABLE_DEFAULT_SENS;
-}
-
-if ($posted==1) {
-	$SQLcmd = '';
-	$SQLcmd = do_field($SQLcmd, 'src', 'source');
-	$SQLcmd = do_field($SQLcmd, 'phonenumber', 'calledstation');
-}
-
-
-$date_clause = '';
-
-normalize_day_of_month($fromstatsday_sday, $fromstatsmonth_sday, 1);
-normalize_day_of_month($tostatsday_sday, $tostatsmonth_sday, 1);
-if ($fromday && isset($fromstatsday_sday) && isset($fromstatsmonth_sday)) $date_clause.=" AND t1.starttime >= ('$fromstatsmonth_sday-$fromstatsday_sday')";
-if ($today && isset($tostatsday_sday) && isset($tostatsmonth_sday)) $date_clause.=" AND t1.starttime <= ('$tostatsmonth_sday-".sprintf("%02d",intval($tostatsday_sday)/*+1*/)." 23:59:59')";
-
-  
-if (strpos($SQLcmd, 'WHERE') > 0) {
-	$FG_TABLE_CLAUSE = substr($SQLcmd,6).$date_clause;
-} elseif (strpos($date_clause, 'AND') > 0) {
-	$FG_TABLE_CLAUSE = substr($date_clause,5);
-}
-
-
-if (!isset ($FG_TABLE_CLAUSE) || strlen($FG_TABLE_CLAUSE)==0) {
-	$cc_yearmonth = sprintf("%04d-%02d-%02d",date("Y"),date("n"),date("d"));
-	$FG_TABLE_CLAUSE=" t1.starttime >= ('$cc_yearmonth')";
-}
-
-
-if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE.=" AND ";
-$FG_TABLE_CLAUSE.="t1.card_id='$customer'";
-
-
-if (isset($choose_calltype) && ($choose_calltype!=-1)) {
-	if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE.=" AND ";
-	$FG_TABLE_CLAUSE .= " t1.sipiax='$choose_calltype' ";
-}
-
-if (!isset($terminatecauseid)) {
-	$terminatecauseid="ANSWER";
-} elseif ($terminatecauseid=="ANSWER") {
-	if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE .= " AND ";
-	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=1) ";
-}
-
-if (!$nodisplay) {
-	$list = $instance_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE, $order, $sens, null, null, $FG_LIMITE_DISPLAY, $current_page*$FG_LIMITE_DISPLAY);
-}
-$_SESSION["pr_sql_export"] = "SELECT $FG_COL_QUERY FROM $FG_TABLE_NAME WHERE $FG_TABLE_CLAUSE";
-
-$QUERY = "SELECT DATE(t1.starttime) AS day, sum(t1.sessiontime) AS calltime, sum(t1.sessionbill) AS cost, count(*) as nbcall FROM $FG_TABLE_NAME WHERE ".$FG_TABLE_CLAUSE." GROUP BY day ORDER BY day"; //extract(DAY from calldate)
-
-if (!$nodisplay) {
-	$res = $DBHandle -> Execute($QUERY);
-	if ($res) {
-		$num = $res -> RecordCount();
-		for($i=0;$i<$num;$i++) {				
-			$list_total_day [] =$res -> fetchRow();
-		}
-	}
-	
-	if ($FG_DEBUG == 3) echo "<br>Clause : $FG_TABLE_CLAUSE";
-	$nb_record = $instance_table -> Table_count ($DBHandle, $FG_TABLE_CLAUSE);
-	if ($FG_DEBUG >= 1) var_dump ($list);
-}
-
-if ($nb_record<=$FG_LIMITE_DISPLAY) { 
-	$nb_record_max=1;
-} else { 
-	if ($nb_record % $FG_LIMITE_DISPLAY == 0) {
-		$nb_record_max=(intval($nb_record/$FG_LIMITE_DISPLAY));
-	} else {
-		$nb_record_max=(intval($nb_record/$FG_LIMITE_DISPLAY)+1);
-	}	
-}
-
-
-$smarty->display( 'main.tpl');
-
-// #### HELP SECTION
-echo $CC_help_balance_customer;
-
-?>
-
-
-<!-- ** ** ** ** ** Part for the research ** ** ** ** ** -->
-	<center>
-	<FORM METHOD=POST ACTION="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php echo $current_page?>&terminatecauseid=<?php echo $terminatecauseid?>">
-		<INPUT TYPE="hidden" NAME="posted" value=1>
-		<INPUT TYPE="hidden" NAME="current_page" value=0>
-		<table class="callhistory_maintable" align="center">
-			
-			<tr>
-        		<td align="left" class="bgcolor_002"> &nbsp;
-					<font class="fontstyle_003"><?php echo gettext("DATE");?></b></font>
-				</td>
-      			<td align="left" class="bgcolor_003">
-					<table width="100%" border="0" cellspacing="0" cellpadding="0" >
-					<tr><td class="fontstyle_searchoptions">
-	  				<input type="checkbox" name="fromday" value="true" <?php  if ($fromday){ ?>checked<?php }?>> <?php echo gettext("FROM");?> :
-					<select name="fromstatsday_sday" class="form_input_select">
-						<?php  
-							for ($i=1;$i<=31;$i++){
-								if ($fromstatsday_sday==sprintf("%02d",$i)){$selected="selected";}else{$selected="";}
-								echo '<option value="'.sprintf("%02d",$i)."\"$selected>".sprintf("%02d",$i).'</option>';
-							}
-						?>	
-					</select>
-				 	<select name="fromstatsmonth_sday" class="form_input_select">
-					<?php 	
-						$year_actual = date("Y");
-						for ($i=$year_actual;$i >= $year_actual-1;$i--) {		   
-							$monthname = array( gettext("JANUARY"), gettext("FEBRUARY"), gettext("MARCH"), gettext("APRIL"), gettext("MAY"), gettext("JUNE"), gettext("JULY"), gettext("AUGUST"), gettext("SEPTEMBER"), gettext("OCTOBER"), gettext("NOVEMBER"), gettext("DECEMBER"));
-							if ($year_actual==$i){
-								$monthnumber = date("n")-1; // Month number without lead 0.
-							}else{
-								$monthnumber=11;
-							}		   
-							for ($j=$monthnumber;$j>=0;$j--){	
-								$month_formated = sprintf("%02d",$j+1);
-							   	if ($fromstatsmonth_sday=="$i-$month_formated"){$selected="selected";}else{$selected="";}
-								echo "<OPTION value=\"$i-$month_formated\" $selected> $monthname[$j]-$i </option>";				
-							}
-						}
-					?>
-					</select>
-					</td><td class="fontstyle_searchoptions">&nbsp;&nbsp;
-					<input type="checkbox" name="today" value="true" <?php  if ($today){ ?>checked<?php }?>> <?php echo gettext("TO");?> :
-					<select name="tostatsday_sday" class="form_input_select">
-					<?php  
-						for ($i=1;$i<=31;$i++){
-							if ($tostatsday_sday==sprintf("%02d",$i)){$selected="selected";}else{$selected="";}
-							echo '<option value="'.sprintf("%02d",$i)."\"$selected>".sprintf("%02d",$i).'</option>';
-						}
-					?>						
-					</select>
-				 	<select name="tostatsmonth_sday" class="form_input_select">
-					<?php 	$year_actual = date("Y");
-						for ($i=$year_actual;$i >= $year_actual-1;$i--)
-						{		   
-							   $monthname = array( gettext("JANUARY"), gettext("FEBRUARY"), gettext("MARCH"), gettext("APRIL"), gettext("MAY"), gettext("JUNE"), gettext("JULY"), gettext("AUGUST"), gettext("SEPTEMBER"), gettext("OCTOBER"), gettext("NOVEMBER"), gettext("DECEMBER"));
-							   if ($year_actual==$i){
-									$monthnumber = date("n")-1; // Month number without lead 0.
-							   }else{
-									$monthnumber=11;
-							   }		   
-							   for ($j=$monthnumber;$j>=0;$j--){	
-										$month_formated = sprintf("%02d",$j+1);
-							   			if ($tostatsmonth_sday=="$i-$month_formated"){$selected="selected";}else{$selected="";}
-										echo "<OPTION value=\"$i-$month_formated\" $selected> $monthname[$j]-$i </option>";				
-							   }
-						}
-					?>
-					</select>
-					</td></tr></table>
-	  			</td>
-    		</tr>
-			<tr>
-				<td  align="left" class="bgcolor_004">
-					<font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("PHONENUMBER");?></font>
-				</td>
-				<td  align="left" class="bgcolor_005">
-				<table width="100%" border="0" cellspacing="0" cellpadding="0">
-				<tr><td class="fontstyle_searchoptions">&nbsp;&nbsp;<INPUT TYPE="text" NAME="phonenumber" value="<?php echo $phonenumber?>" class="form_input_text"></td>
-				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="1" <?php if((!isset($phonenumbertype))||($phonenumbertype==1)){?>checked<?php }?>><?php echo gettext("Exact");?></td>
-				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="2" <?php if($phonenumbertype==2){?>checked<?php }?>><?php echo gettext("Begins with")?></td>
-				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="3" <?php if($phonenumbertype==3){?>checked<?php }?>><?php echo gettext("Contains");?></td>
-				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="4" <?php if($phonenumbertype==4){?>checked<?php }?>><?php echo gettext("Ends with");?></td>
-				</tr></table></td>
-			</tr>		
-			<!-- Select Calltype: -->
-			<tr>
-			  <td class="bgcolor_002" align="left" ><font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("CALL TYPE"); ?></font></td>
-			  <td class="bgcolor_003" align="center">
-			  <table width="100%" border="0" cellspacing="0" cellpadding="0">
-								<tr>
-					<td  class="fontstyle_searchoptions">
-					<select NAME="choose_calltype" size="1" class="form_input_select" >
-						<option value='-1' <?php if (($choose_calltype==-1) || (!isset($choose_calltype))){?>selected<?php } ?>><?php echo gettext('ALL CALLS') ?>
-								</option>
-							<?php
-								foreach($list_calltype as $key => $cur_value) {
-							?>
-								<option value='<?php echo $cur_value[1] ?>' <?php if ($choose_calltype==$cur_value[1]){?>selected<?php } ?>><?php echo gettext($cur_value[0]) ?>
-								</option>
-							<?php 	} ?>
-						</select>
-					</td>
-				</tr>				
-				</table>
-			  </td>
-			  </tr>
-	
-			<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
-			<tr>
-			  <td class="bgcolor_002" align="left" ><font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("OPTIONS"); ?></font></td>
-			  <td class="bgcolor_003" align="center">
-			  <table width="100%" border="0" cellspacing="0" cellpadding="0">
-				<tr>
-					<td width="20%"  class="fontstyle_searchoptions">
-						<?php echo gettext("SHOW");?> :  						
-				   </td>
-				   <td width="80%"  class="fontstyle_searchoptions">				   		
-				 <?php echo gettext("Answered Calls"); ?>
-				  <input name="terminatecauseid" type="radio" value="ANSWER" <?php if((!isset($terminatecauseid))||($terminatecauseid=="ANSWER")){?>checked<?php }?> />
-				  <?php echo gettext("All Calls"); ?>
-
-				   <input name="terminatecauseid" type="radio" value="ALL" <?php if($terminatecauseid=="ALL"){?>checked<?php }?>/>
-					</td>
-				</tr>
-				<tr class="bgcolor_005">
-					<td  class="fontstyle_searchoptions">
-						<?php echo gettext("RESULT");?> : 
-				   </td>
-				   <td  class="fontstyle_searchoptions">
-					<?php echo gettext("Minutes");?><input type="radio" NAME="resulttype" value="min" <?php if((!isset($resulttype))||($resulttype=="min")){?>checked<?php }?>> - <?php echo gettext("Seconds");?> <input type="radio" NAME="resulttype" value="sec" <?php if($resulttype=="sec"){?>checked<?php }?>>
-					</td>
-				</tr>
-				<tr>
-					<td  class="fontstyle_searchoptions">
-						<?php echo gettext("CURRENCY");?> :
-					</td>
-					<td  class="fontstyle_searchoptions">
-					<select NAME="choose_currency" size="1" class="form_input_select" >
-							<?php
-								$currencies_list = get_currencies();
-								foreach($currencies_list as $key => $cur_value) {
-							?>
-								<option value='<?php echo $key ?>' <?php if (($choose_currency==$key) || (!isset($choose_currency) && $key==strtoupper(BASE_CURRENCY))){?>selected<?php } ?>><?php echo $cur_value[1].' ('.$cur_value[2].')' ?>
-								</option>
-							<?php 	} ?>
-						</select>
-					</td>
-				</tr>				
-				</table>
-			  </td>
-			  </tr>
-			<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
-			
-			<tr>
-        		<td class="bgcolor_004" align="left" > </td>
-				<td class="bgcolor_005" align="center" >
-					<input class="form_input_button" value=" <?php echo gettext("Search");?> " type="submit">
-	  			</td>
-    		</tr>
-	</table>
-	</FORM>
-</center>
-
-
-<!-- ** ** ** ** ** Part to display the CDR ** ** ** ** ** -->
-<center><?php echo gettext("Number of Calls");?> : <?php  if (is_array($list) && count($list)>0){ echo $nb_record; }else{echo "0";}?></center>
-     <table width="<?php echo $FG_HTML_TABLE_WIDTH?>" border="0" align="center" cellpadding="0" cellspacing="0">
-		<TR bgcolor="#ffffff"> 
-          <TD class="callhistory_td11"> 
-            <TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
-                <TR> 
-                  <TD><SPAN style="COLOR: #ffffff; FONT-SIZE: 11px"><B><?php echo $FG_HTML_TABLE_TITLE?></B></SPAN></TD>
-                </TR>
-            </TABLE></TD>
-        </TR>
-        <TR> 
-          <TD> <TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
-                <TR class="bgcolor_008">
-				  <TD width="<?php echo $FG_ACTION_SIZE_COLUMN?>" align="center" class="tableBodyRight" style="PADDING-BOTTOM: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; PADDING-TOP: 2px"></TD>					
-				  
-                  <?php 
-				  	if (is_array($list) && count($list)>0) {
-					
-				  	for($i=0;$i<$FG_NB_TABLE_COL;$i++) {
-					?>
-	                  <TD width="<?php echo $FG_TABLE_COL[$i][2]?>" align=middle class="tableBody" style="PADDING-BOTTOM: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; PADDING-TOP: 2px"> 
-	                    <center><strong> 
-	                    <?php  if (strtoupper($FG_TABLE_COL[$i][4])=="SORT"){?>
-	                    <a href="<?php  echo $PHP_SELF."?customer=$customer&s=1&t=0&stitle=$stitle&atmenu=$atmenu&current_page=$current_page&order=".$FG_TABLE_COL[$i][1]."&sens="; if ($sens=="ASC"){echo"DESC";}else{echo"ASC";} 
-						echo "&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&phonenumbertype=$phonenumbertype&sourcetype=$sourcetype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&phonenumber=$phonenumber&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype";?>"> 
-	                    <span class="liens"><?php  } ?>
-	                    <?php echo $FG_TABLE_COL[$i][0]?> 
-	                    <?php if ($order==$FG_TABLE_COL[$i][1] && $sens=="ASC"){?>
-	                    &nbsp;<img src="<?php echo Images_Path_Main ?>/icon_up_12x12.GIF" width="12" height="12" border="0"> 
-	                    <?php }elseif ($order==$FG_TABLE_COL[$i][1] && $sens=="DESC"){?>
-	                    &nbsp;<img src="<?php echo Images_Path_Main ?>/icon_down_12x12.GIF" width="12" height="12" border="0"> 
-	                    <?php }?>
-	                    <?php  if (strtoupper($FG_TABLE_COL[$i][4])=="SORT"){?>
-	                    </span></a> 
-	                    <?php }?>
-	                    </strong></center></TD>
-				   <?php } ?>
-				   		
-                </TR>
-                <TR> 
-                  <TD bgColor="#e1e1e1" colSpan=<?php echo $FG_TOTAL_TABLE_COL?> height="1">
-                </TR>
-				<?php
-				  	 $ligne_number=0;					 
-				  	 foreach ($list as $recordset){ 
-						 $ligne_number++;
-						 $recordset[0] = display_GMT($recordset[0], $_SESSION["gmtoffset"], 1);
-				?>
-				
-               		 <TR bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>"  onMouseOver="bgColor='#C4FFD7'" onMouseOut="bgColor='<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>'"> 
-						<TD align="<?php echo $FG_TABLE_COL[$i][3]?>" class="tableBody"><?php  echo $ligne_number+$current_page*$FG_LIMITE_DISPLAY.".&nbsp;"; ?></TD>
-							 
-				  		<?php for($i=0;$i<$FG_NB_TABLE_COL;$i++){ ?>
-						<?php 				
-							if ($FG_TABLE_COL[$i][6]=="lie"){
-									$instance_sub_table = new Table($FG_TABLE_COL[$i][7], $FG_TABLE_COL[$i][8]);
-									$sub_clause = str_replace("%id", $recordset[$i], $FG_TABLE_COL[$i][9]);																																	
-									$select_list = $instance_sub_table -> Get_list ($DBHandle, $sub_clause, null, null, null, null, null, null);
-									
-									
-									$field_list_sun = preg_split('/,/',$FG_TABLE_COL[$i][8]);
-									$record_display = $FG_TABLE_COL[$i][10];
-									
-									for ($l=1;$l<=count($field_list_sun);$l++){										
-										$record_display = str_replace("%$l", $select_list[0][$l-1], $record_display);	
-									}
-								
-							}elseif ($FG_TABLE_COL[$i][6]=="list"){
-									$select_list = $FG_TABLE_COL[$i][7];
-									$record_display = $select_list[$recordset[$i]][0];
-							
-							}else{
-									$record_display = $recordset[$i];
-							}
-							
-							if ( is_numeric($FG_TABLE_COL[$i][5]) && (strlen($record_display) > $FG_TABLE_COL[$i][5]) ) {
-								$record_display = substr($record_display, 0, $FG_TABLE_COL[$i][5]-3)."";  
-							}
-							
-							
-				 		 ?>
-                 		 <TD vAlign=top align="<?php echo $FG_TABLE_COL[$i][3]?>" class=tableBody><?php 
-                 		 if (isset ($FG_TABLE_COL[$i][11]) && strlen($FG_TABLE_COL[$i][11])>1){
-						 	call_user_func($FG_TABLE_COL[$i][11], $record_display);
-						 }else{
-						 	echo stripslashes($record_display);
-						 }						 
-						 ?></TD>
-				 		 <?php  } ?>
-                  
-					</TR>
-				<?php
-					 }//foreach ($list as $recordset)
-					 if ($ligne_number < $FG_LIMITE_DISPLAY)  $ligne_number_end=$ligne_number +2;
-					 while ($ligne_number < $ligne_number_end){
-					 	$ligne_number++;
-				?>
-					<TR bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>"> 
-				  		<?php for($i=0;$i<$FG_NB_TABLE_COL;$i++){ 
-				 		 ?>
-                 		 <TD vAlign=top class=tableBody>&nbsp;</TD>
-				 		 <?php  } ?>
-                 		 <TD align="center" vAlign=top class=tableBodyRight>&nbsp;</TD>				
-					</TR>
-									
-				<?php					 
-					 } //END_WHILE
-					 
-				  }else{
-				  		echo gettext("No data found !!!");
-				  }//end_if
-				 ?>
-            </TABLE></td>
-        </tr>
-        <TR bgcolor="#ffffff"> 
-          <TD bgColor=#ADBEDE height=16 style="PADDING-LEFT: 5px; PADDING-RIGHT: 3px"> 
-			<TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
-                <TR> 
-                  <TD align="right"><SPAN style="COLOR: #ffffff; FONT-SIZE: 11px"><B> 
-                    <?php if ($current_page>0){?>
-                    <img src="<?php echo Images_Path_Main ?>/fleche-g.gif" width="5" height="10"> <a href="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php  echo ($current_page-1)?><?php  if (!is_null($letter) && ($letter!="")){ echo "&letter=$letter";} 
-					echo "&customer=$customer&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&phonenumbertype=$phonenumbertype&sourcetype=$sourcetype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&phonenumber=$phonenumber&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype";?>"> 
-                    <?php echo gettext("PREVIOUS");?> </a> -
-                    <?php }?>
-                    <?php echo ($current_page+1);?> / <?php  echo $nb_record_max;?> 
-                    <?php if ($current_page<$nb_record_max-1){?>
-                    - <a href="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php  echo ($current_page+1)?><?php  if (!is_null($letter) && ($letter!="")){ echo "&letter=$letter";} 
-					echo "&customer=$customer&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&phonenumbertype=$phonenumbertype&sourcetype=$sourcetype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&phonenumber=$phonenumber&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype";?>"> 
-                    <?php echo gettext("NEXT");?> </a> <img src="<?php echo Images_Path_Main ?>/fleche-d.gif" width="5" height="10">
-                    </B></SPAN> 
-                    <?php }?>
-                  </TD>
-            </TABLE></TD>
-        </TR>
-      </table>
-
-<!-- ** ** ** ** ** Part to display the GRAPHIC ** ** ** ** ** -->
-<br>
-
-<?php 
-
-if (is_array($list_total_day) && count($list_total_day)>0){
-
-$mmax=0;
-$totalcall==0;
-$totalminutes=0;
-foreach ($list_total_day as $data){
-	if ($mmax < $data[1]) $mmax=$data[1];
-	$totalcall+=$data[3];
-	$totalminutes+=$data[1];
-	$totalcost+=$data[2];
-}
-
-?>
-
-
-<!-- TITLE GLOBAL -->
-<center>
- <table border="0" cellspacing="0" cellpadding="0" width="80%"><tr><td align="left" height="30">
-		<table cellspacing="0" cellpadding="1" bgcolor="#000000" width="50%"><tr><td>
-			<table cellspacing="0" cellpadding="0" width="100%">
-				<tr><td class="callhistory_td1" align="left" ><?php echo gettext("SUMMARY");?></td></tr>
-			</table>
-		</td></tr></table>
- </td></tr></table>
-
-<!-- FIN TITLE GLOBAL MINUTES //-->
-
-<table border="0" cellspacing="0" cellpadding="0"  width="80%">
-<tr><td bgcolor="#000000">			
-	<table border="0" cellspacing="1" cellpadding="2" width="100%">
-	<tr>
-		<td align="center" class="callhistory_td2"></td>
-    	<td class="callhistory_td3" align="center" colspan="5"><?php echo gettext("CALLING CARD MINUTES");?></td>
-    </tr>
-	<tr>
-		<td align="center" class="callhistory_td3"><?php echo gettext("DATE");?></td>
-        <td align="center" class="callhistory_td2"><?php echo gettext("DURATION");?></td>
-		<td align="center" class="callhistory_td2"><?php echo gettext("GRAPHIC");?></td>
-		<td align="center" class="callhistory_td2"><?php echo gettext("CALLS");?></td>
-		<td align="center" class="callhistory_td2"><acronym title="<?php echo gettext("AVERAGE LENGTH OF CALL");?>"><?php echo gettext("ALOC");?></acronym></font></td>
-		<td align="center" class="callhistory_td2"><?php echo gettext("TOTAL COST");?></td>
-
-		<!-- LOOP -->
-	<?php
-		$i=0;
-		foreach ($list_total_day as $data) {	
-			$i=($i+1)%2;
-			$tmc = $data[1]/$data[3];
-			
-			if ((!isset($resulttype)) || ($resulttype=="min")){  
-				$tmc = sprintf("%02d",intval($tmc/60)).":".sprintf("%02d",intval($tmc%60));		
-			}else{
-				$tmc =intval($tmc);
-			}
-			
-			if ((!isset($resulttype)) || ($resulttype=="min")){  
-				$minutes = sprintf("%02d",intval($data[1]/60)).":".sprintf("%02d",intval($data[1]%60));
-			}else{
-				$minutes = $data[1];
-			}
-			if ($mmax>0) 	$widthbar= intval(($data[1]/$mmax)*200); 
-			
-		?>
-			</tr><tr>
-			<td align="right" class="sidenav" nowrap="nowrap"><font class="callhistory_td5"><?php echo $data[0]?></font></td>
-			<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001"><?php echo $minutes?> </td>
-	        <td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="left" nowrap="nowrap" width="<?php echo $widthbar+60?>">
-		        <table cellspacing="0" cellpadding="0"><tr>
-		        	<td bgcolor="#e22424"><img src="<?php echo Images_Path_Main ?>/spacer.gif" width="<?php echo $widthbar?>" height="6"></td>
-		        </tr></table>
-	        </td>
-	        <td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001"><?php echo $data[3]?></td>
-	        <td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001" ><?php echo $tmc?> </td>
-			<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001"><?php  display_2bill($data[2]) ?></td>
-     	<?php 	 
-     	}	 	 	
-	 	
-		if ((!isset($resulttype)) || ($resulttype=="min")){  
-			$total_tmc = sprintf("%02d",intval(($totalminutes/$totalcall)/60)).":".sprintf("%02d",intval(($totalminutes/$totalcall)%60));				
-			$totalminutes = sprintf("%02d",intval($totalminutes/60)).":".sprintf("%02d",intval($totalminutes%60));
-		}else{
-			$total_tmc = intval($totalminutes/$totalcall);			
-		}
-	 
-	 ?>                   	
-	</tr>
-
-	<!-- TOTAL -->
-	<tr class="callhistory_td2">
-		<td align="right" nowrap="nowrap" class="callhistory_td4"><?php echo gettext("TOTAL");?></td>
-		<td align="center" nowrap="nowrap" colspan="2" class="callhistory_td4"><?php echo $totalminutes?> </td>
-		<td align="center" nowrap="nowrap" class="callhistory_td4"><?php echo $totalcall?></td>
-		<td align="center" nowrap="nowrap" class="callhistory_td4"><?php echo $total_tmc?></td>
-		<td align="center" nowrap="nowrap" class="callhistory_td4"><?php  display_2bill($totalcost) ?></td>
-	</tr>
-	
-	</table>
-	  
-</td></tr></table>
-
-<?php  } else { ?>
-	<center><h3><?php echo gettext("No calls in your selection");?>.</h3></center>
-<?php  } ?>
-</center>
-
-<?php
-
-$smarty->display( 'footer.tpl');
-
-
+<?php
+
+/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
+
+/**
+ * This file is part of A2Billing (http://www.a2billing.net/)
+ *
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
+ * powered by Star2billing S.L. <http://www.star2billing.com/>
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
+ * @author      Belaid Arezqui <areski@gmail.com>
+ * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
+ * @package     A2Billing
+ *
+ * Software License Agreement (GNU Affero General Public License)
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Affero General Public License as
+ * published by the Free Software Foundation, either version 3 of the
+ * License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Affero General Public License for more details.
+ *
+ * You should have received a copy of the GNU Affero General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ * 
+ * 
+**/
+
+
+include ("lib/customer.defines.php");
+include ("lib/customer.module.access.php");
+include ("lib/customer.smarty.php");
+
+
+if (! has_rights (ACX_CALL_HISTORY)) { 
+	Header ("HTTP/1.0 401 Unauthorized");
+	Header ("Location: PP_error.php?c=accessdenied");	   
+	die();
+}
+
+getpost_ifset(array('posted', 'Period', 'frommonth', 'fromstatsmonth', 'tomonth', 'tostatsmonth', 'fromday', 'fromstatsday_sday', 'fromstatsmonth_sday', 'today', 'tostatsday_sday', 'tostatsmonth_sday', 'phonenumbertype', 'sourcetype', 'clidtype', 'channel', 'resulttype', 'stitle', 'atmenu', 'current_page', 'order', 'sens', 'phonenumber', 'src', 'clid', 'choose_currency', 'terminatecauseid', 'choose_calltype', 'download', 'file'));
+
+
+if (($download == "file") && $file && $ACXSEERECORDING) {
+	
+	if (strpos($file, '/') !== false) exit;
+	
+	$value_de = base64_decode ( $file );
+	$dl_full = MONITOR_PATH . "/" . $value_de;
+	$dl_name = $value_de;
+	
+	if (! file_exists ( $dl_full )) {
+		echo gettext ( "ERROR: Cannot download file " . $dl_full . ", it does not exist.<br>" );
+		exit ();
+	}
+	
+	header ( "Content-Type: application/octet-stream" );
+	header ( "Content-Disposition: attachment; filename=$dl_name" );
+	header ( "Content-Length: " . filesize ( $dl_full ) );
+	header ( "Accept-Ranges: bytes" );
+	header ( "Pragma: no-cache" );
+	header ( "Expires: 0" );
+	header ( "Cache-Control: must-revalidate, post-check=0, pre-check=0" );
+	header ( "Content-transfer-encoding: binary" );
+	
+	@readfile ( $dl_full );
+	exit ();
+}
+
+
+$QUERY = "SELECT username, credit, lastname, firstname, address, city, state, country, zipcode, phone, email, fax, lastuse, activated, status FROM cc_card WHERE username = '".$_SESSION["pr_login"]."' AND uipass = '".$_SESSION["pr_password"]."'";
+
+$DBHandle_max = DbConnect();
+$numrow = 0;
+$resmax = $DBHandle_max -> Execute($QUERY);
+if ($resmax)
+	$numrow = $resmax -> RecordCount();
+
+if ($numrow == 0) exit();
+$customer_info =$resmax -> fetchRow();
+
+if ($customer_info[14] != "1" && $customer_info[14] != "8") {
+	Header("HTTP/1.0 401 Unauthorized");
+	Header("Location: PP_error.php?c=accessdenied");
+	die();
+}
+
+$customer = $_SESSION["card_id"];
+
+
+$dialstatus_list = Constants::getDialStatusList();
+
+if (!isset ($current_page) || ($current_page == "")) {
+	$current_page=0;
+}
+
+$FG_DEBUG = 0;
+$FG_TABLE_NAME="cc_call_archive t1";
+
+// THIS VARIABLE DEFINE THE COLOR OF THE HEAD TABLE
+$FG_TABLE_ALTERNATE_ROW_COLOR[] = "#FFFFFF";
+$FG_TABLE_ALTERNATE_ROW_COLOR[] = "#F2F8FF";
+
+$yesno = array();
+$yesno["1"] = array( "Yes", "1");
+$yesno["0"] = array( "No", "0");
+
+// 0 = NORMAL CALL ; 1 = VOIP CALL (SIP/IAX) ; 2= DIDCALL + TRUNK ; 3 = VOIP CALL DID ; 4 = CALLBACK call
+$list_calltype = array(); 
+$list_calltype["0"]  = array( gettext("STANDARD"), "0");
+$list_calltype["1"]  = array( gettext("SIP/IAX"), "1");
+$list_calltype["2"]  = array( gettext("DIDCALL"), "2");
+$list_calltype["3"]  = array( gettext("DID_VOIP"), "3");
+$list_calltype["4"]  = array( gettext("CALLBACK"), "4");
+$list_calltype["5"]  = array( gettext("PREDICT"), "5");
+$list_calltype ["6"] = array (gettext("AUTO DIALER"), "6" );
+$list_calltype ["7"] = array (gettext("DID-ALEG"), "7" );
+
+$DBHandle  = DbConnect();
+
+$FG_TABLE_DEFAULT_ORDER = "t1.starttime";
+$FG_TABLE_DEFAULT_SENS = "DESC";
+
+$FG_TABLE_COL = array();
+$FG_TABLE_COL[]=array (gettext("Date"), "starttime", "17%", "center", "SORT", "22", "", "", "", "", "", "");
+$FG_TABLE_COL[]=array (gettext("CallerID"), "source", "14%", "center", "SORT", "30");
+$FG_TABLE_COL[]=array (gettext("PhoneNumber"), "calledstation", "14%", "center", "SORT", "30", "", "", "", "", "", "");
+$FG_TABLE_COL[]=array (gettext("Destination"), "destination", "14%", "center", "SORT", "30", "lie", "cc_prefix", "destination", "prefix='%id'", "%1" );
+$FG_TABLE_COL[]=array (gettext("Duration"), "sessiontime", "10%", "center", "SORT", "30", "", "", "", "", "", "display_minute");
+$FG_TABLE_COL[]=array ('<acronym title="'.gettext("Terminate Cause").'">'.gettext("TC").'</acronym>', "terminatecauseid", "10%", "center", "SORT", "", "list", $dialstatus_list);
+$FG_TABLE_COL[]=array (gettext("CallType"), "sipiax", "12%", "center", "SORT",  "", "list", $list_calltype);
+$FG_TABLE_COL[]=array (gettext("Cost"), "sessionbill", "12%", "center", "SORT", "30", "", "", "", "", "", "display_2bill");
+
+if ($ACXSEERECORDING) {
+	$FG_TABLE_COL [] = array ("", "uniqueid", "1%", "center", "", "30", "", "", "", "", "", "linkonmonitorfile_customer" );
+}
+
+$FG_COL_QUERY = 't1.starttime, t1.src, t1.calledstation, t1.destination, t1.sessiontime, t1.terminatecauseid, t1.sipiax, t1.sessionbill';
+
+if ($ACXSEERECORDING) {
+	$FG_COL_QUERY .= ', t1.uniqueid';
+}
+
+$FG_LIMITE_DISPLAY = 25;
+$FG_NB_TABLE_COL = count($FG_TABLE_COL);
+$FG_EDITION = true;
+$FG_TOTAL_TABLE_COL = $FG_NB_TABLE_COL;
+if ($FG_DELETION || $FG_EDITION) $FG_TOTAL_TABLE_COL++;
+$FG_HTML_TABLE_TITLE = " - ".gettext("Call Logs")." - ";
+$FG_HTML_TABLE_WIDTH = "98%";
+
+
+$instance_table = new Table($FG_TABLE_NAME, $FG_COL_QUERY);
+
+
+if ( is_null ($order) || is_null($sens) ){
+	$order = $FG_TABLE_DEFAULT_ORDER;
+	$sens  = $FG_TABLE_DEFAULT_SENS;
+}
+
+if ($posted==1) {
+	$SQLcmd = '';
+	$SQLcmd = do_field($SQLcmd, 'src', 'source');
+	$SQLcmd = do_field($SQLcmd, 'phonenumber', 'calledstation');
+}
+
+//Obtengo offset del server respecto a UTC
+$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
+foreach ($timezone_list as $key => $timezone_list_val) {
+	$server_offset = $timezone_list_val[3];
+	break;
+}
+//Obtengo el offset del account respecto a UTC
+$account_offset = $_SESSION["gmtoffset"];
+
+$date_offset = (-($server_offset - $account_offset)) / 60 / 60;
+	
+$date_clause = '';
+
+normalize_day_of_month($fromstatsday_sday, $fromstatsmonth_sday, 1);
+normalize_day_of_month($tostatsday_sday, $tostatsmonth_sday, 1);
+
+// Calculo fecha maxima a mostrar
+$actual_date = date("Y-m-d");
+//Resto un dias a la fecha actual
+$menos1day = - 24;
+$timestamp = date_add_hour($actual_date,$menos1day);
+$date_tmp = date("Y-m-d", $timestamp);
+//Sumo el offset para obtener fecha y hora inicial.
+$timestamp =date_add_hour ($date_tmp,-$date_offset);
+$max_end_date = date("Y-m-d H:i:s", $timestamp);
+
+// Selecciona fecha de inicio
+if ($fromday && isset($fromstatsday_sday) && isset($fromstatsmonth_sday)) {
+	$date_ini = $fromstatsmonth_sday."-".$fromstatsday_sday;
+	$timestamp = date_add_hour($date_ini,-$date_offset);
+	$init_date = date("Y-m-d H:i:s", $timestamp);
+	$date_clause .=" AND t1.starttime >= ('$init_date')";
+}
+
+// Selecciona fecha de fin
+if ($today && isset($tostatsday_sday) && isset($tostatsmonth_sday)) {
+	$date_fin = $tostatsmonth_sday."-".$tostatsday_sday;
+	$timestamp = date_add_hour($date_fin,24);
+	$date_fin = date("Y-m-d H:i:s", $timestamp);
+	$timestamp = date_add_hour($date_fin,-$date_offset);
+	//fecha fin seleccionada
+	$fin_date = date("Y-m-d H:i:s", $timestamp);
+
+	if ($fin_date > $max_end_date ) {
+		$fin_date = $max_end_date;
+	}
+	
+	$date_clause.= " AND t1.starttime < ('$fin_date')";
+} else {
+	if ($fromday && isset($fromstatsday_sday) && isset($fromstatsmonth_sday)) {		
+		$date_clause.= " AND t1.starttime < ('$max_end_date')";
+	}
+}
+
+if (strpos($SQLcmd, 'WHERE') > 0) {
+	if (strpos($date_clause, 'AND') <= 0) {
+		$date_clause.= " AND t1.starttime < ('$max_end_date')";
+	}
+	$FG_TABLE_CLAUSE = substr($SQLcmd,6).$date_clause;
+} elseif (strpos($date_clause, 'AND') > 0) {
+	$FG_TABLE_CLAUSE = substr($date_clause,5);
+}
+
+if (!isset ($FG_TABLE_CLAUSE) || strlen($FG_TABLE_CLAUSE)==0) {
+	$actual_date = date("Y-m-d");
+	
+	//Resto dos dias para obtener la fecha inicial a generar
+	$menos2day = - 48;
+	$timestamp = date_add_hour($actual_date,$menos2day);
+	$initial_date_tmp = date("Y-m-d", $timestamp);
+	
+	//Sumo el offset para obtener fecha y hora inicial.
+	$timestamp =date_add_hour ($initial_date_tmp,-$date_offset);
+	$initial_date = date("Y-m-d H:i:s", $timestamp);
+
+	$timestamp =date_add_hour ($initial_date,24);
+	$end_date = date("Y-m-d H:i:s", $timestamp);
+
+	$FG_TABLE_CLAUSE=" t1.starttime >= ('$initial_date') and t1.starttime <= ('$end_date')";
+}
+
+if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE.=" AND ";
+$FG_TABLE_CLAUSE.="t1.card_id='$customer'";
+
+if (isset($choose_calltype) && ($choose_calltype!=-1)) {
+	if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE.=" AND ";
+	$FG_TABLE_CLAUSE .= " t1.sipiax='$choose_calltype' ";
+}
+
+if (!isset($terminatecauseid)) {
+	$terminatecauseid="ANSWER";
+} elseif ($terminatecauseid=="ANSWER") {
+	if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=1) ";
+}
+
+if (!$nodisplay) {
+	$list = $instance_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE, $order, $sens, null, null, $FG_LIMITE_DISPLAY, $current_page*$FG_LIMITE_DISPLAY);
+}
+$_SESSION["pr_sql_export"] = "SELECT $FG_COL_QUERY FROM $FG_TABLE_NAME WHERE $FG_TABLE_CLAUSE";
+
+if ($date_offset < 0) {
+	$off_temp = -$date_offset;
+	$QUERY = "SELECT DATE(DATE_SUB(t1.starttime,INTERVAL $off_temp HOUR)) AS day, sum(t1.sessiontime) AS calltime, sum(t1.sessionbill) AS cost, count(*) as nbcall FROM $FG_TABLE_NAME WHERE ".$FG_TABLE_CLAUSE." GROUP BY day ORDER BY day"; //extract(DAY from calldate)	
+} else {
+	$QUERY = "SELECT DATE(DATE_ADD(t1.starttime,INTERVAL $date_offset HOUR)) AS day, sum(t1.sessiontime) AS calltime, sum(t1.sessionbill) AS cost, count(*) as nbcall FROM $FG_TABLE_NAME WHERE ".$FG_TABLE_CLAUSE." GROUP BY day ORDER BY day"; //extract(DAY from calldate)
+}
+
+if (!$nodisplay) {
+	$res = $DBHandle -> Execute($QUERY);
+	if ($res) {
+		$num = $res -> RecordCount();
+		for($i=0;$i<$num;$i++) {				
+			$list_total_day [] =$res -> fetchRow();
+		}
+	}
+	
+	if ($FG_DEBUG == 3) echo "<br>Clause : $FG_TABLE_CLAUSE";
+	$nb_record = $instance_table -> Table_count ($DBHandle, $FG_TABLE_CLAUSE);
+	if ($FG_DEBUG >= 1) var_dump ($list);
+}
+
+if ($nb_record<=$FG_LIMITE_DISPLAY) { 
+	$nb_record_max=1;
+} else { 
+	if ($nb_record % $FG_LIMITE_DISPLAY == 0) {
+		$nb_record_max=(intval($nb_record/$FG_LIMITE_DISPLAY));
+	} else {
+		$nb_record_max=(intval($nb_record/$FG_LIMITE_DISPLAY)+1);
+	}	
+}
+
+
+$smarty->display( 'main.tpl');
+
+// #### HELP SECTION
+echo $CC_help_balance_customer_calls_history;
+
+?>
+
+
+<!-- ** ** ** ** ** Part for the research ** ** ** ** ** -->
+	<center>
+	<FORM METHOD=POST ACTION="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php echo $current_page?>&terminatecauseid=<?php echo $terminatecauseid?>">
+		<INPUT TYPE="hidden" NAME="posted" value=1>
+		<INPUT TYPE="hidden" NAME="current_page" value=0>
+		<table class="callhistory_maintable" align="center">
+			
+			<tr>
+        		<td align="left" class="bgcolor_002"> &nbsp;
+					<font class="fontstyle_003"><?php echo gettext("DATE");?></b></font>
+				</td>
+      			<td align="left" class="bgcolor_003">
+					<table width="100%" border="0" cellspacing="0" cellpadding="0" >
+					<tr><td class="fontstyle_searchoptions">
+	  				<input type="checkbox" name="fromday" value="true" <?php  if ($fromday){ ?>checked<?php }?>> <?php echo gettext("FROM");?> :
+					<select name="fromstatsday_sday" class="form_input_select">
+						<?php  
+							for ($i=1;$i<=31;$i++){
+								if ($fromstatsday_sday==sprintf("%02d",$i)){$selected="selected";}else{$selected="";}
+								echo '<option value="'.sprintf("%02d",$i)."\"$selected>".sprintf("%02d",$i).'</option>';
+							}
+						?>	
+					</select>
+				 	<select name="fromstatsmonth_sday" class="form_input_select">
+					<?php 	
+						$year_actual = date("Y");
+						for ($i=$year_actual;$i >= $year_actual-1;$i--) {		   
+							$monthname = array( gettext("JANUARY"), gettext("FEBRUARY"), gettext("MARCH"), gettext("APRIL"), gettext("MAY"), gettext("JUNE"), gettext("JULY"), gettext("AUGUST"), gettext("SEPTEMBER"), gettext("OCTOBER"), gettext("NOVEMBER"), gettext("DECEMBER"));
+							if ($year_actual==$i){
+								$monthnumber = date("n")-1; // Month number without lead 0.
+							}else{
+								$monthnumber=11;
+							}		   
+							for ($j=$monthnumber;$j>=0;$j--){	
+								$month_formated = sprintf("%02d",$j+1);
+							   	if ($fromstatsmonth_sday=="$i-$month_formated"){$selected="selected";}else{$selected="";}
+								echo "<OPTION value=\"$i-$month_formated\" $selected> $monthname[$j]-$i </option>";				
+							}
+						}
+					?>
+					</select>
+					</td><td class="fontstyle_searchoptions">&nbsp;&nbsp;
+					<input type="checkbox" name="today" value="true" <?php  if ($today){ ?>checked<?php }?>> <?php echo gettext("TO");?> :
+					<select name="tostatsday_sday" class="form_input_select">
+					<?php  
+						for ($i=1;$i<=31;$i++){
+							if ($tostatsday_sday==sprintf("%02d",$i)){$selected="selected";}else{$selected="";}
+							echo '<option value="'.sprintf("%02d",$i)."\"$selected>".sprintf("%02d",$i).'</option>';
+						}
+					?>						
+					</select>
+				 	<select name="tostatsmonth_sday" class="form_input_select">
+					<?php 	$year_actual = date("Y");
+						for ($i=$year_actual;$i >= $year_actual-1;$i--)
+						{		   
+							   $monthname = array( gettext("JANUARY"), gettext("FEBRUARY"), gettext("MARCH"), gettext("APRIL"), gettext("MAY"), gettext("JUNE"), gettext("JULY"), gettext("AUGUST"), gettext("SEPTEMBER"), gettext("OCTOBER"), gettext("NOVEMBER"), gettext("DECEMBER"));
+							   if ($year_actual==$i){
+									$monthnumber = date("n")-1; // Month number without lead 0.
+							   }else{
+									$monthnumber=11;
+							   }		   
+							   for ($j=$monthnumber;$j>=0;$j--){	
+										$month_formated = sprintf("%02d",$j+1);
+							   			if ($tostatsmonth_sday=="$i-$month_formated"){$selected="selected";}else{$selected="";}
+										echo "<OPTION value=\"$i-$month_formated\" $selected> $monthname[$j]-$i </option>";				
+							   }
+						}
+					?>
+					</select>
+					</td></tr></table>
+	  			</td>
+    		</tr>
+			<tr>
+				<td  align="left" class="bgcolor_004">
+					<font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("PHONENUMBER");?></font>
+				</td>
+				<td  align="left" class="bgcolor_005">
+				<table width="100%" border="0" cellspacing="0" cellpadding="0">
+				<tr><td class="fontstyle_searchoptions">&nbsp;&nbsp;<INPUT TYPE="text" NAME="phonenumber" value="<?php echo $phonenumber?>" class="form_input_text"></td>
+				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="1" <?php if((!isset($phonenumbertype))||($phonenumbertype==1)){?>checked<?php }?>><?php echo gettext("Exact");?></td>
+				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="2" <?php if($phonenumbertype==2){?>checked<?php }?>><?php echo gettext("Begins with")?></td>
+				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="3" <?php if($phonenumbertype==3){?>checked<?php }?>><?php echo gettext("Contains");?></td>
+				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="4" <?php if($phonenumbertype==4){?>checked<?php }?>><?php echo gettext("Ends with");?></td>
+				</tr></table></td>
+			</tr>		
+			<!-- Select Calltype: -->
+			<tr>
+			  <td class="bgcolor_002" align="left" ><font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("CALL TYPE"); ?></font></td>
+			  <td class="bgcolor_003" align="center">
+			  <table width="100%" border="0" cellspacing="0" cellpadding="0">
+								<tr>
+					<td  class="fontstyle_searchoptions">
+					<select NAME="choose_calltype" size="1" class="form_input_select" >
+						<option value='-1' <?php if (($choose_calltype==-1) || (!isset($choose_calltype))){?>selected<?php } ?>><?php echo gettext('ALL CALLS') ?>
+								</option>
+							<?php
+								foreach($list_calltype as $key => $cur_value) {
+							?>
+								<option value='<?php echo $cur_value[1] ?>' <?php if ($choose_calltype==$cur_value[1]){?>selected<?php } ?>><?php echo gettext($cur_value[0]) ?>
+								</option>
+							<?php 	} ?>
+						</select>
+					</td>
+				</tr>				
+				</table>
+			  </td>
+			  </tr>
+	
+			<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
+			<tr>
+			  <td class="bgcolor_002" align="left" ><font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("OPTIONS"); ?></font></td>
+			  <td class="bgcolor_003" align="center">
+			  <table width="100%" border="0" cellspacing="0" cellpadding="0">
+				<tr>
+					<td width="20%"  class="fontstyle_searchoptions">
+						<?php echo gettext("SHOW");?> :  						
+				   </td>
+				   <td width="80%"  class="fontstyle_searchoptions">				   		
+				 <?php echo gettext("Answered Calls"); ?>
+				  <input name="terminatecauseid" type="radio" value="ANSWER" <?php if((!isset($terminatecauseid))||($terminatecauseid=="ANSWER")){?>checked<?php }?> />
+				  <?php echo gettext("All Calls"); ?>
+
+				   <input name="terminatecauseid" type="radio" value="ALL" <?php if($terminatecauseid=="ALL"){?>checked<?php }?>/>
+					</td>
+				</tr>
+				<tr class="bgcolor_005">
+					<td  class="fontstyle_searchoptions">
+						<?php echo gettext("RESULT");?> : 
+				   </td>
+				   <td  class="fontstyle_searchoptions">
+					<?php echo gettext("Minutes");?><input type="radio" NAME="resulttype" value="min" <?php if((!isset($resulttype))||($resulttype=="min")){?>checked<?php }?>> - <?php echo gettext("Seconds");?> <input type="radio" NAME="resulttype" value="sec" <?php if($resulttype=="sec"){?>checked<?php }?>>
+					</td>
+				</tr>
+				<tr>
+					<td  class="fontstyle_searchoptions">
+						<?php echo gettext("CURRENCY");?> :
+					</td>
+					<td  class="fontstyle_searchoptions">
+					<select NAME="choose_currency" size="1" class="form_input_select" >
+							<?php
+								$currencies_list = get_currencies();
+								foreach($currencies_list as $key => $cur_value) {
+							?>
+								<option value='<?php echo $key ?>' <?php if (($choose_currency==$key) || (!isset($choose_currency) && $key==strtoupper(BASE_CURRENCY))){?>selected<?php } ?>><?php echo $cur_value[1].' ('.$cur_value[2].')' ?>
+								</option>
+							<?php 	} ?>
+						</select>
+					</td>
+				</tr>				
+				</table>
+			  </td>
+			  </tr>
+			<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
+			
+			<tr>
+        		<td class="bgcolor_004" align="left" > </td>
+				<td class="bgcolor_005" align="center" >
+					<input class="form_input_button" value=" <?php echo gettext("Search");?> " type="submit">
+	  			</td>
+    		</tr>
+	</table>
+	</FORM>
+</center>
+
+
+<!-- ** ** ** ** ** Part to display the CDR ** ** ** ** ** -->
+<center><?php echo gettext("Number of Calls");?> : <?php  if (is_array($list) && count($list)>0){ echo $nb_record; }else{echo "0";}?></center>
+     <table width="<?php echo $FG_HTML_TABLE_WIDTH?>" border="0" align="center" cellpadding="0" cellspacing="0">
+		<TR bgcolor="#ffffff"> 
+          <TD class="callhistory_td11"> 
+            <TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+                <TR> 
+                  <TD><SPAN style="COLOR: #ffffff; FONT-SIZE: 11px"><B><?php echo $FG_HTML_TABLE_TITLE?></B></SPAN></TD>
+                </TR>
+            </TABLE></TD>
+        </TR>
+        <TR> 
+          <TD> <TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+                <TR class="bgcolor_008">
+				  <TD width="<?php echo $FG_ACTION_SIZE_COLUMN?>" align="center" class="tableBodyRight" style="PADDING-BOTTOM: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; PADDING-TOP: 2px"></TD>					
+				  
+                  <?php 
+				  	if (is_array($list) && count($list)>0) {
+					
+				  	for($i=0;$i<$FG_NB_TABLE_COL;$i++) {
+					?>
+	                  <TD width="<?php echo $FG_TABLE_COL[$i][2]?>" align=middle class="tableBody" style="PADDING-BOTTOM: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; PADDING-TOP: 2px"> 
+	                    <center><strong> 
+	                    <?php  if (strtoupper($FG_TABLE_COL[$i][4])=="SORT"){?>
+	                    <a href="<?php  echo $PHP_SELF."?customer=$customer&s=1&t=0&stitle=$stitle&atmenu=$atmenu&current_page=$current_page&order=".$FG_TABLE_COL[$i][1]."&sens="; if ($sens=="ASC"){echo"DESC";}else{echo"ASC";} 
+						echo "&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&phonenumbertype=$phonenumbertype&sourcetype=$sourcetype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&phonenumber=$phonenumber&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype";?>"> 
+	                    <span class="liens"><?php  } ?>
+	                    <?php echo $FG_TABLE_COL[$i][0]?> 
+	                    <?php if ($order==$FG_TABLE_COL[$i][1] && $sens=="ASC"){?>
+	                    &nbsp;<img src="<?php echo Images_Path_Main ?>/icon_up_12x12.GIF" width="12" height="12" border="0"> 
+	                    <?php }elseif ($order==$FG_TABLE_COL[$i][1] && $sens=="DESC"){?>
+	                    &nbsp;<img src="<?php echo Images_Path_Main ?>/icon_down_12x12.GIF" width="12" height="12" border="0"> 
+	                    <?php }?>
+	                    <?php  if (strtoupper($FG_TABLE_COL[$i][4])=="SORT"){?>
+	                    </span></a> 
+	                    <?php }?>
+	                    </strong></center></TD>
+				   <?php } ?>
+				   		
+                </TR>
+                <TR> 
+                  <TD bgColor="#e1e1e1" colSpan=<?php echo $FG_TOTAL_TABLE_COL?> height="1">
+                </TR>
+				<?php
+				  	 $ligne_number=0;					 
+				  	 foreach ($list as $recordset){ 
+						 $ligne_number++;
+						 $recordset[0] = display_GMT($recordset[0], $_SESSION["gmtoffset"], 1);
+				?>
+				
+               		 <TR bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>"  onMouseOver="bgColor='#C4FFD7'" onMouseOut="bgColor='<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>'"> 
+						<TD align="<?php echo $FG_TABLE_COL[$i][3]?>" class="tableBody"><?php  echo $ligne_number+$current_page*$FG_LIMITE_DISPLAY.".&nbsp;"; ?></TD>
+							 
+				  		<?php for($i=0;$i<$FG_NB_TABLE_COL;$i++){ ?>
+						<?php 				
+							if ($FG_TABLE_COL[$i][6]=="lie"){
+									$instance_sub_table = new Table($FG_TABLE_COL[$i][7], $FG_TABLE_COL[$i][8]);
+									$sub_clause = str_replace("%id", $recordset[$i], $FG_TABLE_COL[$i][9]);																																	
+									$select_list = $instance_sub_table -> Get_list ($DBHandle, $sub_clause, null, null, null, null, null, null);
+									
+									
+									$field_list_sun = preg_split('/,/',$FG_TABLE_COL[$i][8]);
+									$record_display = $FG_TABLE_COL[$i][10];
+									
+									for ($l=1;$l<=count($field_list_sun);$l++){										
+										$record_display = str_replace("%$l", $select_list[0][$l-1], $record_display);	
+									}
+								
+							}elseif ($FG_TABLE_COL[$i][6]=="list"){
+									$select_list = $FG_TABLE_COL[$i][7];
+									$record_display = $select_list[$recordset[$i]][0];
+							
+							}else{
+									$record_display = $recordset[$i];
+							}
+							
+							if ( is_numeric($FG_TABLE_COL[$i][5]) && (strlen($record_display) > $FG_TABLE_COL[$i][5]) ) {
+								$record_display = substr($record_display, 0, $FG_TABLE_COL[$i][5]-3)."";  
+							}
+							
+							
+				 		 ?>
+                 		 <TD vAlign=top align="<?php echo $FG_TABLE_COL[$i][3]?>" class=tableBody><?php 
+                 		 if (isset ($FG_TABLE_COL[$i][11]) && strlen($FG_TABLE_COL[$i][11])>1){
+						 	call_user_func($FG_TABLE_COL[$i][11], $record_display);
+						 }else{
+						 	echo stripslashes($record_display);
+						 }						 
+						 ?></TD>
+				 		 <?php  } ?>
+                  
+					</TR>
+				<?php
+					 }//foreach ($list as $recordset)
+					 if ($ligne_number < $FG_LIMITE_DISPLAY)  $ligne_number_end=$ligne_number +2;
+					 while ($ligne_number < $ligne_number_end){
+					 	$ligne_number++;
+				?>
+					<TR bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>"> 
+				  		<?php for($i=0;$i<$FG_NB_TABLE_COL;$i++){ 
+				 		 ?>
+                 		 <TD vAlign=top class=tableBody>&nbsp;</TD>
+				 		 <?php  } ?>
+                 		 <TD align="center" vAlign=top class=tableBodyRight>&nbsp;</TD>				
+					</TR>
+									
+				<?php					 
+					 } //END_WHILE
+					 
+				  }else{
+				  		echo gettext("No data found !!!");
+				  }//end_if
+				 ?>
+            </TABLE></td>
+        </tr>
+        <TR bgcolor="#ffffff"> 
+          <TD bgColor=#ADBEDE height=16 style="PADDING-LEFT: 5px; PADDING-RIGHT: 3px"> 
+			<TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+                <TR> 
+                  <TD align="right"><SPAN style="COLOR: #ffffff; FONT-SIZE: 11px"><B> 
+                    <?php if ($current_page>0){?>
+                    <img src="<?php echo Images_Path_Main ?>/fleche-g.gif" width="5" height="10"> <a href="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php  echo ($current_page-1)?><?php  if (!is_null($letter) && ($letter!="")){ echo "&letter=$letter";} 
+					echo "&customer=$customer&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&phonenumbertype=$phonenumbertype&sourcetype=$sourcetype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&phonenumber=$phonenumber&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype";?>"> 
+                    <?php echo gettext("PREVIOUS");?> </a> -
+                    <?php }?>
+                    <?php echo ($current_page+1);?> / <?php  echo $nb_record_max;?> 
+                    <?php if ($current_page<$nb_record_max-1){?>
+                    - <a href="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php  echo ($current_page+1)?><?php  if (!is_null($letter) && ($letter!="")){ echo "&letter=$letter";} 
+					echo "&customer=$customer&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&phonenumbertype=$phonenumbertype&sourcetype=$sourcetype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&phonenumber=$phonenumber&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype";?>"> 
+                    <?php echo gettext("NEXT");?> </a> <img src="<?php echo Images_Path_Main ?>/fleche-d.gif" width="5" height="10">
+                    </B></SPAN> 
+                    <?php }?>
+                  </TD>
+            </TABLE></TD>
+        </TR>
+      </table>
+
+<!-- ** ** ** ** ** Part to display the GRAPHIC ** ** ** ** ** -->
+<br>
+
+<?php 
+
+if (is_array($list_total_day) && count($list_total_day)>0){
+
+$mmax=0;
+$totalcall==0;
+$totalminutes=0;
+foreach ($list_total_day as $data){
+	if ($mmax < $data[1]) $mmax=$data[1];
+	$totalcall+=$data[3];
+	$totalminutes+=$data[1];
+	$totalcost+=$data[2];
+}
+
+?>
+
+
+<!-- TITLE GLOBAL -->
+<center>
+ <table border="0" cellspacing="0" cellpadding="0" width="80%"><tr><td align="left" height="30">
+		<table cellspacing="0" cellpadding="1" bgcolor="#000000" width="50%"><tr><td>
+			<table cellspacing="0" cellpadding="0" width="100%">
+				<tr><td class="callhistory_td1" align="left" ><?php echo gettext("SUMMARY");?></td></tr>
+			</table>
+		</td></tr></table>
+ </td></tr></table>
+
+<!-- FIN TITLE GLOBAL MINUTES //-->
+
+<table border="0" cellspacing="0" cellpadding="0"  width="80%">
+<tr><td bgcolor="#000000">			
+	<table border="0" cellspacing="1" cellpadding="2" width="100%">
+	<tr>
+		<td align="center" class="callhistory_td2"></td>
+    	<td class="callhistory_td3" align="center" colspan="5"><?php echo gettext("CALLING CARD MINUTES");?></td>
+    </tr>
+	<tr>
+		<td align="center" class="callhistory_td3"><?php echo gettext("DATE");?></td>
+        <td align="center" class="callhistory_td2"><?php echo gettext("DURATION");?></td>
+		<td align="center" class="callhistory_td2"><?php echo gettext("GRAPHIC");?></td>
+		<td align="center" class="callhistory_td2"><?php echo gettext("CALLS");?></td>
+		<td align="center" class="callhistory_td2"><acronym title="<?php echo gettext("AVERAGE LENGTH OF CALL");?>"><?php echo gettext("ALOC");?></acronym></font></td>
+		<td align="center" class="callhistory_td2"><?php echo gettext("TOTAL COST");?></td>
+
+		<!-- LOOP -->
+	<?php
+		$i=0;
+		foreach ($list_total_day as $data) {	
+			$i=($i+1)%2;
+			$tmc = $data[1]/$data[3];
+			
+			if ((!isset($resulttype)) || ($resulttype=="min")){  
+				$tmc = sprintf("%02d",intval($tmc/60)).":".sprintf("%02d",intval($tmc%60));		
+			}else{
+				$tmc =intval($tmc);
+			}
+			
+			if ((!isset($resulttype)) || ($resulttype=="min")){  
+				$minutes = sprintf("%02d",intval($data[1]/60)).":".sprintf("%02d",intval($data[1]%60));
+			}else{
+				$minutes = $data[1];
+			}
+			if ($mmax>0) 	$widthbar= intval(($data[1]/$mmax)*200); 
+			
+		?>
+			</tr><tr>
+			<td align="right" class="sidenav" nowrap="nowrap"><font class="callhistory_td5"><?php echo $data[0]?></font></td>
+			<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001"><?php echo $minutes?> </td>
+	        <td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="left" nowrap="nowrap" width="<?php echo $widthbar+60?>">
+		        <table cellspacing="0" cellpadding="0"><tr>
+		        	<td bgcolor="#e22424"><img src="<?php echo Images_Path_Main ?>/spacer.gif" width="<?php echo $widthbar?>" height="6"></td>
+		        </tr></table>
+	        </td>
+	        <td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001"><?php echo $data[3]?></td>
+	        <td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001" ><?php echo $tmc?> </td>
+			<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001"><?php  display_2bill($data[2]) ?></td>
+     	<?php 	 
+     	}	 	 	
+	 	
+		if ((!isset($resulttype)) || ($resulttype=="min")){  
+			$total_tmc = sprintf("%02d",intval(($totalminutes/$totalcall)/60)).":".sprintf("%02d",intval(($totalminutes/$totalcall)%60));				
+			$totalminutes = sprintf("%02d",intval($totalminutes/60)).":".sprintf("%02d",intval($totalminutes%60));
+		}else{
+			$total_tmc = intval($totalminutes/$totalcall);			
+		}
+	 
+	 ?>                   	
+	</tr>
+
+	<!-- TOTAL -->
+	<tr class="callhistory_td2">
+		<td align="right" nowrap="nowrap" class="callhistory_td4"><?php echo gettext("TOTAL");?></td>
+		<td align="center" nowrap="nowrap" colspan="2" class="callhistory_td4"><?php echo $totalminutes?> </td>
+		<td align="center" nowrap="nowrap" class="callhistory_td4"><?php echo $totalcall?></td>
+		<td align="center" nowrap="nowrap" class="callhistory_td4"><?php echo $total_tmc?></td>
+		<td align="center" nowrap="nowrap" class="callhistory_td4"><?php  display_2bill($totalcost) ?></td>
+	</tr>
+	
+	</table>
+	  
+</td></tr></table>
+
+<!-- SECTION EXPORT //--> &nbsp; &nbsp; 
+
+ <table border="0" cellspacing="0" cellpadding="0" width="80%"><tr><td align="left" height="30">
+		<table cellspacing="0" cellpadding="1" bgcolor="#000000" width="50%"><tr><td>
+			<table cellspacing="0" cellpadding="0" width="100%">
+				<tr><td class="callhistory_td1" align="left" ><?php echo gettext("CDR TO DOWNLOAD");?></td></tr>
+			</table>
+		</td></tr></table>
+ </td></tr></table>
+
+<table border="0" cellspacing="0" cellpadding="0"  width="80%">
+<tr><td >			
+	<table border="0" cellspacing="1" cellpadding="2" width="50%">
+	<tr>
+		<td align="center" class="callhistory_td3"><?php echo gettext("CDR Date");?></td>
+        <td align="center" class="callhistory_td2"><?php echo gettext("File to Download");?></td>
+	</tr>
+
+	<!-- LOOP -->
+<?php
+    $dir = "/var/www/html/billing/customer_cdr/".$_SESSION["card_id"];
+	$dh = opendir($dir);
+	$files=array();
+    while (($file = readdir($dh)) !== false) {
+		if (is_file($dir.'/'.$file) && $file != "." && $file != ".."){ 
+			if($file!=".DS_Store"){
+				$files[] = $file;
+			}
+		}
+	}
+	closedir($dh);
+	sort($files, SORT_LOCALE_STRING);
+	foreach ($files as $f){
+		$data_date = substr($f,strpos($f, '_') + 1,8);
+		$data_date = substr($data_date,0,4)."-".substr($data_date,4,2)."-".substr($data_date,6,2);
+?>
+			<tr>
+				<td align="right" class="callhistory_td3"> <?php echo "$data_date"?></td>
+				<td align="center" class="callhistory_td2">
+					<a href="export_csv_customer.php?var_file=<?php echo "$f"?>&var_card_id=<?php echo $_SESSION["card_id"]?>" target="_blank"><?php echo gettext ( "CDR File" ); ?></a> 
+				</td>
+			</tr>
+<?php
+	}
+?>
+	</table>
+</td></tr></table>
+- &nbsp; &nbsp;
+
+<?php  } else { ?>
+	<center><h3><?php echo gettext("No calls in your selection");?>.</h3></center>
+<?php  } ?>
+</center>
+
+<?php
+
+$smarty->display( 'footer.tpl');
+
+
diff -urN -x lib a2billing_v1.9.4/customer/call.php a2billing/customer/call.php
--- a2billing_v1.9.4/customer/call.php	1969-12-31 21:00:00.000000000 -0300
+++ a2billing/customer/call.php	2012-09-18 17:30:50.000000000 -0300
@@ -0,0 +1,658 @@
+<?php
+
+/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
+
+/**
+ * This file is part of A2Billing (http://www.a2billing.net/)
+ *
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
+ * powered by Star2billing S.L. <http://www.star2billing.com/>
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
+ * @author      Belaid Arezqui <areski@gmail.com>
+ * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
+ * @package     A2Billing
+ *
+ * Software License Agreement (GNU Affero General Public License)
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Affero General Public License as
+ * published by the Free Software Foundation, either version 3 of the
+ * License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Affero General Public License for more details.
+ *
+ * You should have received a copy of the GNU Affero General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ * 
+ * 
+**/
+
+
+include ("lib/customer.defines.php");
+include ("lib/customer.module.access.php");
+include ("lib/customer.smarty.php");
+
+
+if (! has_rights (ACX_CALL_HISTORY)) { 
+	Header ("HTTP/1.0 401 Unauthorized");
+	Header ("Location: PP_error.php?c=accessdenied");	   
+	die();
+}
+
+getpost_ifset(array('posted', 'Period', 'frommonth', 'fromstatsmonth', 'tomonth', 'tostatsmonth', 'fromday', 'fromstatsday_sday', 'fromstatsmonth_sday', 'today', 'tostatsday_sday', 'tostatsmonth_sday', 'phonenumbertype', 'sourcetype', 'clidtype', 'channel', 'resulttype', 'stitle', 'atmenu', 'current_page', 'order', 'sens', 'phonenumber', 'src', 'clid', 'choose_currency', 'terminatecauseid', 'choose_calltype', 'download', 'file'));
+
+
+if (($download == "file") && $file && $ACXSEERECORDING) {
+	
+	if (strpos($file, '/') !== false) exit;
+	
+	$value_de = base64_decode ( $file );
+	$dl_full = MONITOR_PATH . "/" . $value_de;
+	$dl_name = $value_de;
+	
+	if (! file_exists ( $dl_full )) {
+		echo gettext ( "ERROR: Cannot download file " . $dl_full . ", it does not exist.<br>" );
+		exit ();
+	}
+	
+	header ( "Content-Type: application/octet-stream" );
+	header ( "Content-Disposition: attachment; filename=$dl_name" );
+	header ( "Content-Length: " . filesize ( $dl_full ) );
+	header ( "Accept-Ranges: bytes" );
+	header ( "Pragma: no-cache" );
+	header ( "Expires: 0" );
+	header ( "Cache-Control: must-revalidate, post-check=0, pre-check=0" );
+	header ( "Content-transfer-encoding: binary" );
+	
+	@readfile ( $dl_full );
+	exit ();
+}
+
+
+$QUERY = "SELECT username, credit, lastname, firstname, address, city, state, country, zipcode, phone, email, fax, lastuse, activated, status FROM cc_card WHERE username = '".$_SESSION["pr_login"]."' AND uipass = '".$_SESSION["pr_password"]."'";
+
+$DBHandle_max = DbConnect();
+$numrow = 0;
+$resmax = $DBHandle_max -> Execute($QUERY);
+if ($resmax)
+	$numrow = $resmax -> RecordCount();
+
+if ($numrow == 0) exit();
+$customer_info =$resmax -> fetchRow();
+
+if ($customer_info[14] != "1" && $customer_info[14] != "8") {
+	Header("HTTP/1.0 401 Unauthorized");
+	Header("Location: PP_error.php?c=accessdenied");
+	die();
+}
+
+$customer = $_SESSION["card_id"];
+
+
+$dialstatus_list = Constants::getDialStatusList();
+
+if (!isset ($current_page) || ($current_page == "")) {
+	$current_page=0;
+}
+
+$FG_DEBUG = 0;
+$FG_TABLE_NAME="cc_call t1";
+
+// THIS VARIABLE DEFINE THE COLOR OF THE HEAD TABLE
+$FG_TABLE_ALTERNATE_ROW_COLOR[] = "#FFFFFF";
+$FG_TABLE_ALTERNATE_ROW_COLOR[] = "#F2F8FF";
+
+$yesno = array();
+$yesno["1"] = array( "Yes", "1");
+$yesno["0"] = array( "No", "0");
+
+// 0 = NORMAL CALL ; 1 = VOIP CALL (SIP/IAX) ; 2= DIDCALL + TRUNK ; 3 = VOIP CALL DID ; 4 = CALLBACK call
+$list_calltype = array(); 
+$list_calltype["0"]  = array( gettext("STANDARD"), "0");
+$list_calltype["1"]  = array( gettext("SIP/IAX"), "1");
+$list_calltype["2"]  = array( gettext("DIDCALL"), "2");
+$list_calltype["3"]  = array( gettext("DID_VOIP"), "3");
+$list_calltype["4"]  = array( gettext("CALLBACK"), "4");
+$list_calltype["5"]  = array( gettext("PREDICT"), "5");
+$list_calltype ["6"] = array (gettext("AUTO DIALER"), "6" );
+$list_calltype ["7"] = array (gettext("DID-ALEG"), "7" );
+
+$DBHandle  = DbConnect();
+
+$FG_TABLE_DEFAULT_ORDER = "starttime";
+$FG_TABLE_DEFAULT_SENS = "DESC";
+
+$FG_TABLE_COL = array();
+$FG_TABLE_COL[]=array (gettext("Date"), "starttime", "17%", "center", "SORT", "22", "", "", "", "", "", "");
+$FG_TABLE_COL[]=array (gettext("CallerID"), "source", "14%", "center", "SORT", "30");
+$FG_TABLE_COL[]=array (gettext("PhoneNumber"), "calledstation", "14%", "center", "SORT", "30", "", "", "", "", "", "");
+$FG_TABLE_COL[]=array (gettext("Destination"), "destination", "14%", "center", "SORT", "30", "lie", "cc_prefix", "destination", "prefix='%id'", "%1" );
+$FG_TABLE_COL[]=array (gettext("Duration"), "sessiontime", "10%", "center", "SORT", "30", "", "", "", "", "", "display_minute");
+$FG_TABLE_COL[]=array ('<acronym title="'.gettext("Terminate Cause").'">'.gettext("TC").'</acronym>', "terminatecauseid", "10%", "center", "SORT", "", "list", $dialstatus_list);
+$FG_TABLE_COL[]=array (gettext("CallType"), "sipiax", "12%", "center", "SORT",  "", "list", $list_calltype);
+$FG_TABLE_COL[]=array (gettext("Cost"), "sessionbill", "12%", "center", "SORT", "30", "", "", "", "", "", "display_2bill");
+
+if ($ACXSEERECORDING) {
+	$FG_TABLE_COL [] = array ("", "uniqueid", "1%", "center", "", "30", "", "", "", "", "", "linkonmonitorfile_customer" );
+}
+
+$FG_COL_QUERY = 't1.starttime, t1.src, t1.calledstation, t1.destination, t1.sessiontime, t1.terminatecauseid, t1.sipiax, t1.sessionbill';
+
+if ($ACXSEERECORDING) {
+	$FG_COL_QUERY .= ', t1.uniqueid';
+}
+
+$FG_LIMITE_DISPLAY = 25;
+$FG_NB_TABLE_COL = count($FG_TABLE_COL);
+$FG_EDITION = true;
+$FG_TOTAL_TABLE_COL = $FG_NB_TABLE_COL;
+if ($FG_DELETION || $FG_EDITION) $FG_TOTAL_TABLE_COL++;
+$FG_HTML_TABLE_TITLE = " - ".gettext("Call Logs")." - ";
+$FG_HTML_TABLE_WIDTH = "98%";
+
+
+$instance_table = new Table($FG_TABLE_NAME, $FG_COL_QUERY);
+
+if ( is_null ($order) || is_null($sens) ){
+	$order = $FG_TABLE_DEFAULT_ORDER;
+	$sens  = $FG_TABLE_DEFAULT_SENS;
+}
+
+if ($posted==1) {
+	$SQLcmd = '';
+	$SQLcmd = do_field($SQLcmd, 'src', 'source');
+	$SQLcmd = do_field($SQLcmd, 'phonenumber', 'calledstation');
+}
+
+$date_clause = '';
+  
+//Obtengo offset del server respecto a UTC
+$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
+foreach ($timezone_list as $key => $timezone_list_val) {
+	$server_offset = $timezone_list_val[3];
+	break;
+}
+//Obtengo el offset del account respecto a UTC
+$account_offset = $_SESSION["gmtoffset"];
+
+$actual_date = date("Y-m-d H:i:s");
+$date_time_array = getdate(strtotime($actual_date));
+$hours = $date_time_array['hours'];
+$minutes = $date_time_array['minutes'];
+$seconds = $date_time_array['seconds'];
+$month = $date_time_array['mon'];
+$day = $date_time_array['mday'];
+$year = $date_time_array['year'];
+$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+
+//dia de ayer segun horario del cliente
+$timestamp = $timestamp -($server_offset - $account_offset) - 86400 ;
+$timestamp = date("Y-m-d", $timestamp);
+	
+$date_time_array = getdate(strtotime($timestamp));
+$hours = $date_time_array['hours'];
+$minutes = $date_time_array['minutes'];
+$seconds = $date_time_array['seconds'];
+$month = $date_time_array['mon'];
+$day = $date_time_array['mday'];
+$year = $date_time_array['year'];
+$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+
+$timestamp = $timestamp  + ($server_offset - $account_offset);
+
+$timestamp = date("Y-m-d H:i:s", $timestamp);
+
+$date_clause= " and t1.starttime >= ('$timestamp')";
+
+//calculo el offset general	
+$date_offset = (-($server_offset - $account_offset)) / 60 / 60 ;
+
+if (strpos($SQLcmd, 'WHERE') > 0) {
+	$FG_TABLE_CLAUSE = substr($SQLcmd,6).$date_clause;
+} else {
+	$FG_TABLE_CLAUSE = substr($date_clause,5);
+}
+
+if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE.=" AND ";
+$FG_TABLE_CLAUSE.="t1.card_id='$customer'";
+
+
+if (isset($choose_calltype) && ($choose_calltype!=-1)) {
+	if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE.=" AND ";
+	$FG_TABLE_CLAUSE .= " t1.sipiax='$choose_calltype' ";
+}
+
+if (!isset($terminatecauseid)) {
+	$terminatecauseid="ANSWER";
+} elseif ($terminatecauseid=="ANSWER") {
+	if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=1) ";
+}
+
+//CREO TABLA TEMPORAL
+$sql1 = "CREATE TEMPORARY TABLE cc_call_archive_temp (SELECT t1.starttime, t1.src, t1.calledstation, t1.destination, t1.sessiontime, t1.terminatecauseid, ";
+$sql1 .= "t1.sipiax, t1.sessionbill FROM cc_call_archive t1 WHERE ".$FG_TABLE_CLAUSE." )";
+
+$res = $DBHandle -> Execute($sql1);
+
+if (!$nodisplay) {
+	$list = $instance_table -> Get_list_union ($DBHandle, $FG_TABLE_CLAUSE, $order, $sens, null, null, $FG_LIMITE_DISPLAY, $current_page*$FG_LIMITE_DISPLAY, null, null);
+	//$list = $instance_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE, $order, $sens, null, null, $FG_LIMITE_DISPLAY, $current_page*$FG_LIMITE_DISPLAY);
+}
+
+$_SESSION["pr_sql_export"] = "SELECT $FG_COL_QUERY FROM $FG_TABLE_NAME WHERE $FG_TABLE_CLAUSE";
+
+if ($date_offset < 0) {
+	$off_temp = -$date_offset;
+	$QUERY = "SELECT DATE(DATE_SUB(tbl.starttime,INTERVAL $off_temp HOUR)) AS day, sum(tbl.sessiontime) AS calltime, sum(tbl.sessionbill) AS cost, count(*) as nbcall FROM (";
+} else {
+	$QUERY = "SELECT DATE(DATE_ADD(tbl.starttime,INTERVAL $date_offset HOUR)) AS day, sum(tbl.sessiontime) AS calltime, sum(tbl.sessionbill) AS cost, count(*) as nbcall FROM (";
+}
+$QUERY .= " select t1.starttime, t1.sessiontime,t1.sessionbill FROM $FG_TABLE_NAME WHERE ".$FG_TABLE_CLAUSE;
+$QUERY .= " UNION ALL select t1.starttime, t1.sessiontime,t1.sessionbill FROM cc_call_archive_temp t1 ) tbl ";
+$QUERY .= " GROUP BY day ORDER BY day"; //extract(DAY from calldate)
+
+if (!$nodisplay) {
+	$res = $DBHandle -> Execute($QUERY);
+	if ($res) {
+		$num = $res -> RecordCount();
+		for($i=0;$i<$num;$i++) {				
+			$list_total_day [] =$res -> fetchRow();
+		}
+	}
+
+	$row_temp = 0;
+	$QUERY = "select count(*) from cc_call_archive_temp";
+	$res = $DBHandle -> Execute($QUERY);
+	if ($res) {
+		$row = $res -> fetchRow();
+		$row_temp = $row['0'];
+	}
+
+	if ($FG_DEBUG == 3) echo "<br>Clause : $FG_TABLE_CLAUSE";
+	$nb_record = $instance_table -> Table_count ($DBHandle, $FG_TABLE_CLAUSE);
+	$nb_record = $nb_record + $row_temp;
+	if ($FG_DEBUG >= 1) var_dump ($list);
+}
+
+//Borro tabla temporal
+$sql1 = "DROP TABLE cc_call_archive_temp";
+$res = $DBHandle -> Execute($sql1);
+
+
+if ($nb_record<=$FG_LIMITE_DISPLAY) { 
+	$nb_record_max=1;
+} else { 
+	if ($nb_record % $FG_LIMITE_DISPLAY == 0) {
+		$nb_record_max=(intval($nb_record/$FG_LIMITE_DISPLAY));
+	} else {
+		$nb_record_max=(intval($nb_record/$FG_LIMITE_DISPLAY)+1);
+	}	
+}
+
+
+$smarty->display( 'main.tpl');
+
+// #### HELP SECTION
+echo $CC_help_balance_customer_calls;
+
+?>
+
+
+<!-- ** ** ** ** ** Part for the research ** ** ** ** ** -->
+	<center>
+	<FORM METHOD=POST ACTION="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php echo $current_page?>&terminatecauseid=<?php echo $terminatecauseid?>">
+		<INPUT TYPE="hidden" NAME="posted" value=1>
+		<INPUT TYPE="hidden" NAME="current_page" value=0>
+		<table class="callhistory_maintable" align="center">
+			
+			
+			<tr>
+				<td  align="left" class="bgcolor_004">
+					<font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("PHONENUMBER");?></font>
+				</td>
+				<td  align="left" class="bgcolor_005">
+				<table width="100%" border="0" cellspacing="0" cellpadding="0">
+				<tr><td class="fontstyle_searchoptions">&nbsp;&nbsp;<INPUT TYPE="text" NAME="phonenumber" value="<?php echo $phonenumber?>" class="form_input_text"></td>
+				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="1" <?php if((!isset($phonenumbertype))||($phonenumbertype==1)){?>checked<?php }?>><?php echo gettext("Exact");?></td>
+				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="2" <?php if($phonenumbertype==2){?>checked<?php }?>><?php echo gettext("Begins with")?></td>
+				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="3" <?php if($phonenumbertype==3){?>checked<?php }?>><?php echo gettext("Contains");?></td>
+				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="4" <?php if($phonenumbertype==4){?>checked<?php }?>><?php echo gettext("Ends with");?></td>
+				</tr></table></td>
+			</tr>		
+			<!-- Select Calltype: -->
+			<tr>
+			  <td class="bgcolor_002" align="left" ><font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("CALL TYPE"); ?></font></td>
+			  <td class="bgcolor_003" align="center">
+			  <table width="100%" border="0" cellspacing="0" cellpadding="0">
+								<tr>
+					<td  class="fontstyle_searchoptions">
+					<select NAME="choose_calltype" size="1" class="form_input_select" >
+						<option value='-1' <?php if (($choose_calltype==-1) || (!isset($choose_calltype))){?>selected<?php } ?>><?php echo gettext('ALL CALLS') ?>
+								</option>
+							<?php
+								foreach($list_calltype as $key => $cur_value) {
+							?>
+								<option value='<?php echo $cur_value[1] ?>' <?php if ($choose_calltype==$cur_value[1]){?>selected<?php } ?>><?php echo gettext($cur_value[0]) ?>
+								</option>
+							<?php 	} ?>
+						</select>
+					</td>
+				</tr>				
+				</table>
+			  </td>
+			  </tr>
+	
+			<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
+			<tr>
+			  <td class="bgcolor_002" align="left" ><font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("OPTIONS"); ?></font></td>
+			  <td class="bgcolor_003" align="center">
+			  <table width="100%" border="0" cellspacing="0" cellpadding="0">
+				<tr>
+					<td width="20%"  class="fontstyle_searchoptions">
+						<?php echo gettext("SHOW");?> :  						
+				   </td>
+				   <td width="80%"  class="fontstyle_searchoptions">				   		
+				 <?php echo gettext("Answered Calls"); ?>
+				  <input name="terminatecauseid" type="radio" value="ANSWER" <?php if((!isset($terminatecauseid))||($terminatecauseid=="ANSWER")){?>checked<?php }?> />
+				  <?php echo gettext("All Calls"); ?>
+
+				   <input name="terminatecauseid" type="radio" value="ALL" <?php if($terminatecauseid=="ALL"){?>checked<?php }?>/>
+					</td>
+				</tr>
+				<tr class="bgcolor_005">
+					<td  class="fontstyle_searchoptions">
+						<?php echo gettext("RESULT");?> : 
+				   </td>
+				   <td  class="fontstyle_searchoptions">
+					<?php echo gettext("Minutes");?><input type="radio" NAME="resulttype" value="min" <?php if((!isset($resulttype))||($resulttype=="min")){?>checked<?php }?>> - <?php echo gettext("Seconds");?> <input type="radio" NAME="resulttype" value="sec" <?php if($resulttype=="sec"){?>checked<?php }?>>
+					</td>
+				</tr>
+				<tr>
+					<td  class="fontstyle_searchoptions">
+						<?php echo gettext("CURRENCY");?> :
+					</td>
+					<td  class="fontstyle_searchoptions">
+					<select NAME="choose_currency" size="1" class="form_input_select" >
+							<?php
+								$currencies_list = get_currencies();
+								foreach($currencies_list as $key => $cur_value) {
+							?>
+								<option value='<?php echo $key ?>' <?php if (($choose_currency==$key) || (!isset($choose_currency) && $key==strtoupper(BASE_CURRENCY))){?>selected<?php } ?>><?php echo $cur_value[1].' ('.$cur_value[2].')' ?>
+								</option>
+							<?php 	} ?>
+						</select>
+					</td>
+				</tr>				
+				</table>
+			  </td>
+			  </tr>
+			<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
+			
+			<tr>
+        		<td class="bgcolor_004" align="left" > </td>
+				<td class="bgcolor_005" align="center" >
+					<input class="form_input_button" value=" <?php echo gettext("Search");?> " type="submit">
+	  			</td>
+    		</tr>
+	</table>
+	</FORM>
+</center>
+
+
+<!-- ** ** ** ** ** Part to display the CDR ** ** ** ** ** -->
+<center><?php echo gettext("Number of Calls");?> : <?php  if (is_array($list) && count($list)>0){ echo $nb_record; }else{echo "0";}?></center>
+     <table width="<?php echo $FG_HTML_TABLE_WIDTH?>" border="0" align="center" cellpadding="0" cellspacing="0">
+		<TR bgcolor="#ffffff"> 
+          <TD class="callhistory_td11"> 
+            <TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+                <TR> 
+                  <TD><SPAN style="COLOR: #ffffff; FONT-SIZE: 11px"><B><?php echo $FG_HTML_TABLE_TITLE?></B></SPAN></TD>
+                </TR>
+            </TABLE></TD>
+        </TR>
+        <TR> 
+          <TD> <TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+                <TR class="bgcolor_008">
+				  <TD width="<?php echo $FG_ACTION_SIZE_COLUMN?>" align="center" class="tableBodyRight" style="PADDING-BOTTOM: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; PADDING-TOP: 2px"></TD>					
+				  
+                  <?php 
+				  	if (is_array($list) && count($list)>0) {
+					
+				  	for($i=0;$i<$FG_NB_TABLE_COL;$i++) {
+					?>
+	                  <TD width="<?php echo $FG_TABLE_COL[$i][2]?>" align=middle class="tableBody" style="PADDING-BOTTOM: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; PADDING-TOP: 2px"> 
+	                    <center><strong> 
+	                    <?php  if (strtoupper($FG_TABLE_COL[$i][4])=="SORT"){?>
+	                    <a href="<?php  echo $PHP_SELF."?customer=$customer&s=1&t=0&stitle=$stitle&atmenu=$atmenu&current_page=$current_page&order=".$FG_TABLE_COL[$i][1]."&sens="; if ($sens=="ASC"){echo"DESC";}else{echo"ASC";} 
+						echo "&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&phonenumbertype=$phonenumbertype&sourcetype=$sourcetype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&phonenumber=$phonenumber&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype";?>"> 
+	                    <span class="liens"><?php  } ?>
+	                    <?php echo $FG_TABLE_COL[$i][0]?> 
+	                    <?php if ($order==$FG_TABLE_COL[$i][1] && $sens=="ASC"){?>
+	                    &nbsp;<img src="<?php echo Images_Path_Main ?>/icon_up_12x12.GIF" width="12" height="12" border="0"> 
+	                    <?php }elseif ($order==$FG_TABLE_COL[$i][1] && $sens=="DESC"){?>
+	                    &nbsp;<img src="<?php echo Images_Path_Main ?>/icon_down_12x12.GIF" width="12" height="12" border="0"> 
+	                    <?php }?>
+	                    <?php  if (strtoupper($FG_TABLE_COL[$i][4])=="SORT"){?>
+	                    </span></a> 
+	                    <?php }?>
+	                    </strong></center></TD>
+				   <?php } ?>
+				   		
+                </TR>
+                <TR> 
+                  <TD bgColor="#e1e1e1" colSpan=<?php echo $FG_TOTAL_TABLE_COL?> height="1">
+                </TR>
+				<?php
+				  	 $ligne_number=0;					 
+				  	 foreach ($list as $recordset){ 
+						 $ligne_number++;
+						 $recordset[0] = display_GMT($recordset[0], $_SESSION["gmtoffset"], 1);
+				?>
+				
+               		 <TR bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>"  onMouseOver="bgColor='#C4FFD7'" onMouseOut="bgColor='<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>'"> 
+						<TD align="<?php echo $FG_TABLE_COL[$i][3]?>" class="tableBody"><?php  echo $ligne_number+$current_page*$FG_LIMITE_DISPLAY.".&nbsp;"; ?></TD>
+							 
+				  		<?php for($i=0;$i<$FG_NB_TABLE_COL;$i++){ ?>
+						<?php 				
+							if ($FG_TABLE_COL[$i][6]=="lie"){
+									$instance_sub_table = new Table($FG_TABLE_COL[$i][7], $FG_TABLE_COL[$i][8]);
+									$sub_clause = str_replace("%id", $recordset[$i], $FG_TABLE_COL[$i][9]);																																	
+									$select_list = $instance_sub_table -> Get_list ($DBHandle, $sub_clause, null, null, null, null, null, null);
+									
+									
+									$field_list_sun = preg_split('/,/',$FG_TABLE_COL[$i][8]);
+									$record_display = $FG_TABLE_COL[$i][10];
+									
+									for ($l=1;$l<=count($field_list_sun);$l++){										
+										$record_display = str_replace("%$l", $select_list[0][$l-1], $record_display);	
+									}
+								
+							}elseif ($FG_TABLE_COL[$i][6]=="list"){
+									$select_list = $FG_TABLE_COL[$i][7];
+									$record_display = $select_list[$recordset[$i]][0];
+							
+							}else{
+									$record_display = $recordset[$i];
+							}
+							
+							if ( is_numeric($FG_TABLE_COL[$i][5]) && (strlen($record_display) > $FG_TABLE_COL[$i][5]) ) {
+								$record_display = substr($record_display, 0, $FG_TABLE_COL[$i][5]-3)."";  
+							}
+							
+							
+				 		 ?>
+                 		 <TD vAlign=top align="<?php echo $FG_TABLE_COL[$i][3]?>" class=tableBody><?php 
+                 		 if (isset ($FG_TABLE_COL[$i][11]) && strlen($FG_TABLE_COL[$i][11])>1){
+						 	call_user_func($FG_TABLE_COL[$i][11], $record_display);
+						 }else{
+						 	echo stripslashes($record_display);
+						 }						 
+						 ?></TD>
+				 		 <?php  } ?>
+                  
+					</TR>
+				<?php
+					 }//foreach ($list as $recordset)
+					 if ($ligne_number < $FG_LIMITE_DISPLAY)  $ligne_number_end=$ligne_number +2;
+					 while ($ligne_number < $ligne_number_end){
+					 	$ligne_number++;
+				?>
+					<TR bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>"> 
+				  		<?php for($i=0;$i<$FG_NB_TABLE_COL;$i++){ 
+				 		 ?>
+                 		 <TD vAlign=top class=tableBody>&nbsp;</TD>
+				 		 <?php  } ?>
+                 		 <TD align="center" vAlign=top class=tableBodyRight>&nbsp;</TD>				
+					</TR>
+									
+				<?php					 
+					 } //END_WHILE
+					 
+				  }else{
+				  		echo gettext("No data found !!!");
+				  }//end_if
+				 ?>
+            </TABLE></td>
+        </tr>
+        <TR bgcolor="#ffffff"> 
+          <TD bgColor=#ADBEDE height=16 style="PADDING-LEFT: 5px; PADDING-RIGHT: 3px"> 
+			<TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+                <TR> 
+                  <TD align="right"><SPAN style="COLOR: #ffffff; FONT-SIZE: 11px"><B> 
+                    <?php if ($current_page>0){?>
+                    <img src="<?php echo Images_Path_Main ?>/fleche-g.gif" width="5" height="10"> <a href="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php  echo ($current_page-1)?><?php  if (!is_null($letter) && ($letter!="")){ echo "&letter=$letter";} 
+					echo "&customer=$customer&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&phonenumbertype=$phonenumbertype&sourcetype=$sourcetype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&phonenumber=$phonenumber&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype";?>"> 
+                    <?php echo gettext("PREVIOUS");?> </a> -
+                    <?php }?>
+                    <?php echo ($current_page+1);?> / <?php  echo $nb_record_max;?> 
+                    <?php if ($current_page<$nb_record_max-1){?>
+                    - <a href="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php  echo ($current_page+1)?><?php  if (!is_null($letter) && ($letter!="")){ echo "&letter=$letter";} 
+					echo "&customer=$customer&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&phonenumbertype=$phonenumbertype&sourcetype=$sourcetype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&phonenumber=$phonenumber&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype";?>"> 
+                    <?php echo gettext("NEXT");?> </a> <img src="<?php echo Images_Path_Main ?>/fleche-d.gif" width="5" height="10">
+                    </B></SPAN> 
+                    <?php }?>
+                  </TD>
+            </TABLE></TD>
+        </TR>
+      </table>
+
+<!-- ** ** ** ** ** Part to display the GRAPHIC ** ** ** ** ** -->
+<br>
+
+<?php 
+
+if (is_array($list_total_day) && count($list_total_day)>0){
+
+$mmax=0;
+$totalcall==0;
+$totalminutes=0;
+foreach ($list_total_day as $data){
+	if ($mmax < $data[1]) $mmax=$data[1];
+	$totalcall+=$data[3];
+	$totalminutes+=$data[1];
+	$totalcost+=$data[2];
+}
+
+?>
+
+
+<!-- TITLE GLOBAL -->
+<center>
+ <table border="0" cellspacing="0" cellpadding="0" width="80%"><tr><td align="left" height="30">
+		<table cellspacing="0" cellpadding="1" bgcolor="#000000" width="50%"><tr><td>
+			<table cellspacing="0" cellpadding="0" width="100%">
+				<tr><td class="callhistory_td1" align="left" ><?php echo gettext("SUMMARY");?></td></tr>
+			</table>
+		</td></tr></table>
+ </td></tr></table>
+
+<!-- FIN TITLE GLOBAL MINUTES //-->
+
+<table border="0" cellspacing="0" cellpadding="0"  width="80%">
+<tr><td bgcolor="#000000">			
+	<table border="0" cellspacing="1" cellpadding="2" width="100%">
+	<tr>
+		<td align="center" class="callhistory_td2"></td>
+    	<td class="callhistory_td3" align="center" colspan="5"><?php echo gettext("CALLING CARD MINUTES");?></td>
+    </tr>
+	<tr>
+		<td align="center" class="callhistory_td3"><?php echo gettext("DATE");?></td>
+        <td align="center" class="callhistory_td2"><?php echo gettext("DURATION");?></td>
+		<td align="center" class="callhistory_td2"><?php echo gettext("GRAPHIC");?></td>
+		<td align="center" class="callhistory_td2"><?php echo gettext("CALLS");?></td>
+		<td align="center" class="callhistory_td2"><acronym title="<?php echo gettext("AVERAGE LENGTH OF CALL");?>"><?php echo gettext("ALOC");?></acronym></font></td>
+		<td align="center" class="callhistory_td2"><?php echo gettext("TOTAL COST");?></td>
+
+		<!-- LOOP -->
+	<?php
+		$i=0;
+		foreach ($list_total_day as $data) {	
+			$i=($i+1)%2;
+			$tmc = $data[1]/$data[3];
+			
+			if ((!isset($resulttype)) || ($resulttype=="min")){  
+				$tmc = sprintf("%02d",intval($tmc/60)).":".sprintf("%02d",intval($tmc%60));		
+			}else{
+				$tmc =intval($tmc);
+			}
+			
+			if ((!isset($resulttype)) || ($resulttype=="min")){  
+				$minutes = sprintf("%02d",intval($data[1]/60)).":".sprintf("%02d",intval($data[1]%60));
+			}else{
+				$minutes = $data[1];
+			}
+			if ($mmax>0) 	$widthbar= intval(($data[1]/$mmax)*200); 
+			
+		?>
+			</tr><tr>
+			<td align="right" class="sidenav" nowrap="nowrap"><font class="callhistory_td5"><?php echo $data[0]?></font></td>
+			<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001"><?php echo $minutes?> </td>
+	        <td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="left" nowrap="nowrap" width="<?php echo $widthbar+60?>">
+		        <table cellspacing="0" cellpadding="0"><tr>
+		        	<td bgcolor="#e22424"><img src="<?php echo Images_Path_Main ?>/spacer.gif" width="<?php echo $widthbar?>" height="6"></td>
+		        </tr></table>
+	        </td>
+	        <td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001"><?php echo $data[3]?></td>
+	        <td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001" ><?php echo $tmc?> </td>
+			<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001"><?php  display_2bill($data[2]) ?></td>
+     	<?php 	 
+     	}	 	 	
+	 	
+		if ((!isset($resulttype)) || ($resulttype=="min")){  
+			$total_tmc = sprintf("%02d",intval(($totalminutes/$totalcall)/60)).":".sprintf("%02d",intval(($totalminutes/$totalcall)%60));				
+			$totalminutes = sprintf("%02d",intval($totalminutes/60)).":".sprintf("%02d",intval($totalminutes%60));
+		}else{
+			$total_tmc = intval($totalminutes/$totalcall);			
+		}
+	 
+	 ?>                   	
+	</tr>
+
+	<!-- TOTAL -->
+	<tr class="callhistory_td2">
+		<td align="right" nowrap="nowrap" class="callhistory_td4"><?php echo gettext("TOTAL");?></td>
+		<td align="center" nowrap="nowrap" colspan="2" class="callhistory_td4"><?php echo $totalminutes?> </td>
+		<td align="center" nowrap="nowrap" class="callhistory_td4"><?php echo $totalcall?></td>
+		<td align="center" nowrap="nowrap" class="callhistory_td4"><?php echo $total_tmc?></td>
+		<td align="center" nowrap="nowrap" class="callhistory_td4"><?php  display_2bill($totalcost) ?></td>
+	</tr>
+	
+	</table>
+	  
+</td></tr></table>
+
+<?php  } else { ?>
+	<center><h3><?php echo gettext("No calls in your selection");?>.</h3></center>
+<?php  } ?>
+</center>
+
+<?php
+
+$smarty->display( 'footer.tpl');
+
+
diff -urN -x lib a2billing_v1.9.4/customer/export_csv_customer.php a2billing/customer/export_csv_customer.php
--- a2billing_v1.9.4/customer/export_csv_customer.php	1969-12-31 21:00:00.000000000 -0300
+++ a2billing/customer/export_csv_customer.php	2012-09-20 13:08:07.000000000 -0300
@@ -0,0 +1,94 @@
+<?php
+
+/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
+
+/**
+ * This file is part of A2Billing (http://www.a2billing.net/)
+ *
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
+ * powered by Star2billing S.L. <http://www.star2billing.com/>
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
+ * @author      Belaid Arezqui <areski@gmail.com>
+ * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
+ * @package     A2Billing
+ *
+ * Software License Agreement (GNU Affero General Public License)
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Affero General Public License as
+ * published by the Free Software Foundation, either version 3 of the
+ * License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Affero General Public License for more details.
+ *
+ * You should have received a copy of the GNU Affero General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ * 
+ * 
+**/
+
+
+include ("lib/admin.defines.php");
+//require_once ("../lib/iam_csvdump.php");
+include ("lib/admin.module.access.php");
+
+getpost_ifset(array ( 'var_file', 'var_card_id' ));
+
+if (strlen($var_file) == 0) {
+	$var_file = '';
+}
+
+
+#  Set the parameters: SQL Query, hostname, databasename, dbuser and password
+//$dumpfile = new iam_csvdump;
+
+#  Call the CSV Dumping function and THAT'S IT!!!!  A file named dump.csv is sent to the user for download
+
+$log = new Logger();
+
+$root = "/var/www/html/billing/customer_cdr/".$var_card_id."/";
+$file = $var_file;
+$path = $root.$file;
+$type = '';
+ 
+ echo $path."\n";
+if (is_file($path)) {
+    $size = filesize($path);
+    if (function_exists('mime_content_type')) {
+        $type = mime_content_type($path);
+    } else if (function_exists('finfo_file')) {
+		$info = finfo_open(FILEINFO_MIME);
+        $type = finfo_file($info, $path);
+        finfo_close($info); 
+    }
+	echo $type."--".$size."..\n";
+    if ($type == '') {
+        $type = "application/force-download";
+    }
+    // Set Headers
+	header("Pragma: public");
+	header("Expires: 0");
+	header("Cache-Control: must-revalidate, post-check=0, pre-check=0");
+	header("Cache-control: public");
+	header("Content-Description: File Transfer");
+	header('Content-type: application/zip'); 
+	header('Content-Disposition: attachment; filename="'.basename($file).'"');
+	header("Content-Transfer-Encoding: binary");
+	header("Content-Length: " . filesize($file) );
+
+    // Download File
+    readfile($path);
+} else {
+    die("File not exist !!");
+}
+
+//$myfileName = $var_file;
+//$log->insertLog($_SESSION["admin_id"], 2, "FILE EXPORTED", "A File in CSV Format is exported by User, File Name= " . $myfileName . ".csv", '', $_SERVER['REMOTE_ADDR'], $_SERVER['REQUEST_URI'], '');
+//$dumpfile->dump_file($_SESSION[$var_export], $myfileName, "csv", DBNAME, USER, PASS, HOST, DB_TYPE);
+
+$log = null;
+
diff -urN -x lib a2billing_v1.9.4/customer/templates/default/main.tpl a2billing/customer/templates/default/main.tpl
--- a2billing_v1.9.4/customer/templates/default/main.tpl	2011-05-31 16:39:39.000000000 -0300
+++ a2billing/customer/templates/default/main.tpl	2012-09-19 09:51:56.000000000 -0300
@@ -1,173 +1,176 @@
-{include file="header.tpl"}
-{if ($popupwindow == 0)}
-{if ($EXPORT == 0)}
-<div id="left-sidebar">
-<div id="leftmenu-top">
-<div id="leftmenu-down">
-<div id="leftmenu-middle">
-
-	
-<ul id="nav">
-
-	<div class="toggle_menu"><li><a href="userinfo.php"><strong>{php} echo gettext("ACCOUNT INFO");{/php}</strong></a></li></div>
-	
-	{if $ACXVOICEMAIL>0 }
-	<div class="toggle_menu"><li><a href="A2B_entity_voicemail.php"><strong>{php} echo gettext("VOICEMAIL");{/php}</strong></a></li></div>
-	{/if}
-	
-	{if $ACXSIP_IAX>0 }
-	<div class="toggle_menu"><li><a href="A2B_entity_sipiax_info.php"><strong>{php} echo gettext("SIP/IAX INFO");{/php}</strong></a></li></div>
-	{/if}
-
-	{if $ACXCALL_HISTORY >0 }
-	<div class="toggle_menu"><li><a href="call-history.php"><strong>{php} echo gettext("CALL HISTORY");{/php}</strong></a></li></div>
-	{/if}
-	
-	{if $ACXPAYMENT_HISTORY >0 }
-	<div class="toggle_menu"><li><a href="payment-history.php"><strong>{php} echo gettext("PAYMENT HISTORY");{/php}</strong></a></li></div>
-	{/if}
-	
-
-	{if $ACXVOUCHER >0 }
-	<div class="toggle_menu"><li><a href="A2B_entity_voucher.php?form_action=list"><strong>{php} echo gettext("VOUCHERS");{/php}</strong></a></li></div>
-	{/if}
-
-
-	{if $ACXINVOICES >0 }
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img5"
-	{if ($section == "5")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("INVOICES");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="5")}
-		style="">
-	{else}
-	style="display:none;">
-	{/if}
-	<ul>
-		<li><ul>
-				<li><a href="A2B_entity_receipt.php?section=5"><strong>{php} echo gettext("View Receipts");{/php}</strong></a></li>
-				<li><a href="A2B_entity_invoice.php?section=5"><strong>{php} echo gettext("View Invoices");{/php}</strong></a></li>
-				<li><a href="A2B_billing_preview.php?section=5"><strong>{php} echo gettext("Preview Next Billing");{/php}</strong></a></li>
-		</ul></li>
-	</ul>
-	</div>
-	{/if}
-
-
-	{if $ACXDID >0 }
-	<div class="toggle_menu"><li><a href="A2B_entity_did.php?form_action=list"><strong>{php} echo gettext("DID");{/php}</strong></a></li></div>
-	{/if}
-
-	{if $ACXSPEED_DIAL >0 }
-	<div class="toggle_menu"><li><a href="A2B_entity_speeddial.php?atmenu=speeddial&stitle=Speed+Dial"><strong>{php} echo gettext("SPEED DIAL");{/php}</strong></a></li></div>
-	{/if}
-
-	{if $ACXRATECARD >0 }
-	<div class="toggle_menu"><li><a href="A2B_entity_ratecard.php?form_action=list"><strong>{php} echo gettext("RATECARD");{/php}</strong></a></li></div>
-	{/if}
-
-	{if $ACXSIMULATOR >0 }
-	<div class="toggle_menu"><li><a href="simulator.php"><strong>{php} echo gettext("SIMULATOR");{/php}</strong></a></li></div>
-	{/if}
-
-	{if $ACXCALL_BACK >0 }
-	<div class="toggle_menu"><li><a href="callback.php"><strong>{php} echo gettext("CALLBACK");{/php}</strong></a></li></div>
-	{/if}
-	
-	{if $ACXCALLER_ID >0 }
-	<div class="toggle_menu"><li><a href="A2B_entity_callerid.php?atmenu=callerid&stitle=CallerID"><strong>{php} echo gettext("ADD CALLER ID");{/php}</strong></a></li></div>
-	{/if}
-
-	{if $ACXPASSWORD>0 }
-	<div class="toggle_menu"><li><a href="A2B_entity_password.php?atmenu=password&form_action=ask-edit&stitle=Password"><strong>{php} echo gettext("PASSWORD");{/php}</strong></a></li></div>
-	{/if}
-	
-	{if $ACXSUPPORT >0 }
-	<div class="toggle_menu"><li><a href="A2B_support.php"><strong>{php} echo gettext("SUPPORT");{/php}</strong></a></li></div>
-	{/if}
-	
-	{if $ACXNOTIFICATION >0 }
-	<div class="toggle_menu"><li><a href="A2B_notification.php?form_action=ask-edit"><strong>{php} echo gettext("NOTIFICATION");{/php}</strong></a></li></div>
-	{/if}
-	
-	{if $ACXAUTODIALER>0 }
-	<div class="toggle_menu"><li>
-	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img10"
-	{if ($section == "10")}
-	src="templates/{$SKIN_NAME}/images/minus.gif"
-	{else}
-	src="templates/{$SKIN_NAME}/images/plus.gif"
-	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("AUTO DIALLER");{/php}</strong></div></div></a></li></div>
-		<div class="tohide"
-	{if ($section =="10")}
-		style="">
-	{else}
-	style="display:none;">
-	{/if}
-	<ul>
-		<li><ul>
-				<li><a href="A2B_entity_campaign.php?section=10">{php} echo gettext("Campaign's");{/php}</a></li>
-				<li><a href="A2B_entity_phonebook.php?section=10">{php} echo gettext("Phone Book");{/php}</a></li>
-				<li><a href="A2B_entity_phonenumber.php?section=10">{php} echo gettext("Phone Number");{/php}</a></li>
-				<li><a href="A2B_phonelist_import.php?section=10">{php} echo gettext("Import Phone List");{/php}</a></li>
-		</ul></li>
-	</ul>
-	</div>
-	{/if}
-
-</ul>
-
-<br/>
-<ul id="nav"><li>
-	<ul><li><a href="logout.php?logout=true" target="_top"><img style="vertical-align:bottom;" src="templates/{$SKIN_NAME}/images/logout.png"> <font color="#DD0000"><STRONG>&nbsp;&nbsp;{php} echo gettext("LOGOUT");{/php}</STRONG></font> </a></li></ul>
-</li></ul>
-
-</div>
-</div>
-</div>
-
-
-<table width="90%" cellspacing="15">
-<tr>
-   <td>
-		<a href="{$PAGE_SELF}?ui_language=english"><img src="templates/{$SKIN_NAME}/images/flags/gb.gif" border="0" title="English" alt="English"></a>
-		<a href="{$PAGE_SELF}?ui_language=spanish"><img src="templates/{$SKIN_NAME}/images/flags/es.gif" border="0" title="Spanish" alt="Spanish"></a>
-		<a href="{$PAGE_SELF}?ui_language=french"><img src="templates/{$SKIN_NAME}/images/flags/fr.gif" border="0" title="French" alt="French"></a>
-		<a href="{$PAGE_SELF}?ui_language=german"><img src="templates/{$SKIN_NAME}/images/flags/de.gif" border="0" title="German" alt="German"></a>
-		<a href="{$PAGE_SELF}?ui_language=portuguese"><img src="templates/{$SKIN_NAME}/images/flags/pt.gif" border="0" title="Portuguese" alt="Portuguese"></a>
-		<a href="{$PAGE_SELF}?ui_language=brazilian"><img src="templates/{$SKIN_NAME}/images/flags/br.gif" border="0" title="Brazilian" alt="Brazilian"></a>
-		<a href="{$PAGE_SELF}?ui_language=italian"><img src="templates/{$SKIN_NAME}/images/flags/it.gif" border="0" title="Italian" alt="Italian"></a>
-		<a href="{$PAGE_SELF}?ui_language=romanian"><img src="templates/{$SKIN_NAME}/images/flags/ro.gif" border="0" title="Romanian"alt="Romanian"></a>
-		<a href="{$PAGE_SELF}?ui_language=chinese"><img src="templates/{$SKIN_NAME}/images/flags/cn.gif" border="0" title="Chinese" alt="Chinese"></a>
-		<a href="{$PAGE_SELF}?ui_language=polish"><img src="templates/{$SKIN_NAME}/images/flags/pl.gif" border="0" title="Polish" alt="Polish"></a>
-		<a href="{$PAGE_SELF}?ui_language=russian"><img src="templates/{$SKIN_NAME}/images/flags/ru.gif" border="0" title="russian" alt="russian"></a>
-		<a href="{$PAGE_SELF}?ui_language=turkish"><img src="templates/{$SKIN_NAME}/images/flags/tr.gif" border="0" title="Turkish" alt="Turkish"></a>
-		<a href="{$PAGE_SELF}?ui_language=urdu"><img src="templates/{$SKIN_NAME}/images/flags/pk.gif" border="0" title="Urdu" alt="Urdu"></a>
-		<a href="{$PAGE_SELF}?ui_language=ukrainian"><img src="templates/{$SKIN_NAME}/images/flags/ua.gif" border="0" title="Ukrainian" alt="Ukrainian"></a>
-		<a href="{$PAGE_SELF}?ui_language=farsi"><img src="templates/{$SKIN_NAME}/images/flags/ir.gif" border="0" title="Farsi" alt="Farsi"></a>
-		<a href="{$PAGE_SELF}?ui_language=greek"><img src="templates/{$SKIN_NAME}/images/flags/gr.gif" border="0" title="Greek" alt="Greek"></a>
-		<a href="{$PAGE_SELF}?ui_language=indonesian"><img src="templates/{$SKIN_NAME}/images/flags/id.gif" border="0" title="Indonesian" alt="Indonesian"></a>
-   </td>
-</tr>
-
-
-</table>
-
-
-</div>
-
-<div id="main-content">
-<br/>
-{else}
-<div>
-{/if}
-{else}
-<div>
-{/if}
-
-
-{$MAIN_MSG}
+{include file="header.tpl"}
+{if ($popupwindow == 0)}
+{if ($EXPORT == 0)}
+<div id="left-sidebar">
+<div id="leftmenu-top">
+<div id="leftmenu-down">
+<div id="leftmenu-middle">
+
+	
+<ul id="nav">
+
+	<div class="toggle_menu"><li><a href="userinfo.php"><strong>{php} echo gettext("ACCOUNT INFO");{/php}</strong></a></li></div>
+	
+	{if $ACXVOICEMAIL>0 }
+	<div class="toggle_menu"><li><a href="A2B_entity_voicemail.php"><strong>{php} echo gettext("VOICEMAIL");{/php}</strong></a></li></div>
+	{/if}
+	
+	{if $ACXSIP_IAX>0 }
+	<div class="toggle_menu"><li><a href="A2B_entity_sipiax_info.php"><strong>{php} echo gettext("SIP/IAX INFO");{/php}</strong></a></li></div>
+	{/if}
+
+	{if $ACXCALL_HISTORY >0 }
+	<div class="toggle_menu"><li><a href="call.php?s=1&t=0&order=starttime&sens=DESC&current_page=0&terminatecauseid=ANSWER"><strong>{php} echo gettext("CALL - REAL TIME");{/php}</strong></a></li></div>
+	{/if}
+
+	{if $ACXCALL_HISTORY >0 }
+	<div class="toggle_menu"><li><a href="call-history.php?s=1&t=0&order=t1.starttime&sens=DESC&current_page=0&terminatecauseid=ANSWER"><strong>{php} echo gettext("CALL - HISTORY");{/php}</strong></a></li></div>
+	{/if}	
+	{if $ACXPAYMENT_HISTORY >0 }
+	<div class="toggle_menu"><li><a href="payment-history.php"><strong>{php} echo gettext("PAYMENT HISTORY");{/php}</strong></a></li></div>
+	{/if}
+	
+
+	{if $ACXVOUCHER >0 }
+	<div class="toggle_menu"><li><a href="A2B_entity_voucher.php?form_action=list"><strong>{php} echo gettext("VOUCHERS");{/php}</strong></a></li></div>
+	{/if}
+
+
+	{if $ACXINVOICES >0 }
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img5"
+	{if ($section == "5")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("INVOICES");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="5")}
+		style="">
+	{else}
+	style="display:none;">
+	{/if}
+	<ul>
+		<li><ul>
+				<li><a href="A2B_entity_receipt.php?section=5"><strong>{php} echo gettext("View Receipts");{/php}</strong></a></li>
+				<li><a href="A2B_entity_invoice.php?section=5"><strong>{php} echo gettext("View Invoices");{/php}</strong></a></li>
+				<li><a href="A2B_billing_preview.php?section=5"><strong>{php} echo gettext("Preview Next Billing");{/php}</strong></a></li>
+		</ul></li>
+	</ul>
+	</div>
+	{/if}
+
+
+	{if $ACXDID >0 }
+	<div class="toggle_menu"><li><a href="A2B_entity_did.php?form_action=list"><strong>{php} echo gettext("DID");{/php}</strong></a></li></div>
+	{/if}
+
+	{if $ACXSPEED_DIAL >0 }
+	<div class="toggle_menu"><li><a href="A2B_entity_speeddial.php?atmenu=speeddial&stitle=Speed+Dial"><strong>{php} echo gettext("SPEED DIAL");{/php}</strong></a></li></div>
+	{/if}
+
+	{if $ACXRATECARD >0 }
+	<div class="toggle_menu"><li><a href="A2B_entity_ratecard.php?form_action=list"><strong>{php} echo gettext("RATECARD");{/php}</strong></a></li></div>
+	{/if}
+
+	{if $ACXSIMULATOR >0 }
+	<div class="toggle_menu"><li><a href="simulator.php"><strong>{php} echo gettext("SIMULATOR");{/php}</strong></a></li></div>
+	{/if}
+
+	{if $ACXCALL_BACK >0 }
+	<div class="toggle_menu"><li><a href="callback.php"><strong>{php} echo gettext("CALLBACK");{/php}</strong></a></li></div>
+	{/if}
+	
+	{if $ACXCALLER_ID >0 }
+	<div class="toggle_menu"><li><a href="A2B_entity_callerid.php?atmenu=callerid&stitle=CallerID"><strong>{php} echo gettext("ADD CALLER ID");{/php}</strong></a></li></div>
+	{/if}
+
+	{if $ACXPASSWORD>0 }
+	<div class="toggle_menu"><li><a href="A2B_entity_password.php?atmenu=password&form_action=ask-edit&stitle=Password"><strong>{php} echo gettext("PASSWORD");{/php}</strong></a></li></div>
+	{/if}
+	
+	{if $ACXSUPPORT >0 }
+	<div class="toggle_menu"><li><a href="A2B_support.php"><strong>{php} echo gettext("SUPPORT");{/php}</strong></a></li></div>
+	{/if}
+	
+	{if $ACXNOTIFICATION >0 }
+	<div class="toggle_menu"><li><a href="A2B_notification.php?form_action=ask-edit"><strong>{php} echo gettext("NOTIFICATION");{/php}</strong></a></li></div>
+	{/if}
+	
+	{if $ACXAUTODIALER>0 }
+	<div class="toggle_menu"><li>
+	<a href="javascript:;" class="toggle_menu" target="_self"> <div> <div id="menutitlebutton"> <img id="img10"
+	{if ($section == "10")}
+	src="templates/{$SKIN_NAME}/images/minus.gif"
+	{else}
+	src="templates/{$SKIN_NAME}/images/plus.gif"
+	{/if} onmouseover="this.style.cursor='hand';" ></div> <div id="menutitlesection"><strong>{php} echo gettext("AUTO DIALLER");{/php}</strong></div></div></a></li></div>
+		<div class="tohide"
+	{if ($section =="10")}
+		style="">
+	{else}
+	style="display:none;">
+	{/if}
+	<ul>
+		<li><ul>
+				<li><a href="A2B_entity_campaign.php?section=10">{php} echo gettext("Campaign's");{/php}</a></li>
+				<li><a href="A2B_entity_phonebook.php?section=10">{php} echo gettext("Phone Book");{/php}</a></li>
+				<li><a href="A2B_entity_phonenumber.php?section=10">{php} echo gettext("Phone Number");{/php}</a></li>
+				<li><a href="A2B_phonelist_import.php?section=10">{php} echo gettext("Import Phone List");{/php}</a></li>
+		</ul></li>
+	</ul>
+	</div>
+	{/if}
+
+</ul>
+
+<br/>
+<ul id="nav"><li>
+	<ul><li><a href="logout.php?logout=true" target="_top"><img style="vertical-align:bottom;" src="templates/{$SKIN_NAME}/images/logout.png"> <font color="#DD0000"><STRONG>&nbsp;&nbsp;{php} echo gettext("LOGOUT");{/php}</STRONG></font> </a></li></ul>
+</li></ul>
+
+</div>
+</div>
+</div>
+
+
+<table width="90%" cellspacing="15">
+<tr>
+   <td>
+		<a href="{$PAGE_SELF}?ui_language=english"><img src="templates/{$SKIN_NAME}/images/flags/gb.gif" border="0" title="English" alt="English"></a>
+		<a href="{$PAGE_SELF}?ui_language=spanish"><img src="templates/{$SKIN_NAME}/images/flags/es.gif" border="0" title="Spanish" alt="Spanish"></a>
+		<a href="{$PAGE_SELF}?ui_language=french"><img src="templates/{$SKIN_NAME}/images/flags/fr.gif" border="0" title="French" alt="French"></a>
+		<a href="{$PAGE_SELF}?ui_language=german"><img src="templates/{$SKIN_NAME}/images/flags/de.gif" border="0" title="German" alt="German"></a>
+		<a href="{$PAGE_SELF}?ui_language=portuguese"><img src="templates/{$SKIN_NAME}/images/flags/pt.gif" border="0" title="Portuguese" alt="Portuguese"></a>
+		<a href="{$PAGE_SELF}?ui_language=brazilian"><img src="templates/{$SKIN_NAME}/images/flags/br.gif" border="0" title="Brazilian" alt="Brazilian"></a>
+		<a href="{$PAGE_SELF}?ui_language=italian"><img src="templates/{$SKIN_NAME}/images/flags/it.gif" border="0" title="Italian" alt="Italian"></a>
+		<a href="{$PAGE_SELF}?ui_language=romanian"><img src="templates/{$SKIN_NAME}/images/flags/ro.gif" border="0" title="Romanian"alt="Romanian"></a>
+		<a href="{$PAGE_SELF}?ui_language=chinese"><img src="templates/{$SKIN_NAME}/images/flags/cn.gif" border="0" title="Chinese" alt="Chinese"></a>
+		<a href="{$PAGE_SELF}?ui_language=polish"><img src="templates/{$SKIN_NAME}/images/flags/pl.gif" border="0" title="Polish" alt="Polish"></a>
+		<a href="{$PAGE_SELF}?ui_language=russian"><img src="templates/{$SKIN_NAME}/images/flags/ru.gif" border="0" title="russian" alt="russian"></a>
+		<a href="{$PAGE_SELF}?ui_language=turkish"><img src="templates/{$SKIN_NAME}/images/flags/tr.gif" border="0" title="Turkish" alt="Turkish"></a>
+		<a href="{$PAGE_SELF}?ui_language=urdu"><img src="templates/{$SKIN_NAME}/images/flags/pk.gif" border="0" title="Urdu" alt="Urdu"></a>
+		<a href="{$PAGE_SELF}?ui_language=ukrainian"><img src="templates/{$SKIN_NAME}/images/flags/ua.gif" border="0" title="Ukrainian" alt="Ukrainian"></a>
+		<a href="{$PAGE_SELF}?ui_language=farsi"><img src="templates/{$SKIN_NAME}/images/flags/ir.gif" border="0" title="Farsi" alt="Farsi"></a>
+		<a href="{$PAGE_SELF}?ui_language=greek"><img src="templates/{$SKIN_NAME}/images/flags/gr.gif" border="0" title="Greek" alt="Greek"></a>
+		<a href="{$PAGE_SELF}?ui_language=indonesian"><img src="templates/{$SKIN_NAME}/images/flags/id.gif" border="0" title="Indonesian" alt="Indonesian"></a>
+   </td>
+</tr>
+
+
+</table>
+
+
+</div>
+
+<div id="main-content">
+<br/>
+{else}
+<div>
+{/if}
+{else}
+<div>
+{/if}
+
+
+{$MAIN_MSG}
diff -urN a2billing_v1.9.4/common/lib/Class.Table.php a2billing/common/lib/Class.Table.php
--- a2billing_v1.9.4/common/lib/Class.Table.php	2011-05-31 16:39:39.000000000 -0300
+++ a2billing/common/lib/Class.Table.php	2012-09-13 04:18:11.000000000 -0300
@@ -1,437 +1,499 @@
-<?php
-
-/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
-
-/**
- * This file is part of A2Billing (http://www.a2billing.net/)
- *
- * A2Billing, Commercial Open Source Telecom Billing platform,   
- * powered by Star2billing S.L. <http://www.star2billing.com/>
- * 
- * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
- * @author      Belaid Arezqui <areski@gmail.com>
- * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
- * @package     A2Billing
- *
- * Software License Agreement (GNU Affero General Public License)
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU Affero General Public License as
- * published by the Free Software Foundation, either version 3 of the
- * License, or (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU Affero General Public License for more details.
- *
- * You should have received a copy of the GNU Affero General Public License
- * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- * 
- * 
-**/
-
-/**
-* Class Table used to abstract Database queries and processing
-*
-* @categoryDatabase
-* @packageTable
-* @authorArezqui Belaid <areski _atl_ gmail com>
-* @authorSteve Dommett <steve@st4vs.net>
-* @copyright2004-2009 A2Billing
-* @licensehttp://www.gnu.org/copyleft/lesser.html  LGPL License 2.1
-* @versionCVS: $Id:$
-* @sinceFile available since Release 1.0
-*/
-
-include (dirname(__FILE__)."/Class.MytoPg.php");
-
-$ADODB_CACHE_DIR = '/tmp';
-
-class Query_trace {
-
-	public $queryCount = 0;
-	public $queries = array();
-	
-	private static $m_pInstance;
-
-	/* CONSTRUCTOR */
-	function Query_trace ()
-	{
-		
-	}
-
-	// Query_trace::getInstance();
-	public static function getInstance ()
-	{
-	    if (!self::$m_pInstance) {
-	        self::$m_pInstance = new  Query_trace();
-	    }
-	
-	    return self::$m_pInstance;
-	}
-}
-
-
-class Table {
-
-	var $fields 				= '*';
-	var $table  				= '';
-	var $table_count			= '';
-	var $errstr 				= '';
-	var $debug_st 				= 0;
-	var $debug_st_stop 			= 0;
-	var $start_message_debug 	= "<table width=\"100%\" align=\"right\" style=\"float : left;\"><tr><td>QUERY: \n";
-	var $end_message_debug 		= "\n</td></tr></table><br><br><br>";
-	var $alert_query_time 		= 0.1;
-	var $alert_query_long_time 	= 2;
-	
-	var $writelog 				= null;
-
-    var $FK_TABLES				= null;
-    var $FK_EDITION_CLAUSE		= null;
-    // FALSE if you want to delete the dependent Records, TRUE if you want to update
-    // Dependent Records to -1
-    var $FK_DELETE 				= true;
-    var $FK_ID_VALUE 			= 0;
-	
-	var $query_handler			= null;
-	
-
-	/* CONSTRUCTOR */
-	function Table ($table = null, $liste_fields = null,  $fk_Tables = null, $fk_Fields = null, $id_Value = null, $fk_del_upd = true, $table_count = null)
-	{
-        $this->writelog = defined('WRITELOG_QUERY') ? WRITELOG_QUERY : false;
-		$this -> table = $table;
-		$this -> table_count = $table_count;
-		$this -> fields = $liste_fields;
-		$this -> mytopg = new MytoPg(0); // debug level 0 logs only >30ms CPU hogs
-		
-		if ((count($fk_Tables) == count($fk_Fields)) && (count($fk_Fields) > 0)) {
-			$this -> FK_TABLES = $fk_Tables;
-			$this -> FK_EDITION_CLAUSE = $fk_Fields;
-			$this -> FK_DELETE = $fk_del_upd;
-			$this -> FK_ID_VALUE = $id_Value;
-		}
-		
-		$this->query_handler = Query_trace::getInstance();
-		
-	}
-	
-	/* MODIFY PROPRIETY*/
-	function Define_fields ($liste_fields )
-	{
-		$this -> fields = $liste_fields;
-	}
-
-
-	function Define_table ($table)
-	{
-		$this -> table = $table;
-	}
-
-	/*
-	 * ExecuteQuery
-	 */
-	function ExecuteQuery ($DBHandle, $QUERY, $cache = 0)
-	{
-		global $A2B;
-		
-		if ($this -> writelog) {
-			$time_start = microtime(true);
-		}
-
-		if ($A2B->config["database"]['dbtype'] == 'postgres') {
-			// convert MySQLisms to be Postgres compatible
-			$this -> mytopg -> My_to_Pg($QUERY);
-		} else {
-			// the MySQL schema takes care of case-insensitivity
-			$QUERY = preg_replace('/([[:space:]]+)I(LIKE[[:space:]]+)/i', '\1\2', $QUERY);
-		}
-		
-		if ($this -> debug_st) echo $this->start_message_debug.$QUERY.$this->end_message_debug;
-		if ($cache > 0) {
-			$res = $DBHandle -> CacheExecute($cache, $QUERY);
-		} else {
-			$start = $this->getTime();
-			$res = $DBHandle -> Execute($QUERY);
-			$this->query_handler->queryCount += 1;
-			$this->logQuery($QUERY, $start);
-		}
-		
-		if ($DBHandle -> ErrorNo() != 0) {
-			$this -> errstr = $DBHandle -> ErrorMsg();
-			if ($this -> debug_st)
-				echo $DBHandle -> ErrorMsg();
-			if ($this -> debug_st_stop)
-				exit;
-		}
-		
-		if ($this -> writelog) {
-			$time_end = microtime(true);
-			$time = $time_end - $time_start;
-		}
-        
-        if ($this -> writelog) {
-			if ($time > $this->alert_query_time) {
-				if ($time > $this->alert_query_long_time ) 
-					$A2B -> debug( WARN, false, __FILE__, __LINE__, "EXTRA_TOOLONG_DB_QUERY - RUNNING TIME = $time");
-				else 
-					$A2B -> debug( WARN, false, __FILE__, __LINE__, "TOOLONG_DB_QUERY - RUNNING TIME = $time");
-			}
-			$A2B -> debug( DEBUG, false, __FILE__, __LINE__, "Running time=$time - QUERY=\n$QUERY\n");
-        }
-        
-		return $res;
-	}
-
-	// If $select is not supplied then function check numrows
-	// so expect a SELECT query.
-
-	function SQLExec ($DBHandle, $QUERY, $select = 1, $cache = 0)
-	{
-		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, $cache);
-		if (!$res) return false;
-
-		if ($select) {
-			$num = $res -> RecordCount();
-			if ($num==0) {
-				return false;
-			}
-
-			for($i=0;$i<$num;$i++) {
-				$row [] =$res -> fetchRow();
-			}
-
-			return ($row);
-		}
-		return true;
-	}
-
-
-	function Get_list ($DBHandle, $clause = NULL, $order = NULL, $sens = NULL, $field_order_letter = NULL, $letters = NULL, $limite = NULL, $current_record = NULL, $sql_group= NULL, $cache = 0)
-	{
-		$sql = 'SELECT '.$this -> fields.' FROM '.trim($this -> table);
-		$sql_clause='';
-		if ($clause!='') {
-			$sql_clause=' WHERE '.$clause;
-		}
-
-		$sqlletters = "";
-		if (!is_null ($letters) && (preg_match("/^[A-Za-z]+$/", $letters)) && !is_null ($field_order_letter) && ($field_order_letter!='')) {
-			$sql_letters= ' (".$field_order_letter." LIKE \''.strtolower($letters).'%\') ';
-
-			if ($sql_clause != "") {
-				$sql_clause .= " AND ";
-			} else {
-				$sql_clause .= " WHERE ";
-			}
-		}
-
-		$sql_orderby = '';
-		if (  !is_null ($order) && ($order!='') && !is_null ($sens) && ($sens!='') ) {
-			$sql_orderby = " ORDER BY $order $sens";
-		}
-
-		$sql_limit ='';
-		if (!is_null ($limite) && (is_numeric($limite)) && !is_null ($current_record) && (is_numeric($current_record)) ) {
-			if (DB_TYPE == "postgres") $sql_limit = " LIMIT $limite OFFSET $current_record";
-			else $sql_limit = " LIMIT $current_record,$limite";
-		}
-
-		$QUERY = $sql.$sql_clause.$sql_group;
-		
-		if (strpos($QUERY, '%ORDER%') === false) {
-			$QUERY .= $sql_orderby;
-		} else {
-			$QUERY = str_replace("%ORDER%", $sql_orderby, $QUERY);
-		}
-		
-		if (strpos($QUERY, '%LIMIT%') === false) {
-			$QUERY .= $sql_limit;
-		} else {
-			$QUERY = str_replace("%LIMIT%", $sql_limit, $QUERY);
-		}
-
-		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, $cache);
-		if (!$res) return false;
-		
-		$num = $res -> RecordCount();
-		if ($num==0) {
-			return 0;
-		}
-
-		for( $i=0 ; $i<$num ; $i++ ) {
-			$row [] =$res -> fetchRow();
-		}
-		
-		return ($row);
-	}
-
-
-	function Table_count ($DBHandle, $clause=null, $id_Value = null, $cache = 0)
-	{
-		if (!is_null($this -> table_count))
-			$sql = 'SELECT count(*) FROM '.trim($this -> table_count);
-		else
-			$sql = 'SELECT count(*) FROM '.trim($this -> table);
-		
-		$sql_clause='';
-		if ($clause!='') {
-            if ($id_Value == null || $id_Value == '') {
-			    $sql_clause=' WHERE '.$clause;
-            } else {
-                $sql_clause=' WHERE '.$clause." = ".$id_Value;
-            }
-        }
-
-		$QUERY = $sql.$sql_clause;
-		
-		if (preg_replace("/[ ]+group[ ]+by[ ]+/i",$sql_clause)) $QUERY="SELECT count(*) FROM (".$QUERY.") as tmp";
-		
-		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, $cache);
-		if (!$res) return false;
-		
-		$row =$res -> fetchRow();
-
-		return ($row['0']);
-	}
-
-
-	function Add_table ($DBHandle, $value, $func_fields = null, $func_table = null, $id_name = null, $subquery = false) {
-		if ($func_fields!="") {
-			$this -> fields = $func_fields;
-		}
-
-		if ($func_table !="") {
-			$this -> table = $func_table;
-		}
-		if ($subquery) {
-			$QUERY = "INSERT INTO ".$this -> table." (".$this -> fields.") (".trim ($value).")";
-		} else {
-			$QUERY = "INSERT INTO ".$this -> table." (".$this -> fields.") values (".trim ($value).")";
-		}
-		
-		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, 0);
-		if (!$res) return false;
-		
-		// Fix that , make PEAR complaint
-		if ($id_name != "") {
-
-			if (DB_TYPE == "postgres") {
-
-				$oid = $DBHandle -> Insert_ID();
-				if ($oid <= 0 || $oid==''){
-					return (true);
-				}
-				$sql = 'SELECT '.$id_name.' FROM '.$this -> table.' WHERE oid=\''.$oid.'\'';
-				$res = $DBHandle -> Execute($sql);
-				if (!$res) {
-					return (false);
-				}
-				$row [] =$res -> fetchRow();
-				if ($this -> debug_st)
-					echo "\n <br> psql_insert_id = ".$row[0][0];
-				
-				return $row[0][0];
-
-			} else {
-				$insertid = $DBHandle -> Insert_ID();
-				if ($this -> debug_st)
-					echo "\n <br> mysql_insert_id = $insertid";
-				return $insertid;
-			}
-		}
-
-		return (true);
-	}
-
-
-	function Update_table ($DBHandle, $param_update, $clause, $func_table = null)
-	{
-		
-		if ($func_table !="")
-			$this -> table = $func_table;
-		
-		$QUERY = "UPDATE ".$this -> table." SET ".trim ($param_update)." WHERE ".trim ($clause);
-		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, 0);
-        
-        return ($res);
-	}
-
-
-
-	function Delete_table ($DBHandle, $clause, $func_table = null)
-	{
-		
-		if ($func_table !="")
-			$this -> table = $func_table;
-		
-        $countFK = count($this->FK_TABLES);
-        for ($i = 0; $i < $countFK; $i++) {
-            if ($this -> FK_DELETE == false) {
-            	$QUERY = "UPDATE ".$this -> FK_TABLES[$i]." SET ".
-							trim ($this -> FK_EDITION_CLAUSE[$i])." = -1 WHERE (".trim ($this -> FK_EDITION_CLAUSE[$i])." = ".$this -> FK_ID_VALUE." )";
-            } else {
-                $QUERY = "DELETE FROM ".$this -> FK_TABLES[$i].
-							" WHERE (".trim ($this -> FK_EDITION_CLAUSE[$i])." = ".$this -> FK_ID_VALUE." )";
-            }
-			if ($this -> debug_st) echo "<br>$QUERY";
-            $res = $DBHandle -> Execute($QUERY);
-        }
-
-		$QUERY = "DELETE FROM ".$this -> table." WHERE (".trim ($clause).")";
-		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, 0);
-		
-		return ($res);
-	}
-
-
-    function Delete_Selected ($DBHandle, $clause=null, $order=null, $sens=null, $field_order_letter=null, $letters = null, $limite=null, $current_record=NULL, $sql_group= NULL)
-	{
-		$sql = 'DELETE FROM '.trim($this -> table);
-
-		$sql_clause='';
-		if ($clause!='') {
-			$sql_clause=' WHERE '.$clause;
-		}
-
-		$sqlletters = "";
-		if (!is_null ($letters) && (preg_match("/^[A-Za-z]+$/", $letters)) && !is_null ($field_order_letter) && ($field_order_letter!='') ) {
-			$sql_letters= ' (".$field_order_letter." LIKE \''.strtolower($letters).'%\') ';
-            
-			if ($sql_clause != "") {
-				$sql_clause .= " AND ";
-			} else {
-				$sql_clause .= " WHERE ";
-			}
-		}
-
-        $QUERY = $sql.$sql_clause;
-		
-		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, 0);
-		
-		return ($res);
-	}
-	
-	function logQuery($sql, $start) {
-		if (count($this->query_handler->queries) < 100) {
-			$query = array(
-					'sql' => $sql,
-					'time' => ($this->getTime() - $start)*1000
-				);
-			array_push($this->query_handler->queries, $query);
-		}
-	}
-	
-	function getTime() {
-		$time = microtime();
-		$time = explode(' ', $time);
-		$time = $time[1] + $time[0];
-		$start = $time;
-		return $start;
-	}
-
-};
-
-
+<?php
+
+/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
+
+/**
+ * This file is part of A2Billing (http://www.a2billing.net/)
+ *
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
+ * powered by Star2billing S.L. <http://www.star2billing.com/>
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
+ * @author      Belaid Arezqui <areski@gmail.com>
+ * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
+ * @package     A2Billing
+ *
+ * Software License Agreement (GNU Affero General Public License)
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Affero General Public License as
+ * published by the Free Software Foundation, either version 3 of the
+ * License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Affero General Public License for more details.
+ *
+ * You should have received a copy of the GNU Affero General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ * 
+ * 
+**/
+
+/**
+* Class Table used to abstract Database queries and processing
+*
+* @categoryDatabase
+* @packageTable
+* @authorArezqui Belaid <areski _atl_ gmail com>
+* @authorSteve Dommett <steve@st4vs.net>
+* @copyright2004-2009 A2Billing
+* @licensehttp://www.gnu.org/copyleft/lesser.html  LGPL License 2.1
+* @versionCVS: $Id:$
+* @sinceFile available since Release 1.0
+*/
+
+include (dirname(__FILE__)."/Class.MytoPg.php");
+
+$ADODB_CACHE_DIR = '/tmp';
+
+class Query_trace {
+
+	public $queryCount = 0;
+	public $queries = array();
+	
+	private static $m_pInstance;
+
+	/* CONSTRUCTOR */
+	function Query_trace ()
+	{
+		
+	}
+
+	// Query_trace::getInstance();
+	public static function getInstance ()
+	{
+	    if (!self::$m_pInstance) {
+	        self::$m_pInstance = new  Query_trace();
+	    }
+	
+	    return self::$m_pInstance;
+	}
+}
+
+
+class Table {
+
+	var $fields 				= '*';
+	var $table  				= '';
+	var $table_count			= '';
+	var $errstr 				= '';
+	var $debug_st 				= 0;
+	var $debug_st_stop 			= 0;
+	var $start_message_debug 	= "<table width=\"100%\" align=\"right\" style=\"float : left;\"><tr><td>QUERY: \n";
+	var $end_message_debug 		= "\n</td></tr></table><br><br><br>";
+	var $alert_query_time 		= 0.1;
+	var $alert_query_long_time 	= 2;
+	
+	var $writelog 				= null;
+
+    var $FK_TABLES				= null;
+    var $FK_EDITION_CLAUSE		= null;
+    // FALSE if you want to delete the dependent Records, TRUE if you want to update
+    // Dependent Records to -1
+    var $FK_DELETE 				= true;
+    var $FK_ID_VALUE 			= 0;
+	
+	var $query_handler			= null;
+	
+
+	/* CONSTRUCTOR */
+	function Table ($table = null, $liste_fields = null,  $fk_Tables = null, $fk_Fields = null, $id_Value = null, $fk_del_upd = true, $table_count = null)
+	{
+        $this->writelog = defined('WRITELOG_QUERY') ? WRITELOG_QUERY : false;
+		$this -> table = $table;
+		$this -> table_count = $table_count;
+		$this -> fields = $liste_fields;
+		$this -> mytopg = new MytoPg(0); // debug level 0 logs only >30ms CPU hogs
+		
+		if ((count($fk_Tables) == count($fk_Fields)) && (count($fk_Fields) > 0)) {
+			$this -> FK_TABLES = $fk_Tables;
+			$this -> FK_EDITION_CLAUSE = $fk_Fields;
+			$this -> FK_DELETE = $fk_del_upd;
+			$this -> FK_ID_VALUE = $id_Value;
+		}
+		
+		$this->query_handler = Query_trace::getInstance();
+		
+	}
+	
+	/* MODIFY PROPRIETY*/
+	function Define_fields ($liste_fields )
+	{
+		$this -> fields = $liste_fields;
+	}
+
+
+	function Define_table ($table)
+	{
+		$this -> table = $table;
+	}
+
+	/*
+	 * ExecuteQuery
+	 */
+	function ExecuteQuery ($DBHandle, $QUERY, $cache = 0)
+	{
+		global $A2B;
+		
+		if ($this -> writelog) {
+			$time_start = microtime(true);
+		}
+
+		if ($A2B->config["database"]['dbtype'] == 'postgres') {
+			// convert MySQLisms to be Postgres compatible
+			$this -> mytopg -> My_to_Pg($QUERY);
+		} else {
+			// the MySQL schema takes care of case-insensitivity
+			$QUERY = preg_replace('/([[:space:]]+)I(LIKE[[:space:]]+)/i', '\1\2', $QUERY);
+		}
+		
+		if ($this -> debug_st) echo $this->start_message_debug.$QUERY.$this->end_message_debug;
+		if ($cache > 0) {
+			$res = $DBHandle -> CacheExecute($cache, $QUERY);
+		} else {
+			$start = $this->getTime();
+			$res = $DBHandle -> Execute($QUERY);
+			$this->query_handler->queryCount += 1;
+			$this->logQuery($QUERY, $start);
+		}
+		
+		if ($DBHandle -> ErrorNo() != 0) {
+			$this -> errstr = $DBHandle -> ErrorMsg();
+			if ($this -> debug_st)
+				echo $DBHandle -> ErrorMsg();
+			if ($this -> debug_st_stop)
+				exit;
+		}
+		
+		if ($this -> writelog) {
+			$time_end = microtime(true);
+			$time = $time_end - $time_start;
+		}
+        
+        if ($this -> writelog) {
+			if ($time > $this->alert_query_time) {
+				if ($time > $this->alert_query_long_time ) 
+					$A2B -> debug( WARN, false, __FILE__, __LINE__, "EXTRA_TOOLONG_DB_QUERY - RUNNING TIME = $time");
+				else 
+					$A2B -> debug( WARN, false, __FILE__, __LINE__, "TOOLONG_DB_QUERY - RUNNING TIME = $time");
+			}
+			$A2B -> debug( DEBUG, false, __FILE__, __LINE__, "Running time=$time - QUERY=\n$QUERY\n");
+        }
+        
+		return $res;
+	}
+
+	// If $select is not supplied then function check numrows
+	// so expect a SELECT query.
+
+	function SQLExec ($DBHandle, $QUERY, $select = 1, $cache = 0)
+	{
+		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, $cache);
+		if (!$res) return false;
+
+		if ($select) {
+			$num = $res -> RecordCount();
+			if ($num==0) {
+				return false;
+			}
+
+			for($i=0;$i<$num;$i++) {
+				$row [] =$res -> fetchRow();
+			}
+
+			return ($row);
+		}
+		return true;
+	}
+
+
+	function Get_list ($DBHandle, $clause = NULL, $order = NULL, $sens = NULL, $field_order_letter = NULL, $letters = NULL, $limite = NULL, $current_record = NULL, $sql_group= NULL, $cache = 0)
+	{
+		$sql = 'SELECT '.$this -> fields.' FROM '.trim($this -> table);
+		$sql_clause='';
+		if ($clause!='') {
+			$sql_clause=' WHERE '.$clause;
+		}
+
+		$sqlletters = "";
+		if (!is_null ($letters) && (preg_match("/^[A-Za-z]+$/", $letters)) && !is_null ($field_order_letter) && ($field_order_letter!='')) {
+			$sql_letters= ' (".$field_order_letter." LIKE \''.strtolower($letters).'%\') ';
+
+			if ($sql_clause != "") {
+				$sql_clause .= " AND ";
+			} else {
+				$sql_clause .= " WHERE ";
+			}
+		}
+
+		$sql_orderby = '';
+		if (  !is_null ($order) && ($order!='') && !is_null ($sens) && ($sens!='') ) {
+			$sql_orderby = " ORDER BY $order $sens";
+		}
+
+		$sql_limit ='';
+		if (!is_null ($limite) && (is_numeric($limite)) && !is_null ($current_record) && (is_numeric($current_record)) ) {
+			if (DB_TYPE == "postgres") $sql_limit = " LIMIT $limite OFFSET $current_record";
+			else $sql_limit = " LIMIT $current_record,$limite";
+		}
+
+		$QUERY = $sql.$sql_clause.$sql_group;
+		
+		if (strpos($QUERY, '%ORDER%') === false) {
+			$QUERY .= $sql_orderby;
+		} else {
+			$QUERY = str_replace("%ORDER%", $sql_orderby, $QUERY);
+		}
+		
+		if (strpos($QUERY, '%LIMIT%') === false) {
+			$QUERY .= $sql_limit;
+		} else {
+			$QUERY = str_replace("%LIMIT%", $sql_limit, $QUERY);
+		}
+
+		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, $cache);
+		if (!$res) return false;
+		
+		$num = $res -> RecordCount();
+		if ($num==0) {
+			return 0;
+		}
+
+		for( $i=0 ; $i<$num ; $i++ ) {
+			$row [] =$res -> fetchRow();
+		}
+		
+		return ($row);
+	}
+
+	function Get_list_union ($DBHandle, $clause = NULL, $order = NULL, $sens = NULL, $field_order_letter = NULL, $letters = NULL, $limite = NULL, $current_record = NULL, $sql_group= NULL, $cache = 0)
+	{
+	
+		$sql1 = ' UNION ALL ( SELECT starttime, src, calledstation, destination, sessiontime, terminatecauseid, sipiax, sessionbill from cc_call_archive_temp ) ';
+		
+		$sql = '( SELECT '.$this -> fields.' FROM '.trim($this -> table);
+		$sql_clause='';
+		if ($clause!='') {
+			$sql_clause=' WHERE '.$clause;
+		}
+		
+		$sqlletters = "";
+		if (!is_null ($letters) && (preg_match("/^[A-Za-z]+$/", $letters)) && !is_null ($field_order_letter) && ($field_order_letter!='')) {
+			$sql_letters= ' (".$field_order_letter." LIKE \''.strtolower($letters).'%\') ';
+
+			if ($sql_clause != "") {
+				$sql_clause .= " AND ";
+			} else {
+				$sql_clause .= " WHERE ";
+			}
+		}
+		
+		$sql_orderby = '';
+		if (  !is_null ($order) && ($order!='') && !is_null ($sens) && ($sens!='') ) {
+			$sql_orderby = " ORDER BY $order $sens";
+		}
+
+		$sql_limit ='';
+		if (!is_null ($limite) && (is_numeric($limite)) && !is_null ($current_record) && (is_numeric($current_record)) ) {
+			if (DB_TYPE == "postgres") $sql_limit = " LIMIT $limite OFFSET $current_record";
+			else $sql_limit = " LIMIT $current_record,$limite";
+		}
+
+		$QUERY = $sql.$sql_clause." ) ".$sql1.$sql_group;
+		
+		if (strpos($QUERY, '%ORDER%') === false) {
+			$QUERY .= $sql_orderby;
+		} else {
+			$QUERY = str_replace("%ORDER%", $sql_orderby, $QUERY);
+		}
+		
+		if (strpos($QUERY, '%LIMIT%') === false) {
+			$QUERY .= $sql_limit;
+		} else {
+			$QUERY = str_replace("%LIMIT%", $sql_limit, $QUERY);
+		}
+
+		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, $cache);
+		if (!$res) return false;
+		
+		$num = $res -> RecordCount();
+		if ($num==0) {
+			return 0;
+		}
+
+		for( $i=0 ; $i<$num ; $i++ ) {
+			$row [] =$res -> fetchRow();
+		}
+		
+		return ($row);
+	}
+
+	function Table_count ($DBHandle, $clause=null, $id_Value = null, $cache = 0)
+	{
+		
+		
+		if (!is_null($this -> table_count))
+			$sql = 'SELECT count(*) FROM '.trim($this -> table_count);
+		else
+			$sql = 'SELECT count(*) FROM '.trim($this -> table);
+		
+		$sql_clause='';
+		if ($clause!='') {
+            if ($id_Value == null || $id_Value == '') {
+			    $sql_clause=' WHERE '.$clause;
+            } else {
+                $sql_clause=' WHERE '.$clause." = ".$id_Value;
+            }
+        }
+
+		$QUERY = $sql.$sql_clause;
+		
+		if (preg_replace("/[ ]+group[ ]+by[ ]+/i",$sql_clause)) $QUERY="SELECT count(*) FROM (".$QUERY.") as tmp";
+		
+		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, $cache);
+		if (!$res) return false;
+		
+		$row =$res -> fetchRow();
+
+		return ($row['0']);
+	}
+	
+	function Add_table ($DBHandle, $value, $func_fields = null, $func_table = null, $id_name = null, $subquery = false) {
+		if ($func_fields!="") {
+			$this -> fields = $func_fields;
+		}
+
+		if ($func_table !="") {
+			$this -> table = $func_table;
+		}
+		if ($subquery) {
+			$QUERY = "INSERT INTO ".$this -> table." (".$this -> fields.") (".trim ($value).")";
+		} else {
+			$QUERY = "INSERT INTO ".$this -> table." (".$this -> fields.") values (".trim ($value).")";
+		}
+		
+		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, 0);
+		if (!$res) return false;
+		
+		// Fix that , make PEAR complaint
+		if ($id_name != "") {
+
+			if (DB_TYPE == "postgres") {
+
+				$oid = $DBHandle -> Insert_ID();
+				if ($oid <= 0 || $oid==''){
+					return (true);
+				}
+				$sql = 'SELECT '.$id_name.' FROM '.$this -> table.' WHERE oid=\''.$oid.'\'';
+				$res = $DBHandle -> Execute($sql);
+				if (!$res) {
+					return (false);
+				}
+				$row [] =$res -> fetchRow();
+				if ($this -> debug_st)
+					echo "\n <br> psql_insert_id = ".$row[0][0];
+				
+				return $row[0][0];
+
+			} else {
+				$insertid = $DBHandle -> Insert_ID();
+				if ($this -> debug_st)
+					echo "\n <br> mysql_insert_id = $insertid";
+				return $insertid;
+			}
+		}
+
+		return (true);
+	}
+
+
+	function Update_table ($DBHandle, $param_update, $clause, $func_table = null)
+	{
+		
+		if ($func_table !="")
+			$this -> table = $func_table;
+		
+		$QUERY = "UPDATE ".$this -> table." SET ".trim ($param_update)." WHERE ".trim ($clause);
+		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, 0);
+        
+        return ($res);
+	}
+
+
+
+	function Delete_table ($DBHandle, $clause, $func_table = null)
+	{
+		
+		if ($func_table !="")
+			$this -> table = $func_table;
+		
+        $countFK = count($this->FK_TABLES);
+        for ($i = 0; $i < $countFK; $i++) {
+            if ($this -> FK_DELETE == false) {
+            	$QUERY = "UPDATE ".$this -> FK_TABLES[$i]." SET ".
+							trim ($this -> FK_EDITION_CLAUSE[$i])." = -1 WHERE (".trim ($this -> FK_EDITION_CLAUSE[$i])." = ".$this -> FK_ID_VALUE." )";
+            } else {
+                $QUERY = "DELETE FROM ".$this -> FK_TABLES[$i].
+							" WHERE (".trim ($this -> FK_EDITION_CLAUSE[$i])." = ".$this -> FK_ID_VALUE." )";
+            }
+			if ($this -> debug_st) echo "<br>$QUERY";
+            $res = $DBHandle -> Execute($QUERY);
+        }
+
+		$QUERY = "DELETE FROM ".$this -> table." WHERE (".trim ($clause).")";
+		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, 0);
+		
+		return ($res);
+	}
+
+
+    function Delete_Selected ($DBHandle, $clause=null, $order=null, $sens=null, $field_order_letter=null, $letters = null, $limite=null, $current_record=NULL, $sql_group= NULL)
+	{
+		$sql = 'DELETE FROM '.trim($this -> table);
+
+		$sql_clause='';
+		if ($clause!='') {
+			$sql_clause=' WHERE '.$clause;
+		}
+
+		$sqlletters = "";
+		if (!is_null ($letters) && (preg_match("/^[A-Za-z]+$/", $letters)) && !is_null ($field_order_letter) && ($field_order_letter!='') ) {
+			$sql_letters= ' (".$field_order_letter." LIKE \''.strtolower($letters).'%\') ';
+            
+			if ($sql_clause != "") {
+				$sql_clause .= " AND ";
+			} else {
+				$sql_clause .= " WHERE ";
+			}
+		}
+
+        $QUERY = $sql.$sql_clause;
+		
+		$res = $this -> ExecuteQuery ($DBHandle, $QUERY, 0);
+		
+		return ($res);
+	}
+	
+	function logQuery($sql, $start) {
+		if (count($this->query_handler->queries) < 100) {
+			$query = array(
+					'sql' => $sql,
+					'time' => ($this->getTime() - $start)*1000
+				);
+			array_push($this->query_handler->queries, $query);
+		}
+	}
+	
+	function getTime() {
+		$time = microtime();
+		$time = explode(' ', $time);
+		$time = $time[1] + $time[0];
+		$start = $time;
+		return $start;
+	}
+
+};
+
+
diff -urN a2billing_v1.9.4/common/lib/customer.help.php a2billing/common/lib/customer.help.php
--- a2billing_v1.9.4/common/lib/customer.help.php	2011-05-31 16:39:39.000000000 -0300
+++ a2billing/common/lib/customer.help.php	2012-09-14 18:14:47.000000000 -0300
@@ -1,131 +1,135 @@
-<?php
-
-/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
-
-/**
- * This file is part of A2Billing (http://www.a2billing.net/)
- *
- * A2Billing, Commercial Open Source Telecom Billing platform,   
- * powered by Star2billing S.L. <http://www.star2billing.com/>
- * 
- * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
- * @author      Belaid Arezqui <areski@gmail.com>
- * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
- * @package     A2Billing
- *
- * Software License Agreement (GNU Affero General Public License)
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU Affero General Public License as
- * published by the Free Software Foundation, either version 3 of the
- * License, or (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU Affero General Public License for more details.
- *
- * You should have received a copy of the GNU Affero General Public License
- * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- * 
- * 
-**/
-
-function create_help($text) {
-	$help = '
-	<div class="toggle_show2hide">
-	<div class="tohide" style="display:visible;">
-	<div class="msg_info">' . $text . '
-	<a href="#" target="_self" class="hide_help" style="float:right;"><img class="toggle_show2hide" src="' . Images_Path . '/toggle_hide2show_on.png" onmouseover="this.style.cursor=\'hand\';" HEIGHT="16"> </a>
-	</div></div></div>';
-	return $help;
-
-}
-
-if (SHOW_HELP) {
-
-	$CC_help_webphone = create_help(gettext("From here, you can use the web based screen phone. You need microphone and speakers on your PC."));
-
-	$CC_help_balance_customer = create_help(gettext("All calls are listed below. Search by month, day or status. Additionally, you can check the rate and price."));
-	
-	$CC_help_support = create_help(gettext("On this page, you can open a support ticket and consult the status of your existing ticket."));
-	
-	$CC_help_card = create_help(gettext("Personal information.") . '<br>' . gettext("You can update your personal information here."));
-
-	$CC_help_notification = create_help(gettext("Notification settings.") . '<br>' . gettext("You can update your notification settings here."));
-	
-	$CC_help_simulator_rateengine = create_help(gettext("Simulate the calling process to discover the cost per minute of a call, and the number of minutes you can call that number with your current credit."));
-
-	$CC_help_sipiax_info = create_help(gettext("Configuration information for SIP and IAX Client. You can simply copy and paste it in your configuration files and do necessary modifications."));
-
-	$CC_help_password_change = create_help(gettext("On this page you will be able to change your password, You have to enter the New Password and Confirm it."));
-
-	$CC_help_ratecard = create_help(gettext("View Rates"));
-
-	$CC_help_view_payment = create_help(gettext("Payment history - Record of payments made."));
-	
-	$CC_help_voicemail = create_help(gettext("Voicemail - The section below allows you to see all your voicemail, listen to them and move them into other folders."));
-
-	$CC_help_list_voucher = create_help(gettext("Enter your voucher number to top up your card."));
-
-	$CC_help_campaign = create_help(gettext("This section will allow you to create and edit campaign. ") .
-	gettext("A campaign will be attached to a user in order to let him use the predictive-dialer option. ") .
-	gettext("Predictive dialer will browse all the phone numbers from the campaign and perform outgoing calls."));
-
-	$CC_help_phonelist = create_help(gettext("Phonelist are all the phone numbers attached to a campaign. You can add, remove and edit the phone numbers."));
-
-	$CC_help_view_invoice = create_help(gettext("Invoice history - The section below allows you to see and pay the invoices that you have to pay."));
-
-	$CC_help_view_receipt = create_help(gettext("Receipt history - The section below allows you to see the receipt that you received. you can see in them the summary of some withdrawal"));
-
-	$CC_help_phonebook = create_help(gettext("Phonebook are set of phone numbers. You can add, remove and edit the phonebook. You can also associate phonebook to a campaign in the Campaign section"));
-
-	$CC_help_list_did = create_help(gettext("Select the country below where you would like a DID, select a DID from the list and enter the destination you would like to assign it to."));
-
-	$CC_help_release_did = create_help(gettext("After confirmation, the release of the did will be done immediately and you will not be monthly charged any more."));
-
-	$CC_help_speeddial = create_help(gettext("Map single digit to your most dialed numbers."));
-	
-	$CC_help_callback = create_help(gettext("Callback : Entre your phone number and the phone number you wish to call."));
-
-} //ENDIF SHOW_HELP
-
-if (!isset ($disable_load_conf) || !($disable_load_conf)) {
-
-	$DBHandle = DbConnect();
-	$instance_table = new Table();
-	$QUERY = "SELECT configuration_key FROM cc_configuration where configuration_key in ('MODULE_PAYMENT_AUTHORIZENET_STATUS','MODULE_PAYMENT_PAYPAL_STATUS','MODULE_PAYMENT_MONEYBOOKERS_STATUS','MODULE_PAYMENT_WORLDPAY_STATUS','MODULE_PAYMENT_PLUGNPAY_STATUS') AND configuration_value='True'";
-	$payment_methods = $instance_table->SQLExec($DBHandle, $QUERY);
-	$show_logo = '';
-	for ($index = 0; $index < sizeof($payment_methods); $index++) {
-		if ($payment_methods[$index][0] == "MODULE_PAYMENT_PAYPAL_STATUS") {
-			$show_logo .= '<a href="https://www.paypal.com/en/mrb/pal=PGSJEXAEXKTBU" target="_blank"><img src="' . KICON_PATH . '/paypal_logo.gif" alt="Paypal"/></a> &nbsp; ';
-			//} elseif( $payment_methods[$index][0] == "MODULE_PAYMENT_AUTHORIZENET_STATUS") {
-			//	$show_logo .= '<a href="http://authorize.net/" target="_blank"><img src="'.KICON_PATH.'/authorize.gif" alt="Authorize.net"/></a> &nbsp; ';
-		}
-		elseif ($payment_methods[$index][0] == "MODULE_PAYMENT_MONEYBOOKERS_STATUS") {
-			$show_logo .= '<a href="https://www.moneybookers.com/app/?rid=811621" target="_blank"><img src="' . KICON_PATH . '/moneybookers.gif" alt="Moneybookers"/></a> &nbsp; ';
-			//} elseif( $payment_methods[$index][0] == "MODULE_PAYMENT_WORLDPAY_STATUS") {
-			//	$show_logo .= '<a href="http://www.worldpay.com/" target="_blank"><img src="'.KICON_PATH.'/worldpay.gif" alt="worldpay.com"/></a> &nbsp; ';
-		}
-		elseif ($payment_methods[$index][0] == "MODULE_PAYMENT_PLUGNPAY_STATUS") {
-			$show_logo .= '<a href="http://www.plugnpay.com/" target="_blank"><img src="' . KICON_PATH . '/plugnpay.png" alt="plugnpay.com"/></a> &nbsp; ';
-		}
-	}
-	$PAYMENT_METHOD = '<table style="width:70%;margin:0 auto;" align="center" ><tr><TD valign="top" align="center" class="tableBodyRight">' . $show_logo . '</td></tr></table>';
-}
-
-$CALL_LABS = '
-<table width="70%" align="center">
-	<tr>
-		<TD width="%75" valign="top" align="center" class="tableBodyRight" background="' . Images_Path . '/background_cells.gif" >
-				Global VoIP termination (A-Z)  to over 400 worldwide destinations!<br>
-				Visit Call-Labs at <a href="http://www.call-labs.com/" target="_blank">http://www.call-labs.com/</a><br/>
-		</TD>
-		<TD width="%25" valign="middle" align="center" class="tableBodyRight" background="' . Images_Path . '/background_cells.gif" >
-				<a href="http://www.call-labs.com/" target="_blank"><img src="' . Images_Path . '/call-labs.com.png" alt="call-labs"/></a>
-		</TD>
-	</tr>
-</table>';
-
-
+<?php
+
+/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
+
+/**
+ * This file is part of A2Billing (http://www.a2billing.net/)
+ *
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
+ * powered by Star2billing S.L. <http://www.star2billing.com/>
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
+ * @author      Belaid Arezqui <areski@gmail.com>
+ * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
+ * @package     A2Billing
+ *
+ * Software License Agreement (GNU Affero General Public License)
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Affero General Public License as
+ * published by the Free Software Foundation, either version 3 of the
+ * License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Affero General Public License for more details.
+ *
+ * You should have received a copy of the GNU Affero General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ * 
+ * 
+**/
+
+function create_help($text) {
+	$help = '
+	<div class="toggle_show2hide">
+	<div class="tohide" style="display:visible;">
+	<div class="msg_info">' . $text . '
+	<a href="#" target="_self" class="hide_help" style="float:right;"><img class="toggle_show2hide" src="' . Images_Path . '/toggle_hide2show_on.png" onmouseover="this.style.cursor=\'hand\';" HEIGHT="16"> </a>
+	</div></div></div>';
+	return $help;
+
+}
+
+if (SHOW_HELP) {
+
+	$CC_help_webphone = create_help(gettext("From here, you can use the web based screen phone. You need microphone and speakers on your PC."));
+
+	$CC_help_balance_customer = create_help(gettext("All calls are listed below. Search by month, day or status. Additionally, you can check the rate and price."));
+	
+	$CC_help_balance_customer_calls = create_help(gettext("This sections presents information only the last two days."));
+	
+	$CC_help_balance_customer_calls_history = create_help(gettext("This section presents historical information except the last two days."));
+	
+	$CC_help_support = create_help(gettext("On this page, you can open a support ticket and consult the status of your existing ticket."));
+	
+	$CC_help_card = create_help(gettext("Personal information.") . '<br>' . gettext("You can update your personal information here."));
+
+	$CC_help_notification = create_help(gettext("Notification settings.") . '<br>' . gettext("You can update your notification settings here."));
+	
+	$CC_help_simulator_rateengine = create_help(gettext("Simulate the calling process to discover the cost per minute of a call, and the number of minutes you can call that number with your current credit."));
+
+	$CC_help_sipiax_info = create_help(gettext("Configuration information for SIP and IAX Client. You can simply copy and paste it in your configuration files and do necessary modifications."));
+
+	$CC_help_password_change = create_help(gettext("On this page you will be able to change your password, You have to enter the New Password and Confirm it."));
+
+	$CC_help_ratecard = create_help(gettext("View Rates"));
+
+	$CC_help_view_payment = create_help(gettext("Payment history - Record of payments made."));
+	
+	$CC_help_voicemail = create_help(gettext("Voicemail - The section below allows you to see all your voicemail, listen to them and move them into other folders."));
+
+	$CC_help_list_voucher = create_help(gettext("Enter your voucher number to top up your card."));
+
+	$CC_help_campaign = create_help(gettext("This section will allow you to create and edit campaign. ") .
+	gettext("A campaign will be attached to a user in order to let him use the predictive-dialer option. ") .
+	gettext("Predictive dialer will browse all the phone numbers from the campaign and perform outgoing calls."));
+
+	$CC_help_phonelist = create_help(gettext("Phonelist are all the phone numbers attached to a campaign. You can add, remove and edit the phone numbers."));
+
+	$CC_help_view_invoice = create_help(gettext("Invoice history - The section below allows you to see and pay the invoices that you have to pay."));
+
+	$CC_help_view_receipt = create_help(gettext("Receipt history - The section below allows you to see the receipt that you received. you can see in them the summary of some withdrawal"));
+
+	$CC_help_phonebook = create_help(gettext("Phonebook are set of phone numbers. You can add, remove and edit the phonebook. You can also associate phonebook to a campaign in the Campaign section"));
+
+	$CC_help_list_did = create_help(gettext("Select the country below where you would like a DID, select a DID from the list and enter the destination you would like to assign it to."));
+
+	$CC_help_release_did = create_help(gettext("After confirmation, the release of the did will be done immediately and you will not be monthly charged any more."));
+
+	$CC_help_speeddial = create_help(gettext("Map single digit to your most dialed numbers."));
+	
+	$CC_help_callback = create_help(gettext("Callback : Entre your phone number and the phone number you wish to call."));
+
+} //ENDIF SHOW_HELP
+
+if (!isset ($disable_load_conf) || !($disable_load_conf)) {
+
+	$DBHandle = DbConnect();
+	$instance_table = new Table();
+	$QUERY = "SELECT configuration_key FROM cc_configuration where configuration_key in ('MODULE_PAYMENT_AUTHORIZENET_STATUS','MODULE_PAYMENT_PAYPAL_STATUS','MODULE_PAYMENT_MONEYBOOKERS_STATUS','MODULE_PAYMENT_WORLDPAY_STATUS','MODULE_PAYMENT_PLUGNPAY_STATUS') AND configuration_value='True'";
+	$payment_methods = $instance_table->SQLExec($DBHandle, $QUERY);
+	$show_logo = '';
+	for ($index = 0; $index < sizeof($payment_methods); $index++) {
+		if ($payment_methods[$index][0] == "MODULE_PAYMENT_PAYPAL_STATUS") {
+			$show_logo .= '<a href="https://www.paypal.com/en/mrb/pal=PGSJEXAEXKTBU" target="_blank"><img src="' . KICON_PATH . '/paypal_logo.gif" alt="Paypal"/></a> &nbsp; ';
+			//} elseif( $payment_methods[$index][0] == "MODULE_PAYMENT_AUTHORIZENET_STATUS") {
+			//	$show_logo .= '<a href="http://authorize.net/" target="_blank"><img src="'.KICON_PATH.'/authorize.gif" alt="Authorize.net"/></a> &nbsp; ';
+		}
+		elseif ($payment_methods[$index][0] == "MODULE_PAYMENT_MONEYBOOKERS_STATUS") {
+			$show_logo .= '<a href="https://www.moneybookers.com/app/?rid=811621" target="_blank"><img src="' . KICON_PATH . '/moneybookers.gif" alt="Moneybookers"/></a> &nbsp; ';
+			//} elseif( $payment_methods[$index][0] == "MODULE_PAYMENT_WORLDPAY_STATUS") {
+			//	$show_logo .= '<a href="http://www.worldpay.com/" target="_blank"><img src="'.KICON_PATH.'/worldpay.gif" alt="worldpay.com"/></a> &nbsp; ';
+		}
+		elseif ($payment_methods[$index][0] == "MODULE_PAYMENT_PLUGNPAY_STATUS") {
+			$show_logo .= '<a href="http://www.plugnpay.com/" target="_blank"><img src="' . KICON_PATH . '/plugnpay.png" alt="plugnpay.com"/></a> &nbsp; ';
+		}
+	}
+	$PAYMENT_METHOD = '<table style="width:70%;margin:0 auto;" align="center" ><tr><TD valign="top" align="center" class="tableBodyRight">' . $show_logo . '</td></tr></table>';
+}
+
+$CALL_LABS = '
+<table width="70%" align="center">
+	<tr>
+		<TD width="%75" valign="top" align="center" class="tableBodyRight" background="' . Images_Path . '/background_cells.gif" >
+				Global VoIP termination (A-Z)  to over 400 worldwide destinations!<br>
+				Visit Call-Labs at <a href="http://www.call-labs.com/" target="_blank">http://www.call-labs.com/</a><br/>
+		</TD>
+		<TD width="%25" valign="middle" align="center" class="tableBodyRight" background="' . Images_Path . '/background_cells.gif" >
+				<a href="http://www.call-labs.com/" target="_blank"><img src="' . Images_Path . '/call-labs.com.png" alt="call-labs"/></a>
+		</TD>
+	</tr>
+</table>';
+
+
diff -urN a2billing_v1.9.4/common/lib/iam_csvdump.php a2billing/common/lib/iam_csvdump.php
--- a2billing_v1.9.4/common/lib/iam_csvdump.php	2011-05-31 16:39:39.000000000 -0300
+++ a2billing/common/lib/iam_csvdump.php	2012-09-20 10:45:55.000000000 -0300
@@ -1,533 +1,630 @@
-<?php
-
-/**
- *  IAM_CSVDump A class form performing a query dump and sending it to the browser or setting it or download.
- *  @package    iam_csvdump
- */
-
- /**
- *  IAM_CSVDump A class form performing a query dump and sending it to the browser or setting it or download.
- *  @author     Ivn Ariel Melgrati <phpclasses@imelgrat.mailshell.com>
- *  @package    iam_csvdump
- *  @version 1.0
- *
- *  IAM_CSVDump A class form performing a query dump and sending it to the browser or setting it or download.
- *
- *  Browser and OS detection for appropriate handling of download and EOL chars.
- *
- *  Requires PHP v 4.0+ and MySQL 3.23+. Some portions taken from the CSV_UTIL_CLASS by Andrej Arn <andrej@blueshoes.org>.
- *
- *  This library is free software; you can redistribute it and/or
- *  modify it under the terms of the GNU Lesser General Public
- *  License as published by the Free Software Foundation; either
- *  version 2 of the License, or (at your option) any later version.
- *
- *  This library is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
- *  Lesser General Public License for more details.
- */
-class iam_csvdump
-{
-
-    /**
-    * @desc Takes an array and creates a csv string from it.
-    *
-    * @access public
-    * @param  Array  $array (see below)
-    * @param  String $separator Field separator ()default is ';')
-    * @param  String $trim  If the cells should be trimmed , default is 'both'. It can also be 'left', 'right' or 'both'. 'none' makes it faster since omits many function calls.
-    * @param  Boolean   $removeEmptyLines (default is TRUE. removes "lines" that have no value, would come out empty.)
-    * @return String A CSV String. It returns an empty string if there Array is empty (NULL)
-    * @todo Add param "fill to fit max length"?
-    */
-    function arrayToCsvString($array, $separator=';', $trim='both', $removeEmptyLines=TRUE) {
-    if (!is_array($array) || empty($array)) return '';
-
-    switch ($trim) {
-      case 'none':
-        $trimFunction = FALSE;
-        break;
-      case 'left':
-        $trimFunction = 'ltrim';
-        break;
-      case 'right':
-        $trimFunction = 'rtrim';
-        break;
-      default: //'both':
-        $trimFunction = 'trim';
-        break;
-    }
-    $ret = array();
-    reset($array);
-    if (is_array(current($array))) {
-      while (list(,$lineArr) = each($array)) {
-        if (!is_array($lineArr)) {
-          //Could issue a warning ...
-          $ret[] = array();
-        } else {
-          $subArr = array();
-          while (list(,$val) = each($lineArr)) {
-            $val      = $this->_valToCsvHelper($val, $separator, $trimFunction);
-            $subArr[] = $val;
-          }
-        }
-        $ret[] = join($separator, $subArr);
-      }
-      return join("\n", $ret);
-    } else {
-      while (list(,$val) = each($array)) {
-        $val   = $this->_valToCsvHelper($val, $separator, $trimFunction);
-        $ret[] = $val;
-      }
-      return join($separator, $ret);
-    }
-    }
-
-    /**
-    * @desc Works on a string to include in a csv string.
-    * @access private
-    * @param  String $val
-    * @param  String $separator
-    * @param  Mixed  $trimFunction If the cells should be trimmed , default is 'both'. It can also be 'left', 'right' or 'both'. 'none' makes it faster since omits many function calls.
-    * @return String
-    * @see    arrayToCsvString()
-    */
-    function _valToCsvHelper($val, $separator, $trimFunction) {
-    if ($trimFunction) $val = $trimFunction($val);
-    //If there is a separator (;) or a quote (") or a linebreak in the string, we need to quote it.
-    $needQuote = FALSE;
-    // Change to always quote
-    $needQuote = TRUE;
-    do {
-      if (strpos($val, '"') !== FALSE) {
-        $val = str_replace('"', '""', $val);
-        $needQuote = TRUE;
-        break;
-      }
-      if (strpos($val, $separator) !== FALSE) {
-        $needQuote = TRUE;
-        break;
-      }
-      if ((strpos($val, "\n") !== FALSE) || (strpos($val, "\r") !== FALSE)) { // \r is for mac
-        $needQuote = TRUE;
-        break;
-      }
-    } while (FALSE);
-    
-    if ($needQuote) {
-      $val = '"' . $val . '"';
-    }
-    return $val;
-    }
-
-    /**
-    * @desc Define EOL character according to target OS
-    * @access private
-    * @return String A String containing the End Of Line Sequence corresponding to the client's OS
-    */
-    function _define_newline()
-    {
-         $unewline = "\r\n";
-
-         if (strstr(strtolower($_SERVER["HTTP_USER_AGENT"]), 'win'))
-         {
-            $unewline = "\r\n";
-         }
-         else if (strstr(strtolower($_SERVER["HTTP_USER_AGENT"]), 'mac'))
-         {
-            $unewline = "\r";
-         }
-         else
-         {
-            // $unewline = "\n";
-         }
-
-         return $unewline;
-    }
-
-    /**
-    * @desc Define the client's browser type
-    * @access private
-    * @return String A String containing the Browser's type or brand
-    */
-    function _get_browser_type()
-    {
-        $USER_BROWSER_AGENT="";
-
-        if (preg_match('/OPERA/i', strtoupper($_SERVER["HTTP_USER_AGENT"]))) 
-        {
-            $USER_BROWSER_AGENT='OPERA';
-        }
-        else if (preg_match('/MSIE/i',strtoupper($_SERVER["HTTP_USER_AGENT"])))
-        {
-            $USER_BROWSER_AGENT='IE';
-        }
-        else if (preg_match('/OMNIWEB/i', strtoupper($_SERVER["HTTP_USER_AGENT"])))
-        {
-            $USER_BROWSER_AGENT='OMNIWEB';
-        }
-        else if (preg_match('/MOZILLA/i', strtoupper($_SERVER["HTTP_USER_AGENT"]))) 
-        {
-            $USER_BROWSER_AGENT='MOZILLA';
-        }
-        else if (preg_match('/FIREFOX/i', strtoupper($_SERVER["HTTP_USER_AGENT"]))) 
-        {
-            $USER_BROWSER_AGENT='FIREFOX';
-        }
-        else if (preg_match('/KONQUEROR/i', strtoupper($_SERVER["HTTP_USER_AGENT"]))) 
-        {
-            $USER_BROWSER_AGENT='KONQUEROR';
-        }
-        else if (preg_match('/CHROME/i', strtoupper($_SERVER["HTTP_USER_AGENT"]))) 
-        {
-            $USER_BROWSER_AGENT='CHROME';
-        }
-        else
-        {
-            $USER_BROWSER_AGENT='OTHER';
-        }
-
-        return $USER_BROWSER_AGENT;
-    }
-
-    /**
-    * @desc Define MIME-TYPE according to target Browser
-    * @access private
-    * @return String A string containing the MIME-TYPE String corresponding to the client's browser
-    */
-    function _get_mime_type()
-    {
-        $USER_BROWSER_AGENT= $this->_get_browser_type();
-
-        $mime_type = ($USER_BROWSER_AGENT == 'IE' || $USER_BROWSER_AGENT == 'OPERA')
-                       ? 'application/octetstream'
-                       : 'application/octet-stream';
-        return $mime_type;
-    }
-
-    /**
-    * @desc Generates a CSV File from an SQL String (and outputs it to the browser)
-    * @access private
-    * @param  String $dbname Name of the Database
-    * @param  String $user User to Access the Database
-    * @param  String $password Password to Access the Database
-    * @param  String $host Name of the Host holding the DB
-    */
-		  
-	function _db_connect($dbname="mysql", $user="root", $password="", $host="localhost")
-    {
-      $result = pg_connect("host=$host port=5432 dbname=$dbname user=$user password=$password");
-      if(!$result)     // If no connection, return 0
-      {
-       return false;
-      }      
-      return $result;
-    }
-
-	
-    function _db_connect_mysql($dbname="mysql", $user="root", $password="", $host="localhost")
-    {
-      $result = @mysql_pconnect($host, $user, $password);
-      if(!$result)     // If no connection, return 0
-      {
-       return false;
-      }
-
-      if(!@mysql_select_db($dbname))  // If db not set, return 0
-      {
-       return false;
-      }
-      return $result;
-    }
-
-    /**
-    * @desc Generates a CSV File from an SQL String (and outputs it to the browser)
-    * @access private
-    * @param  String $query_string An SQL statement (usually a SELECT statement)
-    * @param  String $dbname Name of the Database
-    * @param  String $user User to Access the Database
-    * @param  String $password Password to Access the Database
-    * @param  String $host Name of the Host holding the DB
-    */
-	/******* #################################### SEE FONCTION BELOW *****/
-	function db_fetch_array ($result, $row = NULL, $result_type = PGSQL_ASSOC)
-    {
-       $return = @pg_fetch_array ($result, $row, $result_type);
-       return $return;
-    }
-	
-    function _generate_csv($query_string, $dbname="mysql", $user="root", $password="", $host="localhost")
-    {
-      if(!$conn= $this->_db_connect($dbname, $user , $password, $host))
-          die("Error. Cannot connect to Database.");
-      else
-      {	  	
-	$result = pg_query($conn, $query_string);
-        if(!$result){		
-		die("Could not perform the Query: ".pg_ErrorMessage($result));
-        }else
-        {
-            $file = "";
-            $crlf = $this->_define_newline();
-		while ($str= @pg_fetch_array($result,NULL, PGSQL_NUM))			
-            {
-                $file .= $this->arrayToCsvString($str,",").$crlf;
-            }
-            echo $file;
-        }
-      }
-    }
-	
-	function _generate_csv_mysql($query_string, $dbname="mysql", $user="root", $password="", $host="localhost")
-    {
-
-	  
-      if(!$conn= $this->_db_connect_mysql($dbname, $user , $password, $host))
-          die("Error. Cannot connect to Database.");
-      else
-      {
-        $result = @mysql_query($query_string, $conn);
-        if(!$result)
-            die("Could not perform the Query: ".mysql_error());
-        else
-        {
-            $file = "";
-            $crlf = $this->_define_newline();
-            while ($str= @mysql_fetch_array($result, MYSQL_NUM))
-            {
-                $file .= $this->arrayToCsvString($str,",").$crlf;
-            }
-            echo $file;
-        }
-      }
-    }
-    /*
-        Function to Create XML String for the Data for Post Gre SQL
-    */
-
-    function _generate_xml_postgre($query_string, $dbname="mysql", $user="root", $password="", $host="localhost")
-    {
-        /*if (strstr($_SERVER['HTTP_USER_AGENT'], 'MSIE') && isset($_SERVER['HTTPS']))
-        {
-            header('Content-Type: text/plain');
-        }
-		else
-        {
-		    header('Content-Type: application/download');
-            header('Content-Disposition: attachment; filename=dump.xml');
-		} */
-        if(!$conn= $this->_db_connect($dbname, $user , $password, $host))
-        {
-          die("Error. Cannot connect to Database.");
-        }
-        else
-        {			
-    	    $result = pg_query($conn, $query_string);
-			
-            if(!$result)
-            {
-    		    die("Could not perform the Query: ".pg_ErrorMessage($result));
-            }
-            else
-            {
-                $file = "";
-                $crlf = $this->_define_newline();
-                $this->_generate_pgxml($result);
-            }
-        }
-    }
-    /*
-        Function to Generate XML String for Post GreSQL
-    */
-
-
-    function _generate_pgxml($result=NULL)
-    {
-        if(!$result)
-        {
-            return false;
-        }
-        echo "<?xml version=\"1.0\"";
-		echo " encoding=".'"'."US-ASCII".'"';
-        echo " ?>\n";
-		echo "<data>\n";
-        // Output header row
-        $j = 0;
-        echo "\t<header>\n";
-        $totalFields = @pg_num_fields($result);
-        for($i=0; $i < $totalFields; $i++)
-        {
-            $name = htmlspecialchars(@pg_field_name($result, $i));
-			$type = htmlspecialchars(@pg_field_type($result, $i));
-			echo "\t\t<column name=\"{$name}\" type=\"{$type}\" />\n";
-		}
-        echo "\t</header>\n";
-
-		echo "\t<records>\n";
-        $totalRows = @pg_num_rows($result);
-		for($k=0; $k< $totalRows; $k++)
-        {
-            $j = 0;
-			echo "\t\t<row>\n";
-			for($l = 0; $l < $totalFields; $l++)
-            {
-                $name = htmlspecialchars(@pg_field_name($result, $l));
-                $v =  htmlspecialchars(@pg_fetch_result($result, $k, $l));
-                if ($v != null)
-                {
-                    $v = htmlspecialchars($v);
-                }
-                echo "\t\t\t<column name=\"{$name}\"", ($v == null ? ' null="null"' : ''), ">{$v}</column>\n";
-            }
-			echo "\t\t</row>\n";
-		}
-		echo "\t</records>\n";
-		echo "</data>\n";
-    }
-
-    function _generate_xml_mysql($query_string, $dbname="mysql", $user="root", $password="", $host="localhost")
-    {
-        /*if(strstr($_SERVER['HTTP_USER_AGENT'], 'MSIE') && isset($_SERVER['HTTPS']))
-        {
-            header('Content-Type: text/plain');
-        }
-		else
-        {
-		    header('Content-Type: application/download');
-            header('Content-Disposition: attachment; filename=dump.xml');
-		} */
-        if(!$conn= $this->_db_connect_mysql($dbname, $user , $password, $host))
-        {
-            die("Error. Cannot connect to Database.");
-        }
-        else
-        {
-            $result = @mysql_query($query_string, $conn);
-            if(!$result)
-            {
-              die("Could not perform the Query: ".mysql_error());
-            }
-            else
-            {
-                $file = "";
-                $crlf = $this->_define_newline();
-
-                $this->_generate_msqlxml($result);
-            }
-        }
-    }
-
-    function _generate_msqlxml($result=NULL)
-    {
-
-        if(!$result)
-        {
-            return false;
-        }
-        echo "<?xml version=\"1.0\"";
-		echo " encoding=".'"'."US-ASCII".'"';
-        echo " ?>\n";
-		echo "<data>\n";
-        // Output header row
-        $j = 0;
-        echo "\t<header>\n";
-        $totalFields = @mysql_num_fields($result);
-        for ($i=0; $i<$totalFields; $i++)
-        {
-            $name = htmlspecialchars(@mysql_field_name($result, $i));
-			$type = htmlspecialchars(@mysql_field_type($result, $i));
-			echo "\t\t<column name=\"{$name}\" type=\"{$type}\" />\n";
-		}
-        echo "\t</header>\n";
-
-		echo "\t<records>\n";
-        $totalRows = @mysql_num_rows($result);
-		while($row = @mysql_fetch_array($result, MYSQL_NUM))
-        {
-            $j = 0;
-			echo "\t\t<row>\n";
-
-			for($l = 0; $l < $totalFields; $l++)
-            {
-                $name = htmlspecialchars(@mysql_field_name($result, $l));
-                $v =  $row[$l];
-                if ($v != null)
-                {
-                    $v = htmlspecialchars($v);
-                }
-                echo "\t\t\t<column name=\"{$name}\"", ($v == null ? ' null="null"' : ''), ">{$v}</column>\n";
-            }
-			echo "\t\t</row>\n";
-		}
-		echo "\t</records>\n";
-		echo "</data>\n";
-    }
-
-
-
-    /**
-    * @desc Generate the CSV File and send it to browser or download it as a file
-    * @access public
-    * @param String $query_string  An SQL statement (usually a SELECT statement)
-    * @param String $filename  Filename to use when downloading the File. Default="dump". If set to "", the dump is displayed on the browser.
-    * @param String $extension Extension to use when downloading the File. Default="csv"
-    * @param  String $dbname Name of the Database to use
-    * @param  String $user User to Access the Database
-    * @param  String $password Password to Access the Database
-    * @param  String $host Name of the Host holding the DB
-    */
-    function dump($query_string, $filename="dump", $ext="csv", $dbname="mysql", $user="root", $password="", $host="localhost",$db_type="postgres")
-    {
-            $now = gmdate('D, d M Y H:i:s') . ' GMT';
-            $USER_BROWSER_AGENT= $this->_get_browser_type();
-
-            if ($filename!="")
-            {
-                 header('Content-Type: ' . $this->_get_mime_type());
-                 header('Expires: ' . $now);
-                 if ($USER_BROWSER_AGENT == 'IE')
-                 {
-                      header('Content-Disposition: inline; filename="' . $filename . '.' . $ext . '"');
-                      header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
-                      header('Pragma: public');
-                 }
-                 else
-                 {
-                      header('Content-Disposition: attachment; filename="' . $filename . '.' . $ext . '"');
-                      header('Pragma: no-cache');
-                 }
-                 /* Coding for the xml and csv file generation */
-                 if($ext=="csv")
-                 {
-                     if ($db_type == "postgres")
-                     {
-                        $this->_generate_csv($query_string, $dbname, $user, $password, $host);
-                     }
-                     else
-                     {
-                         $this->_generate_csv_mysql($query_string, $dbname, $user, $password, $host);
-                     }
-                 }
-                 elseif($ext=="xml")
-                 {
-                      if ($db_type == "postgres")
-                      {
-
-                          $this->_generate_xml_postgre($query_string, $dbname, $user, $password, $host);
-                      }
-                      else
-                      {
-
-                          $this->_generate_xml_mysql($query_string, $dbname, $user, $password, $host);
-                      }
-                 }
-            }
-            else
-            {
-                 echo "<html><body><pre>";
-                 echo htmlspecialchars($this->_generate_csv($query_string, $dbname, $user, $password, $host));
-                 echo "</PRE></BODY></HTML>";
-            }
-    }
-}
+<?php
+
+/**
+ *  IAM_CSVDump A class form performing a query dump and sending it to the browser or setting it or download.
+ *  @package    iam_csvdump
+ */
+
+ /**
+ *  IAM_CSVDump A class form performing a query dump and sending it to the browser or setting it or download.
+ *  @author     Ivn Ariel Melgrati <phpclasses@imelgrat.mailshell.com>
+ *  @package    iam_csvdump
+ *  @version 1.0
+ *
+ *  IAM_CSVDump A class form performing a query dump and sending it to the browser or setting it or download.
+ *
+ *  Browser and OS detection for appropriate handling of download and EOL chars.
+ *
+ *  Requires PHP v 4.0+ and MySQL 3.23+. Some portions taken from the CSV_UTIL_CLASS by Andrej Arn <andrej@blueshoes.org>.
+ *
+ *  This library is free software; you can redistribute it and/or
+ *  modify it under the terms of the GNU Lesser General Public
+ *  License as published by the Free Software Foundation; either
+ *  version 2 of the License, or (at your option) any later version.
+ *
+ *  This library is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ *  Lesser General Public License for more details.
+ */
+class iam_csvdump
+{
+
+    /**
+    * @desc Takes an array and creates a csv string from it.
+    *
+    * @access public
+    * @param  Array  $array (see below)
+    * @param  String $separator Field separator ()default is ';')
+    * @param  String $trim  If the cells should be trimmed , default is 'both'. It can also be 'left', 'right' or 'both'. 'none' makes it faster since omits many function calls.
+    * @param  Boolean   $removeEmptyLines (default is TRUE. removes "lines" that have no value, would come out empty.)
+    * @return String A CSV String. It returns an empty string if there Array is empty (NULL)
+    * @todo Add param "fill to fit max length"?
+    */
+    function arrayToCsvString($array, $separator=';', $trim='both', $removeEmptyLines=TRUE) {
+    if (!is_array($array) || empty($array)) return '';
+
+    switch ($trim) {
+      case 'none':
+        $trimFunction = FALSE;
+        break;
+      case 'left':
+        $trimFunction = 'ltrim';
+        break;
+      case 'right':
+        $trimFunction = 'rtrim';
+        break;
+      default: //'both':
+        $trimFunction = 'trim';
+        break;
+    }
+    $ret = array();
+    reset($array);
+    if (is_array(current($array))) {
+      while (list(,$lineArr) = each($array)) {
+        if (!is_array($lineArr)) {
+          //Could issue a warning ...
+          $ret[] = array();
+        } else {
+          $subArr = array();
+          while (list(,$val) = each($lineArr)) {
+            $val      = $this->_valToCsvHelper($val, $separator, $trimFunction);
+            $subArr[] = $val;
+          }
+        }
+        $ret[] = join($separator, $subArr);
+      }
+      return join("\n", $ret);
+    } else {
+      while (list(,$val) = each($array)) {
+        $val   = $this->_valToCsvHelper($val, $separator, $trimFunction);
+        $ret[] = $val;
+      }
+      return join($separator, $ret);
+    }
+    }
+
+    /**
+    * @desc Works on a string to include in a csv string.
+    * @access private
+    * @param  String $val
+    * @param  String $separator
+    * @param  Mixed  $trimFunction If the cells should be trimmed , default is 'both'. It can also be 'left', 'right' or 'both'. 'none' makes it faster since omits many function calls.
+    * @return String
+    * @see    arrayToCsvString()
+    */
+    function _valToCsvHelper($val, $separator, $trimFunction) {
+    if ($trimFunction) $val = $trimFunction($val);
+    //If there is a separator (;) or a quote (") or a linebreak in the string, we need to quote it.
+    $needQuote = FALSE;
+    // Change to always quote
+    $needQuote = TRUE;
+    do {
+      if (strpos($val, '"') !== FALSE) {
+        $val = str_replace('"', '""', $val);
+        $needQuote = TRUE;
+        break;
+      }
+      if (strpos($val, $separator) !== FALSE) {
+        $needQuote = TRUE;
+        break;
+      }
+      if ((strpos($val, "\n") !== FALSE) || (strpos($val, "\r") !== FALSE)) { // \r is for mac
+        $needQuote = TRUE;
+        break;
+      }
+    } while (FALSE);
+    
+    if ($needQuote) {
+      $val = '"' . $val . '"';
+    }
+    return $val;
+    }
+
+    /**
+    * @desc Define EOL character according to target OS
+    * @access private
+    * @return String A String containing the End Of Line Sequence corresponding to the client's OS
+    */
+    function _define_newline()
+    {
+         $unewline = "\r\n";
+
+         if (strstr(strtolower($_SERVER["HTTP_USER_AGENT"]), 'win'))
+         {
+            $unewline = "\r\n";
+         }
+         else if (strstr(strtolower($_SERVER["HTTP_USER_AGENT"]), 'mac'))
+         {
+            $unewline = "\r";
+         }
+         else
+         {
+            // $unewline = "\n";
+         }
+
+         return $unewline;
+    }
+
+    /**
+    * @desc Define the client's browser type
+    * @access private
+    * @return String A String containing the Browser's type or brand
+    */
+    function _get_browser_type()
+    {
+        $USER_BROWSER_AGENT="";
+
+        if (preg_match('/OPERA/i', strtoupper($_SERVER["HTTP_USER_AGENT"]))) 
+        {
+            $USER_BROWSER_AGENT='OPERA';
+        }
+        else if (preg_match('/MSIE/i',strtoupper($_SERVER["HTTP_USER_AGENT"])))
+        {
+            $USER_BROWSER_AGENT='IE';
+        }
+        else if (preg_match('/OMNIWEB/i', strtoupper($_SERVER["HTTP_USER_AGENT"])))
+        {
+            $USER_BROWSER_AGENT='OMNIWEB';
+        }
+        else if (preg_match('/MOZILLA/i', strtoupper($_SERVER["HTTP_USER_AGENT"]))) 
+        {
+            $USER_BROWSER_AGENT='MOZILLA';
+        }
+        else if (preg_match('/FIREFOX/i', strtoupper($_SERVER["HTTP_USER_AGENT"]))) 
+        {
+            $USER_BROWSER_AGENT='FIREFOX';
+        }
+        else if (preg_match('/KONQUEROR/i', strtoupper($_SERVER["HTTP_USER_AGENT"]))) 
+        {
+            $USER_BROWSER_AGENT='KONQUEROR';
+        }
+        else if (preg_match('/CHROME/i', strtoupper($_SERVER["HTTP_USER_AGENT"]))) 
+        {
+            $USER_BROWSER_AGENT='CHROME';
+        }
+        else
+        {
+            $USER_BROWSER_AGENT='OTHER';
+        }
+
+        return $USER_BROWSER_AGENT;
+    }
+
+    /**
+    * @desc Define MIME-TYPE according to target Browser
+    * @access private
+    * @return String A string containing the MIME-TYPE String corresponding to the client's browser
+    */
+    function _get_mime_type()
+    {
+        $USER_BROWSER_AGENT= $this->_get_browser_type();
+
+        $mime_type = ($USER_BROWSER_AGENT == 'IE' || $USER_BROWSER_AGENT == 'OPERA')
+                       ? 'application/octetstream'
+                       : 'application/octet-stream';
+        return $mime_type;
+    }
+
+    /**
+    * @desc Generates a CSV File from an SQL String (and outputs it to the browser)
+    * @access private
+    * @param  String $dbname Name of the Database
+    * @param  String $user User to Access the Database
+    * @param  String $password Password to Access the Database
+    * @param  String $host Name of the Host holding the DB
+    */
+		  
+	function _db_connect($dbname="mysql", $user="root", $password="", $host="localhost")
+    {
+      $result = pg_connect("host=$host port=5432 dbname=$dbname user=$user password=$password");
+      if(!$result)     // If no connection, return 0
+      {
+       return false;
+      }      
+      return $result;
+    }
+
+	
+    function _db_connect_mysql($dbname="mysql", $user="root", $password="", $host="localhost")
+    {
+      $result = @mysql_pconnect($host, $user, $password);
+      if(!$result)     // If no connection, return 0
+      {
+       return false;
+      }
+
+      if(!@mysql_select_db($dbname))  // If db not set, return 0
+      {
+       return false;
+      }
+      return $result;
+    }
+
+    /**
+    * @desc Generates a CSV File from an SQL String (and outputs it to the browser)
+    * @access private
+    * @param  String $query_string An SQL statement (usually a SELECT statement)
+    * @param  String $dbname Name of the Database
+    * @param  String $user User to Access the Database
+    * @param  String $password Password to Access the Database
+    * @param  String $host Name of the Host holding the DB
+    */
+	/******* #################################### SEE FONCTION BELOW *****/
+	function db_fetch_array ($result, $row = NULL, $result_type = PGSQL_ASSOC)
+    {
+       $return = @pg_fetch_array ($result, $row, $result_type);
+       return $return;
+    }
+	
+    function _generate_csv($query_string, $dbname="mysql", $user="root", $password="", $host="localhost")
+    {
+      if(!$conn= $this->_db_connect($dbname, $user , $password, $host))
+          die("Error. Cannot connect to Database.");
+      else
+      {	  	
+	$result = pg_query($conn, $query_string);
+        if(!$result){		
+		die("Could not perform the Query: ".pg_ErrorMessage($result));
+        }else
+        {
+            $file = "";
+            $crlf = $this->_define_newline();
+		while ($str= @pg_fetch_array($result,NULL, PGSQL_NUM))			
+            {
+                $file .= $this->arrayToCsvString($str,",").$crlf;
+            }
+            echo $file;
+        }
+      }
+    }
+	
+	function _generate_csv_mysql($query_string, $dbname="mysql", $user="root", $password="", $host="localhost")
+    {
+
+	  
+      if(!$conn= $this->_db_connect_mysql($dbname, $user , $password, $host))
+          die("Error. Cannot connect to Database.");
+      else
+      {
+        $result = @mysql_query($query_string, $conn);
+        if(!$result)
+            die("Could not perform the Query: ".mysql_error());
+        else
+        {
+            $file = "";
+            $crlf = $this->_define_newline();
+            while ($str= @mysql_fetch_array($result, MYSQL_NUM))
+            {
+                $file .= $this->arrayToCsvString($str,",").$crlf;
+            }
+            echo $file;
+        }
+      }
+    }
+    /*
+        Function to Create XML String for the Data for Post Gre SQL
+    */
+
+    function _generate_xml_postgre($query_string, $dbname="mysql", $user="root", $password="", $host="localhost")
+    {
+        /*if (strstr($_SERVER['HTTP_USER_AGENT'], 'MSIE') && isset($_SERVER['HTTPS']))
+        {
+            header('Content-Type: text/plain');
+        }
+		else
+        {
+		    header('Content-Type: application/download');
+            header('Content-Disposition: attachment; filename=dump.xml');
+		} */
+        if(!$conn= $this->_db_connect($dbname, $user , $password, $host))
+        {
+          die("Error. Cannot connect to Database.");
+        }
+        else
+        {			
+    	    $result = pg_query($conn, $query_string);
+			
+            if(!$result)
+            {
+    		    die("Could not perform the Query: ".pg_ErrorMessage($result));
+            }
+            else
+            {
+                $file = "";
+                $crlf = $this->_define_newline();
+                $this->_generate_pgxml($result);
+            }
+        }
+    }
+    /*
+        Function to Generate XML String for Post GreSQL
+    */
+
+
+    function _generate_pgxml($result=NULL)
+    {
+        if(!$result)
+        {
+            return false;
+        }
+        echo "<?xml version=\"1.0\"";
+		echo " encoding=".'"'."US-ASCII".'"';
+        echo " ?>\n";
+		echo "<data>\n";
+        // Output header row
+        $j = 0;
+        echo "\t<header>\n";
+        $totalFields = @pg_num_fields($result);
+        for($i=0; $i < $totalFields; $i++)
+        {
+            $name = htmlspecialchars(@pg_field_name($result, $i));
+			$type = htmlspecialchars(@pg_field_type($result, $i));
+			echo "\t\t<column name=\"{$name}\" type=\"{$type}\" />\n";
+		}
+        echo "\t</header>\n";
+
+		echo "\t<records>\n";
+        $totalRows = @pg_num_rows($result);
+		for($k=0; $k< $totalRows; $k++)
+        {
+            $j = 0;
+			echo "\t\t<row>\n";
+			for($l = 0; $l < $totalFields; $l++)
+            {
+                $name = htmlspecialchars(@pg_field_name($result, $l));
+                $v =  htmlspecialchars(@pg_fetch_result($result, $k, $l));
+                if ($v != null)
+                {
+                    $v = htmlspecialchars($v);
+                }
+                echo "\t\t\t<column name=\"{$name}\"", ($v == null ? ' null="null"' : ''), ">{$v}</column>\n";
+            }
+			echo "\t\t</row>\n";
+		}
+		echo "\t</records>\n";
+		echo "</data>\n";
+    }
+
+    function _generate_xml_mysql($query_string, $dbname="mysql", $user="root", $password="", $host="localhost")
+    {
+        /*if(strstr($_SERVER['HTTP_USER_AGENT'], 'MSIE') && isset($_SERVER['HTTPS']))
+        {
+            header('Content-Type: text/plain');
+        }
+		else
+        {
+		    header('Content-Type: application/download');
+            header('Content-Disposition: attachment; filename=dump.xml');
+		} */
+        if(!$conn= $this->_db_connect_mysql($dbname, $user , $password, $host))
+        {
+            die("Error. Cannot connect to Database.");
+        }
+        else
+        {
+            $result = @mysql_query($query_string, $conn);
+            if(!$result)
+            {
+              die("Could not perform the Query: ".mysql_error());
+            }
+            else
+            {
+                $file = "";
+                $crlf = $this->_define_newline();
+
+                $this->_generate_msqlxml($result);
+            }
+        }
+    }
+
+    function _generate_msqlxml($result=NULL)
+    {
+
+        if(!$result)
+        {
+            return false;
+        }
+        echo "<?xml version=\"1.0\"";
+		echo " encoding=".'"'."US-ASCII".'"';
+        echo " ?>\n";
+		echo "<data>\n";
+        // Output header row
+        $j = 0;
+        echo "\t<header>\n";
+        $totalFields = @mysql_num_fields($result);
+        for ($i=0; $i<$totalFields; $i++)
+        {
+            $name = htmlspecialchars(@mysql_field_name($result, $i));
+			$type = htmlspecialchars(@mysql_field_type($result, $i));
+			echo "\t\t<column name=\"{$name}\" type=\"{$type}\" />\n";
+		}
+        echo "\t</header>\n";
+
+		echo "\t<records>\n";
+        $totalRows = @mysql_num_rows($result);
+		while($row = @mysql_fetch_array($result, MYSQL_NUM))
+        {
+            $j = 0;
+			echo "\t\t<row>\n";
+
+			for($l = 0; $l < $totalFields; $l++)
+            {
+                $name = htmlspecialchars(@mysql_field_name($result, $l));
+                $v =  $row[$l];
+                if ($v != null)
+                {
+                    $v = htmlspecialchars($v);
+                }
+                echo "\t\t\t<column name=\"{$name}\"", ($v == null ? ' null="null"' : ''), ">{$v}</column>\n";
+            }
+			echo "\t\t</row>\n";
+		}
+		echo "\t</records>\n";
+		echo "</data>\n";
+    }
+
+
+
+    /**
+    * @desc Generate the CSV File and send it to browser or download it as a file
+    * @access public
+    * @param String $query_string  An SQL statement (usually a SELECT statement)
+    * @param String $filename  Filename to use when downloading the File. Default="dump". If set to "", the dump is displayed on the browser.
+    * @param String $extension Extension to use when downloading the File. Default="csv"
+    * @param  String $dbname Name of the Database to use
+    * @param  String $user User to Access the Database
+    * @param  String $password Password to Access the Database
+    * @param  String $host Name of the Host holding the DB
+    */
+    function dump($query_string, $filename="dump", $ext="csv", $dbname="mysql", $user="root", $password="", $host="localhost",$db_type="postgres")
+    {
+            $now = gmdate('D, d M Y H:i:s') . ' GMT';
+            $USER_BROWSER_AGENT= $this->_get_browser_type();
+
+            if ($filename!="")
+            {
+                 header('Content-Type: ' . $this->_get_mime_type());
+                 header('Expires: ' . $now);
+                 if ($USER_BROWSER_AGENT == 'IE')
+                 {
+                      header('Content-Disposition: inline; filename="' . $filename . '.' . $ext . '"');
+                      header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
+                      header('Pragma: public');
+                 }
+                 else
+                 {
+                      header('Content-Disposition: attachment; filename="' . $filename . '.' . $ext . '"');
+                      header('Pragma: no-cache');
+                 }
+                 /* Coding for the xml and csv file generation */
+                 if($ext=="csv")
+                 {
+                     if ($db_type == "postgres")
+                     {
+                        $this->_generate_csv($query_string, $dbname, $user, $password, $host);
+                     }
+                     else
+                     {
+                         $this->_generate_csv_mysql($query_string, $dbname, $user, $password, $host);
+                     }
+                 }
+                 elseif($ext=="xml")
+                 {
+                      if ($db_type == "postgres")
+                      {
+
+                          $this->_generate_xml_postgre($query_string, $dbname, $user, $password, $host);
+                      }
+                      else
+                      {
+
+                          $this->_generate_xml_mysql($query_string, $dbname, $user, $password, $host);
+                      }
+                 }
+            }
+            else
+            {
+                 echo "<html><body><pre>";
+                 echo htmlspecialchars($this->_generate_csv($query_string, $dbname, $user, $password, $host));
+                 echo "</PRE></BODY></HTML>";
+            }
+    }
+	
+	function dump_file($query_string, $filename="dump", $ext="csv", $dbname="mysql", $user="root", $password="", $host="localhost",$db_type="postgres")
+    {
+		//$now = gmdate('D, d M Y H:i:s') . ' GMT';
+		$USER_BROWSER_AGENT= $this->_get_browser_type();
+
+		if ($filename!="")
+		{
+			 header('Content-Type: ' . $this->_get_mime_type());
+			 header('Expires: ' . $now);
+			 if ($USER_BROWSER_AGENT == 'IE')
+			 {
+				  header('Content-Disposition: inline; filename="' . $filename . '.' . $ext . '"');
+				  header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
+				  header('Pragma: public');
+			 }
+			 else
+			 {
+				  header('Content-Disposition: attachment; filename="' . $filename . '.' . $ext . '"');
+				  header('Pragma: no-cache');
+			 }
+			 /* Coding for the xml and csv file generation */
+			$this->_send_csv_file($filename);
+		}
+    }
+	
+	function dump_job($query_string, $filename="dump", $ext="csv", $dbname="mysql", $user="root", $password="", $host="localhost",$db_type="postgres", $header= "", $gmtoffset_card = 0,$currency_card = "USD")
+    {
+		$fh = fopen($filename.".".$ext, 'w');
+		if (!fwrite($fh, $header."\n")) {
+			write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [dump_job ->NO SE PUDO ESCRIBIR EL ARCHIVO]");
+			return false;
+		} else {
+			if(!$conn= $this->_db_connect_mysql($dbname, $user , $password, $host))
+				die("Error. Cannot connect to Database.");
+			else
+			{
+				$result = @mysql_query($query_string, $conn);
+				if(!$result)
+					die("Could not perform the Query: ".mysql_error());
+				else
+				{
+					$file = "";
+					while ($str= @mysql_fetch_array($result, MYSQL_NUM))
+					{
+						$str[0] = display_GMT($str[0],$gmtoffset_card,1);
+						$str[10] = $this->format_2bill($str[10],$currency_card);
+						$str[11] = number_format($str[11], 2) . "%";
+						$str[12] = number_format($str[12], 2) . "%";
+						$file = $this->arrayToCsvString($str,",")."\n";
+
+						fwrite($fh, $file);
+						
+					}
+				}
+			}
+		}
+		fclose($fh);
+		
+		//$gzip_command = "gzip -9 -f ".$filename.".".$ext;
+		$zip_command = "zip -j ".$filename.".zip ".$filename.".".$ext;
+		
+		unlink($filename.".zip");
+		
+		exec($zip_command);
+		
+		unlink($filename.".".$ext);
+
+    }
+	
+	function format_2bill($var, $currency = BASE_CURRENCY) {
+		global $currencies_list, $choose_currency;
+
+		if (!is_array($currencies_list))
+			$currencies_list = get_currencies();
+		$var = $var / $currencies_list[strtoupper($currency)][2];
+		return number_format($var, 3) . ' ' . strtoupper($currency);
+	}
+	
+	function date_add_hour($tmpdate, $hour = 0) {
+	
+		$second = $hour * 60 * 60 ;
+		$date_time_array = getdate(strtotime($tmpdate));
+	
+		$hours = $date_time_array['hours'];
+		$minutes = $date_time_array['minutes'];
+		$seconds = $date_time_array['seconds'];
+		$month = $date_time_array['mon'];
+		$day = $date_time_array['mday'];
+		$year = $date_time_array['year'];
+		
+		$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+
+		$timestamp = $timestamp + $second;
+
+		return $timestamp;
+	}
+}
diff -urN a2billing_v1.9.4/common/lib/Misc.php a2billing/common/lib/Misc.php
--- a2billing_v1.9.4/common/lib/Misc.php	2011-05-31 16:39:39.000000000 -0300
+++ a2billing/common/lib/Misc.php	2012-09-18 16:07:15.000000000 -0300
@@ -1,1502 +1,1520 @@
-<?php
-
-/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
-
-/**
- * This file is part of A2Billing (http://www.a2billing.net/)
- *
- * A2Billing, Commercial Open Source Telecom Billing platform,   
- * powered by Star2billing S.L. <http://www.star2billing.com/>
- * 
- * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
- * @author      Belaid Arezqui <areski@gmail.com>
- * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
- * @package     A2Billing
- *
- * Software License Agreement (GNU Affero General Public License)
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU Affero General Public License as
- * published by the Free Software Foundation, either version 3 of the
- * License, or (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU Affero General Public License for more details.
- *
- * You should have received a copy of the GNU Affero General Public License
- * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- * 
- * 
-**/
-
-
-/*
- * a2b_round: specific function to use the same precision everywhere
- */
-function a2b_round($number) {
-	$PRECISION = 6;
-	return round($number, $PRECISION);
-}
-
-function a2b_encrypt($text, $key) {
-	$iv_size = mcrypt_get_iv_size(MCRYPT_RIJNDAEL_256, MCRYPT_MODE_ECB);
-	$iv = mcrypt_create_iv($iv_size);
-	$temp = mcrypt_encrypt(MCRYPT_RIJNDAEL_256, md5($key), $text, MCRYPT_MODE_ECB, $iv);
-	return $temp;
-}
-
-function a2b_decrypt($text, $key) {
-	$iv_size = mcrypt_get_iv_size(MCRYPT_RIJNDAEL_256, MCRYPT_MODE_ECB);
-	$iv = mcrypt_create_iv($iv_size);
-	$temp = mcrypt_decrypt(MCRYPT_RIJNDAEL_256, md5($key), $text, MCRYPT_MODE_ECB, $iv);
-	return $temp;
-}
-
-/*
- * a2b_mail - function mail used in a2billing
- */
-function a2b_mail($to, $subject, $mail_content, $from = 'root@localhost', $fromname = '', $contenttype = 'multipart/alternative')
-{
-	
-	$mail = new PHPMailer(true);
-	
-	if (SMTP_SERVER) {
-		$mail->Mailer = "smtp";
-	} else {
-		$mail->Mailer = "sendmail";
-	}
-
-	$mail->Host = SMTP_HOST;
-	$mail->Username = SMTP_USERNAME;
-	$mail->Password = SMTP_PASSWORD;
-	$mail->Port = SMTP_PORT;
-	$mail->SMTPSecure = SMTP_SECURE;
-    $mail->CharSet = 'UTF-8';
-
-	if (strlen(SMTP_USERNAME) > 0)
-		$mail->SMTPAuth = true;
-
-	$mail->From = $from;
-	$mail->FromName = $fromname;
-	$mail->Subject = $subject;
-	$mail->Body = nl2br($mail_content); //$HTML;
-	$mail->AltBody = $mail_content; // Plain text body (for mail clients that cannot read 	HTML)
-	// if ContentType = multipart/alternative -> HTML will be send
-	$mail->ContentType = $contenttype;
-	
-	if (strpos($to, ',') > 0) {
-		foreach (explode(',', $to) as $toemail){
-            $mail->AddAddress($toemail);
-        }
-	} else {
-	    $mail->AddAddress($to);
-	}
-	
-	try {
-		$mail->Send();
-	} catch (phpmailerException $e) {
-		throw $e;
-	}
-}
-
-/*
- * get_currencies
- */
-function get_currencies($handle = null) {
-	if (empty ($handle)) {
-		$handle = DbConnect();
-	}
-	$instance_table = new Table();
-	$QUERY = "SELECT id, currency, name, value FROM cc_currencies ORDER BY id";
-	$result = $instance_table->SQLExec($handle, $QUERY, 1, 300);
-
-	if (is_array($result)) {
-		$num_cur = count($result);
-		for ($i = 0; $i < $num_cur; $i++) {
-			$currencies_list[$result[$i][1]] = array (
-				1 => $result[$i][2],
-				2 => $result[$i][3]
-			);
-		}
-	}
-
-	if ((isset ($currencies_list)) && (is_array($currencies_list)))
-		sort_currencies_list($currencies_list);
-
-	return $currencies_list;
-}
-
-function getCurrenciesList() {
-	$currencies_list = get_currencies();
-	foreach ($currencies_list as $key => $cur_value) {
-		$currency_list[$key] = array (
-			$cur_value[1] . ' (' . $cur_value[2] . ')',
-			$key
-		);
-	}
-	return $currency_list;
-}
-
-function getCurrenciesKeyList() {
-	$currencies_list = get_currencies();
-	foreach ($currencies_list as $key => $cur_value) {
-		$currency_list_key[$key][0] = $key;
-	}
-	return $currency_list_key;
-}
-
-function getCurrenciesRateList() {
-	$currencies_list = get_currencies();
-	foreach ($currencies_list as $key => $cur_value) {
-		$currency_list_r[$key] = array (
-			$key,
-			$cur_value[1]
-		);
-	}
-	return $currency_list_r;
-}
-
-/**
-* Do Currency Conversion.
-* @param $currencies_list the List of currencies.
-* @param $amount the amount to be converted.
-* @param $from_cur Source Currency
-* @param $to_cur Destination Currecny
-*/
-function convert_currency($currencies_list, $amount, $from_cur, $to_cur) {
-	if (!is_numeric($amount) || ($amount == 0)) {
-		return 0;
-	}
-	if ($from_cur == $to_cur) {
-		return $amount;
-	}
-	// EUR -> 1.19175 : MAD -> 0.10897
-	// FROM -> 2 - TO -> 0.5 =>>>> multiply 4
-	$mycur_tobase = $currencies_list[strtoupper($from_cur)][2];
-	$mycur = $currencies_list[strtoupper($to_cur)][2];
-	if ($mycur == 0)
-		return 0;
-	$amount = $amount * ($mycur_tobase / $mycur);
-	// echo "\n \n AMOUNT CONVERTED IN NEW CURRENCY $to_cur -> VALUE =".$amount;
-	return $amount;
-}
-
-/*
- * sort_currencies_list
- */
-function sort_currencies_list(& $currencies_list) {
-	$first_array = array (
-		strtoupper(BASE_CURRENCY
-	), 'USD', 'EUR', 'GBP', 'AUD', 'HKD', 'JPY', 'NZD', 'SGD', 'TWD', 'PLN', 'SEK', 'DKK', 'CHF', 'COP', 'MXN', 'CLP');
-	foreach ($first_array as $element_first_array) {
-		if (isset ($currencies_list[$element_first_array])) {
-			$currencies_list2[$element_first_array] = $currencies_list[$element_first_array];
-			unset ($currencies_list[$element_first_array]);
-		}
-	}
-	$currencies_list = array_merge((array)$currencies_list2, (array)$currencies_list);
-}
-
-/*
- * Write log into file
- */
-function write_log($logfile, $output) {
-	// echo "<br>$output<br>";
-	if (strlen($logfile) > 1) {
-		$string_log = "[" . date("d/m/Y H:i:s") . "]:[$output]\n";
-		error_log($string_log . "\n", 3, $logfile);
-	}
-}
-
-/*
- * function cleanInput
- */
-function cleanInput($input) {
-	$search = array (
-			'@<script[^>]*?>.*?</script>@si', // Strip out javascript
-		'@<[\/\!]*?[^<>]*?>@si', // Strip out HTML tags
-		'@<style[^>]*?>.*?</style>@siU', // Strip style tags properly
-		'@<![\s\S]*?--[ \t\n\r]*>@' // Strip multi-line comments
-	);
-
-	$output = preg_replace($search, '', $input);
-	return $output;
-}
-
-/*
- * function sanitize_data
- */
-function sanitize_data($input) {
-
-	if (is_array($input)) {
-		foreach ($input as $var => $val) {
-			$output[$var] = sanitize_data($val);
-		}
-	} else {
-
-		// remove whitespaces (not a must though)  
-		$input = trim($input);
-
-		$input = str_replace('--', '', $input);
-		$input = str_replace(';', '', $input);
-
-		if (!(stripos($input, ' or 1') === FALSE)) {
-			return false;
-		}
-		if (!(stripos($input, ' or true') === FALSE)) {
-			return false;
-		}
-
-		if (get_magic_quotes_gpc()) {
-			$input = stripslashes($input);
-		}
-		$input = cleanInput($input);
-		
-		$output = addslashes($input);
-	}
-
-	return $output;
-}
-
-/*
- * function getpost_ifset
- */
-function getpost_ifset($test_vars) {
-	if (!is_array($test_vars)) {
-		$test_vars = array (
-			$test_vars
-		);
-	}
-	foreach ($test_vars as $test_var) {
-		if (isset ($_POST[$test_var])) {
-			global $$test_var;
-			$$test_var = $_POST[$test_var];
-			$$test_var = sanitize_data($$test_var);
-			if ($test_var == 'username' || $test_var == 'filterprefix') {
-				//rebuild the search parameter to filter character to format card number
-				$filtered_char = array (
-					" ",
-					"-",
-					"_",
-					"(",
-					")",
-					"+"
-				);
-				$$test_var = str_replace($filtered_char, "", $$test_var);
-
-			}
-		} elseif (isset ($_GET[$test_var])) {
-			global $$test_var;
-			$$test_var = $_GET[$test_var];
-			$$test_var = sanitize_data($$test_var);
-			//rebuild the search parameter to filter character to format card number
-			if ($test_var == 'username' || $test_var == 'filterprefix') {
-				//rebuild the search parameter to filter character to format card number
-				$filtered_char = array (
-					" ",
-					"-",
-					"_",
-					"(",
-					")",
-					"/",
-					"\\"
-				);
-				$$test_var = str_replace($filtered_char, "", $$test_var);
-			}
-		}
-	}
-}
-
-/*
- * function display_money
- */
-function display_money($value, $currency = BASE_CURRENCY) {
-	echo number_format($value, 2, '.', ' ') . ' ' . strtoupper($currency);
-}
-
-/*
- * function display_dateformat
- */
-function display_dateformat($mydate) {
-	if (DB_TYPE == "mysql") {
-		if (strlen($mydate) == 14) {
-			// YYYY-MM-DD HH:MM:SS 20300331225242
-			echo substr($mydate, 0, 4) . '-' . substr($mydate, 4, 2) . '-' . substr($mydate, 6, 2);
-			echo ' ' . substr($mydate, 8, 2) . ':' . substr($mydate, 10, 2) . ':' . substr($mydate, 12, 2);
-			return;
-		}
-	}
-	echo $mydate;
-}
-
-/*
- * function display_vm_callerid
- */
-function display_date_timestamp($timestamp){
-	echo date("m/d/Y H:i:s", $timestamp);
-}	
-
-/*
- * function display_vm_callerid
- */
-function display_vm_callerid($callerid_string){
-	$arr_spli = preg_split("/ /", $callerid_string);
-	echo str_replace('"',"", $arr_spli[0]);
-}	
-
-
-
-/*
- * function display_dateonly
- */
-function display_dateonly($mydate) {
-	if (strlen($mydate) > 0 && $mydate != '0000-00-00') {
-		echo date("m/d/Y", strtotime($mydate));
-	}
-}
-
-/*
- * function res_display_dateformat
- */
-function res_display_dateformat($mydate) {
-	if (DB_TYPE == "mysql") {
-		if (strlen($mydate) == 14) {
-			// YYYY-MM-DD HH:MM:SS 20300331225242
-			$res = substr($mydate, 0, 4) . '-' . substr($mydate, 4, 2) . '-' . substr($mydate, 6, 2);
-			$res .= ' ' . substr($mydate, 8, 2) . ':' . substr($mydate, 10, 2) . ':' . substr($mydate, 12, 2);
-			return $res;
-		}
-	}
-	return $mydate;
-}
-
-function res_display_timeformat($mydate) {
-	if (DB_TYPE == "mysql") {
-		if (strlen($mydate) == 6) {
-			// YYYY-MM-DD HH:MM:SS 20300331225242
-			$res = substr($mydate, 0, 4) . ':' . substr($mydate, 4, 2) . ':' . substr($mydate, 6, 2);
-			return $res;
-		}
-	}
-	return $mydate;
-}
-
-/*
- * function display_minute
- */
-function display_minute($sessiontime) {
-	global $resulttype;
-	if ((!isset ($resulttype)) || ($resulttype == "min")) {
-		$minutes = sprintf("%02d", intval($sessiontime / 60)) . ":" . sprintf("%02d", intval($sessiontime % 60));
-	} else {
-		$minutes = $sessiontime;
-	}
-	echo $minutes;
-}
-
-function display_2dec($var) {
-	echo number_format($var, 2);
-}
-
-function display_2dec_percentage($var) {
-	if (isset ($var)) {
-		echo number_format($var, 2) . "%";
-	} else {
-		echo "n/a";
-	}
-}
-
-function display_percentage($var) {
-	if (isset ($var)) {
-		printf("%d%%", $var);
-	} else {
-		echo "n/a";
-	}
-}
-
-function display_2bill($var, $currency = BASE_CURRENCY) {
-	global $currencies_list, $choose_currency;
-
-	if (isset ($choose_currency) && strlen($choose_currency) == 3)
-		$currency = $choose_currency;
-	if ((!isset ($currencies_list)) || (!is_array($currencies_list)))
-		$currencies_list = get_currencies();
-	$var = $var / $currencies_list[strtoupper($currency)][2];
-	echo number_format($var, 3) . ' ' . strtoupper($currency);
-}
-
-function remove_prefix($phonenumber) {
-	if (substr($phonenumber, 0, 3) == "011") {
-		echo substr($phonenumber, 3);
-		return 1;
-	}
-	if (substr($phonenumber, 0, 2) == "00") {
-		echo substr($phonenumber, 2);
-		return 1;
-	}
-	echo $phonenumber;
-}
-
-/*
- * function linkonmonitorfile
- */
-function linkonmonitorfile($value) {
-	$format_list = array ('wav','gsm','mp3','sln','g723','g729');
-	$find_record = false;
-	foreach ($format_list as $c_format){
-		$myfile = $value . "." . $c_format;
-		$dl_full = MONITOR_PATH . "/" . $myfile;
-		if (file_exists($dl_full)) {
-			$find_record = true;
-			break;
-		}
-	}
-	if (!$find_record) return false;
-	
-	$myfile = base64_encode($myfile);
-	echo "<a target=_blank href=\"call-log-customers.php?download=file&file=" . $myfile . "\">";
-	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
-}
-
-/*
- * function linkonmonitorfile_customer
- */
-function linkonmonitorfile_customer($value) {
-	$format_list = array ('wav','gsm','mp3','sln','g723','g729');
-	$find_record = false;
-	foreach ($format_list as $c_format){
-		$myfile = $value . "." . $c_format;
-		$dl_full = MONITOR_PATH . "/" . $myfile;
-		if (file_exists($dl_full)) {
-			$find_record = true;
-			break;
-		}
-	}
-	if (!$find_record) return false;
-	
-	$myfile = base64_encode($myfile);
-	echo "<a target=_blank href=\"call-history.php?download=file&file=" . $myfile . "\">";
-	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
-}
-
-/*
- * function linkdelete_cdr
- */
-function linkdelete_cdr($value) {
-	echo "<a target=\"_blank\" href=\"A2B_entity_call.php?form_action=ask-delete&id=" . $value . "\">";
-	echo '<img src="' . Images_Path . '/delete.png"/></a>';
-}
-
-function linktocustomer($value) {
-	$handle = DbConnect();
-	$inst_table = new Table("cc_card", "id");
-	$FG_TABLE_CLAUSE = "username = '$value'";
-	$list_customer = $inst_table->Get_list($handle, $FG_TABLE_CLAUSE, "", "", "", "", "", "", "", 10);
-	$id = $list_customer[0][0];
-	if ($id > 0) {
-		echo "<a href=\"A2B_entity_card.php?form_action=ask-edit&id=$id\">$value</a>";
-	} else {
-		echo $value;
-	}
-}
-
-function linktocustomer_id($id) {
-	$handle = DbConnect();
-	$inst_table = new Table("cc_card", "username");
-	$FG_TABLE_CLAUSE = "id = '$id'";
-	$list_customer = $inst_table->Get_list($handle, $FG_TABLE_CLAUSE, "", "", "", "", "", "", "", 10);
-	$value = $list_customer[0][0];
-	if ($id > 0) {
-		echo "<a href=\"A2B_entity_card.php?form_action=ask-edit&id=$id\">$value</a>";
-	} else {
-		echo $value;
-	}
-}
-
-function linkto_TC($id) {
-	$call_status = Constants :: getDialStatusList();
-	if (!empty ($call_status[$id][0]))
-		echo $call_status[$id][0];
-	else
-		echo gettext("UNKNOWN");
-}
-
-function infocustomer_id($id) {
-	$handle = DbConnect();
-	$inst_table = new Table("cc_card", "username,firstname,lastname");
-	$FG_TABLE_CLAUSE = "id = '$id'";
-	$list_customer = $inst_table->Get_list($handle, $FG_TABLE_CLAUSE, "", "", "", "", "", "", "", 10);
-	if (is_array($list_customer))
-		$value = $list_customer[0][1] . " " . $list_customer[0][2] . " (" . $list_customer[0][0] . ")";
-	else
-		$value = "";
-	if ($id > 0) {
-		echo "<a href=\"A2B_card_info.php?id=$id\">$value</a>";
-	} else {
-		echo $value;
-	}
-}
-
-function nameofadmin($id) {
-	echo getnameofadmin($id);
-}
-
-function getnameofadmin($id) {
-	$handle = DbConnect();
-	$inst_table = new Table("cc_ui_authen", "login,name");
-	$FG_TABLE_CLAUSE = "userid = '$id'";
-	$list_admin = $inst_table->Get_list($handle, $FG_TABLE_CLAUSE, "", "", "", "", "", "", "", 10);
-	if (is_array($list_admin))
-		$value = $list_admin[0][1] . " (" . $list_admin[0][0] . ")";
-	else
-		$value = "";
-	return $value;
-}
-
-function nameofcustomer_id($id) {
-	echo getnameofcustomer_id($id);
-}
-
-function getnameofcustomer_id($id) {
-	$handle = DbConnect();
-	$inst_table = new Table("cc_card", "username,firstname,lastname");
-	$FG_TABLE_CLAUSE = "id = '$id'";
-	$list_customer = $inst_table->Get_list($handle, $FG_TABLE_CLAUSE, "", "", "", "", "", "", "", 10);
-	if (is_array($list_customer))
-		$value = $list_customer[0][1] . " " . $list_customer[0][2] . " (" . $list_customer[0][0] . ")";
-	else
-		$value = "";
-	return $value;
-}
-
-function linktoagent($id) {
-	$handle = DbConnect();
-	$inst_table = new Table("cc_agent", "login,firstname,lastname");
-	$FG_TABLE_CLAUSE = "id = '$id'";
-	$list_agent = $inst_table->Get_list($handle, $FG_TABLE_CLAUSE, "", "", "", "", "", "", "", 10);
-	if (is_array($list_agent))
-		$value = $list_agent[0][1] . " " . $list_agent[0][2] . " (" . $list_agent[0][0] . ")";
-	else
-		$value = "";
-	if ($id > 0) {
-		return "<a href=\"A2B_entity_agent.php?form_action=ask-edit&id=$id\">$value</a>";
-	} else {
-		return $value;
-	}
-}
-
-function nameofagent($id) {
-	echo getnameofagent($id);
-}
-function getnameofagent($id) {
-	$handle = DbConnect();
-	$inst_table = new Table("cc_agent", "login,firstname,lastname");
-	$FG_TABLE_CLAUSE = "id = '$id'";
-	$list_agent = $inst_table->Get_list($handle, $FG_TABLE_CLAUSE, "", "", "", "", "", "", "", 10);
-	if (is_array($list_agent))
-		$value = $list_agent[0][1] . " " . $list_agent[0][2] . " ( login: " . $list_agent[0][0] . ")";
-	else
-		$value = "";
-	return $value;
-}
-
-/*
- * function MDP_STRING
- */
-function MDP_STRING($chrs = LEN_CARDNUMBER)
-{
-	$pwd = "";
-	mt_srand((double) microtime() * 1000000);
-	while (strlen($pwd) < $chrs) {
-		$chr = chr(mt_rand(0, 255));
-		if (preg_match("/^[0-9a-z]$/i", $chr))
-			$pwd = $pwd . $chr;
-	};
-	return strtolower($pwd);
-}
-
-/*
- * function MDP_NUMERIC
- */
-function MDP_NUMERIC($chrs = LEN_CARDNUMBER)
-{
-    $myrand = "";
-    for($i = 0; $i < $chrs; $i++){
-        $myrand .= mt_rand(0,9);
-    }
-    
-    return $myrand;
-}
-
-/*
- * function MDP
- */
-function MDP($chrs = LEN_CARDNUMBER)
-{
-	return MDP_NUMERIC ($chrs);
-}
-
-/*
- * function gen_card
- */
-function gen_card($table = "cc_card", $len = LEN_CARDNUMBER, $field = "username")
-{
-	return generate_unique_value ($table, $len, $field);
-}
-
-/*
- * function generate_unique_value
- */
-function generate_unique_value($table, $len, $field)
-{
-	$DBHandle_max = DbConnect();
-	for ($k = 0; $k <= 200; $k++) {
-		$card_gen = MDP($len);
-		if ($k == 200) {
-			echo "ERROR : Impossible to generate a $field not yet used!<br>Perhaps check the LEN_CARDNUMBER (value:" . LEN_CARDNUMBER . ")";
-			exit ();
-		}
-
-		$query = "SELECT " . $field . " FROM " . $table . " where " . $field . "='$card_gen'";
-		$resmax = $DBHandle_max->Execute($query);
-		$numrow = 0;
-		if ($resmax)
-			$numrow = $resmax->RecordCount();
-
-		if ($numrow != 0)
-			continue;
-		return $card_gen;
-	}
-}
-
-/*
- * function gen_card_with_alias
- */
-function gen_card_with_alias($table = "cc_card", $api = 0, $length_cardnumber = LEN_CARDNUMBER, $DBHandle = null)
-{
-	if (!isset($DBHandle)) {
-		$DBHandle = DbConnect();
-	}
-
-	for ($k = 0; $k <= 200; $k++) {
-		$card_gen = MDP($length_cardnumber);
-		$alias_gen = MDP(LEN_ALIASNUMBER);
-		if ($k == 200) {
-			if ($api) {
-				global $mail_content, $email_alarm, $logfile;
-				mail($email_alarm, "ALARM : API (gen_card_with_alias - CODE_ERROR 8)", $mail_content);
-				error_log("[" . date("Y/m/d G:i:s", mktime()) . "] " . "[gen_card_with_alias] - CODE_ERROR 8" . "\n", 3, $logfile);
-				echo ("500 Internal server error");
-				exit ();
-			} else {
-				echo "ERROR : Impossible to generate a Cardnumber & Aliasnumber not yet used!<br>Perhaps check the LEN_CARDNUMBER  (value:" . LEN_CARDNUMBER . ") & LEN_ALIASNUMBER (value:" . LEN_ALIASNUMBER . ")";
-				exit ();
-			}
-		}
-
-		$query = "SELECT username FROM " . $table . " where username='$card_gen' OR useralias='$alias_gen'";
-		$numrow = 0;
-		$resmax = $DBHandle->Execute($query);
-		if ($resmax)
-			$numrow = $resmax->RecordCount();
-
-		if ($numrow != 0)
-			continue;
-		$arr_val[0] = $card_gen;
-		$arr_val[1] = $alias_gen;
-		return $arr_val;
-	}
-}
-
-/**
-* Do multi-page navigation.  Displays the prev, next and page options.
-* @param $page the page currently viewed
-* @param $pages the maximum number of pages
-* @param $url the url to refer to with the page number inserted
-* @param $max_width the number of pages to make available at any one time (default = 20)
-*/
-function printPages($page, $pages, $url, $max_width = 20)
-{
-	$lang['strfirst'] = '&lt;&lt; ' . gettext('First');
-	$lang['strprev'] = '&lt; ' . gettext('Prev');
-	$lang['strnext'] = gettext('Next') . ' &gt;';
-	$lang['strlast'] = gettext('Last') . ' &gt;&gt;';
-
-	$window = 8;
-
-	if ($page < 0 || $page > $pages)
-		return;
-	if ($pages < 0)
-		return;
-	if ($max_width <= 0)
-		return;
-
-	if ($pages > 1) {
-		//echo "<center><p>\n";
-		if ($page != 1) {
-			$temp = str_replace('%s', 1 - 1, $url);
-			echo "<a class=\"pagenav\" href=\"{$temp}\">{$lang['strfirst']}</a>\n";
-			$temp = str_replace('%s', $page -1 - 1, $url);
-			echo "<a class=\"pagenav\" href=\"{$temp}\">{$lang['strprev']}</a>\n";
-		}
-
-		if ($page <= $window) {
-			$min_page = 1;
-			$max_page = min(2 * $window, $pages);
-		} elseif ($page > $window && $pages >= $page + $window) {
-			$min_page = ($page - $window) +1;
-			$max_page = $page + $window;
-		} else {
-			$min_page = ($page - (2 * $window - ($pages - $page))) +1;
-			$max_page = $pages;
-		}
-
-		// Make sure min_page is always at least 1
-		// and max_page is never greater than $pages
-		$min_page = max($min_page, 1);
-		$max_page = min($max_page, $pages);
-
-		for ($i = $min_page; $i <= $max_page; $i++) {
-			$temp = str_replace('%s', $i -1, $url);
-			if ($i != $page)
-				echo "<a class=\"pagenav\" href=\"{$temp}\">$i</a>\n";
-			else
-				echo "$i\n";
-		}
-		if ($page != $pages) {
-			$temp = str_replace('%s', $page +1 - 1, $url);
-			echo "<a class=\"pagenav\" href=\"{$temp}\">{$lang['strnext']}</a>\n";
-			$temp = str_replace('%s', $pages -1, $url);
-			echo "<a class=\"pagenav\" href=\"{$temp}\">{$lang['strlast']}</a>\n";
-		}
-	}
-}
-
-/**
-* Validate the Uploaded Files.  Return the error string if any.
-* @param $the_file the file to validate
-* @param $the_file_type the file type
-*/
-function validate_upload($the_file, $the_file_type) {
-	$registered_types = array (
-		"application/x-gzip-compressed" => ".tar.gz, .tgz",
-		"application/x-zip-compressed" => ".zip",
-		"application/x-tar" => ".tar",
-		"text/plain" => ".html, .php, .txt, .inc (etc)",
-		"image/bmp" => ".bmp, .ico",
-		"image/gif" => ".gif",
-		"image/pjpeg" => ".jpg, .jpeg",
-		"image/jpeg" => ".jpg, .jpeg",
-		"image/png" => ".png",
-		"application/x-shockwave-flash" => ".swf",
-		"application/msword" => ".doc",
-		"application/vnd.ms-excel" => ".xls",
-		"application/octet-stream" => ".exe, .fla (etc)",
-		"text/x-comma-separated-values" => ".csv",
-		"text/comma-separated-values" => ".csv",
-		"text/csv" => ".csv",
-		"text/x-csv" => ".csv"
-	); # these are only a few examples, you can find many more!
-
-	$allowed_types = array (
-		"text/plain",
-		"text/x-comma-separated-values",
-		"text/comma-separated-values",
-		"text/csv",
-		"text/x-csv",
-		"application/vnd.ms-excel"
-	);
-
-	$start_error = "\n<b>ERROR:</b>\n<ul>";
-	$error = "";
-	if ($the_file == "") {
-		$error .= "\n<li>" . gettext("File size is greater than allowed limit.") . "\n<ul>";
-	} else {
-		if ($the_file == "none") {
-			$error .= "\n<li>" . gettext("You did not upload anything!") . "</li>";
-		}
-		elseif ($_FILES['the_file']['size'] == 0) {
-			$error .= "\n<li>" . gettext("Failed to upload the file, The file you uploaded may not exist on disk.") . "!</li>";
-		} else {
-			if (!in_array($the_file_type, $allowed_types)) {
-				$error .= "\n<li>" . gettext("file type is not allowed") . ': ' . $the_file_type . "\n<ul>";
-				while ($type = current($allowed_types)) {
-					$error .= "\n<li>" . $registered_types[$type] . " (" . $type . ")</li>";
-					next($allowed_types);
-				}
-				$error .= "\n</ul>";
-			}
-		}
-	}
-	if ($error) {
-		$error = $start_error . $error . "\n</ul>";
-		return $error;
-	} else {
-		return false;
-	}
-
-} # END validate_upload
-
-/*
-	Function securitykey
-*/
-function securitykey($key, $data) {
-	// RFC 2104 HMAC implementation for php.
-	// Creates an md5 HMAC.
-	// Eliminates the need to install mhash to compute a HMAC
-	// Hacked by Lance Rushing
-
-	$b = 64; // byte length for md5
-	if (strlen($key) > $b) {
-		$key = pack("H*", md5($key));
-	}
-	$key = str_pad($key, $b, chr(0x00));
-	$ipad = str_pad('', $b, chr(0x36));
-	$opad = str_pad('', $b, chr(0x5c));
-	$k_ipad = $key ^ $ipad;
-	$k_opad = $key ^ $opad;
-
-	return md5($k_opad . pack("H*", md5($k_ipad . $data)));
-}
-
-/*
-	Function to show GMT DateTime.
-*/
-function get_timezones($handle = null, $clause = null) {
-	if (empty ($handle)) {
-		$handle = DbConnect();
-	}
-	$instance_table = new Table();
-	if (!is_null($clause)) 
-		$clause = 'WHERE '.$clause; 
-	$QUERY = "SELECT id, gmttime, gmtzone, gmtoffset FROM cc_timezone $clause ORDER by id";
-	$result = $instance_table->SQLExec($handle, $QUERY, 1, 300);
-	
-	if (is_array($result)) {
-		$num_cur = count($result);
-		for ($i = 0; $i < $num_cur; $i++) {
-			$timezone_list[$result[$i][0]] = array (
-				1 => $result[$i][1],
-				2 => $result[$i][2],
-				3 => $result[$i][3]
-			);
-		}
-	}
-
-	return $timezone_list;
-}
-
-function display_GMT($currDate, $number, $fulldate = 1)
-{	
-	$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
-	foreach ($timezone_list as $key => $timezone_list_val) {
-		$server_offset = $timezone_list_val[3];
-		break;
-	}
-	
-	$date_time_array = getdate(strtotime($currDate));
-	$hours = $date_time_array['hours'];
-	$minutes = $date_time_array['minutes'];
-	$seconds = $date_time_array['seconds'];
-	$month = $date_time_array['mon'];
-	$day = $date_time_array['mday'];
-	$year = $date_time_array['year'];
-	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
-	
-	$timestamp = $timestamp - ($server_offset - $number);
-	/*
-	if ($fulldate == 1) {
-		$gmdate = gmdate("Y-m-d H:i:s", $timestamp);
-	} else {
-		$gmdate = gmdate("Y-m-d", $timestamp);
-	}
-	return $gmdate;
-	*/
-	
-	if ($fulldate == 1) {
-		$date = date("Y-m-d H:i:s", $timestamp);
-	} else {
-		$date = date("Y-m-d", $timestamp);
-	}
-	return $date;
-}
-
-
-function check_translated($id, $languages, $mailtype)
-{
-	if (empty ($handle)) {
-		$handle = DbConnect();
-	}
-	$instance_table = new Table();
-
-	$QUERY = "SELECT id FROM cc_templatemail WHERE mailtype = '$mailtype' AND id_language = '$languages'";
-	$result = $instance_table->SQLExec($handle, $QUERY);
-	if (is_array($result)) {
-		if (count($result) > 0)
-			return true;
-		else
-			return false;
-	} else {
-		return false;
-	}
-
-}
-
-function update_translation($id, $languages, $subject, $mailtext, $mailtype) {
-	if (empty ($handle)) {
-		$handle = DbConnect();
-	}
-	$instance_table = new Table();
-	$param_update = "subject = '$subject', messagetext = '$mailtext'";
-	$clause = "mailtype = '$mailtype' AND id_language = '$languages'";
-	$func_table = 'cc_templatemail';
-	$update = $instance_table->Update_table($handle, $param_update, $clause, $func_table);
-	return $update;
-}
-
-function insert_translation($id, $languages, $subject, $mailtext, $mailtype) {
-	if (empty ($handle)) {
-		$handle = DbConnect();
-	}
-	$instance_table = new Table();
-	$fromemail = '';
-	$fromname = '';
-	$QUERY = "SELECT fromemail, fromname, mailtype FROM cc_templatemail WHERE mailtype = '$mailtype' AND id_language = 'en'";
-	$result = $instance_table->SQLExec($handle, $QUERY);
-	if (is_array($result)) {
-		if (count($result) > 0) {
-			$fromemail = $result[0][0];
-			$fromname = $result[0][1];
-			$mailtype = $result[0][2];
-		}
-	}
-
-	$value = "'$languages', '$subject', '$mailtext', '$mailtype','$fromemail','$fromname'";
-	$func_fields = "id_language, subject, messagetext, mailtype, fromemail, fromname";
-	$func_table = 'cc_templatemail';
-	$id_name = "id";
-	$inserted = $instance_table->Add_table($handle, $value, $func_fields, $func_table, $id_name);
-	return $inserted;
-}
-
-function mailtemplate_latest_id() {
-	if (empty ($handle)) {
-		$handle = DbConnect();
-	}
-	$instance_table = new Table();
-
-	$QUERY = "SELECT max(id) as latest_id from cc_templatemail where id_language = 'en'";
-	$result = $instance_table->SQLExec($handle, $QUERY);
-	$result[0][0] = $result[0][0] + 1;
-	return $result[0][0];
-
-}
-
-function get_db_languages($handle = null) {
-	if (empty ($handle)) {
-		$handle = DbConnect();
-	}
-	$instance_table = new Table();
-	$QUERY = "SELECT code, name from cc_iso639 order by code";
-	$result = $instance_table->SQLExec($handle, $QUERY);
-
-	return $result;
-}
-
-/*
- * Function use to archive data and call records
- * Insert in cc_call_archive and cc_card_archive on seletion criteria
- * Delete from cc_call and cc_card
- * Used in
- * 1. A2Billing_UI/Public/A2B_data_archving.php
- * 2. A2Billing_UI/Public/A2B_call_archiving.php
- */
-
-function archive_data($condition, $entity = "")
-{	
-	$handle = DbConnect();
-	$instance_table = new Table();
-	if (!empty ($entity)) {
-		if ($entity == "card") {
-			$func_fields = "id, creationdate, firstusedate, expirationdate, enableexpire, expiredays, username, useralias, uipass, credit, tariff, id_didgroup, activated, status, lastname, firstname, address, city, state, country, zipcode, phone, email, fax, inuse, simultaccess, currency, lastuse, nbused, typepaid, creditlimit, voipcall, sip_buddy, iax_buddy, language, redial, runservice, nbservice, id_campaign, num_trials_done, vat, servicelastrun, initialbalance, invoiceday, autorefill, loginkey, mac_addr, id_timezone, tag, voicemail_permitted, voicemail_activated, last_notification, email_notification, notify_email, credit_notification, id_group, company_name, company_website, VAT_RN, traffic, traffic_target, discount, restriction";
-			$value = "SELECT $func_fields FROM cc_card $condition";
-			$func_table = 'cc_card_archive';
-			$id_name = "";
-			$subquery = true;
-			$result = $instance_table->Add_table($handle, $value, $func_fields, $func_table, $id_name, $subquery);
-			$fun_table = "cc_card";
-			if (strpos($condition, 'WHERE') > 0) {
-				$condition = str_replace("WHERE", "", $condition);
-			}
-
-			$result = $instance_table->Delete_table($handle, $condition, $fun_table);
-		} else
-			if ($entity == "call") {
-				$value = "SELECT id, sessionid,uniqueid,card_id,nasipaddress,starttime,stoptime,sessiontime,calledstation,sessionbill,id_tariffgroup,id_tariffplan,id_ratecard,id_trunk,sipiax,src,id_did,buyrate,id_card_package_offer,real_sessiontime FROM cc_call $condition";
-				$func_fields = "id, sessionid,uniqueid,card_id,nasipaddress,starttime,stoptime,sessiontime,calledstation,sessionbill,id_tariffgroup,id_tariffplan,id_ratecard,id_trunk,sipiax,src,id_did,buyrate,id_card_package_offer,real_sessiontime";
-				$func_table = 'cc_call_archive';
-				$id_name = "";
-				$subquery = true;
-				$result = $instance_table->Add_table($handle, $value, $func_fields, $func_table, $id_name, $subquery);
-				if (strpos($condition, 'WHERE') > 0) {
-					$condition = str_replace("WHERE", "", $condition);
-				}
-				$fun_table = "cc_call";
-				$result = $instance_table->Delete_table($handle, $condition, $fun_table);
-			}
-	}
-	return 1;
-}
-
-/*
- * Function use to define exact sql statement for
- * different criteria selection
- */
-function do_field($sql, $fld, $dbfld) {
-	$fldtype = $fld . 'type';
-	global $$fld;
-	global $$fldtype;
-	
-	if ($$fld) {
-		if (strpos($sql, 'WHERE') > 0) {
-			$sql = "$sql AND ";
-		} else {
-			$sql = "$sql WHERE ";
-		}
-		$sql = "$sql $dbfld";
-		if (isset ($$fldtype)) {
-			switch ($$fldtype) {
-				case 1 :
-					$sql = "$sql='" . $$fld . "'";
-					break;
-				case 2 :
-					$sql = "$sql LIKE '" . $$fld . "%'";
-					break;
-				case 3 :
-					$sql = "$sql LIKE '%" . $$fld . "%'";
-					break;
-				case 4 :
-					$sql = "$sql LIKE '%" . $$fld . "'";
-			}
-		} else {
-			$sql = "$sql LIKE '%" . $$fld . "%'";
-		}
-	}
-	return $sql;
-}
-
-// Update currency exchange rate list from finance.yahoo.com.
-// To work around yahoo truncating to 4 decimal places before
-// doing a division, leading to >10% errors with weak base_currency,
-// we always request in a strong currency and convert ourselves.
-// We use ounces of silver,  as if silver ever devalues significantly
-// we'll all be pretty much boned anyway,  wouldn't you say?
-function currencies_update_yahoo ($DBHandle, $instance_table)
-{
-	$FG_DEBUG = 0;
-	$strong_currency = 'EUR';
-	$url = "http://download.finance.yahoo.com/d/quotes.csv?s=";
-	$return = "";
-	
-	$QUERY = "SELECT id, currency, basecurrency FROM cc_currencies ORDER BY id";
-	$old_currencies = $instance_table->SQLExec($DBHandle, $QUERY);
-
-	// we will retrieve a .CSV file e.g. USD to EUR and USD to CAD with a URL like:
-	// http://download.finance.yahoo.com/d/quotes.csv?s=USDEUR=X+USDCAD=X&f=l1
-	if (is_array($old_currencies)) {
-		$num_cur = count($old_currencies);
-		if ($FG_DEBUG >= 1)
-			$return .= basename(__FILE__) . ' line:' . __LINE__ . "[CURRENCIES TO UPDATE = $num_cur]\n";
-		for ($i = 0; $i < $num_cur; $i++) {
-			if ($FG_DEBUG >= 1)
-				$return .= $old_currencies[$i][0] . ' - ' . $old_currencies[$i][1] . ' - ' . $old_currencies[$i][2] . "\n";
-			// Finish and add termination ?
-			if ($i +1 == $num_cur) {
-				$url .= $strong_currency . $old_currencies[$i][1] . "=X&f=l1";
-			} else {
-				$url .= $strong_currency . $old_currencies[$i][1] . "=X+";
-			}
-
-			// Save the index of base_currency when we find it
-			if (strcasecmp(BASE_CURRENCY, $old_currencies[$i][1]) == 0) {
-				$index_base_currency = $i;
-			}
-		}
-
-		// Check we found the index of base_currency
-		if (!isset ($index_base_currency)) {
-			return gettext("Can't find our base_currency in cc_currencies.") . ' ' . gettext('Currency update ABORTED.');
-		}
-
-		// Call wget to download the URL to the .CVS file
-		$command = "wget '" . $url . "' -O /tmp/currencies.cvs  2>&1";
-		exec($command, $output);
-		if ($FG_DEBUG >= 1)
-			$return .= "wget '" . $url . "' -O /tmp/currencies.cvs\n" . $output;
-
-		// get the file with the currencies to update the database
-		$currencies = file("/tmp/currencies.cvs");
-
-		// trim off any leading/trailing comments/headers that may have been added
-		$i = 0;
-		while (!is_numeric(trim($currencies[$i]))) {
-			$i++;
-		}
-		$currencies = array_slice($currencies, $i, $num_cur);
-
-		// do some simple checks to try to verify we've received exactly one
-		// valid response for each currency we requested
-		$num_res = count($currencies);
-		if ($num_res < $num_cur) {
-			return gettext("The CSV file doesn't contain all the currencies we requested.") . ' ' . gettext('Currency update ABORTED.');
-		}
-		for ($i = 0; $i < $num_cur; $i++) {
-			if (!is_numeric(trim($currencies[$i]))) {
-				return gettext("At least one of the entries in the CSV file isn't a number.") . ' ' . gettext('Currency update ABORTED.');
-			}
-		}
-		
-		// Find base_currency's value in $strong_currency to help avoid Yahoo's
-		// early truncation,  and therefore win back a lot of accuracy
-		$base_value = $currencies[$index_base_currency];
-
-		// Check our base_currency will still fund our addiction to tea and biscuits
-		if (round($base_value, 5) < 0.00001) {
-			return gettext('Our base_currency seems to be worthless.') . ' ' . gettext('Currency update ABORTED.');
-		}
-
-		// update each row we originally retrieved from cc_currencies
-		$i = 0;
-		foreach ($currencies as $currency) {
-
-			$currency = trim($currency);
-
-			if ($currency != 0) {
-				$currency = $base_value / $currency;
-			}
-
-			//  extremely weak currencies are assigned the smallest value the schema permits
-			if (round($currency, 5) < 0.00001) {
-				$currency = '0.00001';
-			}
-
-			// if the currency is base_currency then set to exactly 1.00000
-			if ($i == $index_base_currency)
-				$currency = 1;
-
-			$QUERY = "UPDATE cc_currencies SET value='$currency'";
-
-			// if we've changed base_currency,  update each SQL row to reflect this
-			if (BASE_CURRENCY != $old_currencies[$i][2]) {
-				$QUERY .= ", basecurrency='" . BASE_CURRENCY . "'";
-			}
-
-			$QUERY .= " , lastupdate = CURRENT_TIMESTAMP WHERE id ='" . $old_currencies[$i][0] . "'";
-			$result = $instance_table->SQLExec($DBHandle, $QUERY, 0);
-			if ($FG_DEBUG >= 1)
-				$return .= "$QUERY -> [$result]\n";
-
-			$i++;
-			if ($i > 2000)
-				return $return;
-		}
-		$return .= gettext('Success! All currencies are now updated.');
-	}
-	return $return;
-}
-
-/*
- * arguments - function to handle arguments in CLI script
- */
-function arguments($argv) {
-	$_ARG = array ();
-	array_shift($argv); //skip argv[0] !
-	foreach ($argv as $arg) {
-		if (preg_match('/--([^=]+)=(.*)/', $arg, $reg)) {
-			$_ARG[$reg[1]] = $reg[2];
-		}
-		elseif (preg_match('/--([^=]+)/', $arg, $reg)) {
-			$_ARG[$reg[1]] = true;
-		}
-		elseif (preg_match('/^-([a-zA-Z0-9])/', $arg, $reg)) {
-			$_ARG[$reg[1]] = true;
-		} else {
-			$_ARG['input'][] = $arg;
-		}
-	}
-	return $_ARG;
-}
-
-function generate_invoice_reference() {
-	$handle = DbConnect();
-	$year = date("Y");
-	$invoice_conf_table = new Table('cc_invoice_conf', 'value');
-	$conf_clause = "key_val = 'count_$year'";
-	$result = $invoice_conf_table->Get_list($handle, $conf_clause, 0);
-	
-	if (is_array($result) && !empty ($result[0][0])) {
-		$count = $result[0][0];
-		if (!is_numeric($count)) {
-			$count = 0;
-		}
-		$count++;
-		$param_update_conf = "value ='" . $count . "'";
-		$clause_update_conf = "key_val = 'count_$year'";
-		$invoice_conf_table->Update_table($handle, $param_update_conf, $clause_update_conf, $func_table = null);
-	} else {
-		//insert newcount
-		$count = 1;
-		$QUERY = "INSERT INTO cc_invoice_conf (key_val ,value) VALUES ( 'count_$year', '1');";
-		$invoice_conf_table->SQLExec($handle, $QUERY);
-	}
-	$reference = $year . sprintf("%08d", $count);
-	return $reference;
-}
-
-function check_demo_mode()
-{
-	if (DEMO_MODE) {
-		if (strpos($_SERVER['HTTP_REFERER'], '?') === false)
-			Header("Location: " . $_SERVER['HTTP_REFERER'] . "?msg=nodemo");
-		else
-			Header("Location: " . $_SERVER['HTTP_REFERER'] . "&msg=nodemo");
-
-		die();
-	}
-}
-
-function check_demo_mode_intro()
-{
-	if (DEMO_MODE) {
-		Header("Location: PP_intro.php?msg=nodemo");
-		die();
-	}
-}
-
-function isLuhnNum($num)
-{
-	$length = strlen($num);
-	$tot = 0;
-	for($i=$length-1;$i>=0;$i--)
-	{
-		$digit = substr($num, $i, 1);
-		if ((($length - $i) % 2) == 0)
-		{
-			$digit = $digit*2;
-			if ($digit>9)
-			{
-				$digit = $digit-9;
-			}
-		}
-		$tot += $digit;
-	}
-	return (($tot % 10) == 0);
-}
-
-/*
- * Checks the day of month for date related forms and reduces the day to the last valid day of the month if too large.
- * Inputs: &$day: 'xx' from '01' to '31'
- *         $year_month: 'xxxx-mm'
- *         $inplace : 1 == edit day in place.
- * Return  normalized day (integer)
- */
-function normalize_day_of_month(&$day, $year_month, $inplace=0)
-{
-	if( isset($day) && isset($year_month)) {
-		$year_month_ary = preg_split('/-/', $year_month);
-		$year = (int) $year_month_ary[0];
-		$month = (int) $year_month_ary[1];
-		$normalized_day = min( (int) $day, cal_days_in_month(CAL_GREGORIAN, $month, $year) );
-		if($inplace == 1) $day = $normalized_day;
-		return $normalized_day;
-	}
-}
-
-
-
-
-// mt_get: returns the current microtime
-function mt_get()
-{
-    global $mt_time;
-    list($usec, $sec) = explode(" ", microtime());
-    return ((float)$usec + (float)$sec);
-}
- 
-// mt_start: starts the microtime counter
-function mt_start()
-{
-    global $mt_time; $mt_time = mt_get();
-}
- 
-// mt_end: calculates the elapsed time
-function mt_end($len=4)
-{
-    global $mt_time;
-    $time_end = mt_get();
-    return round($time_end - $mt_time, $len);
-}
-
-
-
-/*
-   * @return string
-   * @param string $url
-   * @desc Return string content from a remote file
-*/
-
-function open_url($url)
-{
-    $ch = curl_init();
-
-    curl_setopt ($ch, CURLOPT_URL, $url);
-    curl_setopt ($ch, CURLOPT_HEADER, 0);
-
-    ob_start();
-
-    curl_exec ($ch);
-    curl_close ($ch);
-    $string = ob_get_contents();
-
-    ob_end_clean();
-   
-    return $string;    
-}
-
-
-/*
- * function retrieve_rates_callplan
- */
-function retrieve_rates_callplan($callplan_id, $DBHandle)
-{
-    $instance_table = new Table();
-    
-    $QUERY = "SELECT DISTINCT cc_ratecard.destination, cc_ratecard.dialprefix, cc_ratecard.buyrate, cc_ratecard.rateinitial, cc_ratecard.startdate, cc_ratecard.stopdate, cc_ratecard.initblock, " .
-    		"cc_ratecard.connectcharge, cc_ratecard.id_trunk , cc_ratecard.idtariffplan , cc_ratecard.id FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
-    		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard ON cc_ratecard.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
-    		"AND cc_ratecard.rateinitial = (SELECT min(c1.rateinitial) FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
-    		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard AS c1 ON c1.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
-    		"AND cc_ratecard.dialprefix=c1.dialprefix) ORDER BY destination ASC";
-	
-	$result = $instance_table -> SQLExec ($DBHandle, $QUERY, 1, 3600); // cached for 1hour
-	
-	if (!is_array($result)) {
-	    return false;
-	}
-	
-	return $result;
-	
-}
-
-/*
- * function
- */
-function check_cp()
-{
-	$randn = rand(1, 10);
-	$ret_val = ($randn == 5)? 1 : 0;
-	
-	$pos_star = strpos(COPYRIGHT, 'star2billing');
-	if ($pos_star === false) {
-		return $ret_val;
-	}
-	$pageURL = get_curPageURL();
-    $pos = strpos($pageURL, 'phpsysinfo');
-    
-    if ($pos === false) {
-        
-        $footer_content = file_get_contents("templates/default/footer.tpl");
-
-        $pos_copyright = strpos($footer_content, '$COPYRIGHT');
-        if ($pos_copyright === false) {
-            return $ret_val;
-        }
-    }
-	return 0;
-}
-
-function get_curPageURL($show_get = 0) {
-	$pageURL = 'http';
-	if (array_key_exists('HTTPS', $_SERVER) && ($_SERVER["HTTPS"] == "on")) {
-		$pageURL .= "s";
-	}
-	$pageURL .= "://";
-	if ($_SERVER["SERVER_PORT"] != "80") {
-		$pageURL .= $_SERVER["SERVER_NAME"].":".$_SERVER["SERVER_PORT"].$_SERVER["REQUEST_URI"];
-	} else {
-		$pageURL .= $_SERVER["SERVER_NAME"].$_SERVER["REQUEST_URI"];
-	}
-
-	$pos = strpos($pageURL, '?');
-
-	if ($show_get || ($pos === false))
-		return $pageURL;
-
-
-	$pageURL = substr($pageURL, 0, strpos($pageURL, '?'));
-
-	return $pageURL;
-}
-
-//////////////////////////////////////////////////////
-// Get the last day of the month
-function lastDayOfMonth($month = '', $year = '' , $format = 'd-m-Y')
-{
-   if (empty($month)) {
-      $month = date('m');
-   }
-   if (empty($year)) {
-      $year = date('Y');
-   }
-   $result = strtotime("{$year}-{$month}-01");
-   $result = strtotime('-1 second', strtotime('+1 month', $result));
-   return date($format, $result);
-}
-
-function addRealMonth($timeStamp)
-{
-    // Check if it's the end of the year and the month and year need to be changed
-    $tempMonth = date('m', $timeStamp);
-    $tempYear  = date('Y', $timeStamp);
-    if($tempMonth == "12")
-    {
-        $tempMonth = 1;
-        $tempYear++;
-    }
-    else
-        $tempMonth++;
-
-    $newDate = lastDayOfMonth($tempMonth, $tempYear);
-    return strtotime($newDate);
-}
-
-
-function Display_Login_Button ($DBHandle, $id) {
-	
-	$inst_table = new Table("cc_card", "useralias, uipass");
-	$FG_TABLE_CLAUSE = "id = $id";
-	$list_card_info = $inst_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE);
-	$username = $list_card_info[0][0];
-	$password = $list_card_info[0][1];
-	$link = CUSTOMER_UI_URL;
-
-	if (strpos($link, 'index.php') !== false) {
-		$link = substr($link, 0, strlen($link)-9) . 'userinfo.php';
-	} else {
-		$link = $link . '/userinfo.php';
-	}
-
-	$content = '<div align="right" style="padding-right:20px;">
-		<form action="'.$link.'" method="POST" target="_blank">
-			<input type="hidden" name="done" value="submit_log"/>
-			<input type="hidden" name="pr_login" value="'.$username.'"/>
-			<input type="hidden" name="pr_password" value="'.$password.'"/>
-			<a href="javascript:;" onclick="javascript:$(\'form\').submit();" > '.gettext("GO TO CUSTOMER ACCOUNT").'</a>
-		</form>
-	</div>';
-	return $content;
-}
-
-
+<?php
+
+/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
+
+/**
+ * This file is part of A2Billing (http://www.a2billing.net/)
+ *
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
+ * powered by Star2billing S.L. <http://www.star2billing.com/>
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
+ * @author      Belaid Arezqui <areski@gmail.com>
+ * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
+ * @package     A2Billing
+ *
+ * Software License Agreement (GNU Affero General Public License)
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Affero General Public License as
+ * published by the Free Software Foundation, either version 3 of the
+ * License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Affero General Public License for more details.
+ *
+ * You should have received a copy of the GNU Affero General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ * 
+ * 
+**/
+
+
+/*
+ * a2b_round: specific function to use the same precision everywhere
+ */
+function a2b_round($number) {
+	$PRECISION = 6;
+	return round($number, $PRECISION);
+}
+
+function a2b_encrypt($text, $key) {
+	$iv_size = mcrypt_get_iv_size(MCRYPT_RIJNDAEL_256, MCRYPT_MODE_ECB);
+	$iv = mcrypt_create_iv($iv_size);
+	$temp = mcrypt_encrypt(MCRYPT_RIJNDAEL_256, md5($key), $text, MCRYPT_MODE_ECB, $iv);
+	return $temp;
+}
+
+function a2b_decrypt($text, $key) {
+	$iv_size = mcrypt_get_iv_size(MCRYPT_RIJNDAEL_256, MCRYPT_MODE_ECB);
+	$iv = mcrypt_create_iv($iv_size);
+	$temp = mcrypt_decrypt(MCRYPT_RIJNDAEL_256, md5($key), $text, MCRYPT_MODE_ECB, $iv);
+	return $temp;
+}
+
+/*
+ * a2b_mail - function mail used in a2billing
+ */
+function a2b_mail($to, $subject, $mail_content, $from = 'root@localhost', $fromname = '', $contenttype = 'multipart/alternative')
+{
+	
+	$mail = new PHPMailer(true);
+	
+	if (SMTP_SERVER) {
+		$mail->Mailer = "smtp";
+	} else {
+		$mail->Mailer = "sendmail";
+	}
+
+	$mail->Host = SMTP_HOST;
+	$mail->Username = SMTP_USERNAME;
+	$mail->Password = SMTP_PASSWORD;
+	$mail->Port = SMTP_PORT;
+	$mail->SMTPSecure = SMTP_SECURE;
+    $mail->CharSet = 'UTF-8';
+
+	if (strlen(SMTP_USERNAME) > 0)
+		$mail->SMTPAuth = true;
+
+	$mail->From = $from;
+	$mail->FromName = $fromname;
+	$mail->Subject = $subject;
+	$mail->Body = nl2br($mail_content); //$HTML;
+	$mail->AltBody = $mail_content; // Plain text body (for mail clients that cannot read 	HTML)
+	// if ContentType = multipart/alternative -> HTML will be send
+	$mail->ContentType = $contenttype;
+	
+	if (strpos($to, ',') > 0) {
+		foreach (explode(',', $to) as $toemail){
+            $mail->AddAddress($toemail);
+        }
+	} else {
+	    $mail->AddAddress($to);
+	}
+	
+	try {
+		$mail->Send();
+	} catch (phpmailerException $e) {
+		throw $e;
+	}
+}
+
+/*
+ * get_currencies
+ */
+function get_currencies($handle = null) {
+	if (empty ($handle)) {
+		$handle = DbConnect();
+	}
+	$instance_table = new Table();
+	$QUERY = "SELECT id, currency, name, value FROM cc_currencies ORDER BY id";
+	$result = $instance_table->SQLExec($handle, $QUERY, 1, 300);
+
+	if (is_array($result)) {
+		$num_cur = count($result);
+		for ($i = 0; $i < $num_cur; $i++) {
+			$currencies_list[$result[$i][1]] = array (
+				1 => $result[$i][2],
+				2 => $result[$i][3]
+			);
+		}
+	}
+
+	if ((isset ($currencies_list)) && (is_array($currencies_list)))
+		sort_currencies_list($currencies_list);
+
+	return $currencies_list;
+}
+
+function getCurrenciesList() {
+	$currencies_list = get_currencies();
+	foreach ($currencies_list as $key => $cur_value) {
+		$currency_list[$key] = array (
+			$cur_value[1] . ' (' . $cur_value[2] . ')',
+			$key
+		);
+	}
+	return $currency_list;
+}
+
+function getCurrenciesKeyList() {
+	$currencies_list = get_currencies();
+	foreach ($currencies_list as $key => $cur_value) {
+		$currency_list_key[$key][0] = $key;
+	}
+	return $currency_list_key;
+}
+
+function getCurrenciesRateList() {
+	$currencies_list = get_currencies();
+	foreach ($currencies_list as $key => $cur_value) {
+		$currency_list_r[$key] = array (
+			$key,
+			$cur_value[1]
+		);
+	}
+	return $currency_list_r;
+}
+
+/**
+* Do Currency Conversion.
+* @param $currencies_list the List of currencies.
+* @param $amount the amount to be converted.
+* @param $from_cur Source Currency
+* @param $to_cur Destination Currecny
+*/
+function convert_currency($currencies_list, $amount, $from_cur, $to_cur) {
+	if (!is_numeric($amount) || ($amount == 0)) {
+		return 0;
+	}
+	if ($from_cur == $to_cur) {
+		return $amount;
+	}
+	// EUR -> 1.19175 : MAD -> 0.10897
+	// FROM -> 2 - TO -> 0.5 =>>>> multiply 4
+	$mycur_tobase = $currencies_list[strtoupper($from_cur)][2];
+	$mycur = $currencies_list[strtoupper($to_cur)][2];
+	if ($mycur == 0)
+		return 0;
+	$amount = $amount * ($mycur_tobase / $mycur);
+	// echo "\n \n AMOUNT CONVERTED IN NEW CURRENCY $to_cur -> VALUE =".$amount;
+	return $amount;
+}
+
+/*
+ * sort_currencies_list
+ */
+function sort_currencies_list(& $currencies_list) {
+	$first_array = array (
+		strtoupper(BASE_CURRENCY
+	), 'USD', 'EUR', 'GBP', 'AUD', 'HKD', 'JPY', 'NZD', 'SGD', 'TWD', 'PLN', 'SEK', 'DKK', 'CHF', 'COP', 'MXN', 'CLP');
+	foreach ($first_array as $element_first_array) {
+		if (isset ($currencies_list[$element_first_array])) {
+			$currencies_list2[$element_first_array] = $currencies_list[$element_first_array];
+			unset ($currencies_list[$element_first_array]);
+		}
+	}
+	$currencies_list = array_merge((array)$currencies_list2, (array)$currencies_list);
+}
+
+/*
+ * Write log into file
+ */
+function write_log($logfile, $output) {
+	// echo "<br>$output<br>";
+	if (strlen($logfile) > 1) {
+		$string_log = "[" . date("d/m/Y H:i:s") . "]:[$output]\n";
+		error_log($string_log . "\n", 3, $logfile);
+	}
+}
+
+/*
+ * function cleanInput
+ */
+function cleanInput($input) {
+	$search = array (
+			'@<script[^>]*?>.*?</script>@si', // Strip out javascript
+		'@<[\/\!]*?[^<>]*?>@si', // Strip out HTML tags
+		'@<style[^>]*?>.*?</style>@siU', // Strip style tags properly
+		'@<![\s\S]*?--[ \t\n\r]*>@' // Strip multi-line comments
+	);
+
+	$output = preg_replace($search, '', $input);
+	return $output;
+}
+
+/*
+ * function sanitize_data
+ */
+function sanitize_data($input) {
+
+	if (is_array($input)) {
+		foreach ($input as $var => $val) {
+			$output[$var] = sanitize_data($val);
+		}
+	} else {
+
+		// remove whitespaces (not a must though)  
+		$input = trim($input);
+
+		$input = str_replace('--', '', $input);
+		$input = str_replace(';', '', $input);
+
+		if (!(stripos($input, ' or 1') === FALSE)) {
+			return false;
+		}
+		if (!(stripos($input, ' or true') === FALSE)) {
+			return false;
+		}
+
+		if (get_magic_quotes_gpc()) {
+			$input = stripslashes($input);
+		}
+		$input = cleanInput($input);
+		
+		$output = addslashes($input);
+	}
+
+	return $output;
+}
+
+/*
+ * function getpost_ifset
+ */
+function getpost_ifset($test_vars) {
+	if (!is_array($test_vars)) {
+		$test_vars = array (
+			$test_vars
+		);
+	}
+	foreach ($test_vars as $test_var) {
+		if (isset ($_POST[$test_var])) {
+			global $$test_var;
+			$$test_var = $_POST[$test_var];
+			$$test_var = sanitize_data($$test_var);
+			if ($test_var == 'username' || $test_var == 'filterprefix') {
+				//rebuild the search parameter to filter character to format card number
+				$filtered_char = array (
+					" ",
+					"-",
+					"_",
+					"(",
+					")",
+					"+"
+				);
+				$$test_var = str_replace($filtered_char, "", $$test_var);
+
+			}
+		} elseif (isset ($_GET[$test_var])) {
+			global $$test_var;
+			$$test_var = $_GET[$test_var];
+			$$test_var = sanitize_data($$test_var);
+			//rebuild the search parameter to filter character to format card number
+			if ($test_var == 'username' || $test_var == 'filterprefix') {
+				//rebuild the search parameter to filter character to format card number
+				$filtered_char = array (
+					" ",
+					"-",
+					"_",
+					"(",
+					")",
+					"/",
+					"\\"
+				);
+				$$test_var = str_replace($filtered_char, "", $$test_var);
+			}
+		}
+	}
+}
+
+/*
+ * function display_money
+ */
+function display_money($value, $currency = BASE_CURRENCY) {
+	echo number_format($value, 2, '.', ' ') . ' ' . strtoupper($currency);
+}
+
+/*
+ * function display_dateformat
+ */
+function display_dateformat($mydate) {
+	if (DB_TYPE == "mysql") {
+		if (strlen($mydate) == 14) {
+			// YYYY-MM-DD HH:MM:SS 20300331225242
+			echo substr($mydate, 0, 4) . '-' . substr($mydate, 4, 2) . '-' . substr($mydate, 6, 2);
+			echo ' ' . substr($mydate, 8, 2) . ':' . substr($mydate, 10, 2) . ':' . substr($mydate, 12, 2);
+			return;
+		}
+	}
+	echo $mydate;
+}
+
+/*
+ * function display_vm_callerid
+ */
+function display_date_timestamp($timestamp){
+	echo date("m/d/Y H:i:s", $timestamp);
+}	
+
+/*
+ * function display_vm_callerid
+ */
+function display_vm_callerid($callerid_string){
+	$arr_spli = preg_split("/ /", $callerid_string);
+	echo str_replace('"',"", $arr_spli[0]);
+}	
+
+
+
+/*
+ * function display_dateonly
+ */
+function display_dateonly($mydate) {
+	if (strlen($mydate) > 0 && $mydate != '0000-00-00') {
+		echo date("m/d/Y", strtotime($mydate));
+	}
+}
+
+/*
+ * function res_display_dateformat
+ */
+function res_display_dateformat($mydate) {
+	if (DB_TYPE == "mysql") {
+		if (strlen($mydate) == 14) {
+			// YYYY-MM-DD HH:MM:SS 20300331225242
+			$res = substr($mydate, 0, 4) . '-' . substr($mydate, 4, 2) . '-' . substr($mydate, 6, 2);
+			$res .= ' ' . substr($mydate, 8, 2) . ':' . substr($mydate, 10, 2) . ':' . substr($mydate, 12, 2);
+			return $res;
+		}
+	}
+	return $mydate;
+}
+
+function res_display_timeformat($mydate) {
+	if (DB_TYPE == "mysql") {
+		if (strlen($mydate) == 6) {
+			// YYYY-MM-DD HH:MM:SS 20300331225242
+			$res = substr($mydate, 0, 4) . ':' . substr($mydate, 4, 2) . ':' . substr($mydate, 6, 2);
+			return $res;
+		}
+	}
+	return $mydate;
+}
+
+/*
+ * function display_minute
+ */
+function display_minute($sessiontime) {
+	global $resulttype;
+	if ((!isset ($resulttype)) || ($resulttype == "min")) {
+		$minutes = sprintf("%02d", intval($sessiontime / 60)) . ":" . sprintf("%02d", intval($sessiontime % 60));
+	} else {
+		$minutes = $sessiontime;
+	}
+	echo $minutes;
+}
+
+function display_2dec($var) {
+	echo number_format($var, 2);
+}
+
+function display_2dec_percentage($var) {
+	if (isset ($var)) {
+		echo number_format($var, 2) . "%";
+	} else {
+		echo "n/a";
+	}
+}
+
+function display_percentage($var) {
+	if (isset ($var)) {
+		printf("%d%%", $var);
+	} else {
+		echo "n/a";
+	}
+}
+
+function display_2bill($var, $currency = BASE_CURRENCY) {
+	global $currencies_list, $choose_currency;
+
+	if (isset ($choose_currency) && strlen($choose_currency) == 3)
+		$currency = $choose_currency;
+	if ((!isset ($currencies_list)) || (!is_array($currencies_list)))
+		$currencies_list = get_currencies();
+	$var = $var / $currencies_list[strtoupper($currency)][2];
+	echo number_format($var, 3) . ' ' . strtoupper($currency);
+}
+
+function remove_prefix($phonenumber) {
+	if (substr($phonenumber, 0, 3) == "011") {
+		echo substr($phonenumber, 3);
+		return 1;
+	}
+	if (substr($phonenumber, 0, 2) == "00") {
+		echo substr($phonenumber, 2);
+		return 1;
+	}
+	echo $phonenumber;
+}
+
+/*
+ * function linkonmonitorfile
+ */
+function linkonmonitorfile($value) {
+	$format_list = array ('wav','gsm','mp3','sln','g723','g729');
+	$find_record = false;
+	foreach ($format_list as $c_format){
+		$myfile = $value . "." . $c_format;
+		$dl_full = MONITOR_PATH . "/" . $myfile;
+		if (file_exists($dl_full)) {
+			$find_record = true;
+			break;
+		}
+	}
+	if (!$find_record) return false;
+	
+	$myfile = base64_encode($myfile);
+	echo "<a target=_blank href=\"call-log-customers.php?download=file&file=" . $myfile . "\">";
+	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
+}
+
+/*
+ * function linkonmonitorfile_customer
+ */
+function linkonmonitorfile_customer($value) {
+	$format_list = array ('wav','gsm','mp3','sln','g723','g729');
+	$find_record = false;
+	foreach ($format_list as $c_format){
+		$myfile = $value . "." . $c_format;
+		$dl_full = MONITOR_PATH . "/" . $myfile;
+		if (file_exists($dl_full)) {
+			$find_record = true;
+			break;
+		}
+	}
+	if (!$find_record) return false;
+	
+	$myfile = base64_encode($myfile);
+	echo "<a target=_blank href=\"call-history.php?download=file&file=" . $myfile . "\">";
+	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
+}
+
+/*
+ * function linkdelete_cdr
+ */
+function linkdelete_cdr($value) {
+	echo "<a target=\"_blank\" href=\"A2B_entity_call.php?form_action=ask-delete&id=" . $value . "\">";
+	echo '<img src="' . Images_Path . '/delete.png"/></a>';
+}
+
+function linktocustomer($value) {
+	$handle = DbConnect();
+	$inst_table = new Table("cc_card", "id");
+	$FG_TABLE_CLAUSE = "username = '$value'";
+	$list_customer = $inst_table->Get_list($handle, $FG_TABLE_CLAUSE, "", "", "", "", "", "", "", 10);
+	$id = $list_customer[0][0];
+	if ($id > 0) {
+		echo "<a href=\"A2B_entity_card.php?form_action=ask-edit&id=$id\">$value</a>";
+	} else {
+		echo $value;
+	}
+}
+
+function linktocustomer_id($id) {
+	$handle = DbConnect();
+	$inst_table = new Table("cc_card", "username");
+	$FG_TABLE_CLAUSE = "id = '$id'";
+	$list_customer = $inst_table->Get_list($handle, $FG_TABLE_CLAUSE, "", "", "", "", "", "", "", 10);
+	$value = $list_customer[0][0];
+	if ($id > 0) {
+		echo "<a href=\"A2B_entity_card.php?form_action=ask-edit&id=$id\">$value</a>";
+	} else {
+		echo $value;
+	}
+}
+
+function linkto_TC($id) {
+	$call_status = Constants :: getDialStatusList();
+	if (!empty ($call_status[$id][0]))
+		echo $call_status[$id][0];
+	else
+		echo gettext("UNKNOWN");
+}
+
+function infocustomer_id($id) {
+	$handle = DbConnect();
+	$inst_table = new Table("cc_card", "username,firstname,lastname");
+	$FG_TABLE_CLAUSE = "id = '$id'";
+	$list_customer = $inst_table->Get_list($handle, $FG_TABLE_CLAUSE, "", "", "", "", "", "", "", 10);
+	if (is_array($list_customer))
+		$value = $list_customer[0][1] . " " . $list_customer[0][2] . " (" . $list_customer[0][0] . ")";
+	else
+		$value = "";
+	if ($id > 0) {
+		echo "<a href=\"A2B_card_info.php?id=$id\">$value</a>";
+	} else {
+		echo $value;
+	}
+}
+
+function nameofadmin($id) {
+	echo getnameofadmin($id);
+}
+
+function getnameofadmin($id) {
+	$handle = DbConnect();
+	$inst_table = new Table("cc_ui_authen", "login,name");
+	$FG_TABLE_CLAUSE = "userid = '$id'";
+	$list_admin = $inst_table->Get_list($handle, $FG_TABLE_CLAUSE, "", "", "", "", "", "", "", 10);
+	if (is_array($list_admin))
+		$value = $list_admin[0][1] . " (" . $list_admin[0][0] . ")";
+	else
+		$value = "";
+	return $value;
+}
+
+function nameofcustomer_id($id) {
+	echo getnameofcustomer_id($id);
+}
+
+function getnameofcustomer_id($id) {
+	$handle = DbConnect();
+	$inst_table = new Table("cc_card", "username,firstname,lastname");
+	$FG_TABLE_CLAUSE = "id = '$id'";
+	$list_customer = $inst_table->Get_list($handle, $FG_TABLE_CLAUSE, "", "", "", "", "", "", "", 10);
+	if (is_array($list_customer))
+		$value = $list_customer[0][1] . " " . $list_customer[0][2] . " (" . $list_customer[0][0] . ")";
+	else
+		$value = "";
+	return $value;
+}
+
+function linktoagent($id) {
+	$handle = DbConnect();
+	$inst_table = new Table("cc_agent", "login,firstname,lastname");
+	$FG_TABLE_CLAUSE = "id = '$id'";
+	$list_agent = $inst_table->Get_list($handle, $FG_TABLE_CLAUSE, "", "", "", "", "", "", "", 10);
+	if (is_array($list_agent))
+		$value = $list_agent[0][1] . " " . $list_agent[0][2] . " (" . $list_agent[0][0] . ")";
+	else
+		$value = "";
+	if ($id > 0) {
+		return "<a href=\"A2B_entity_agent.php?form_action=ask-edit&id=$id\">$value</a>";
+	} else {
+		return $value;
+	}
+}
+
+function nameofagent($id) {
+	echo getnameofagent($id);
+}
+function getnameofagent($id) {
+	$handle = DbConnect();
+	$inst_table = new Table("cc_agent", "login,firstname,lastname");
+	$FG_TABLE_CLAUSE = "id = '$id'";
+	$list_agent = $inst_table->Get_list($handle, $FG_TABLE_CLAUSE, "", "", "", "", "", "", "", 10);
+	if (is_array($list_agent))
+		$value = $list_agent[0][1] . " " . $list_agent[0][2] . " ( login: " . $list_agent[0][0] . ")";
+	else
+		$value = "";
+	return $value;
+}
+
+/*
+ * function MDP_STRING
+ */
+function MDP_STRING($chrs = LEN_CARDNUMBER)
+{
+	$pwd = "";
+	mt_srand((double) microtime() * 1000000);
+	while (strlen($pwd) < $chrs) {
+		$chr = chr(mt_rand(0, 255));
+		if (preg_match("/^[0-9a-z]$/i", $chr))
+			$pwd = $pwd . $chr;
+	};
+	return strtolower($pwd);
+}
+
+/*
+ * function MDP_NUMERIC
+ */
+function MDP_NUMERIC($chrs = LEN_CARDNUMBER)
+{
+    $myrand = "";
+    for($i = 0; $i < $chrs; $i++){
+        $myrand .= mt_rand(0,9);
+    }
+    
+    return $myrand;
+}
+
+/*
+ * function MDP
+ */
+function MDP($chrs = LEN_CARDNUMBER)
+{
+	return MDP_NUMERIC ($chrs);
+}
+
+/*
+ * function gen_card
+ */
+function gen_card($table = "cc_card", $len = LEN_CARDNUMBER, $field = "username")
+{
+	return generate_unique_value ($table, $len, $field);
+}
+
+/*
+ * function generate_unique_value
+ */
+function generate_unique_value($table, $len, $field)
+{
+	$DBHandle_max = DbConnect();
+	for ($k = 0; $k <= 200; $k++) {
+		$card_gen = MDP($len);
+		if ($k == 200) {
+			echo "ERROR : Impossible to generate a $field not yet used!<br>Perhaps check the LEN_CARDNUMBER (value:" . LEN_CARDNUMBER . ")";
+			exit ();
+		}
+
+		$query = "SELECT " . $field . " FROM " . $table . " where " . $field . "='$card_gen'";
+		$resmax = $DBHandle_max->Execute($query);
+		$numrow = 0;
+		if ($resmax)
+			$numrow = $resmax->RecordCount();
+
+		if ($numrow != 0)
+			continue;
+		return $card_gen;
+	}
+}
+
+/*
+ * function gen_card_with_alias
+ */
+function gen_card_with_alias($table = "cc_card", $api = 0, $length_cardnumber = LEN_CARDNUMBER, $DBHandle = null)
+{
+	if (!isset($DBHandle)) {
+		$DBHandle = DbConnect();
+	}
+
+	for ($k = 0; $k <= 200; $k++) {
+		$card_gen = MDP($length_cardnumber);
+		$alias_gen = MDP(LEN_ALIASNUMBER);
+		if ($k == 200) {
+			if ($api) {
+				global $mail_content, $email_alarm, $logfile;
+				mail($email_alarm, "ALARM : API (gen_card_with_alias - CODE_ERROR 8)", $mail_content);
+				error_log("[" . date("Y/m/d G:i:s", mktime()) . "] " . "[gen_card_with_alias] - CODE_ERROR 8" . "\n", 3, $logfile);
+				echo ("500 Internal server error");
+				exit ();
+			} else {
+				echo "ERROR : Impossible to generate a Cardnumber & Aliasnumber not yet used!<br>Perhaps check the LEN_CARDNUMBER  (value:" . LEN_CARDNUMBER . ") & LEN_ALIASNUMBER (value:" . LEN_ALIASNUMBER . ")";
+				exit ();
+			}
+		}
+
+		$query = "SELECT username FROM " . $table . " where username='$card_gen' OR useralias='$alias_gen'";
+		$numrow = 0;
+		$resmax = $DBHandle->Execute($query);
+		if ($resmax)
+			$numrow = $resmax->RecordCount();
+
+		if ($numrow != 0)
+			continue;
+		$arr_val[0] = $card_gen;
+		$arr_val[1] = $alias_gen;
+		return $arr_val;
+	}
+}
+
+/**
+* Do multi-page navigation.  Displays the prev, next and page options.
+* @param $page the page currently viewed
+* @param $pages the maximum number of pages
+* @param $url the url to refer to with the page number inserted
+* @param $max_width the number of pages to make available at any one time (default = 20)
+*/
+function printPages($page, $pages, $url, $max_width = 20)
+{
+	$lang['strfirst'] = '&lt;&lt; ' . gettext('First');
+	$lang['strprev'] = '&lt; ' . gettext('Prev');
+	$lang['strnext'] = gettext('Next') . ' &gt;';
+	$lang['strlast'] = gettext('Last') . ' &gt;&gt;';
+
+	$window = 8;
+
+	if ($page < 0 || $page > $pages)
+		return;
+	if ($pages < 0)
+		return;
+	if ($max_width <= 0)
+		return;
+
+	if ($pages > 1) {
+		//echo "<center><p>\n";
+		if ($page != 1) {
+			$temp = str_replace('%s', 1 - 1, $url);
+			echo "<a class=\"pagenav\" href=\"{$temp}\">{$lang['strfirst']}</a>\n";
+			$temp = str_replace('%s', $page -1 - 1, $url);
+			echo "<a class=\"pagenav\" href=\"{$temp}\">{$lang['strprev']}</a>\n";
+		}
+
+		if ($page <= $window) {
+			$min_page = 1;
+			$max_page = min(2 * $window, $pages);
+		} elseif ($page > $window && $pages >= $page + $window) {
+			$min_page = ($page - $window) +1;
+			$max_page = $page + $window;
+		} else {
+			$min_page = ($page - (2 * $window - ($pages - $page))) +1;
+			$max_page = $pages;
+		}
+
+		// Make sure min_page is always at least 1
+		// and max_page is never greater than $pages
+		$min_page = max($min_page, 1);
+		$max_page = min($max_page, $pages);
+
+		for ($i = $min_page; $i <= $max_page; $i++) {
+			$temp = str_replace('%s', $i -1, $url);
+			if ($i != $page)
+				echo "<a class=\"pagenav\" href=\"{$temp}\">$i</a>\n";
+			else
+				echo "$i\n";
+		}
+		if ($page != $pages) {
+			$temp = str_replace('%s', $page +1 - 1, $url);
+			echo "<a class=\"pagenav\" href=\"{$temp}\">{$lang['strnext']}</a>\n";
+			$temp = str_replace('%s', $pages -1, $url);
+			echo "<a class=\"pagenav\" href=\"{$temp}\">{$lang['strlast']}</a>\n";
+		}
+	}
+}
+
+/**
+* Validate the Uploaded Files.  Return the error string if any.
+* @param $the_file the file to validate
+* @param $the_file_type the file type
+*/
+function validate_upload($the_file, $the_file_type) {
+	$registered_types = array (
+		"application/x-gzip-compressed" => ".tar.gz, .tgz",
+		"application/x-zip-compressed" => ".zip",
+		"application/x-tar" => ".tar",
+		"text/plain" => ".html, .php, .txt, .inc (etc)",
+		"image/bmp" => ".bmp, .ico",
+		"image/gif" => ".gif",
+		"image/pjpeg" => ".jpg, .jpeg",
+		"image/jpeg" => ".jpg, .jpeg",
+		"image/png" => ".png",
+		"application/x-shockwave-flash" => ".swf",
+		"application/msword" => ".doc",
+		"application/vnd.ms-excel" => ".xls",
+		"application/octet-stream" => ".exe, .fla (etc)",
+		"text/x-comma-separated-values" => ".csv",
+		"text/comma-separated-values" => ".csv",
+		"text/csv" => ".csv",
+		"text/x-csv" => ".csv"
+	); # these are only a few examples, you can find many more!
+
+	$allowed_types = array (
+		"text/plain",
+		"text/x-comma-separated-values",
+		"text/comma-separated-values",
+		"text/csv",
+		"text/x-csv",
+		"application/vnd.ms-excel"
+	);
+
+	$start_error = "\n<b>ERROR:</b>\n<ul>";
+	$error = "";
+	if ($the_file == "") {
+		$error .= "\n<li>" . gettext("File size is greater than allowed limit.") . "\n<ul>";
+	} else {
+		if ($the_file == "none") {
+			$error .= "\n<li>" . gettext("You did not upload anything!") . "</li>";
+		}
+		elseif ($_FILES['the_file']['size'] == 0) {
+			$error .= "\n<li>" . gettext("Failed to upload the file, The file you uploaded may not exist on disk.") . "!</li>";
+		} else {
+			if (!in_array($the_file_type, $allowed_types)) {
+				$error .= "\n<li>" . gettext("file type is not allowed") . ': ' . $the_file_type . "\n<ul>";
+				while ($type = current($allowed_types)) {
+					$error .= "\n<li>" . $registered_types[$type] . " (" . $type . ")</li>";
+					next($allowed_types);
+				}
+				$error .= "\n</ul>";
+			}
+		}
+	}
+	if ($error) {
+		$error = $start_error . $error . "\n</ul>";
+		return $error;
+	} else {
+		return false;
+	}
+
+} # END validate_upload
+
+/*
+	Function securitykey
+*/
+function securitykey($key, $data) {
+	// RFC 2104 HMAC implementation for php.
+	// Creates an md5 HMAC.
+	// Eliminates the need to install mhash to compute a HMAC
+	// Hacked by Lance Rushing
+
+	$b = 64; // byte length for md5
+	if (strlen($key) > $b) {
+		$key = pack("H*", md5($key));
+	}
+	$key = str_pad($key, $b, chr(0x00));
+	$ipad = str_pad('', $b, chr(0x36));
+	$opad = str_pad('', $b, chr(0x5c));
+	$k_ipad = $key ^ $ipad;
+	$k_opad = $key ^ $opad;
+
+	return md5($k_opad . pack("H*", md5($k_ipad . $data)));
+}
+
+/*
+	Function to show GMT DateTime.
+*/
+function get_timezones($handle = null, $clause = null) {
+	if (empty ($handle)) {
+		$handle = DbConnect();
+	}
+	$instance_table = new Table();
+	if (!is_null($clause)) 
+		$clause = 'WHERE '.$clause; 
+	$QUERY = "SELECT id, gmttime, gmtzone, gmtoffset FROM cc_timezone $clause ORDER by id";
+	$result = $instance_table->SQLExec($handle, $QUERY, 1, 300);
+	
+	if (is_array($result)) {
+		$num_cur = count($result);
+		for ($i = 0; $i < $num_cur; $i++) {
+			$timezone_list[$result[$i][0]] = array (
+				1 => $result[$i][1],
+				2 => $result[$i][2],
+				3 => $result[$i][3]
+			);
+		}
+	}
+
+	return $timezone_list;
+}
+
+function display_GMT($currDate, $number, $fulldate = 1)
+{	
+	$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
+	foreach ($timezone_list as $key => $timezone_list_val) {
+		$server_offset = $timezone_list_val[3];
+		break;
+	}
+	
+	$date_time_array = getdate(strtotime($currDate));
+	$hours = $date_time_array['hours'];
+	$minutes = $date_time_array['minutes'];
+	$seconds = $date_time_array['seconds'];
+	$month = $date_time_array['mon'];
+	$day = $date_time_array['mday'];
+	$year = $date_time_array['year'];
+	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+	$timestamp = $timestamp - ($server_offset - $number);
+	/*
+	if ($fulldate == 1) {
+		$gmdate = gmdate("Y-m-d H:i:s", $timestamp);
+	} else {
+		$gmdate = gmdate("Y-m-d", $timestamp);
+	}
+	return $gmdate;
+	*/
+	
+	if ($fulldate == 1) {
+		$date = date("Y-m-d H:i:s", $timestamp);
+	} else {
+		$date = date("Y-m-d", $timestamp);
+	}
+	return $date;
+}
+
+
+function check_translated($id, $languages, $mailtype)
+{
+	if (empty ($handle)) {
+		$handle = DbConnect();
+	}
+	$instance_table = new Table();
+
+	$QUERY = "SELECT id FROM cc_templatemail WHERE mailtype = '$mailtype' AND id_language = '$languages'";
+	$result = $instance_table->SQLExec($handle, $QUERY);
+	if (is_array($result)) {
+		if (count($result) > 0)
+			return true;
+		else
+			return false;
+	} else {
+		return false;
+	}
+
+}
+
+function update_translation($id, $languages, $subject, $mailtext, $mailtype) {
+	if (empty ($handle)) {
+		$handle = DbConnect();
+	}
+	$instance_table = new Table();
+	$param_update = "subject = '$subject', messagetext = '$mailtext'";
+	$clause = "mailtype = '$mailtype' AND id_language = '$languages'";
+	$func_table = 'cc_templatemail';
+	$update = $instance_table->Update_table($handle, $param_update, $clause, $func_table);
+	return $update;
+}
+
+function insert_translation($id, $languages, $subject, $mailtext, $mailtype) {
+	if (empty ($handle)) {
+		$handle = DbConnect();
+	}
+	$instance_table = new Table();
+	$fromemail = '';
+	$fromname = '';
+	$QUERY = "SELECT fromemail, fromname, mailtype FROM cc_templatemail WHERE mailtype = '$mailtype' AND id_language = 'en'";
+	$result = $instance_table->SQLExec($handle, $QUERY);
+	if (is_array($result)) {
+		if (count($result) > 0) {
+			$fromemail = $result[0][0];
+			$fromname = $result[0][1];
+			$mailtype = $result[0][2];
+		}
+	}
+
+	$value = "'$languages', '$subject', '$mailtext', '$mailtype','$fromemail','$fromname'";
+	$func_fields = "id_language, subject, messagetext, mailtype, fromemail, fromname";
+	$func_table = 'cc_templatemail';
+	$id_name = "id";
+	$inserted = $instance_table->Add_table($handle, $value, $func_fields, $func_table, $id_name);
+	return $inserted;
+}
+
+function mailtemplate_latest_id() {
+	if (empty ($handle)) {
+		$handle = DbConnect();
+	}
+	$instance_table = new Table();
+
+	$QUERY = "SELECT max(id) as latest_id from cc_templatemail where id_language = 'en'";
+	$result = $instance_table->SQLExec($handle, $QUERY);
+	$result[0][0] = $result[0][0] + 1;
+	return $result[0][0];
+
+}
+
+function get_db_languages($handle = null) {
+	if (empty ($handle)) {
+		$handle = DbConnect();
+	}
+	$instance_table = new Table();
+	$QUERY = "SELECT code, name from cc_iso639 order by code";
+	$result = $instance_table->SQLExec($handle, $QUERY);
+
+	return $result;
+}
+
+/*
+ * Function use to archive data and call records
+ * Insert in cc_call_archive and cc_card_archive on seletion criteria
+ * Delete from cc_call and cc_card
+ * Used in
+ * 1. A2Billing_UI/Public/A2B_data_archving.php
+ * 2. A2Billing_UI/Public/A2B_call_archiving.php
+ */
+
+function archive_data($condition, $entity = "")
+{	
+	$handle = DbConnect();
+	$instance_table = new Table();
+	if (!empty ($entity)) {
+		if ($entity == "card") {
+			$func_fields = "id, creationdate, firstusedate, expirationdate, enableexpire, expiredays, username, useralias, uipass, credit, tariff, id_didgroup, activated, status, lastname, firstname, address, city, state, country, zipcode, phone, email, fax, inuse, simultaccess, currency, lastuse, nbused, typepaid, creditlimit, voipcall, sip_buddy, iax_buddy, language, redial, runservice, nbservice, id_campaign, num_trials_done, vat, servicelastrun, initialbalance, invoiceday, autorefill, loginkey, mac_addr, id_timezone, tag, voicemail_permitted, voicemail_activated, last_notification, email_notification, notify_email, credit_notification, id_group, company_name, company_website, VAT_RN, traffic, traffic_target, discount, restriction";
+			$value = "SELECT $func_fields FROM cc_card $condition";
+			$func_table = 'cc_card_archive';
+			$id_name = "";
+			$subquery = true;
+			$result = $instance_table->Add_table($handle, $value, $func_fields, $func_table, $id_name, $subquery);
+			$fun_table = "cc_card";
+			if (strpos($condition, 'WHERE') > 0) {
+				$condition = str_replace("WHERE", "", $condition);
+			}
+
+			$result = $instance_table->Delete_table($handle, $condition, $fun_table);
+		} else
+			if ($entity == "call") {
+				$value = "SELECT id, sessionid,uniqueid,card_id,nasipaddress,starttime,stoptime,sessiontime,calledstation,sessionbill,id_tariffgroup,id_tariffplan,id_ratecard,id_trunk,sipiax,src,id_did,buyrate,id_card_package_offer,real_sessiontime FROM cc_call $condition";
+				$func_fields = "id, sessionid,uniqueid,card_id,nasipaddress,starttime,stoptime,sessiontime,calledstation,sessionbill,id_tariffgroup,id_tariffplan,id_ratecard,id_trunk,sipiax,src,id_did,buyrate,id_card_package_offer,real_sessiontime";
+				$func_table = 'cc_call_archive';
+				$id_name = "";
+				$subquery = true;
+				$result = $instance_table->Add_table($handle, $value, $func_fields, $func_table, $id_name, $subquery);
+				if (strpos($condition, 'WHERE') > 0) {
+					$condition = str_replace("WHERE", "", $condition);
+				}
+				$fun_table = "cc_call";
+				$result = $instance_table->Delete_table($handle, $condition, $fun_table);
+			}
+	}
+	return 1;
+}
+
+/*
+ * Function use to define exact sql statement for
+ * different criteria selection
+ */
+function do_field($sql, $fld, $dbfld) {
+	$fldtype = $fld . 'type';
+	global $$fld;
+	global $$fldtype;
+	
+	if ($$fld) {
+		if (strpos($sql, 'WHERE') > 0) {
+			$sql = "$sql AND ";
+		} else {
+			$sql = "$sql WHERE ";
+		}
+		$sql = "$sql $dbfld";
+		if (isset ($$fldtype)) {
+			switch ($$fldtype) {
+				case 1 :
+					$sql = "$sql='" . $$fld . "'";
+					break;
+				case 2 :
+					$sql = "$sql LIKE '" . $$fld . "%'";
+					break;
+				case 3 :
+					$sql = "$sql LIKE '%" . $$fld . "%'";
+					break;
+				case 4 :
+					$sql = "$sql LIKE '%" . $$fld . "'";
+			}
+		} else {
+			$sql = "$sql LIKE '%" . $$fld . "%'";
+		}
+	}
+	return $sql;
+}
+
+// Update currency exchange rate list from finance.yahoo.com.
+// To work around yahoo truncating to 4 decimal places before
+// doing a division, leading to >10% errors with weak base_currency,
+// we always request in a strong currency and convert ourselves.
+// We use ounces of silver,  as if silver ever devalues significantly
+// we'll all be pretty much boned anyway,  wouldn't you say?
+function currencies_update_yahoo ($DBHandle, $instance_table)
+{
+	$FG_DEBUG = 0;
+	$strong_currency = 'EUR';
+	$url = "http://download.finance.yahoo.com/d/quotes.csv?s=";
+	$return = "";
+	
+	$QUERY = "SELECT id, currency, basecurrency FROM cc_currencies ORDER BY id";
+	$old_currencies = $instance_table->SQLExec($DBHandle, $QUERY);
+
+	// we will retrieve a .CSV file e.g. USD to EUR and USD to CAD with a URL like:
+	// http://download.finance.yahoo.com/d/quotes.csv?s=USDEUR=X+USDCAD=X&f=l1
+	if (is_array($old_currencies)) {
+		$num_cur = count($old_currencies);
+		if ($FG_DEBUG >= 1)
+			$return .= basename(__FILE__) . ' line:' . __LINE__ . "[CURRENCIES TO UPDATE = $num_cur]\n";
+		for ($i = 0; $i < $num_cur; $i++) {
+			if ($FG_DEBUG >= 1)
+				$return .= $old_currencies[$i][0] . ' - ' . $old_currencies[$i][1] . ' - ' . $old_currencies[$i][2] . "\n";
+			// Finish and add termination ?
+			if ($i +1 == $num_cur) {
+				$url .= $strong_currency . $old_currencies[$i][1] . "=X&f=l1";
+			} else {
+				$url .= $strong_currency . $old_currencies[$i][1] . "=X+";
+			}
+
+			// Save the index of base_currency when we find it
+			if (strcasecmp(BASE_CURRENCY, $old_currencies[$i][1]) == 0) {
+				$index_base_currency = $i;
+			}
+		}
+
+		// Check we found the index of base_currency
+		if (!isset ($index_base_currency)) {
+			return gettext("Can't find our base_currency in cc_currencies.") . ' ' . gettext('Currency update ABORTED.');
+		}
+
+		// Call wget to download the URL to the .CVS file
+		$command = "wget '" . $url . "' -O /tmp/currencies.cvs  2>&1";
+		exec($command, $output);
+		if ($FG_DEBUG >= 1)
+			$return .= "wget '" . $url . "' -O /tmp/currencies.cvs\n" . $output;
+
+		// get the file with the currencies to update the database
+		$currencies = file("/tmp/currencies.cvs");
+
+		// trim off any leading/trailing comments/headers that may have been added
+		$i = 0;
+		while (!is_numeric(trim($currencies[$i]))) {
+			$i++;
+		}
+		$currencies = array_slice($currencies, $i, $num_cur);
+
+		// do some simple checks to try to verify we've received exactly one
+		// valid response for each currency we requested
+		$num_res = count($currencies);
+		if ($num_res < $num_cur) {
+			return gettext("The CSV file doesn't contain all the currencies we requested.") . ' ' . gettext('Currency update ABORTED.');
+		}
+		for ($i = 0; $i < $num_cur; $i++) {
+			if (!is_numeric(trim($currencies[$i]))) {
+				return gettext("At least one of the entries in the CSV file isn't a number.") . ' ' . gettext('Currency update ABORTED.');
+			}
+		}
+		
+		// Find base_currency's value in $strong_currency to help avoid Yahoo's
+		// early truncation,  and therefore win back a lot of accuracy
+		$base_value = $currencies[$index_base_currency];
+
+		// Check our base_currency will still fund our addiction to tea and biscuits
+		if (round($base_value, 5) < 0.00001) {
+			return gettext('Our base_currency seems to be worthless.') . ' ' . gettext('Currency update ABORTED.');
+		}
+
+		// update each row we originally retrieved from cc_currencies
+		$i = 0;
+		foreach ($currencies as $currency) {
+
+			$currency = trim($currency);
+
+			if ($currency != 0) {
+				$currency = $base_value / $currency;
+			}
+
+			//  extremely weak currencies are assigned the smallest value the schema permits
+			if (round($currency, 5) < 0.00001) {
+				$currency = '0.00001';
+			}
+
+			// if the currency is base_currency then set to exactly 1.00000
+			if ($i == $index_base_currency)
+				$currency = 1;
+
+			$QUERY = "UPDATE cc_currencies SET value='$currency'";
+
+			// if we've changed base_currency,  update each SQL row to reflect this
+			if (BASE_CURRENCY != $old_currencies[$i][2]) {
+				$QUERY .= ", basecurrency='" . BASE_CURRENCY . "'";
+			}
+
+			$QUERY .= " , lastupdate = CURRENT_TIMESTAMP WHERE id ='" . $old_currencies[$i][0] . "'";
+			$result = $instance_table->SQLExec($DBHandle, $QUERY, 0);
+			if ($FG_DEBUG >= 1)
+				$return .= "$QUERY -> [$result]\n";
+
+			$i++;
+			if ($i > 2000)
+				return $return;
+		}
+		$return .= gettext('Success! All currencies are now updated.');
+	}
+	return $return;
+}
+
+/*
+ * arguments - function to handle arguments in CLI script
+ */
+function arguments($argv) {
+	$_ARG = array ();
+	array_shift($argv); //skip argv[0] !
+	foreach ($argv as $arg) {
+		if (preg_match('/--([^=]+)=(.*)/', $arg, $reg)) {
+			$_ARG[$reg[1]] = $reg[2];
+		}
+		elseif (preg_match('/--([^=]+)/', $arg, $reg)) {
+			$_ARG[$reg[1]] = true;
+		}
+		elseif (preg_match('/^-([a-zA-Z0-9])/', $arg, $reg)) {
+			$_ARG[$reg[1]] = true;
+		} else {
+			$_ARG['input'][] = $arg;
+		}
+	}
+	return $_ARG;
+}
+
+function generate_invoice_reference() {
+	$handle = DbConnect();
+	$year = date("Y");
+	$invoice_conf_table = new Table('cc_invoice_conf', 'value');
+	$conf_clause = "key_val = 'count_$year'";
+	$result = $invoice_conf_table->Get_list($handle, $conf_clause, 0);
+	
+	if (is_array($result) && !empty ($result[0][0])) {
+		$count = $result[0][0];
+		if (!is_numeric($count)) {
+			$count = 0;
+		}
+		$count++;
+		$param_update_conf = "value ='" . $count . "'";
+		$clause_update_conf = "key_val = 'count_$year'";
+		$invoice_conf_table->Update_table($handle, $param_update_conf, $clause_update_conf, $func_table = null);
+	} else {
+		//insert newcount
+		$count = 1;
+		$QUERY = "INSERT INTO cc_invoice_conf (key_val ,value) VALUES ( 'count_$year', '1');";
+		$invoice_conf_table->SQLExec($handle, $QUERY);
+	}
+	$reference = $year . sprintf("%08d", $count);
+	return $reference;
+}
+
+function check_demo_mode()
+{
+	if (DEMO_MODE) {
+		if (strpos($_SERVER['HTTP_REFERER'], '?') === false)
+			Header("Location: " . $_SERVER['HTTP_REFERER'] . "?msg=nodemo");
+		else
+			Header("Location: " . $_SERVER['HTTP_REFERER'] . "&msg=nodemo");
+
+		die();
+	}
+}
+
+function check_demo_mode_intro()
+{
+	if (DEMO_MODE) {
+		Header("Location: PP_intro.php?msg=nodemo");
+		die();
+	}
+}
+
+function isLuhnNum($num)
+{
+	$length = strlen($num);
+	$tot = 0;
+	for($i=$length-1;$i>=0;$i--)
+	{
+		$digit = substr($num, $i, 1);
+		if ((($length - $i) % 2) == 0)
+		{
+			$digit = $digit*2;
+			if ($digit>9)
+			{
+				$digit = $digit-9;
+			}
+		}
+		$tot += $digit;
+	}
+	return (($tot % 10) == 0);
+}
+
+/*
+ * Checks the day of month for date related forms and reduces the day to the last valid day of the month if too large.
+ * Inputs: &$day: 'xx' from '01' to '31'
+ *         $year_month: 'xxxx-mm'
+ *         $inplace : 1 == edit day in place.
+ * Return  normalized day (integer)
+ */
+function normalize_day_of_month(&$day, $year_month, $inplace=0)
+{
+	if( isset($day) && isset($year_month)) {
+		$year_month_ary = preg_split('/-/', $year_month);
+		$year = (int) $year_month_ary[0];
+		$month = (int) $year_month_ary[1];
+		$normalized_day = min( (int) $day, cal_days_in_month(CAL_GREGORIAN, $month, $year) );
+		if($inplace == 1) $day = $normalized_day;
+		return $normalized_day;
+	}
+}
+
+
+
+
+// mt_get: returns the current microtime
+function mt_get()
+{
+    global $mt_time;
+    list($usec, $sec) = explode(" ", microtime());
+    return ((float)$usec + (float)$sec);
+}
+ 
+// mt_start: starts the microtime counter
+function mt_start()
+{
+    global $mt_time; $mt_time = mt_get();
+}
+ 
+// mt_end: calculates the elapsed time
+function mt_end($len=4)
+{
+    global $mt_time;
+    $time_end = mt_get();
+    return round($time_end - $mt_time, $len);
+}
+
+
+
+/*
+   * @return string
+   * @param string $url
+   * @desc Return string content from a remote file
+*/
+
+function open_url($url)
+{
+    $ch = curl_init();
+
+    curl_setopt ($ch, CURLOPT_URL, $url);
+    curl_setopt ($ch, CURLOPT_HEADER, 0);
+
+    ob_start();
+
+    curl_exec ($ch);
+    curl_close ($ch);
+    $string = ob_get_contents();
+
+    ob_end_clean();
+   
+    return $string;    
+}
+
+
+/*
+ * function retrieve_rates_callplan
+ */
+function retrieve_rates_callplan($callplan_id, $DBHandle)
+{
+    $instance_table = new Table();
+    
+    $QUERY = "SELECT DISTINCT cc_ratecard.destination, cc_ratecard.dialprefix, cc_ratecard.buyrate, cc_ratecard.rateinitial, cc_ratecard.startdate, cc_ratecard.stopdate, cc_ratecard.initblock, " .
+    		"cc_ratecard.connectcharge, cc_ratecard.id_trunk , cc_ratecard.idtariffplan , cc_ratecard.id FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
+    		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard ON cc_ratecard.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
+    		"AND cc_ratecard.rateinitial = (SELECT min(c1.rateinitial) FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
+    		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard AS c1 ON c1.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
+    		"AND cc_ratecard.dialprefix=c1.dialprefix) ORDER BY destination ASC";
+	
+	$result = $instance_table -> SQLExec ($DBHandle, $QUERY, 1, 3600); // cached for 1hour
+	
+	if (!is_array($result)) {
+	    return false;
+	}
+	
+	return $result;
+	
+}
+
+/*
+ * function
+ */
+function check_cp()
+{
+	$randn = rand(1, 10);
+	$ret_val = ($randn == 5)? 1 : 0;
+	
+	$pos_star = strpos(COPYRIGHT, 'star2billing');
+	if ($pos_star === false) {
+		return $ret_val;
+	}
+	$pageURL = get_curPageURL();
+    $pos = strpos($pageURL, 'phpsysinfo');
+    
+    if ($pos === false) {
+        
+        $footer_content = file_get_contents("templates/default/footer.tpl");
+
+        $pos_copyright = strpos($footer_content, '$COPYRIGHT');
+        if ($pos_copyright === false) {
+            return $ret_val;
+        }
+    }
+	return 0;
+}
+
+function get_curPageURL($show_get = 0) {
+	$pageURL = 'http';
+	if (array_key_exists('HTTPS', $_SERVER) && ($_SERVER["HTTPS"] == "on")) {
+		$pageURL .= "s";
+	}
+	$pageURL .= "://";
+	if ($_SERVER["SERVER_PORT"] != "80") {
+		$pageURL .= $_SERVER["SERVER_NAME"].":".$_SERVER["SERVER_PORT"].$_SERVER["REQUEST_URI"];
+	} else {
+		$pageURL .= $_SERVER["SERVER_NAME"].$_SERVER["REQUEST_URI"];
+	}
+
+	$pos = strpos($pageURL, '?');
+
+	if ($show_get || ($pos === false))
+		return $pageURL;
+
+
+	$pageURL = substr($pageURL, 0, strpos($pageURL, '?'));
+
+	return $pageURL;
+}
+
+//////////////////////////////////////////////////////
+// Get the last day of the month
+function lastDayOfMonth($month = '', $year = '' , $format = 'd-m-Y')
+{
+   if (empty($month)) {
+      $month = date('m');
+   }
+   if (empty($year)) {
+      $year = date('Y');
+   }
+   $result = strtotime("{$year}-{$month}-01");
+   $result = strtotime('-1 second', strtotime('+1 month', $result));
+   return date($format, $result);
+}
+
+function addRealMonth($timeStamp)
+{
+    // Check if it's the end of the year and the month and year need to be changed
+    $tempMonth = date('m', $timeStamp);
+    $tempYear  = date('Y', $timeStamp);
+    if($tempMonth == "12")
+    {
+        $tempMonth = 1;
+        $tempYear++;
+    }
+    else
+        $tempMonth++;
+
+    $newDate = lastDayOfMonth($tempMonth, $tempYear);
+    return strtotime($newDate);
+}
+
+
+function Display_Login_Button ($DBHandle, $id) {
+	
+	$inst_table = new Table("cc_card", "useralias, uipass");
+	$FG_TABLE_CLAUSE = "id = $id";
+	$list_card_info = $inst_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE);
+	$username = $list_card_info[0][0];
+	$password = $list_card_info[0][1];
+	$link = CUSTOMER_UI_URL;
+
+	if (strpos($link, 'index.php') !== false) {
+		$link = substr($link, 0, strlen($link)-9) . 'userinfo.php';
+	} else {
+		$link = $link . '/userinfo.php';
+	}
+
+	$content = '<div align="right" style="padding-right:20px;">
+		<form action="'.$link.'" method="POST" target="_blank">
+			<input type="hidden" name="done" value="submit_log"/>
+			<input type="hidden" name="pr_login" value="'.$username.'"/>
+			<input type="hidden" name="pr_password" value="'.$password.'"/>
+			<a href="javascript:;" onclick="javascript:$(\'form\').submit();" > '.gettext("GO TO CUSTOMER ACCOUNT").'</a>
+		</form>
+	</div>';
+	return $content;
+}
+
+
+function date_add_hour($tmpdate, $hour = 0) {
+	
+	$second = $hour * 60 * 60 ;
+	$date_time_array = getdate(strtotime($tmpdate));
+	
+
+	$hours = $date_time_array['hours'];
+	$minutes = $date_time_array['minutes'];
+	$seconds = $date_time_array['seconds'];
+	$month = $date_time_array['mon'];
+	$day = $date_time_array['mday'];
+	$year = $date_time_array['year'];
+	
+	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+
+	$timestamp = $timestamp + $second;
+
+	return $timestamp;
+}
